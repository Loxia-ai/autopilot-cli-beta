const a0_0x4b179b=a0_0x1ffa;(function(_0x181f1f,_0x3edba5){const _0x67a8cd=a0_0x1ffa,_0x52349a=_0x181f1f();while(!![]){try{const _0x3b5789=-parseInt(_0x67a8cd(0x95))/0x1*(-parseInt(_0x67a8cd(0x88))/0x2)+parseInt(_0x67a8cd(0x79))/0x3*(parseInt(_0x67a8cd(0x76))/0x4)+parseInt(_0x67a8cd(0x77))/0x5*(-parseInt(_0x67a8cd(0x8a))/0x6)+-parseInt(_0x67a8cd(0xb0))/0x7*(-parseInt(_0x67a8cd(0xb1))/0x8)+-parseInt(_0x67a8cd(0xa8))/0x9+-parseInt(_0x67a8cd(0xb2))/0xa+-parseInt(_0x67a8cd(0xad))/0xb*(-parseInt(_0x67a8cd(0x93))/0xc);if(_0x3b5789===_0x3edba5)break;else _0x52349a['push'](_0x52349a['shift']());}catch(_0x11f94a){_0x52349a['push'](_0x52349a['shift']());}}}(a0_0x3d9f,0xb85ab));import a0_0x16c4b0 from'path';import{promises as a0_0x384c75}from'fs';import{TagParser}from'../utilities/tagParser.js';function a0_0x1ffa(_0x1af96b,_0x38892a){const _0x3d9f3c=a0_0x3d9f();return a0_0x1ffa=function(_0x1ffa8f,_0x2c3b80){_0x1ffa8f=_0x1ffa8f-0x72;let _0x552aad=_0x3d9f3c[_0x1ffa8f];if(a0_0x1ffa['sRZUXY']===undefined){var _0x5815c4=function(_0x16c4b0){const _0x384c75='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1440f4='',_0x1e2a87='';for(let _0x2e5beb=0x0,_0x2b3133,_0x48476d,_0x3b7cc6=0x0;_0x48476d=_0x16c4b0['charAt'](_0x3b7cc6++);~_0x48476d&&(_0x2b3133=_0x2e5beb%0x4?_0x2b3133*0x40+_0x48476d:_0x48476d,_0x2e5beb++%0x4)?_0x1440f4+=String['fromCharCode'](0xff&_0x2b3133>>(-0x2*_0x2e5beb&0x6)):0x0){_0x48476d=_0x384c75['indexOf'](_0x48476d);}for(let _0x1a14f4=0x0,_0x30ce15=_0x1440f4['length'];_0x1a14f4<_0x30ce15;_0x1a14f4++){_0x1e2a87+='%'+('00'+_0x1440f4['charCodeAt'](_0x1a14f4)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x1e2a87);};a0_0x1ffa['OsqRSY']=_0x5815c4,_0x1af96b=arguments,a0_0x1ffa['sRZUXY']=!![];}const _0x52e27d=_0x3d9f3c[0x0],_0x1d80e7=_0x1ffa8f+_0x52e27d,_0x3fda3a=_0x1af96b[_0x1d80e7];return!_0x3fda3a?(_0x552aad=a0_0x1ffa['OsqRSY'](_0x552aad),_0x1af96b[_0x1d80e7]=_0x552aad):_0x552aad=_0x3fda3a,_0x552aad;},a0_0x1ffa(_0x1af96b,_0x38892a);}function a0_0x3d9f(){const _0x160250=['u2vUzgLUzYbPBwfNzsbNzw5LCMf0Aw9UihjLCxvLC3qGDg8Gyxv0B3bPBg90lwjHy2TLBMqGD2L0AcbTB2rLBdOG','zxjYB3i','BgXTu2vYDMLJzq','mJaZnZyWwKHLAMjT','z2vUzxjHDgvjBwfNzq','CxvHBgL0Eq','z2v0','DxnHz2u','nZG1odqZm0HftxzKDG','ChjVz3jLC3m','q2fUBM90ignHBMnLBcbQB2iGD2L0AcbZDgf0Dxm6ia','mJaZwMPfz3D0','mtC1ndK2tKf0wxPZ','mtiXmti5mJbdDfvwCKi','AgfZ','y29UDgvUDa','z2vUzxjHDgu','C2v0teXnu2vYDMLJzq','C2v0','CgvUzgLUz0DLBMvYyxrPB25Z','oeLdC0HmrW','ntvRy0Tmvwu','Bw9KzwW','nJeXnJa3s0PmExPA','teXnihnLCNzPy2uGBM90igf2ywLSywjSzs4Gsw1Hz2uGz2vUzxjHDgLVBIbYzxf1AxjLCYbZzxj2zxiGy29UBMvJDgLVBI4','sw1Hz2uGz2vUzxjHDgLVBIbJB25MAwC6','u2H1DhrPBMCGzg93BIbPBwfNzsb0B29S','Cgf0Aa','Dg9VBhm','BwvZC2fNzq','CgvUzgLUzW','Aw1Hz2vvCMW','yxjYyxLcDwzMzxi','Aw1Hz2vhzw4','sw1Hz2uGC2f2zwqGDg86ia','rxjYB3iGCgfYC2LUzYbPBwfNzsbNzw5LCMf0Aw9UihbHCMfTzxrLCNm6','r2vUzxjHDgLUzYbPBwfNzsb3AxrOihbYB21WDdOG','r2vUzxjHDgLVBIbQB2iGBM90igzVDw5K','mJC2nJq5nhrLD3vrza','z2v0rgvZy3jPChrPB24','nJi4nJq0BuHezwDn','z2v0r2vUzxjHDgLVBLn0yxr1CW','C3rHDhvZ','ywn0Aw9U','C3rHBMrHCMq','D3jPDgvgAwXL','zxHLy3v0zvDPDgHqyxjHBwv0zxjZ','Dg9tDhjPBMC','y2fUy2vSr2vUzxjHDgLVBG','mtjsBu15EKy','rMfPBgvKihrVigrVD25SB2fKigLTywDLoIbivfrqia','muznue15qG','y2fUy2vS','yJy0x2PZB24','DgLTzw91Da','sw1Hz2uGzg93BMXVywqGDgLTzw91Da','zgvIDwC','y2fUy2vSBgvK','Aw5MBW','cKLTywDLieDLBMvYyxrPB24Gvg9VBdOGqwXSB3DZihLVDsb0BYbNzw5LCMf0zsbPBwfNzxmGDxnPBMCGrMX1Ec0XlJeTuhjViefjig1VzgvSlGOkvxnHz2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iNjLBgf0AxzLl3bHDgGVDg8VC2f2zs9PBwfNzs5WBMCIxqPezxrHAwXLzcbKzxnJCMLWDgLVBIbVzIb0AguGAw1Hz2uGEw91ihDHBNqGDg8Gz2vUzxjHDgukwY9Nzw5LCMf0zv0kwY90B29SxqOkrxHHBxbSzxm6cJeUieDLBMvYyxrLigeGC2LTCgXLigLTywDLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVBw91BNrHAw5ZlNbUzYjDcKeGyMvHDxrPzNvSig1VDw50ywLUigXHBMrZy2fWzsb3AxrOihnUB3CTy2fWCgvKihbLywTZlcbHignSzwfYigjSDwuGC2T5lcbHBMqGysbMB3jLC3qGyxqGDgHLigjHC2uGB2yGDgHLig1VDw50ywLUCY4kwY9Nzw5LCMf0zv0kwY90B29SxqOkmI4Gr2vUzxjHDguGysbKzxrHAwXLzcbPBwfNzsb3AxrOihnWzwnPzMLJihn0EwXLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVCM9IB3qUCg5NiL0kqsbMDxr1CMLZDgLJihjVyM90igLUigeGy3LIzxjWDw5RignPDhKGyxqGBMLNAhqUifrOzsbYB2jVDcbOyxmGz2XVD2LUzYbIBhvLigv5zxmGyw5KigLZihn0yw5KAw5NihvUzgvYigeGBMvVBIbZAwDUlIbtDhLSztOGzgLNAxrHBcbHCNqSigrLDgfPBgvKlcbOAwDOignVBNrYyxn0lGPBl2DLBMvYyxrLxqPBl3rVB2XDcGOZlIbhzw5LCMf0zsbHBIbHyNn0CMfJDcbHCNqGCgLLy2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iMLTywDLCY9HyNn0CMfJDc5WBMCIxqPbyNn0CMfJDcbNzw9TzxrYAwmGC2HHCgvZigLUigjYAwDODcbJB2XVCNmSihDPDgGGysbMB2n1CYbVBIbJAxjJBgvZigfUzcb0CMLHBMDSzxmUifn0EwXLoIbTAw5PBwfSAxn0lcbJBgvHBIbSAw5LCYWGDMLICMfUDcbJB2XVCNmUcLSVz2vUzxjHDgvDcLSVDg9VBf0kcK5VDgvZoGOTieLTywDLigDLBMvYyxrPB24GBwf5ihrHA2uGC29Tzsb0Aw1LihrVignVBxbSzxrLcI0GvgHLig91Dhb1DcbWyxrOihnOB3vSzcbIzsbYzwXHDgL2zsb0BYb0AguGChjVAMvJDcbKAxjLy3rVCNKklsbqCM92AwrLigrLDgfPBgvKigrLC2nYAxb0Aw9UCYbMB3iGyMv0DgvYihjLC3vSDhmklsbzB3uGD2LSBcbYzwnLAxzLigeGBM90AwzPy2f0Aw9UihDOzw4GDgHLigLTywDLigDLBMvYyxrPB24GAxmGy29TCgXLDgukicaGia','Bg9Nz2vY','y29TBwfUzhm','y29UzMLN','C2H1DgrVD24','CxvLCNK','vgLTzw91DevYCM9Y','B3v0Chv0lxbHDgG'];a0_0x3d9f=function(){return _0x160250;};return a0_0x3d9f();}import{BaseTool}from'./baseTool.js';export class ImageTool extends BaseTool{constructor(_0x1440f4,_0x1e2a87,_0x2e5beb=null){const _0xee4186=a0_0x1ffa;super(_0x1440f4,_0x1e2a87),this[_0xee4186(0xa7)]=_0x2e5beb,this['pendingGenerations']=new Map();}[a0_0x4b179b(0x73)](_0x2b3133){this['llmService']=_0x2b3133;}[a0_0x4b179b(0x89)](){const _0x53329d=a0_0x4b179b;return _0x53329d(0x9d);}['parseParameters'](_0x48476d){const _0x5668d9=a0_0x4b179b;this[_0x5668d9(0x9e)]['info']('Parsing\x20image\x20generation\x20parameters\x20with\x20TagParser');const _0x3b7cc6={'commands':[]};try{const _0x1a14f4=TagParser[_0x5668d9(0xa2)](_0x48476d,_0x5668d9(0x72));for(const _0x30ce15 of _0x1a14f4){const _0x2475c3=_0x30ce15['attributes'][_0x5668d9(0xa4)];_0x2475c3&&_0x3b7cc6['commands']['push']({'action':_0x5668d9(0x72),'path':_0x2475c3,'prompt':_0x30ce15[_0x5668d9(0xb4)]['trim']()});}return _0x3b7cc6;}catch(_0x52797d){return this[_0x5668d9(0x9e)][_0x5668d9(0xa6)](_0x5668d9(0x85),_0x52797d),{'commands':[]};}}async[a0_0x4b179b(0x90)](_0x432696,_0x5be940){const _0x4c6bd2=a0_0x4b179b;this['logger']['info']('Executing\x20image\x20generation\x20command\x20with\x20parameters:',_0x432696);const _0xc9e316=[];if(!_0x432696['commands']||_0x432696['commands']['length']===0x0)throw new Error('No\x20image\x20generation\x20commands\x20specified');for(const _0x475ec8 of _0x432696[_0x4c6bd2(0x9f)]){try{switch(_0x475ec8['action']){case'generate':const _0xb2a7b5=await this[_0x4c6bd2(0xa9)](_0x475ec8['prompt'],_0x475ec8[_0x4c6bd2(0x7d)],_0x5be940);_0xc9e316['push'](_0xb2a7b5);break;default:throw new Error('Unknown\x20image\x20generation\x20command:\x20'+_0x475ec8[_0x4c6bd2(0x8d)]);}}catch(_0x3eef28){this['logger'][_0x4c6bd2(0xa6)]('Error\x20executing\x20image\x20generation\x20command\x20'+_0x475ec8['action']+':',_0x3eef28),_0xc9e316['push']({'action':_0x475ec8[_0x4c6bd2(0x8d)],'success':![],'error':_0x3eef28['message']});}}return{'results':_0xc9e316};}async['generateImage'](_0x2934a1,_0x52ba5e,_0x26490b){const _0x33ec5c=a0_0x4b179b;this[_0x33ec5c(0x9e)][_0x33ec5c(0x9c)](_0x33ec5c(0x86)+_0x2934a1);if(!this[_0x33ec5c(0xa7)])throw new Error(_0x33ec5c(0x7a));const _0x40fbf7=a0_0x16c4b0['isAbsolute'](_0x52ba5e)?_0x52ba5e:a0_0x16c4b0['resolve'](_0x26490b,_0x52ba5e),_0x5ced14=a0_0x16c4b0['dirname'](_0x40fbf7);await a0_0x384c75['mkdir'](_0x5ced14,{'recursive':!![]});const _0x440667=Date['now']()[_0x33ec5c(0x91)](0x24)+Math['random']()[_0x33ec5c(0x91)](0x24)['substring'](0x2,0x9);try{const _0x5e2821=this['config'][_0x33ec5c(0x7e)]?.[_0x33ec5c(0x83)]?.['model']||'azure-vision-flux-1-1';this[_0x33ec5c(0x9e)]['info'](_0x33ec5c(0x7b),{'configModel':this[_0x33ec5c(0xa0)]['tools']?.[_0x33ec5c(0x83)]?.[_0x33ec5c(0x78)],'finalModel':_0x5e2821,'size':this['config'][_0x33ec5c(0x7e)]?.[_0x33ec5c(0x83)]?.['size']||'1024x1024','quality':this['config'][_0x33ec5c(0x7e)]?.['imageGen']?.[_0x33ec5c(0xaa)]||_0x33ec5c(0x8e)}),this[_0x33ec5c(0x9e)][_0x33ec5c(0x9c)](_0x33ec5c(0xa5)+_0x5e2821);const _0x1a5612={'model':_0x5e2821,'size':this[_0x33ec5c(0xa0)]['tools']?.['imageGen']?.['size']||'1024x1024','quality':this[_0x33ec5c(0xa0)]['tools']?.[_0x33ec5c(0x83)]?.[_0x33ec5c(0xaa)]||_0x33ec5c(0x8e),'responseFormat':_0x33ec5c(0x97)};this['logger'][_0x33ec5c(0x9a)]('Image\x20generation\x20options:',_0x1a5612);const _0x6c45b7=await this[_0x33ec5c(0xa7)]['generateImage'](_0x2934a1,_0x1a5612),_0xfa3aff=_0x6c45b7[_0x33ec5c(0x81)];if(!_0xfa3aff)throw new Error('No image URL received from server');try{const _0x1d9fe1=await fetch(_0xfa3aff,{'signal':AbortSignal[_0x33ec5c(0x98)](0xea60)});if(!_0x1d9fe1['ok'])throw new Error(_0x33ec5c(0x94)+_0x1d9fe1['status']);const _0x5e4347=Buffer['from'](await _0x1d9fe1[_0x33ec5c(0x82)]());await a0_0x384c75[_0x33ec5c(0x8f)](_0x40fbf7,_0x5e4347);}catch(_0x36d484){if(_0x36d484['name']===_0x33ec5c(0xa3))throw new Error(_0x33ec5c(0x99));else{if(_0x36d484['name']==='TypeError')throw new Error('Network\x20error:\x20'+_0x36d484[_0x33ec5c(0x7f)]);else throw new Error('Download\x20failed:\x20'+_0x36d484[_0x33ec5c(0x7f)]);}}return this[_0x33ec5c(0x9e)]['info'](_0x33ec5c(0x84)+_0x40fbf7),{'action':'generate','jobId':_0x440667,'prompt':_0x2934a1,'outputPath':_0x52ba5e,'resolvedOutputPath':_0x40fbf7,'success':!![],'status':'completed','model':_0x6c45b7[_0x33ec5c(0x78)],'size':_0x6c45b7['size'],'usage':_0x6c45b7[_0x33ec5c(0xac)]};}catch(_0x2d7618){this[_0x33ec5c(0x9e)]['error']('Failed\x20to\x20generate\x20image:\x20'+_0x2d7618[_0x33ec5c(0x7f)]);throw new Error('Failed\x20to\x20generate\x20image:\x20'+_0x2d7618[_0x33ec5c(0x7f)]);}}async[a0_0x4b179b(0x8b)](_0x1325e3){const _0x56e082=a0_0x4b179b;if(!this[_0x56e082(0x75)]['has'](_0x1325e3))return{'jobId':_0x1325e3,'exists':![],'status':'not_found'};const _0x333c53=this[_0x56e082(0x75)]['get'](_0x1325e3);return{'jobId':_0x1325e3,'exists':!![],'status':_0x333c53[_0x56e082(0x8c)],'progress':_0x333c53[_0x56e082(0xae)],'prompt':_0x333c53['prompt'],'outputPath':_0x333c53['outputPath']};}async[a0_0x4b179b(0x92)](_0x16cb30){const _0x3dd8ba=a0_0x4b179b;if(!this[_0x3dd8ba(0x75)][_0x3dd8ba(0xb3)](_0x16cb30))return{'action':_0x3dd8ba(0x96),'jobId':_0x16cb30,'success':![],'error':_0x3dd8ba(0x87)};const _0x5964bf=this['pendingGenerations'][_0x3dd8ba(0xab)](_0x16cb30);if(_0x5964bf['status']==='pending')return _0x5964bf[_0x3dd8ba(0x8c)]=_0x3dd8ba(0x9b),this[_0x3dd8ba(0x75)]['set'](_0x16cb30,_0x5964bf),{'action':'cancel','jobId':_0x16cb30,'success':!![]};return{'action':'cancel','jobId':_0x16cb30,'success':![],'error':_0x3dd8ba(0xaf)+_0x5964bf[_0x3dd8ba(0x8c)]};}async[a0_0x4b179b(0xa1)](){const _0x25776a=a0_0x4b179b;this[_0x25776a(0x9e)][_0x25776a(0x9c)](_0x25776a(0x7c));for(const [_0x58af23,_0x2f5209]of this[_0x25776a(0x75)]['entries']()){_0x2f5209[_0x25776a(0x8c)]===_0x25776a(0x80)&&(_0x2f5209['status']='cancelled',this[_0x25776a(0x75)][_0x25776a(0x74)](_0x58af23,_0x2f5209));}}}