const a0_0x55daa0=a0_0x3d11;function a0_0x1872(){const _0x264bda=['y2fUy2vSBgvK','y29UzMLN','mZyZmerntNL3qq','BwTKAxi','z2v0rgvZy3jPChrPB24','ChvZAa','nJaWnde4mdzdvfbqwwC','CxvHBgL0Eq','Dg9tDhjPBMC','C2H1DgrVD24','vw5RBM93BIbPBwfNzsbNzw5LCMf0Aw9UignVBw1HBMq6ia','z2v0r2vUzxjHDgLVBLn0yxr1CW','sw1Hz2uGz2vUzxjHDgLVBIbVChrPB25ZoG','sw1Hz2uGz2vUzxjHDgLVBIbJB25MAwC6','mtCYsxfVCwLL','BM93','zgvIDwC','zxjYB3i','Bg9Nz2vY','ChjVBxb0','C3rHBMrHCMq','Dg9VBhm','z2v0','AxnbyNnVBhv0zq','y2fUy2vSr2vUzxjHDgLVBG','C2v0','yxP1CMuTDMLZAw9UlwzSDxGTms0X','yJy0x2PZB24','mtaYnJqWuhbOr2TT','ndi1otDKtuXtCKW','y2fUy2vS','mtiXndi4mxD0te9jsG','C3rHDhvZ','sw1Hz2uGzg93BMXVywqGDgLTzw91Da','q2fUBM90ignHBMnLBcbQB2iGD2L0AcbZDgf0Dxm6ia','mJy1mJaWmLvsqK5fBW','ywn0Aw9U','m0DuBwDvBa','Aw5MBW','mtiZmZiZnJHYDNfuAuC','BMfTzq','rMfPBgvKihrVigrVD25SB2fKigLTywDLoIbivfrqia','yxjYyxLcDwzMzxi','teXnihnLCNzPy2uGBM90igf2ywLSywjSzs4Gsw1Hz2uGz2vUzxjHDgLVBIbYzxf1AxjLCYbZzxj2zxiGy29UBMvJDgLVBI4','Bw9KzwW','Aw1Hz2vhzw4','C2L6zq','cKLTywDLieDLBMvYyxrPB24Gvg9VBdOGqwXSB3DZihLVDsb0BYbNzw5LCMf0zsbPBwfNzxmGDxnPBMCGrMX1Ec0XlJeTuhjViefjig1VzgvSlGOkvxnHz2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iNjLBgf0AxzLl3bHDgGVDg8VC2f2zs9PBwfNzs5WBMCIxqPezxrHAwXLzcbKzxnJCMLWDgLVBIbVzIb0AguGAw1Hz2uGEw91ihDHBNqGDg8Gz2vUzxjHDgukwY9Nzw5LCMf0zv0kwY90B29SxqOkrxHHBxbSzxm6cJeUieDLBMvYyxrLigeGC2LTCgXLigLTywDLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVBw91BNrHAw5ZlNbUzYjDcKeGyMvHDxrPzNvSig1VDw50ywLUigXHBMrZy2fWzsb3AxrOihnUB3CTy2fWCgvKihbLywTZlcbHignSzwfYigjSDwuGC2T5lcbHBMqGysbMB3jLC3qGyxqGDgHLigjHC2uGB2yGDgHLig1VDw50ywLUCY4kwY9Nzw5LCMf0zv0kwY90B29SxqOkmI4Gr2vUzxjHDguGysbKzxrHAwXLzcbPBwfNzsb3AxrOihnWzwnPzMLJihn0EwXLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVCM9IB3qUCg5NiL0kqsbMDxr1CMLZDgLJihjVyM90igLUigeGy3LIzxjWDw5RignPDhKGyxqGBMLNAhqUifrOzsbYB2jVDcbOyxmGz2XVD2LUzYbIBhvLigv5zxmGyw5KigLZihn0yw5KAw5NihvUzgvYigeGBMvVBIbZAwDUlIbtDhLSztOGzgLNAxrHBcbHCNqSigrLDgfPBgvKlcbOAwDOignVBNrYyxn0lGPBl2DLBMvYyxrLxqPBl3rVB2XDcGOZlIbhzw5LCMf0zsbHBIbHyNn0CMfJDcbHCNqGCgLLy2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iMLTywDLCY9HyNn0CMfJDc5WBMCIxqPbyNn0CMfJDcbNzw9TzxrYAwmGC2HHCgvZigLUigjYAwDODcbJB2XVCNmSihDPDgGGysbMB2n1CYbVBIbJAxjJBgvZigfUzcb0CMLHBMDSzxmUifn0EwXLoIbTAw5PBwfSAxn0lcbJBgvHBIbSAw5LCYWGDMLICMfUDcbJB2XVCNmUcLSVz2vUzxjHDgvDcLSVDg9VBf0kcK5VDgvZoGOTieLTywDLigDLBMvYyxrPB24GBwf5ihrHA2uGC29Tzsb0Aw1LihrVignVBxbSzxrLcI0GvgHLig91Dhb1DcbWyxrOihnOB3vSzcbIzsbYzwXHDgL2zsb0BYb0AguGChjVAMvJDcbKAxjLy3rVCNKklsbqCM92AwrLigrLDgfPBgvKigrLC2nYAxb0Aw9UCYbMB3iGyMv0DgvYihjLC3vSDhmklsbzB3uGD2LSBcbYzwnLAxzLigeGBM90AwzPy2f0Aw9UihDOzw4GDgHLigLTywDLigDLBMvYyxrPB24GAxmGy29TCgXLDgukicaGia','tMv0D29YAYbLCNjVCJOG','z2vUzxjHDgu','mJe4mta1ne9NvxfvqW','y29TBwfUzhm','DxnHz2u','rMfPBgvKihrVigDLBMvYyxrLigLTywDLoIa','n2HHDg1Vtq','tM8GAw1Hz2uGz2vUzxjHDgLVBIbJB21Tyw5KCYbZCgvJAwzPzwq','CMvZB2X2zq','CxvLCNK','yxr0CMLIDxrLCW','BwvZC2fNzq','BgXTu2vYDMLJzq','CgvUzgLUz0DLBMvYyxrPB25Z'];a0_0x1872=function(){return _0x264bda;};return a0_0x1872();}function a0_0x3d11(_0x210acd,_0x357137){const _0x187270=a0_0x1872();return a0_0x3d11=function(_0x3d111f,_0x35fd1a){_0x3d111f=_0x3d111f-0x87;let _0xa70189=_0x187270[_0x3d111f];if(a0_0x3d11['UUiZQb']===undefined){var _0x4c7977=function(_0x9da1e7){const _0x49771e='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x57ee65='',_0x5c7ee9='';for(let _0x47b858=0x0,_0x3fbbec,_0x2982c7,_0x596924=0x0;_0x2982c7=_0x9da1e7['charAt'](_0x596924++);~_0x2982c7&&(_0x3fbbec=_0x47b858%0x4?_0x3fbbec*0x40+_0x2982c7:_0x2982c7,_0x47b858++%0x4)?_0x57ee65+=String['fromCharCode'](0xff&_0x3fbbec>>(-0x2*_0x47b858&0x6)):0x0){_0x2982c7=_0x49771e['indexOf'](_0x2982c7);}for(let _0x14d3e2=0x0,_0x535a6b=_0x57ee65['length'];_0x14d3e2<_0x535a6b;_0x14d3e2++){_0x5c7ee9+='%'+('00'+_0x57ee65['charCodeAt'](_0x14d3e2)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x5c7ee9);};a0_0x3d11['oanemZ']=_0x4c7977,_0x210acd=arguments,a0_0x3d11['UUiZQb']=!![];}const _0x5c6a7d=_0x187270[0x0],_0x5aa83a=_0x3d111f+_0x5c6a7d,_0x4c8fe4=_0x210acd[_0x5aa83a];return!_0x4c8fe4?(_0xa70189=a0_0x3d11['oanemZ'](_0xa70189),_0x210acd[_0x5aa83a]=_0xa70189):_0xa70189=_0x4c8fe4,_0xa70189;},a0_0x3d11(_0x210acd,_0x357137);}(function(_0x56b575,_0x45ea8a){const _0x99124c=a0_0x3d11,_0x13ab80=_0x56b575();while(!![]){try{const _0xa6145a=parseInt(_0x99124c(0xb6))/0x1+parseInt(_0x99124c(0xba))/0x2*(parseInt(_0x99124c(0xbc))/0x3)+parseInt(_0x99124c(0xa5))/0x4*(parseInt(_0x99124c(0xb3))/0x5)+-parseInt(_0x99124c(0x8b))/0x6*(parseInt(_0x99124c(0x8f))/0x7)+parseInt(_0x99124c(0xbe))/0x8+parseInt(_0x99124c(0xb4))/0x9*(parseInt(_0x99124c(0x99))/0xa)+-parseInt(_0x99124c(0x9d))/0xb;if(_0xa6145a===_0x45ea8a)break;else _0x13ab80['push'](_0x13ab80['shift']());}catch(_0x7b8d03){_0x13ab80['push'](_0x13ab80['shift']());}}}(a0_0x1872,0xd2254));import a0_0x9da1e7 from'path';import{promises as a0_0x49771e}from'fs';import{TagParser}from'../utilities/tagParser.js';import{BaseTool}from'./baseTool.js';export class ImageTool extends BaseTool{constructor(_0x57ee65,_0x5c7ee9,_0x47b858=null){const _0x5ca1f7=a0_0x3d11;super(_0x57ee65,_0x5c7ee9),this[_0x5ca1f7(0x95)]=_0x47b858,this['pendingGenerations']=new Map();}['setLLMService'](_0x3fbbec){this['llmService']=_0x3fbbec;}[a0_0x55daa0(0x9b)](){const _0x4e6843=a0_0x55daa0;return _0x4e6843(0x88);}['parseParameters'](_0x2982c7){const _0x518374=a0_0x55daa0;this[_0x518374(0xa9)][_0x518374(0xbd)]('Parsing\x20image\x20generation\x20parameters\x20with\x20TagParser');const _0x596924={'commands':[]};try{const _0x14d3e2=TagParser[_0x518374(0x92)](_0x2982c7,_0x518374(0x8a));for(const _0x535a6b of _0x14d3e2){const _0x567ed2=_0x535a6b[_0x518374(0x93)]['output-path'];_0x567ed2&&_0x596924[_0x518374(0x8c)][_0x518374(0x9c)]({'action':'generate','path':_0x567ed2,'prompt':_0x535a6b['content']['trim']()});}return _0x596924;}catch(_0x48cacd){return this['logger'][_0x518374(0xa8)]('Error\x20parsing\x20image\x20generation\x20parameters:',_0x48cacd),{'commands':[]};}}async['executeWithParameters'](_0x1cfcc9,_0x3aa170){const _0x264675=a0_0x55daa0;this['logger'][_0x264675(0xbd)]('Executing\x20image\x20generation\x20command\x20with\x20parameters:',_0x1cfcc9);const _0x525cd6=[];if(!_0x1cfcc9['commands']||_0x1cfcc9['commands']['length']===0x0)throw new Error(_0x264675(0x90));for(const _0x45efae of _0x1cfcc9['commands']){try{switch(_0x45efae[_0x264675(0xbb)]){case _0x264675(0x8a):const _0x1b53bf=await this['generateImage'](_0x45efae[_0x264675(0xaa)],_0x45efae['path'],_0x3aa170);_0x525cd6[_0x264675(0x9c)](_0x1b53bf);break;default:throw new Error(_0x264675(0xa1)+_0x45efae[_0x264675(0xbb)]);}}catch(_0x18d10e){this[_0x264675(0xa9)]['error']('Error\x20executing\x20image\x20generation\x20command\x20'+_0x45efae['action']+':',_0x18d10e),_0x525cd6[_0x264675(0x9c)]({'action':_0x45efae[_0x264675(0xbb)],'success':![],'error':_0x18d10e[_0x264675(0x94)]});}}return{'results':_0x525cd6};}async['generateImage'](_0x2edb62,_0x3cb9b1,_0x12509f){const _0x5b0fba=a0_0x55daa0;this[_0x5b0fba(0xa9)][_0x5b0fba(0xbd)]('Generating\x20image\x20with\x20prompt:\x20'+_0x2edb62);if(!this[_0x5b0fba(0x95)])throw new Error(_0x5b0fba(0xc2));const _0x5b7bf1=a0_0x9da1e7[_0x5b0fba(0xae)](_0x3cb9b1)?_0x3cb9b1:a0_0x9da1e7[_0x5b0fba(0x91)](_0x12509f,_0x3cb9b1),_0x3c13df=a0_0x9da1e7['dirname'](_0x5b7bf1);await a0_0x49771e[_0x5b0fba(0x9a)](_0x3c13df,{'recursive':!![]});const _0xb1c087=Date[_0x5b0fba(0xa6)]()[_0x5b0fba(0x9f)](0x24)+Math['random']()['toString'](0x24)['substring'](0x2,0x9);try{const _0x43e4c8=this[_0x5b0fba(0x98)]['tools']?.[_0x5b0fba(0xc4)]?.[_0x5b0fba(0xc3)]||_0x5b0fba(0xb1);this[_0x5b0fba(0xa9)][_0x5b0fba(0xbd)](_0x5b0fba(0xa4),{'configModel':this['config']['tools']?.['imageGen']?.[_0x5b0fba(0xc3)],'finalModel':_0x43e4c8,'size':this[_0x5b0fba(0x98)]['tools']?.[_0x5b0fba(0xc4)]?.[_0x5b0fba(0x87)]||'1024x1024','quality':this['config'][_0x5b0fba(0xac)]?.[_0x5b0fba(0xc4)]?.['quality']||_0x5b0fba(0xab)}),this[_0x5b0fba(0xa9)][_0x5b0fba(0xbd)]('Sending\x20image\x20generation\x20request\x20to\x20autopilot-backend\x20with\x20model:\x20'+_0x43e4c8);const _0x1dbe89={'model':_0x43e4c8,'size':this['config']['tools']?.['imageGen']?.[_0x5b0fba(0x87)]||'1024x1024','quality':this[_0x5b0fba(0x98)][_0x5b0fba(0xac)]?.['imageGen']?.[_0x5b0fba(0x9e)]||'standard','responseFormat':_0x5b0fba(0xb2)};this['logger'][_0x5b0fba(0xa7)](_0x5b0fba(0xa3),_0x1dbe89);const _0x53dd60=await this[_0x5b0fba(0x95)]['generateImage'](_0x2edb62,_0x1dbe89),_0x2a8012=_0x53dd60['imageUrl'];if(!_0x2a8012)throw new Error('No image URL received from server');try{const _0x1d857b=await fetch(_0x2a8012,{'signal':AbortSignal['timeout'](0xea60)});if(!_0x1d857b['ok'])throw new Error(_0x5b0fba(0xc0)+_0x1d857b[_0x5b0fba(0xb7)]);const _0x505652=Buffer['from'](await _0x1d857b[_0x5b0fba(0xc1)]());await a0_0x49771e['writeFile'](_0x5b7bf1,_0x505652);}catch(_0x187da9){if(_0x187da9[_0x5b0fba(0xbf)]==='TimeoutError')throw new Error(_0x5b0fba(0xb8));else{if(_0x187da9[_0x5b0fba(0xbf)]==='TypeError')throw new Error(_0x5b0fba(0x89)+_0x187da9[_0x5b0fba(0x94)]);else throw new Error('Download\x20failed:\x20'+_0x187da9['message']);}}return this[_0x5b0fba(0xa9)]['info']('Image\x20saved\x20to:\x20'+_0x5b7bf1),{'action':'generate','jobId':_0xb1c087,'prompt':_0x2edb62,'outputPath':_0x3cb9b1,'resolvedOutputPath':_0x5b7bf1,'success':!![],'status':'completed','model':_0x53dd60['model'],'size':_0x53dd60['size'],'usage':_0x53dd60[_0x5b0fba(0x8d)]};}catch(_0xf60dff){this[_0x5b0fba(0xa9)]['error']('Failed\x20to\x20generate\x20image:\x20'+_0xf60dff[_0x5b0fba(0x94)]);throw new Error(_0x5b0fba(0x8e)+_0xf60dff[_0x5b0fba(0x94)]);}}async[a0_0x55daa0(0xa2)](_0x3be67a){const _0x3cc624=a0_0x55daa0;if(!this[_0x3cc624(0x96)]['has'](_0x3be67a))return{'jobId':_0x3be67a,'exists':![],'status':'not_found'};const _0x38bf85=this[_0x3cc624(0x96)]['get'](_0x3be67a);return{'jobId':_0x3be67a,'exists':!![],'status':_0x38bf85['status'],'progress':_0x38bf85['progress'],'prompt':_0x38bf85['prompt'],'outputPath':_0x38bf85['outputPath']};}async[a0_0x55daa0(0xaf)](_0x46a31e){const _0x4adef0=a0_0x55daa0;if(!this['pendingGenerations']['has'](_0x46a31e))return{'action':_0x4adef0(0xb5),'jobId':_0x46a31e,'success':![],'error':'Generation\x20job\x20not\x20found'};const _0xf9935=this[_0x4adef0(0x96)][_0x4adef0(0xad)](_0x46a31e);if(_0xf9935[_0x4adef0(0xb7)]==='pending')return _0xf9935['status']='cancelled',this[_0x4adef0(0x96)]['set'](_0x46a31e,_0xf9935),{'action':'cancel','jobId':_0x46a31e,'success':!![]};return{'action':_0x4adef0(0xb5),'jobId':_0x46a31e,'success':![],'error':_0x4adef0(0xb9)+_0xf9935['status']};}async[a0_0x55daa0(0xa0)](){const _0x242762=a0_0x55daa0;this[_0x242762(0xa9)][_0x242762(0xbd)]('Shutting\x20down\x20image\x20tool');for(const [_0x1f88f9,_0x5467f4]of this[_0x242762(0x96)]['entries']()){_0x5467f4['status']==='pending'&&(_0x5467f4[_0x242762(0xb7)]=_0x242762(0x97),this[_0x242762(0x96)][_0x242762(0xb0)](_0x1f88f9,_0x5467f4));}}}