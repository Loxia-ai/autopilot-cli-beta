const a0_0x4ef37c=a0_0x426d;(function(_0x2bdb4b,_0x46a2f9){const _0x53e35c=a0_0x426d,_0x5f01b6=_0x2bdb4b();while(!![]){try{const _0x40d3fc=parseInt(_0x53e35c(0x125))/0x1+parseInt(_0x53e35c(0x122))/0x2*(-parseInt(_0x53e35c(0x134))/0x3)+-parseInt(_0x53e35c(0x10b))/0x4*(parseInt(_0x53e35c(0x121))/0x5)+-parseInt(_0x53e35c(0x109))/0x6+parseInt(_0x53e35c(0x106))/0x7*(-parseInt(_0x53e35c(0x132))/0x8)+-parseInt(_0x53e35c(0x102))/0x9*(parseInt(_0x53e35c(0x135))/0xa)+parseInt(_0x53e35c(0x12a))/0xb;if(_0x40d3fc===_0x46a2f9)break;else _0x5f01b6['push'](_0x5f01b6['shift']());}catch(_0xa5b64){_0x5f01b6['push'](_0x5f01b6['shift']());}}}(a0_0x304d,0x1fa1e));import a0_0x3a3b8a from'path';import{promises as a0_0x449239}from'fs';import{TagParser}from'../utilities/tagParser.js';function a0_0x426d(_0x47f311,_0xe9f658){const _0x304d06=a0_0x304d();return a0_0x426d=function(_0x426d56,_0x5ab0ab){_0x426d56=_0x426d56-0x100;let _0x5570ee=_0x304d06[_0x426d56];if(a0_0x426d['LrKLam']===undefined){var _0x361410=function(_0x3a3b8a){const _0x449239='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x286fd6='',_0x52f1d6='';for(let _0x114f83=0x0,_0xcca93f,_0x4048a7,_0x13e13b=0x0;_0x4048a7=_0x3a3b8a['charAt'](_0x13e13b++);~_0x4048a7&&(_0xcca93f=_0x114f83%0x4?_0xcca93f*0x40+_0x4048a7:_0x4048a7,_0x114f83++%0x4)?_0x286fd6+=String['fromCharCode'](0xff&_0xcca93f>>(-0x2*_0x114f83&0x6)):0x0){_0x4048a7=_0x449239['indexOf'](_0x4048a7);}for(let _0x3bf7e8=0x0,_0x4ab7d8=_0x286fd6['length'];_0x3bf7e8<_0x4ab7d8;_0x3bf7e8++){_0x52f1d6+='%'+('00'+_0x286fd6['charCodeAt'](_0x3bf7e8)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x52f1d6);};a0_0x426d['cQQjYO']=_0x361410,_0x47f311=arguments,a0_0x426d['LrKLam']=!![];}const _0x1844d7=_0x304d06[0x0],_0x3662f6=_0x426d56+_0x1844d7,_0x713140=_0x47f311[_0x3662f6];return!_0x713140?(_0x5570ee=a0_0x426d['cQQjYO'](_0x5570ee),_0x47f311[_0x3662f6]=_0x5570ee):_0x5570ee=_0x713140,_0x5570ee;},a0_0x426d(_0x47f311,_0xe9f658);}import{BaseTool}from'./baseTool.js';function a0_0x304d(){const _0x554560=['y2fUy2vS','C2L6zq','ywn0Aw9U','ndmYnZvRzhjnD1m','oeXOuurfra','CxvHBgL0Eq','z2v0','mJe5nJa0Eg1Iquf2','C2v0','rxjYB3iGzxHLy3v0Aw5NigLTywDLigDLBMvYyxrPB24Gy29TBwfUzca','BgXTu2vYDMLJzq','D3jPDgvgAwXL','nteZmdC5nKzMr0Tdyq','CMfUzg9T','CgvUzgLUzW','vgLTzw91DevYCM9Y','CgfYC2vqyxjHBwv0zxjZ','y2fUy2vSBgvK','yxjYyxLcDwzMzxi','rxHLy3v0Aw5NigLTywDLigDLBMvYyxrPB24Gy29TBwfUzcb3AxrOihbHCMfTzxrLCNm6','og5tsgrmDG','Aw1Hz2vhzw4','oty0nwrdqMfwqG','mtu4ntbtz2zXrKW','cKLTywDLieDLBMvYyxrPB24Gvg9VBdOGqwXSB3DZihLVDsb0BYbNzw5LCMf0zsbPBwfNzxmGDxnPBMCGquKGBw9KzwXZlGOkvxnHz2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iNjLBgf0AxzLl3bHDgGVDg8VC2f2zs9PBwfNzs5WBMCIxqPezxrHAwXLzcbKzxnJCMLWDgLVBIbVzIb0AguGAw1Hz2uGEw91ihDHBNqGDg8Gz2vUzxjHDgukwY9Nzw5LCMf0zv0kwY90B29SxqOkrxHHBxbSzxm6cJeUieDLBMvYyxrLigeGC2LTCgXLigLTywDLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVBw91BNrHAw5ZlNbUzYjDcKeGyMvHDxrPzNvSig1VDw50ywLUigXHBMrZy2fWzsb3AxrOihnUB3CTy2fWCgvKihbLywTZlcbHignSzwfYigjSDwuGC2T5lcbHBMqGysbMB3jLC3qGyxqGDgHLigjHC2uGB2yGDgHLig1VDw50ywLUCY4kwY9Nzw5LCMf0zv0kwY90B29SxqOkmI4Gr2vUzxjHDguGysbKzxrHAwXLzcbPBwfNzsb3AxrOihnWzwnPzMLJihn0EwXLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVCM9IB3qUCg5NiL0kqsbMDxr1CMLZDgLJihjVyM90igLUigeGy3LIzxjWDw5RignPDhKGyxqGBMLNAhqUifrOzsbYB2jVDcbOyxmGz2XVD2LUzYbIBhvLigv5zxmGyw5KigLZihn0yw5KAw5NihvUzgvYigeGBMvVBIbZAwDUlIbtDhLSztOGzgLNAxrHBcbHCNqSigrLDgfPBgvKlcbOAwDOignVBNrYyxn0lGPBl2DLBMvYyxrLxqPBl3rVB2XDcGOZlIbhzw5LCMf0zsbHBIbHyNn0CMfJDcbHCNqGCgLLy2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iMLTywDLCY9HyNn0CMfJDc5WBMCIxqPbyNn0CMfJDcbNzw9TzxrYAwmGC2HHCgvZigLUigjYAwDODcbJB2XVCNmSihDPDgGGysbMB2n1CYbVBIbJAxjJBgvZigfUzcb0CMLHBMDSzxmUifn0EwXLoIbTAw5PBwfSAxn0lcbJBgvHBIbSAw5LCYWGDMLICMfUDcbJB2XVCNmUcLSVz2vUzxjHDgvDcLSVDg9VBf0kcK5VDgvZoGOTieLTywDLigDLBMvYyxrPB24GBwf5ihrHA2uGC29Tzsb0Aw1LihrVignVBxbSzxrLcI0GvgHLig91Dhb1DcbWyxrOihnOB3vSzcbIzsbYzwXHDgL2zsb0BYb0AguGChjVAMvJDcbKAxjLy3rVCNKklsbqCM92AwrLigrLDgfPBgvKigrLC2nYAxb0Aw9UCYbMB3iGyMv0DgvYihjLC3vSDhmklsbzB3uGD2LSBcbYzwnLAxzLigeGBM90AwzPy2f0Aw9UihDOzw4GDgHLigLTywDLigDLBMvYyxrPB24GAxmGy29TCgXLDgukicaGia','Dg9VBhm','AgfZ','zNjVBq','BwvZC2fNzq','BwTKAxi','mZG3Cxrtu2jU','y29UzMLN','CgvUzgLUz0DLBMvYyxrPB25Z','y29TBwfUzhm','mZeZmJy0swvcBLnO','C3rHDhvZ','z2vUzxjHDgu','mtmZnZKYmNDNCKrpDq','r2vUzxjHDgLVBIbQB2iGBM90igzVDw5K','otzIwenzvha','Bg9Nz2vY','Cgf0Aa','yJy0x2PZB24','ChjVz3jLC3m','mtaYnhGXmdi0','Dg9tDhjPBMC','rMfPBgvKihrVigrVD25SB2fKigLTywDLoIbivfrqia','Aw5MBW','ChjVBxb0','q2fUBM90ignHBMnLBcbQB2iGD2L0AcbZDgf0Dxm6ia','sw1Hz2uGzg93BMXVywqGDgLTzw91Da','yxr0CMLIDxrLCW','tMv0D29YAYbLCNjVCJOG','tM8GAw1Hz2uGz2vUzxjHDgLVBIbJB21Tyw5KCYbZCgvJAwzPzwq','Bw9KzwW','C3rHBMrHCMq','DxnHz2u','y2fUy2vSr2vUzxjHDgLVBG'];a0_0x304d=function(){return _0x554560;};return a0_0x304d();}export class ImageTool extends BaseTool{constructor(_0x286fd6,_0x52f1d6,_0x114f83=null){const _0x2e175e=a0_0x426d;super(_0x286fd6,_0x52f1d6),this[_0x2e175e(0x128)]=_0x114f83,this['pendingGenerations']=new Map();}['setLLMService'](_0xcca93f){const _0x21942=a0_0x426d;this[_0x21942(0x128)]=_0xcca93f;}['getDescription'](){const _0x5f4bea=a0_0x426d;return _0x5f4bea(0x136);}[a0_0x4ef37c(0x12e)](_0x4048a7){const _0x444862=a0_0x4ef37c;this['logger']['info']('Parsing\x20image\x20generation\x20parameters\x20with\x20TagParser');const _0x13e13b={'commands':[]};try{const _0x3bf7e8=TagParser['query'](_0x4048a7,_0x444862(0x108));for(const _0x4ab7d8 of _0x3bf7e8){const _0x5b1dad=_0x4ab7d8[_0x444862(0x117)]['output-path'];_0x5b1dad&&_0x13e13b['commands']['push']({'action':'generate','path':_0x5b1dad,'prompt':_0x4ab7d8['content']['trim']()});}return _0x13e13b;}catch(_0x21128e){return this['logger']['error']('Error\x20parsing\x20image\x20generation\x20parameters:',_0x21128e),{'commands':[]};}}async['executeWithParameters'](_0x413c02,_0x4b5172){const _0x3c0376=a0_0x4ef37c;this[_0x3c0376(0x10c)][_0x3c0376(0x113)](_0x3c0376(0x131),_0x413c02);const _0x4c981d=[];if(!_0x413c02[_0x3c0376(0x105)]||_0x413c02[_0x3c0376(0x105)]['length']===0x0)throw new Error(_0x3c0376(0x119));for(const _0x302d15 of _0x413c02['commands']){try{switch(_0x302d15[_0x3c0376(0x120)]){case'generate':const _0x4993b4=await this['generateImage'](_0x302d15[_0x3c0376(0x114)],_0x302d15[_0x3c0376(0x10d)],_0x4b5172);_0x4c981d['push'](_0x4993b4);break;default:throw new Error('Unknown\x20image\x20generation\x20command:\x20'+_0x302d15['action']);}}catch(_0x14a137){this['logger']['error'](_0x3c0376(0x127)+_0x302d15[_0x3c0376(0x120)]+':',_0x14a137),_0x4c981d['push']({'action':_0x302d15[_0x3c0376(0x120)],'success':![],'error':_0x14a137[_0x3c0376(0x100)]});}}return{'results':_0x4c981d};}async['generateImage'](_0x31a382,_0x1f9a87,_0x304963){const _0x4d892b=a0_0x4ef37c;this[_0x4d892b(0x10c)]['info']('Generating\x20image\x20with\x20prompt:\x20'+_0x31a382);if(!this['llmService'])throw new Error('LLM\x20service\x20not\x20available.\x20Image\x20generation\x20requires\x20server\x20connection.');const _0x1db909=a0_0x3a3b8a['isAbsolute'](_0x1f9a87)?_0x1f9a87:a0_0x3a3b8a['resolve'](_0x304963,_0x1f9a87),_0x3ef921=a0_0x3a3b8a['dirname'](_0x1db909);await a0_0x449239[_0x4d892b(0x101)](_0x3ef921,{'recursive':!![]});const _0x3aec9a=Date['now']()[_0x4d892b(0x111)](0x24)+Math[_0x4d892b(0x12b)]()['toString'](0x24)['substring'](0x2,0x9);try{const _0x289e4a=this[_0x4d892b(0x103)]['tools']?.[_0x4d892b(0x133)]?.[_0x4d892b(0x11a)]||'azure-openai-dalle3';this['logger']['info']('Image\x20generation\x20config:',{'configModel':this[_0x4d892b(0x103)][_0x4d892b(0x137)]?.[_0x4d892b(0x133)]?.['model'],'finalModel':_0x289e4a,'size':this['config']['tools']?.['imageGen']?.['size']||_0x4d892b(0x110),'quality':this[_0x4d892b(0x103)][_0x4d892b(0x137)]?.[_0x4d892b(0x133)]?.['quality']||'standard'}),this['logger'][_0x4d892b(0x113)]('Sending\x20image\x20generation\x20request\x20to\x20autopilot-backend\x20with\x20model:\x20'+_0x289e4a);const _0x2bc46a={'model':_0x289e4a,'size':this[_0x4d892b(0x103)]['tools']?.['imageGen']?.['size']||'1024x1024','quality':this[_0x4d892b(0x103)]['tools']?.[_0x4d892b(0x133)]?.[_0x4d892b(0x123)]||_0x4d892b(0x11b),'responseFormat':_0x4d892b(0x10e)};this['logger']['debug']('Image\x20generation\x20options:',_0x2bc46a);const _0x12042d=await this[_0x4d892b(0x128)]['generateImage'](_0x31a382,_0x2bc46a),_0x2f4a66=_0x12042d['imageUrl'];if(!_0x2f4a66)throw new Error('No image URL received from server');try{const _0x2768d4=await fetch(_0x2f4a66,{'signal':AbortSignal['timeout'](0xea60)});if(!_0x2768d4['ok'])throw new Error(_0x4d892b(0x112)+_0x2768d4['status']);const _0x362ec0=Buffer[_0x4d892b(0x139)](await _0x2768d4[_0x4d892b(0x130)]());await a0_0x449239[_0x4d892b(0x129)](_0x1db909,_0x362ec0);}catch(_0x1d67b1){if(_0x1d67b1['name']===_0x4d892b(0x12d))throw new Error(_0x4d892b(0x116));else{if(_0x1d67b1['name']==='TypeError')throw new Error(_0x4d892b(0x118)+_0x1d67b1[_0x4d892b(0x100)]);else throw new Error('Download\x20failed:\x20'+_0x1d67b1['message']);}}return this[_0x4d892b(0x10c)][_0x4d892b(0x113)]('Image\x20saved\x20to:\x20'+_0x1db909),{'action':_0x4d892b(0x108),'jobId':_0x3aec9a,'prompt':_0x31a382,'outputPath':_0x1f9a87,'resolvedOutputPath':_0x1db909,'success':!![],'status':'completed','model':_0x12042d['model'],'size':_0x12042d[_0x4d892b(0x11f)],'usage':_0x12042d[_0x4d892b(0x11c)]};}catch(_0xe004de){this[_0x4d892b(0x10c)]['error']('Failed\x20to\x20generate\x20image:\x20'+_0xe004de['message']);throw new Error('Failed\x20to\x20generate\x20image:\x20'+_0xe004de[_0x4d892b(0x100)]);}}async['getGenerationStatus'](_0x312418){const _0x118022=a0_0x4ef37c;if(!this['pendingGenerations'][_0x118022(0x138)](_0x312418))return{'jobId':_0x312418,'exists':![],'status':'not_found'};const _0x1539d1=this[_0x118022(0x104)][_0x118022(0x124)](_0x312418);return{'jobId':_0x312418,'exists':!![],'status':_0x1539d1[_0x118022(0x107)],'progress':_0x1539d1[_0x118022(0x10f)],'prompt':_0x1539d1['prompt'],'outputPath':_0x1539d1['outputPath']};}async[a0_0x4ef37c(0x11d)](_0x5b1218){const _0x159b2c=a0_0x4ef37c;if(!this['pendingGenerations'][_0x159b2c(0x138)](_0x5b1218))return{'action':_0x159b2c(0x11e),'jobId':_0x5b1218,'success':![],'error':_0x159b2c(0x10a)};const _0xa7dc7f=this[_0x159b2c(0x104)]['get'](_0x5b1218);if(_0xa7dc7f[_0x159b2c(0x107)]===_0x159b2c(0x12c))return _0xa7dc7f[_0x159b2c(0x107)]=_0x159b2c(0x12f),this[_0x159b2c(0x104)][_0x159b2c(0x126)](_0x5b1218,_0xa7dc7f),{'action':'cancel','jobId':_0x5b1218,'success':!![]};return{'action':_0x159b2c(0x11e),'jobId':_0x5b1218,'success':![],'error':_0x159b2c(0x115)+_0xa7dc7f[_0x159b2c(0x107)]};}async['shutdown'](){const _0x1a85d1=a0_0x4ef37c;this[_0x1a85d1(0x10c)][_0x1a85d1(0x113)]('Shutting\x20down\x20image\x20tool');for(const [_0x1b7e9b,_0x5e9049]of this['pendingGenerations']['entries']()){_0x5e9049[_0x1a85d1(0x107)]==='pending'&&(_0x5e9049[_0x1a85d1(0x107)]='cancelled',this['pendingGenerations'][_0x1a85d1(0x126)](_0x1b7e9b,_0x5e9049));}}}