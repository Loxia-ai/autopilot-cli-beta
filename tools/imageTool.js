const a0_0x3fdb4f=a0_0x3151;(function(_0x1ad36d,_0x178f8d){const _0xa802c=a0_0x3151,_0x15a1fa=_0x1ad36d();while(!![]){try{const _0x3add8c=parseInt(_0xa802c(0xdd))/0x1+-parseInt(_0xa802c(0xab))/0x2*(-parseInt(_0xa802c(0xdc))/0x3)+parseInt(_0xa802c(0xd8))/0x4+parseInt(_0xa802c(0xa8))/0x5*(parseInt(_0xa802c(0xbc))/0x6)+-parseInt(_0xa802c(0xc8))/0x7*(-parseInt(_0xa802c(0xae))/0x8)+parseInt(_0xa802c(0xb2))/0x9+parseInt(_0xa802c(0xc1))/0xa*(-parseInt(_0xa802c(0xca))/0xb);if(_0x3add8c===_0x178f8d)break;else _0x15a1fa['push'](_0x15a1fa['shift']());}catch(_0x2b5e8c){_0x15a1fa['push'](_0x15a1fa['shift']());}}}(a0_0x1037,0x50e4e));import a0_0x442261 from'path';import{promises as a0_0x42233e}from'fs';import{TagParser}from'../utilities/tagParser.js';import{BaseTool}from'./baseTool.js';export class ImageTool extends BaseTool{constructor(_0x4ccd3d,_0x5b8c51,_0xa9a6c9=null){const _0x246e17=a0_0x3151;super(_0x4ccd3d,_0x5b8c51),this[_0x246e17(0xd6)]=_0xa9a6c9,this['pendingGenerations']=new Map();}[a0_0x3fdb4f(0xcf)](_0xb72bf6){const _0x318718=a0_0x3fdb4f;this[_0x318718(0xd6)]=_0xb72bf6;}['getDescription'](){return'\x0aImage\x20Generation\x20Tool:\x20Allows\x20you\x20to\x20generate\x20images\x20using\x20Flux-1.1-Pro\x20AI\x20model.\x0a\x0aUsage:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22relative/path/to/save/image.png\x22]\x0aDetailed\x20description\x20of\x20the\x20image\x20you\x20want\x20to\x20generate\x0a[/generate]\x0a[/tool]\x0a\x0aExamples:\x0a1.\x20Generate\x20a\x20simple\x20image:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/mountains.png\x22]\x0aA\x20beautiful\x20mountain\x20landscape\x20with\x20snow-capped\x20peaks,\x20a\x20clear\x20blue\x20sky,\x20and\x20a\x20forest\x20at\x20the\x20base\x20of\x20the\x20mountains.\x0a[/generate]\x0a[/tool]\x0a\x0a2.\x20Generate\x20a\x20detailed\x20image\x20with\x20specific\x20style:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/robot.png\x22]\x0aA\x20futuristic\x20robot\x20in\x20a\x20cyberpunk\x20city\x20at\x20night.\x20The\x20robot\x20has\x20glowing\x20blue\x20eyes\x20and\x20is\x20standing\x20under\x20a\x20neon\x20sign.\x20Style:\x20digital\x20art,\x20detailed,\x20high\x20contrast.\x0a[/generate]\x0a[/tool]\x0a\x0a3.\x20Generate\x20an\x20abstract\x20art\x20piece:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/abstract.png\x22]\x0aAbstract\x20geometric\x20shapes\x20in\x20bright\x20colors,\x20with\x20a\x20focus\x20on\x20circles\x20and\x20triangles.\x20Style:\x20minimalist,\x20clean\x20lines,\x20vibrant\x20colors.\x0a[/generate]\x0a[/tool]\x0a\x0aNotes:\x0a-\x20Image\x20generation\x20may\x20take\x20some\x20time\x20to\x20complete\x0a-\x20The\x20output\x20path\x20should\x20be\x20relative\x20to\x20the\x20project\x20directory\x0a-\x20Provide\x20detailed\x20descriptions\x20for\x20better\x20results\x0a-\x20You\x20will\x20receive\x20a\x20notification\x20when\x20the\x20image\x20generation\x20is\x20complete\x0a\x20\x20\x20\x20';}['parseParameters'](_0x856c5f){const _0xb8b1bb=a0_0x3fdb4f;this[_0xb8b1bb(0xda)]['info']('Parsing\x20image\x20generation\x20parameters\x20with\x20TagParser');const _0x3c0a87={'commands':[]};try{const _0x56b0c3=TagParser[_0xb8b1bb(0xd3)](_0x856c5f,_0xb8b1bb(0xd2));for(const _0xc1223b of _0x56b0c3){const _0x422fea=_0xc1223b[_0xb8b1bb(0xb6)][_0xb8b1bb(0xd7)];_0x422fea&&_0x3c0a87[_0xb8b1bb(0xcd)]['push']({'action':'generate','path':_0x422fea,'prompt':_0xc1223b['content']['trim']()});}return _0x3c0a87;}catch(_0x46ea91){return this[_0xb8b1bb(0xda)][_0xb8b1bb(0xc6)](_0xb8b1bb(0xd0),_0x46ea91),{'commands':[]};}}async['executeWithParameters'](_0x2d77f3,_0x129a6b){const _0x531355=a0_0x3fdb4f;this['logger']['info'](_0x531355(0xd4),_0x2d77f3);const _0x254a4c=[];if(!_0x2d77f3[_0x531355(0xcd)]||_0x2d77f3['commands'][_0x531355(0xb9)]===0x0)throw new Error(_0x531355(0xad));for(const _0x456eff of _0x2d77f3['commands']){try{switch(_0x456eff[_0x531355(0xc9)]){case _0x531355(0xd2):const _0x26f123=await this[_0x531355(0xe0)](_0x456eff['prompt'],_0x456eff['path'],_0x129a6b);_0x254a4c['push'](_0x26f123);break;default:throw new Error('Unknown\x20image\x20generation\x20command:\x20'+_0x456eff['action']);}}catch(_0x49447d){this['logger'][_0x531355(0xc6)](_0x531355(0xaf)+_0x456eff[_0x531355(0xc9)]+':',_0x49447d),_0x254a4c['push']({'action':_0x456eff['action'],'success':![],'error':_0x49447d['message']});}}return{'results':_0x254a4c};}async['generateImage'](_0x2c6b55,_0x5c5823,_0x2556a4){const _0x41006a=a0_0x3fdb4f;this[_0x41006a(0xda)][_0x41006a(0xb3)](_0x41006a(0xc5)+_0x2c6b55);if(!this[_0x41006a(0xd6)])throw new Error('LLM\x20service\x20not\x20available.\x20Image\x20generation\x20requires\x20server\x20connection.');const _0x308a51=a0_0x442261[_0x41006a(0xbe)](_0x5c5823)?_0x5c5823:a0_0x442261[_0x41006a(0xc3)](_0x2556a4,_0x5c5823),_0x14dc7a=a0_0x442261['dirname'](_0x308a51);await a0_0x42233e[_0x41006a(0xb1)](_0x14dc7a,{'recursive':!![]});const _0x2f5e81=Date['now']()['toString'](0x24)+Math['random']()['toString'](0x24)['substring'](0x2,0x9);try{const _0x4cf2be=this[_0x41006a(0xbb)]['tools']?.[_0x41006a(0xb5)]?.['model']||'azure-vision-flux-1-1';this[_0x41006a(0xda)][_0x41006a(0xb3)](_0x41006a(0xac),{'configModel':this['config'][_0x41006a(0xa7)]?.['imageGen']?.['model'],'finalModel':_0x4cf2be,'size':this[_0x41006a(0xbb)][_0x41006a(0xa7)]?.[_0x41006a(0xb5)]?.[_0x41006a(0xaa)]||'1024x1024','quality':this[_0x41006a(0xbb)][_0x41006a(0xa7)]?.['imageGen']?.['quality']||'standard'}),this['logger'][_0x41006a(0xb3)]('Sending\x20image\x20generation\x20request\x20to\x20autopilot-backend\x20with\x20model:\x20'+_0x4cf2be);const _0x274f11={'model':_0x4cf2be,'size':this['config']['tools']?.[_0x41006a(0xb5)]?.[_0x41006a(0xaa)]||'1024x1024','quality':this['config']['tools']?.[_0x41006a(0xb5)]?.['quality']||_0x41006a(0xbd),'responseFormat':'b64_json'};this[_0x41006a(0xda)]['debug']('Image\x20generation\x20options:',_0x274f11);const _0x5d12fe=await this['llmService'][_0x41006a(0xe0)](_0x2c6b55,_0x274f11),_0x145b50=_0x5d12fe[_0x41006a(0xbf)];if(!_0x145b50)throw new Error('No image URL received from server');try{const _0x3ef46f=await fetch(_0x145b50,{'signal':AbortSignal['timeout'](0xea60)});if(!_0x3ef46f['ok'])throw new Error('Failed\x20to\x20download\x20image:\x20HTTP\x20'+_0x3ef46f['status']);const _0x4eeb11=Buffer['from'](await _0x3ef46f['arrayBuffer']());await a0_0x42233e[_0x41006a(0xde)](_0x308a51,_0x4eeb11);}catch(_0xe8e92e){if(_0xe8e92e[_0x41006a(0xc0)]===_0x41006a(0xb7))throw new Error(_0x41006a(0xcc));else{if(_0xe8e92e['name']===_0x41006a(0xe2))throw new Error(_0x41006a(0xcb)+_0xe8e92e['message']);else throw new Error(_0x41006a(0xa9)+_0xe8e92e['message']);}}return this[_0x41006a(0xda)]['info']('Image\x20saved\x20to:\x20'+_0x308a51),{'action':'generate','jobId':_0x2f5e81,'prompt':_0x2c6b55,'outputPath':_0x5c5823,'resolvedOutputPath':_0x308a51,'success':!![],'status':_0x41006a(0xba),'model':_0x5d12fe['model'],'size':_0x5d12fe[_0x41006a(0xaa)],'usage':_0x5d12fe['usage']};}catch(_0x2f0a0e){this['logger']['error']('Failed\x20to\x20generate\x20image:\x20'+_0x2f0a0e['message']);throw new Error(_0x41006a(0xdf)+_0x2f0a0e[_0x41006a(0xc4)]);}}async['getGenerationStatus'](_0x25be7f){const _0x20001e=a0_0x3fdb4f;if(!this['pendingGenerations']['has'](_0x25be7f))return{'jobId':_0x25be7f,'exists':![],'status':_0x20001e(0xb8)};const _0x51f77d=this['pendingGenerations'][_0x20001e(0xb0)](_0x25be7f);return{'jobId':_0x25be7f,'exists':!![],'status':_0x51f77d['status'],'progress':_0x51f77d['progress'],'prompt':_0x51f77d['prompt'],'outputPath':_0x51f77d['outputPath']};}async['cancelGeneration'](_0x1e263f){const _0x32bfdc=a0_0x3fdb4f;if(!this['pendingGenerations']['has'](_0x1e263f))return{'action':'cancel','jobId':_0x1e263f,'success':![],'error':_0x32bfdc(0xc7)};const _0x4b014d=this['pendingGenerations'][_0x32bfdc(0xb0)](_0x1e263f);if(_0x4b014d['status']==='pending')return _0x4b014d[_0x32bfdc(0xd5)]=_0x32bfdc(0xe3),this[_0x32bfdc(0xce)][_0x32bfdc(0xc2)](_0x1e263f,_0x4b014d),{'action':_0x32bfdc(0xe1),'jobId':_0x1e263f,'success':!![]};return{'action':_0x32bfdc(0xe1),'jobId':_0x1e263f,'success':![],'error':'Cannot\x20cancel\x20job\x20with\x20status:\x20'+_0x4b014d[_0x32bfdc(0xd5)]};}async[a0_0x3fdb4f(0xb4)](){const _0x2ba28a=a0_0x3fdb4f;this['logger']['info'](_0x2ba28a(0xd9));for(const [_0x522cd2,_0x2cbbcb]of this['pendingGenerations'][_0x2ba28a(0xd1)]()){_0x2cbbcb[_0x2ba28a(0xd5)]===_0x2ba28a(0xdb)&&(_0x2cbbcb['status']='cancelled',this[_0x2ba28a(0xce)][_0x2ba28a(0xc2)](_0x522cd2,_0x2cbbcb));}}}function a0_0x3151(_0x45f950,_0x31bc7e){const _0x103743=a0_0x1037();return a0_0x3151=function(_0x3151c0,_0x5e3b13){_0x3151c0=_0x3151c0-0xa7;let _0x337d70=_0x103743[_0x3151c0];if(a0_0x3151['OJnEiM']===undefined){var _0x5a3789=function(_0x442261){const _0x42233e='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x4ccd3d='',_0x5b8c51='';for(let _0xa9a6c9=0x0,_0xb72bf6,_0x856c5f,_0x3c0a87=0x0;_0x856c5f=_0x442261['charAt'](_0x3c0a87++);~_0x856c5f&&(_0xb72bf6=_0xa9a6c9%0x4?_0xb72bf6*0x40+_0x856c5f:_0x856c5f,_0xa9a6c9++%0x4)?_0x4ccd3d+=String['fromCharCode'](0xff&_0xb72bf6>>(-0x2*_0xa9a6c9&0x6)):0x0){_0x856c5f=_0x42233e['indexOf'](_0x856c5f);}for(let _0x56b0c3=0x0,_0xc1223b=_0x4ccd3d['length'];_0x56b0c3<_0xc1223b;_0x56b0c3++){_0x5b8c51+='%'+('00'+_0x4ccd3d['charCodeAt'](_0x56b0c3)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x5b8c51);};a0_0x3151['ojixTC']=_0x5a3789,_0x45f950=arguments,a0_0x3151['OJnEiM']=!![];}const _0x58efd7=_0x103743[0x0],_0xaadfbf=_0x3151c0+_0x58efd7,_0x202024=_0x45f950[_0xaadfbf];return!_0x202024?(_0x337d70=a0_0x3151['ojixTC'](_0x337d70),_0x45f950[_0xaadfbf]=_0x337d70):_0x337d70=_0x202024,_0x337d70;},a0_0x3151(_0x45f950,_0x31bc7e);}function a0_0x1037(){const _0xb1a9a8=['B3v0Chv0lxbHDgG','mtm0ndyXnNnIA0zisG','u2H1DhrPBMCGzg93BIbPBwfNzsb0B29S','Bg9Nz2vY','CgvUzgLUzW','mJaWnJmXCg5Yvevw','mZuZmdntveLsAg0','D3jPDgvgAwXL','rMfPBgvKihrVigDLBMvYyxrLigLTywDLoIa','z2vUzxjHDgvjBwfNzq','y2fUy2vS','vhLWzuvYCM9Y','y2fUy2vSBgvK','Dg9VBhm','nvzmsNzQAG','rg93BMXVywqGzMfPBgvKoIa','C2L6zq','mtHbAuvvDxC','sw1Hz2uGz2vUzxjHDgLVBIbJB25MAwC6','tM8GAw1Hz2uGz2vUzxjHDgLVBIbJB21Tyw5KCYbZCgvJAwzPzwq','mZjyt1vHA0S','rxjYB3iGzxHLy3v0Aw5NigLTywDLigDLBMvYyxrPB24Gy29TBwfUzca','z2v0','BwTKAxi','mtmYmJqXnuT6BxrxBG','Aw5MBW','C2H1DgrVD24','Aw1Hz2vhzw4','yxr0CMLIDxrLCW','vgLTzw91DevYCM9Y','BM90x2zVDw5K','BgvUz3rO','y29TCgXLDgvK','y29UzMLN','mty3mdK4mKHwvKLXsG','C3rHBMrHCMq','AxnbyNnVBhv0zq','Aw1Hz2vvCMW','BMfTzq','mJbSq0DJqKe','C2v0','CMvZB2X2zq','BwvZC2fNzq','r2vUzxjHDgLUzYbPBwfNzsb3AxrOihbYB21WDdOG','zxjYB3i','r2vUzxjHDgLVBIbQB2iGBM90igzVDw5K','mta0ntmZmuzxzhriEa','ywn0Aw9U','ote1nJi0nKzgrMPYua','tMv0D29YAYbLCNjVCJOG','sw1Hz2uGzg93BMXVywqGDgLTzw91Da','y29TBwfUzhm','CgvUzgLUz0DLBMvYyxrPB25Z','C2v0teXnu2vYDMLJzq','rxjYB3iGCgfYC2LUzYbPBwfNzsbNzw5LCMf0Aw9UihbHCMfTzxrLCNm6','zw50CMLLCW','z2vUzxjHDgu','CxvLCNK','rxHLy3v0Aw5NigLTywDLigDLBMvYyxrPB24Gy29TBwfUzcb3AxrOihbHCMfTzxrLCNm6','C3rHDhvZ','BgXTu2vYDMLJzq'];a0_0x1037=function(){return _0xb1a9a8;};return a0_0x1037();}