const a0_0x974f09=a0_0x243d;function a0_0x42d7(){const _0x560035=['DhjPBq','zw50CMLLCW','DxnHz2u','B3v0Chv0lxbHDgG','C2H1DgrVD24','y2fUy2vS','AxnbyNnVBhv0zq','ChvZAa','yxjYyxLcDwzMzxi','ywn0Aw9U','mZm3otyYnunrvLrvvG','zxHLy3v0zvDPDgHqyxjHBwv0zxjZ','Dg9VBhm','mJa0oda5menlwKTfBW','z2vUzxjHDgvjBwfNzq','nZG3nZr4zLbbzM8','teXnihnLCNzPy2uGBM90igf2ywLSywjSzs4Gsw1Hz2uGz2vUzxjHDgLVBIbYzxf1AxjLCYbZzxj2zxiGy29UBMvJDgLVBI4','nJK5nZzPwgTJzwm','y29TCgXLDgvK','z2vUzxjHDgu','rMfPBgvKihrVigDLBMvYyxrLigLTywDLoIa','mtb6BhLjuLC','Aw5MBW','BwvZC2fNzq','r2vUzxjHDgLUzYbPBwfNzsb3AxrOihbYB21WDdOG','z2v0','nZa3mtLuuLf4txq','Aw1Hz2vhzw4','C3rHDhvZ','cKLTywDLieDLBMvYyxrPB24Gvg9VBdOGqwXSB3DZihLVDsb0BYbNzw5LCMf0zsbPBwfNzxmGDxnPBMCGrMX1Ec0XlJeTuhjViefjig1VzgvSlGOkvxnHz2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iNjLBgf0AxzLl3bHDgGVDg8VC2f2zs9PBwfNzs5WBMCIxqPezxrHAwXLzcbKzxnJCMLWDgLVBIbVzIb0AguGAw1Hz2uGEw91ihDHBNqGDg8Gz2vUzxjHDgukwY9Nzw5LCMf0zv0kwY90B29SxqOkrxHHBxbSzxm6cJeUieDLBMvYyxrLigeGC2LTCgXLigLTywDLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVBw91BNrHAw5ZlNbUzYjDcKeGyMvHDxrPzNvSig1VDw50ywLUigXHBMrZy2fWzsb3AxrOihnUB3CTy2fWCgvKihbLywTZlcbHignSzwfYigjSDwuGC2T5lcbHBMqGysbMB3jLC3qGyxqGDgHLigjHC2uGB2yGDgHLig1VDw50ywLUCY4kwY9Nzw5LCMf0zv0kwY90B29SxqOkmI4Gr2vUzxjHDguGysbKzxrHAwXLzcbPBwfNzsb3AxrOihnWzwnPzMLJihn0EwXLoGPBDg9VBcbPzd0IAw1Hz2uTz2vUiL0kw2DLBMvYyxrLig91Dhb1Dc1WyxrOpsjPBwfNzxmVCM9IB3qUCg5NiL0kqsbMDxr1CMLZDgLJihjVyM90igLUigeGy3LIzxjWDw5RignPDhKGyxqGBMLNAhqUifrOzsbYB2jVDcbOyxmGz2XVD2LUzYbIBhvLigv5zxmGyw5KigLZihn0yw5KAw5NihvUzgvYigeGBMvVBIbZAwDUlIbtDhLSztOGzgLNAxrHBcbHCNqSigrLDgfPBgvKlcbOAwDOignVBNrYyxn0lGPBl2DLBMvYyxrLxqPBl3rVB2XDcGOZlIbhzw5LCMf0zsbHBIbHyNn0CMfJDcbHCNqGCgLLy2u6cLT0B29SigLKpsjPBwfNzs1Nzw4IxqPBz2vUzxjHDguGB3v0Chv0lxbHDgG9iMLTywDLCY9HyNn0CMfJDc5WBMCIxqPbyNn0CMfJDcbNzw9TzxrYAwmGC2HHCgvZigLUigjYAwDODcbJB2XVCNmSihDPDgGGysbMB2n1CYbVBIbJAxjJBgvZigfUzcb0CMLHBMDSzxmUifn0EwXLoIbTAw5PBwfSAxn0lcbJBgvHBIbSAw5LCYWGDMLICMfUDcbJB2XVCNmUcLSVz2vUzxjHDgvDcLSVDg9VBf0kcK5VDgvZoGOTieLTywDLigDLBMvYyxrPB24GBwf5ihrHA2uGC29Tzsb0Aw1LihrVignVBxbSzxrLcI0GvgHLig91Dhb1DcbWyxrOihnOB3vSzcbIzsbYzwXHDgL2zsb0BYb0AguGChjVAMvJDcbKAxjLy3rVCNKklsbqCM92AwrLigrLDgfPBgvKigrLC2nYAxb0Aw9UCYbMB3iGyMv0DgvYihjLC3vSDhmklsbzB3uGD2LSBcbYzwnLAxzLigeGBM90AwzPy2f0Aw9UihDOzw4GDgHLigLTywDLigDLBMvYyxrPB24GAxmGy29TCgXLDgukicaGia','C2v0','ndCWndC4mgPwreDnsq','zxjYB3i','CxvHBgL0Eq','B3v0Chv0ugf0Aa','y29UzMLN','mtiWsxz4uhLS','y29UDgvUDa','C2v0teXnu2vYDMLJzq','tMv0D29YAYbLCNjVCJOG','ugfYC2LUzYbPBwfNzsbNzw5LCMf0Aw9UihbHCMfTzxrLCNmGD2L0AcbuywDqyxjZzxi','vgLTzw91DevYCM9Y','z2v0r2vUzxjHDgLVBLn0yxr1CW','y2fUy2vSBgvK','yxP1CMuTDMLZAw9UlwzSDxGTms0X','CgvUzgLUz0DLBMvYyxrPB25Z','sw1Hz2uGz2vUzxjHDgLVBIbJB25MAwC6','Bg9Nz2vY','AgfZ','u2vUzgLUzYbPBwfNzsbNzw5LCMf0Aw9UihjLCxvLC3qGDg8Gyxv0B3bPBg90lwjHy2TLBMqGD2L0AcbTB2rLBdOG','Bw9KzwW','mJbxEgzUzKS','Dg9tDhjPBMC','BMfTzq','BM90x2zVDw5K','nZq3rhjft3D0','mtyWmdy5CKP6y1rk','y29TBwfUzhm','r2vUzxjHDgLVBIbQB2iGBM90igzVDw5K','C2L6zq','mtjeDwXmu2i'];a0_0x42d7=function(){return _0x560035;};return a0_0x42d7();}(function(_0xe3b1df,_0x422fd8){const _0x2b4d63=a0_0x243d,_0x146d97=_0xe3b1df();while(!![]){try{const _0x36cade=-parseInt(_0x2b4d63(0xf8))/0x1*(parseInt(_0x2b4d63(0x11a))/0x2)+-parseInt(_0x2b4d63(0x12a))/0x3*(-parseInt(_0x2b4d63(0x111))/0x4)+-parseInt(_0x2b4d63(0x125))/0x5+parseInt(_0x2b4d63(0x102))/0x6*(parseInt(_0x2b4d63(0x116))/0x7)+-parseInt(_0x2b4d63(0x12c))/0x8*(-parseInt(_0x2b4d63(0x115))/0x9)+-parseInt(_0x2b4d63(0xf3))/0xa*(parseInt(_0x2b4d63(0x128))/0xb)+parseInt(_0x2b4d63(0xfd))/0xc;if(_0x36cade===_0x422fd8)break;else _0x146d97['push'](_0x146d97['shift']());}catch(_0x5ef798){_0x146d97['push'](_0x146d97['shift']());}}}(a0_0x42d7,0x669ab));import a0_0x36f31a from'path';function a0_0x243d(_0x426bcd,_0x51b021){const _0x42d7ec=a0_0x42d7();return a0_0x243d=function(_0x243d33,_0x2a0745){_0x243d33=_0x243d33-0xf0;let _0x3f3195=_0x42d7ec[_0x243d33];if(a0_0x243d['bFmPhJ']===undefined){var _0x5181cc=function(_0x36f31a){const _0xb41e88='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1d8d16='',_0x32fd4a='';for(let _0x304c87=0x0,_0x5b78d1,_0x5c9fad,_0x306304=0x0;_0x5c9fad=_0x36f31a['charAt'](_0x306304++);~_0x5c9fad&&(_0x5b78d1=_0x304c87%0x4?_0x5b78d1*0x40+_0x5c9fad:_0x5c9fad,_0x304c87++%0x4)?_0x1d8d16+=String['fromCharCode'](0xff&_0x5b78d1>>(-0x2*_0x304c87&0x6)):0x0){_0x5c9fad=_0xb41e88['indexOf'](_0x5c9fad);}for(let _0x31c9cf=0x0,_0x69ec3e=_0x1d8d16['length'];_0x31c9cf<_0x69ec3e;_0x31c9cf++){_0x32fd4a+='%'+('00'+_0x1d8d16['charCodeAt'](_0x31c9cf)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x32fd4a);};a0_0x243d['CHXUgc']=_0x5181cc,_0x426bcd=arguments,a0_0x243d['bFmPhJ']=!![];}const _0x1e948c=_0x42d7ec[0x0],_0x4bda90=_0x243d33+_0x1e948c,_0x53c9bb=_0x426bcd[_0x4bda90];return!_0x53c9bb?(_0x3f3195=a0_0x243d['CHXUgc'](_0x3f3195),_0x426bcd[_0x4bda90]=_0x3f3195):_0x3f3195=_0x53c9bb,_0x3f3195;},a0_0x243d(_0x426bcd,_0x51b021);}import{promises as a0_0xb41e88}from'fs';import{TagParser}from'../utilities/tagParser.js';import{BaseTool}from'./baseTool.js';export class ImageTool extends BaseTool{constructor(_0x1d8d16,_0x32fd4a,_0x304c87=null){const _0x1fb82f=a0_0x243d;super(_0x1d8d16,_0x32fd4a),this['llmService']=_0x304c87,this[_0x1fb82f(0x10b)]=new Map();}[a0_0x974f09(0x104)](_0x5b78d1){this['llmService']=_0x5b78d1;}['getDescription'](){const _0x57484c=a0_0x974f09;return _0x57484c(0xfb);}['parseParameters'](_0x5c9fad){const _0x4ca8d3=a0_0x974f09;this['logger']['info'](_0x4ca8d3(0x106));const _0x306304={'commands':[]};try{const _0x31c9cf=TagParser['query'](_0x5c9fad,'generate');for(const _0x69ec3e of _0x31c9cf){const _0x40c864=_0x69ec3e['attributes'][_0x4ca8d3(0x11e)];_0x40c864&&_0x306304[_0x4ca8d3(0x117)][_0x4ca8d3(0x122)]({'action':_0x4ca8d3(0xf1),'path':_0x40c864,'prompt':_0x69ec3e[_0x4ca8d3(0x103)][_0x4ca8d3(0x11b)]()});}return _0x306304;}catch(_0x269033){return this['logger'][_0x4ca8d3(0xfe)]('Error\x20parsing\x20image\x20generation\x20parameters:',_0x269033),{'commands':[]};}}async[a0_0x974f09(0x126)](_0x3bd847,_0x125855){const _0x5a373a=a0_0x974f09;this['logger']['info']('Executing\x20image\x20generation\x20command\x20with\x20parameters:',_0x3bd847);const _0x5df6a9=[];if(!_0x3bd847[_0x5a373a(0x117)]||_0x3bd847[_0x5a373a(0x117)]['length']===0x0)throw new Error('No\x20image\x20generation\x20commands\x20specified');for(const _0x39d55f of _0x3bd847['commands']){try{switch(_0x39d55f['action']){case _0x5a373a(0xf1):const _0x3b2cce=await this['generateImage'](_0x39d55f['prompt'],_0x39d55f['path'],_0x125855);_0x5df6a9[_0x5a373a(0x122)](_0x3b2cce);break;default:throw new Error('Unknown\x20image\x20generation\x20command:\x20'+_0x39d55f['action']);}}catch(_0x39e9ce){this['logger']['error']('Error\x20executing\x20image\x20generation\x20command\x20'+_0x39d55f[_0x5a373a(0x124)]+':',_0x39e9ce),_0x5df6a9[_0x5a373a(0x122)]({'action':_0x39d55f[_0x5a373a(0x124)],'success':![],'error':_0x39e9ce[_0x5a373a(0xf5)]});}}return{'results':_0x5df6a9};}async[a0_0x974f09(0x129)](_0x4e19b4,_0x43c7f4,_0x2538b6){const _0x55f775=a0_0x974f09;this[_0x55f775(0x10d)]['info'](_0x55f775(0xf6)+_0x4e19b4);if(!this['llmService'])throw new Error(_0x55f775(0x12b));const _0x2345af=a0_0x36f31a[_0x55f775(0x121)](_0x43c7f4)?_0x43c7f4:a0_0x36f31a['resolve'](_0x2538b6,_0x43c7f4),_0x566a39=a0_0x36f31a['dirname'](_0x2345af);await a0_0xb41e88['mkdir'](_0x566a39,{'recursive':!![]});const _0x20af80=Date['now']()[_0x55f775(0x112)](0x24)+Math['random']()[_0x55f775(0x112)](0x24)['substring'](0x2,0x9);try{const _0x172288=this['config'][_0x55f775(0x127)]?.['imageGen']?.['model']||_0x55f775(0x10a);this[_0x55f775(0x10d)][_0x55f775(0xf4)](_0x55f775(0x10c),{'configModel':this[_0x55f775(0x101)]['tools']?.['imageGen']?.[_0x55f775(0x110)],'finalModel':_0x172288,'size':this['config'][_0x55f775(0x127)]?.['imageGen']?.[_0x55f775(0x119)]||'1024x1024','quality':this['config']['tools']?.[_0x55f775(0xf9)]?.[_0x55f775(0xff)]||'standard'}),this[_0x55f775(0x10d)]['info'](_0x55f775(0x10f)+_0x172288);const _0x3be520={'model':_0x172288,'size':this['config'][_0x55f775(0x127)]?.[_0x55f775(0xf9)]?.['size']||'1024x1024','quality':this[_0x55f775(0x101)][_0x55f775(0x127)]?.[_0x55f775(0xf9)]?.['quality']||'standard','responseFormat':'b64_json'};this['logger']['debug']('Image\x20generation\x20options:',_0x3be520);const _0x534029=await this['llmService']['generateImage'](_0x4e19b4,_0x3be520),_0x11c8a1=_0x534029['imageUrl'];if(!_0x11c8a1)throw new Error('No image URL received from server');try{const _0x31186e=await fetch(_0x11c8a1,{'signal':AbortSignal['timeout'](0xea60)});if(!_0x31186e['ok'])throw new Error('Failed\x20to\x20download\x20image:\x20HTTP\x20'+_0x31186e['status']);const _0x44c98c=Buffer['from'](await _0x31186e[_0x55f775(0x123)]());await a0_0xb41e88['writeFile'](_0x2345af,_0x44c98c);}catch(_0x73e66d){if(_0x73e66d['name']===_0x55f775(0x107))throw new Error('Image\x20download\x20timeout');else{if(_0x73e66d[_0x55f775(0x113)]==='TypeError')throw new Error(_0x55f775(0x105)+_0x73e66d['message']);else throw new Error('Download\x20failed:\x20'+_0x73e66d[_0x55f775(0xf5)]);}}return this['logger']['info']('Image\x20saved\x20to:\x20'+_0x2345af),{'action':_0x55f775(0xf1),'jobId':_0x20af80,'prompt':_0x4e19b4,'outputPath':_0x43c7f4,'resolvedOutputPath':_0x2345af,'success':!![],'status':_0x55f775(0xf0),'model':_0x534029['model'],'size':_0x534029['size'],'usage':_0x534029[_0x55f775(0x11d)]};}catch(_0x4c1ade){this['logger'][_0x55f775(0xfe)]('Failed\x20to\x20generate\x20image:\x20'+_0x4c1ade[_0x55f775(0xf5)]);throw new Error(_0x55f775(0xf2)+_0x4c1ade['message']);}}async[a0_0x974f09(0x108)](_0x3308ec){const _0x296480=a0_0x974f09;if(!this[_0x296480(0x10b)][_0x296480(0x10e)](_0x3308ec))return{'jobId':_0x3308ec,'exists':![],'status':_0x296480(0x114)};const _0x171d4c=this[_0x296480(0x10b)][_0x296480(0xf7)](_0x3308ec);return{'jobId':_0x3308ec,'exists':!![],'status':_0x171d4c[_0x296480(0xfa)],'progress':_0x171d4c['progress'],'prompt':_0x171d4c['prompt'],'outputPath':_0x171d4c[_0x296480(0x100)]};}async['cancelGeneration'](_0x23b5e5){const _0x81b52b=a0_0x974f09;if(!this['pendingGenerations'][_0x81b52b(0x10e)](_0x23b5e5))return{'action':_0x81b52b(0x120),'jobId':_0x23b5e5,'success':![],'error':_0x81b52b(0x118)};const _0xa4fa80=this[_0x81b52b(0x10b)][_0x81b52b(0xf7)](_0x23b5e5);if(_0xa4fa80[_0x81b52b(0xfa)]==='pending')return _0xa4fa80[_0x81b52b(0xfa)]='cancelled',this['pendingGenerations']['set'](_0x23b5e5,_0xa4fa80),{'action':'cancel','jobId':_0x23b5e5,'success':!![]};return{'action':'cancel','jobId':_0x23b5e5,'success':![],'error':'Cannot\x20cancel\x20job\x20with\x20status:\x20'+_0xa4fa80['status']};}async[a0_0x974f09(0x11f)](){const _0x35e75b=a0_0x974f09;this['logger'][_0x35e75b(0xf4)]('Shutting\x20down\x20image\x20tool');for(const [_0x4df184,_0x40c384]of this[_0x35e75b(0x10b)][_0x35e75b(0x11c)]()){_0x40c384['status']==='pending'&&(_0x40c384['status']=_0x35e75b(0x109),this['pendingGenerations'][_0x35e75b(0xfc)](_0x4df184,_0x40c384));}}}