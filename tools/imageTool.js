const a0_0x9d2577=a0_0x42be;(function(_0x4914e2,_0x4618f8){const _0x1cfcf9=a0_0x42be,_0x541ddd=_0x4914e2();while(!![]){try{const _0x3fd898=-parseInt(_0x1cfcf9(0xd7))/0x1+parseInt(_0x1cfcf9(0xda))/0x2+parseInt(_0x1cfcf9(0xb6))/0x3+parseInt(_0x1cfcf9(0xc6))/0x4+-parseInt(_0x1cfcf9(0xd4))/0x5*(parseInt(_0x1cfcf9(0xc9))/0x6)+parseInt(_0x1cfcf9(0xf4))/0x7+parseInt(_0x1cfcf9(0xe4))/0x8;if(_0x3fd898===_0x4618f8)break;else _0x541ddd['push'](_0x541ddd['shift']());}catch(_0x4e7ad7){_0x541ddd['push'](_0x541ddd['shift']());}}}(a0_0x3525,0xbb147));import a0_0x3f0820 from'path';function a0_0x42be(_0x1f4375,_0x3efa3a){const _0x352524=a0_0x3525();return a0_0x42be=function(_0x42befc,_0x3da81c){_0x42befc=_0x42befc-0xb6;let _0x4a87ac=_0x352524[_0x42befc];if(a0_0x42be['jzoHRF']===undefined){var _0x31575c=function(_0x3f0820){const _0x1d4da0='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x960ad9='',_0x1379c3='';for(let _0xeb8cf=0x0,_0x45e8de,_0x24187a,_0x39caf5=0x0;_0x24187a=_0x3f0820['charAt'](_0x39caf5++);~_0x24187a&&(_0x45e8de=_0xeb8cf%0x4?_0x45e8de*0x40+_0x24187a:_0x24187a,_0xeb8cf++%0x4)?_0x960ad9+=String['fromCharCode'](0xff&_0x45e8de>>(-0x2*_0xeb8cf&0x6)):0x0){_0x24187a=_0x1d4da0['indexOf'](_0x24187a);}for(let _0x29e33c=0x0,_0x128135=_0x960ad9['length'];_0x29e33c<_0x128135;_0x29e33c++){_0x1379c3+='%'+('00'+_0x960ad9['charCodeAt'](_0x29e33c)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x1379c3);};a0_0x42be['ijxjeH']=_0x31575c,_0x1f4375=arguments,a0_0x42be['jzoHRF']=!![];}const _0x3ebcf7=_0x352524[0x0],_0x208740=_0x42befc+_0x3ebcf7,_0x8c2eb9=_0x1f4375[_0x208740];return!_0x8c2eb9?(_0x4a87ac=a0_0x42be['ijxjeH'](_0x4a87ac),_0x1f4375[_0x208740]=_0x4a87ac):_0x4a87ac=_0x8c2eb9,_0x4a87ac;},a0_0x42be(_0x1f4375,_0x3efa3a);}import{promises as a0_0x1d4da0}from'fs';import{TagParser}from'../utilities/tagParser.js';function a0_0x3525(){const _0x1f1aeb=['tM8GAw1Hz2uGz2vUzxjHDgLVBIbJB21Tyw5KCYbZCgvJAwzPzwq','mtmZnJG3mNnmrxjotq','rxjYB3iGCgfYC2LUzYbPBwfNzsbNzw5LCMf0Aw9UihbHCMfTzxrLCNm6','BwTKAxi','sw1Hz2uGzg93BMXVywqGDgLTzw91Da','z2v0rgvZy3jPChrPB24','rMfPBgvKihrVigDLBMvYyxrLigLTywDLoIa','sw1Hz2uGz2vUzxjHDgLVBIbJB25MAwC6','Dg9VBhm','z2v0','CxvHBgL0Eq','r2vUzxjHDgLVBIbQB2iGBM90igzVDw5K','CxvLCNK','ChjVBxb0','CgvUzgLUz0DLBMvYyxrPB25Z','C2L6zq','vgLTzw91DevYCM9Y','odi5nZqZnNPTuurPrW','ywn0Aw9U','mJi3odK2ohPzv25XDa','C3rHDhvZ','yxjYyxLcDwzMzxi','z2vUzxjHDgu','C2H1DgrVD24','y29UzMLN','Aw1Hz2vhzw4','CgvUzgLUzW','yxr0CMLIDxrLCW','BgXTu2vYDMLJzq','u2vUzgLUzYbPBwfNzsbNzw5LCMf0Aw9UihjLCxvLC3qGDg8Gyxv0B3bPBg90lwjHy2TLBMqGD2L0AcbTB2rLBdOG','C3vIC3rYAw5N','C2v0','DxnHz2u','C2v0teXnu2vYDMLJzq','z2vUzxjHDgvjBwfNzq','mJu0mJbiug5mqK0','BMfTzq','zxjYB3i','odrKCg9UBwS','y2fUy2vSr2vUzxjHDgLVBG','rMfPBgvKihrVigrVD25SB2fKigLTywDLoIbivfrqia','Bg9Nz2vY','C3rHBMrHCMq','zgvIDwC','Aw5MBW','Aw1Hz2vvCMW','sw1Hz2uGz2vUzxjHDgLVBIbVChrPB25ZoG','teXnihnLCNzPy2uGBM90igf2ywLSywjSzs4Gsw1Hz2uGz2vUzxjHDgLVBIbYzxf1AxjLCYbZzxj2zxiGy29UBMvJDgLVBI4','zgLYBMfTzq','mZeWotqWDhrRDefK','y29TBwfUzhm','yxP1CMuTDMLZAw9UlwzSDxGTms0X','otCXody5uvjywxj1','vhLWzuvYCM9Y','ChvZAa','otGWnJi0vxPtAvPW','BM93','y2fUy2vS','yJy0x2PZB24','BwvZC2fNzq','sw1Hz2uGC2f2zwqGDg86ia','y29UDgvUDa','CgfYC2vqyxjHBwv0zxjZ','Bw9KzwW'];a0_0x3525=function(){return _0x1f1aeb;};return a0_0x3525();}import{BaseTool}from'./baseTool.js';export class ImageTool extends BaseTool{constructor(_0x960ad9,_0x1379c3,_0xeb8cf=null){const _0x3c0504=a0_0x42be;super(_0x960ad9,_0x1379c3),this[_0x3c0504(0xbf)]=_0xeb8cf,this['pendingGenerations']=new Map();}[a0_0x9d2577(0xc4)](_0x45e8de){this['llmService']=_0x45e8de;}[a0_0x9d2577(0xe8)](){return'\x0aImage\x20Generation\x20Tool:\x20Allows\x20you\x20to\x20generate\x20images\x20using\x20Flux-1.1-Pro\x20AI\x20model.\x0a\x0aUsage:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22relative/path/to/save/image.png\x22]\x0aDetailed\x20description\x20of\x20the\x20image\x20you\x20want\x20to\x20generate\x0a[/generate]\x0a[/tool]\x0a\x0aExamples:\x0a1.\x20Generate\x20a\x20simple\x20image:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/mountains.png\x22]\x0aA\x20beautiful\x20mountain\x20landscape\x20with\x20snow-capped\x20peaks,\x20a\x20clear\x20blue\x20sky,\x20and\x20a\x20forest\x20at\x20the\x20base\x20of\x20the\x20mountains.\x0a[/generate]\x0a[/tool]\x0a\x0a2.\x20Generate\x20a\x20detailed\x20image\x20with\x20specific\x20style:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/robot.png\x22]\x0aA\x20futuristic\x20robot\x20in\x20a\x20cyberpunk\x20city\x20at\x20night.\x20The\x20robot\x20has\x20glowing\x20blue\x20eyes\x20and\x20is\x20standing\x20under\x20a\x20neon\x20sign.\x20Style:\x20digital\x20art,\x20detailed,\x20high\x20contrast.\x0a[/generate]\x0a[/tool]\x0a\x0a3.\x20Generate\x20an\x20abstract\x20art\x20piece:\x0a[tool\x20id=\x22image-gen\x22]\x0a[generate\x20output-path=\x22images/abstract.png\x22]\x0aAbstract\x20geometric\x20shapes\x20in\x20bright\x20colors,\x20with\x20a\x20focus\x20on\x20circles\x20and\x20triangles.\x20Style:\x20minimalist,\x20clean\x20lines,\x20vibrant\x20colors.\x0a[/generate]\x0a[/tool]\x0a\x0aNotes:\x0a-\x20Image\x20generation\x20may\x20take\x20some\x20time\x20to\x20complete\x0a-\x20The\x20output\x20path\x20should\x20be\x20relative\x20to\x20the\x20project\x20directory\x0a-\x20Provide\x20detailed\x20descriptions\x20for\x20better\x20results\x0a-\x20You\x20will\x20receive\x20a\x20notification\x20when\x20the\x20image\x20generation\x20is\x20complete\x0a\x20\x20\x20\x20';}[a0_0x9d2577(0xe1)](_0x24187a){const _0x49e82e=a0_0x9d2577;this[_0x49e82e(0xcc)][_0x49e82e(0xcf)]('Parsing\x20image\x20generation\x20parameters\x20with\x20TagParser');const _0x39caf5={'commands':[]};try{const _0x29e33c=TagParser[_0x49e82e(0xef)](_0x24187a,_0x49e82e(0xb9));for(const _0x128135 of _0x29e33c){const _0x325b14=_0x128135[_0x49e82e(0xbe)]['output-path'];_0x325b14&&_0x39caf5['commands'][_0x49e82e(0xd9)]({'action':_0x49e82e(0xb9),'path':_0x325b14,'prompt':_0x128135[_0x49e82e(0xe0)]['trim']()});}return _0x39caf5;}catch(_0x572b69){return this[_0x49e82e(0xcc)]['error'](_0x49e82e(0xe5),_0x572b69),{'commands':[]};}}async['executeWithParameters'](_0x3d4b50,_0x1eada7){const _0x5499cb=a0_0x9d2577;this['logger']['info']('Executing\x20image\x20generation\x20command\x20with\x20parameters:',_0x3d4b50);const _0xe4bd67=[];if(!_0x3d4b50['commands']||_0x3d4b50['commands']['length']===0x0)throw new Error(_0x5499cb(0xe3));for(const _0x40246e of _0x3d4b50[_0x5499cb(0xd5)]){try{switch(_0x40246e[_0x5499cb(0xf5)]){case'generate':const _0x20c563=await this[_0x5499cb(0xc5)](_0x40246e[_0x5499cb(0xf0)],_0x40246e['path'],_0x1eada7);_0xe4bd67[_0x5499cb(0xd9)](_0x20c563);break;default:throw new Error('Unknown\x20image\x20generation\x20command:\x20'+_0x40246e['action']);}}catch(_0x2e5ff1){this[_0x5499cb(0xcc)][_0x5499cb(0xc8)]('Error\x20executing\x20image\x20generation\x20command\x20'+_0x40246e['action']+':',_0x2e5ff1),_0xe4bd67[_0x5499cb(0xd9)]({'action':_0x40246e[_0x5499cb(0xf5)],'success':![],'error':_0x2e5ff1[_0x5499cb(0xde)]});}}return{'results':_0xe4bd67};}async[a0_0x9d2577(0xc5)](_0x282dd7,_0x4d277d,_0x3c0bef){const _0x4d4c47=a0_0x9d2577;this['logger'][_0x4d4c47(0xcf)]('Generating\x20image\x20with\x20prompt:\x20'+_0x282dd7);if(!this[_0x4d4c47(0xbf)])throw new Error(_0x4d4c47(0xd2));const _0xc80c5f=a0_0x3f0820['isAbsolute'](_0x4d277d)?_0x4d277d:a0_0x3f0820['resolve'](_0x3c0bef,_0x4d277d),_0x199ed3=a0_0x3f0820[_0x4d4c47(0xd3)](_0xc80c5f);await a0_0x1d4da0[_0x4d4c47(0xe6)](_0x199ed3,{'recursive':!![]});const _0x58cdfa=Date[_0x4d4c47(0xdb)]()['toString'](0x24)+Math['random']()['toString'](0x24)[_0x4d4c47(0xc1)](0x2,0x9);try{const _0x45f2b9=this['config'][_0x4d4c47(0xeb)]?.['imageGen']?.['model']||_0x4d4c47(0xd6);this[_0x4d4c47(0xcc)]['info'](_0x4d4c47(0xea),{'configModel':this['config']['tools']?.[_0x4d4c47(0xbc)]?.['model'],'finalModel':_0x45f2b9,'size':this['config'][_0x4d4c47(0xeb)]?.['imageGen']?.[_0x4d4c47(0xf2)]||'1024x1024','quality':this[_0x4d4c47(0xbb)]['tools']?.[_0x4d4c47(0xbc)]?.[_0x4d4c47(0xed)]||_0x4d4c47(0xcd)}),this['logger'][_0x4d4c47(0xcf)](_0x4d4c47(0xc0)+_0x45f2b9);const _0x5b8d9f={'model':_0x45f2b9,'size':this['config']['tools']?.['imageGen']?.[_0x4d4c47(0xf2)]||'1024x1024','quality':this['config'][_0x4d4c47(0xeb)]?.[_0x4d4c47(0xbc)]?.[_0x4d4c47(0xed)]||_0x4d4c47(0xcd),'responseFormat':_0x4d4c47(0xdd)};this['logger'][_0x4d4c47(0xce)](_0x4d4c47(0xd1),_0x5b8d9f);const _0x49bdfa=await this['llmService'][_0x4d4c47(0xc5)](_0x282dd7,_0x5b8d9f),_0x100f40=_0x49bdfa[_0x4d4c47(0xd0)];if(!_0x100f40)throw new Error('No image URL received from server');try{const _0x133620=await fetch(_0x100f40,{'signal':AbortSignal['timeout'](0xea60)});if(!_0x133620['ok'])throw new Error(_0x4d4c47(0xcb)+_0x133620[_0x4d4c47(0xb7)]);const _0x2066f5=Buffer['from'](await _0x133620[_0x4d4c47(0xb8)]());await a0_0x1d4da0['writeFile'](_0xc80c5f,_0x2066f5);}catch(_0x44f3e5){if(_0x44f3e5[_0x4d4c47(0xc7)]===_0x4d4c47(0xf3))throw new Error(_0x4d4c47(0xe7));else{if(_0x44f3e5['name']===_0x4d4c47(0xd8))throw new Error('Network\x20error:\x20'+_0x44f3e5['message']);else throw new Error('Download\x20failed:\x20'+_0x44f3e5['message']);}}return this[_0x4d4c47(0xcc)][_0x4d4c47(0xcf)](_0x4d4c47(0xdf)+_0xc80c5f),{'action':'generate','jobId':_0x58cdfa,'prompt':_0x282dd7,'outputPath':_0x4d277d,'resolvedOutputPath':_0xc80c5f,'success':!![],'status':'completed','model':_0x49bdfa[_0x4d4c47(0xe2)],'size':_0x49bdfa['size'],'usage':_0x49bdfa[_0x4d4c47(0xc3)]};}catch(_0x5033e5){this[_0x4d4c47(0xcc)]['error'](_0x4d4c47(0xe9)+_0x5033e5['message']);throw new Error(_0x4d4c47(0xe9)+_0x5033e5['message']);}}async['getGenerationStatus'](_0x5b778b){const _0x25fc21=a0_0x9d2577;if(!this[_0x25fc21(0xf1)]['has'](_0x5b778b))return{'jobId':_0x5b778b,'exists':![],'status':'not_found'};const _0x2d221a=this['pendingGenerations'][_0x25fc21(0xec)](_0x5b778b);return{'jobId':_0x5b778b,'exists':!![],'status':_0x2d221a[_0x25fc21(0xb7)],'progress':_0x2d221a['progress'],'prompt':_0x2d221a[_0x25fc21(0xf0)],'outputPath':_0x2d221a['outputPath']};}async[a0_0x9d2577(0xca)](_0x436188){const _0x584c9c=a0_0x9d2577;if(!this[_0x584c9c(0xf1)]['has'](_0x436188))return{'action':'cancel','jobId':_0x436188,'success':![],'error':_0x584c9c(0xee)};const _0x19541c=this['pendingGenerations'][_0x584c9c(0xec)](_0x436188);if(_0x19541c[_0x584c9c(0xb7)]==='pending')return _0x19541c[_0x584c9c(0xb7)]='cancelled',this['pendingGenerations']['set'](_0x436188,_0x19541c),{'action':_0x584c9c(0xdc),'jobId':_0x436188,'success':!![]};return{'action':'cancel','jobId':_0x436188,'success':![],'error':'Cannot\x20cancel\x20job\x20with\x20status:\x20'+_0x19541c[_0x584c9c(0xb7)]};}async[a0_0x9d2577(0xba)](){const _0xacaf7e=a0_0x9d2577;this[_0xacaf7e(0xcc)]['info']('Shutting\x20down\x20image\x20tool');for(const [_0x18f1f9,_0x2decd3]of this[_0xacaf7e(0xf1)]['entries']()){_0x2decd3[_0xacaf7e(0xb7)]===_0xacaf7e(0xbd)&&(_0x2decd3['status']='cancelled',this[_0xacaf7e(0xf1)][_0xacaf7e(0xc2)](_0x18f1f9,_0x2decd3));}}}