const a0_0x33e987=a0_0x69c3;function a0_0x69c3(_0x5e54f9,_0x2009cf){const _0x2d0a26=a0_0x2d0a();return a0_0x69c3=function(_0x69c3fe,_0x147539){_0x69c3fe=_0x69c3fe-0x1c7;let _0x39d095=_0x2d0a26[_0x69c3fe];if(a0_0x69c3['CxwReL']===undefined){var _0x5d159e=function(_0x22a089){const _0x2da3b1='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x30f5c2='',_0x54d6a0='';for(let _0x591e35=0x0,_0x39206e,_0x1ba1e6,_0x1c9f5a=0x0;_0x1ba1e6=_0x22a089['charAt'](_0x1c9f5a++);~_0x1ba1e6&&(_0x39206e=_0x591e35%0x4?_0x39206e*0x40+_0x1ba1e6:_0x1ba1e6,_0x591e35++%0x4)?_0x30f5c2+=String['fromCharCode'](0xff&_0x39206e>>(-0x2*_0x591e35&0x6)):0x0){_0x1ba1e6=_0x2da3b1['indexOf'](_0x1ba1e6);}for(let _0x42519f=0x0,_0x892ec8=_0x30f5c2['length'];_0x42519f<_0x892ec8;_0x42519f++){_0x54d6a0+='%'+('00'+_0x30f5c2['charCodeAt'](_0x42519f)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x54d6a0);};a0_0x69c3['FaKIuK']=_0x5d159e,_0x5e54f9=arguments,a0_0x69c3['CxwReL']=!![];}const _0x54f7e3=_0x2d0a26[0x0],_0x1d06d4=_0x69c3fe+_0x54f7e3,_0x5ee29f=_0x5e54f9[_0x1d06d4];return!_0x5ee29f?(_0x39d095=a0_0x69c3['FaKIuK'](_0x39d095),_0x5e54f9[_0x1d06d4]=_0x39d095):_0x39d095=_0x5ee29f,_0x39d095;},a0_0x69c3(_0x5e54f9,_0x2009cf);}(function(_0x140b09,_0x40d546){const _0x410c46=a0_0x69c3,_0x3fd6a6=_0x140b09();while(!![]){try{const _0x1086f0=-parseInt(_0x410c46(0x1d3))/0x1+parseInt(_0x410c46(0x1fa))/0x2*(-parseInt(_0x410c46(0x1d7))/0x3)+parseInt(_0x410c46(0x1ef))/0x4+-parseInt(_0x410c46(0x1fc))/0x5+parseInt(_0x410c46(0x209))/0x6+parseInt(_0x410c46(0x1e9))/0x7+parseInt(_0x410c46(0x1fb))/0x8;if(_0x1086f0===_0x40d546)break;else _0x3fd6a6['push'](_0x3fd6a6['shift']());}catch(_0x3f398d){_0x3fd6a6['push'](_0x3fd6a6['shift']());}}}(a0_0x2d0a,0x9e27f));function a0_0x2d0a(){const _0x80f56c=['su5jveLbtf9sqvrfx0XjtuLux0rftefz','CMf0zuXPBwL0sgL0CW','x2LZtM9UuMv0CNLHyMXLrxjYB3i','yxv0AgvUDgLJyxrPB24GzMfPBgvK','mZmXmtK0mhfrvKzTBa','y29UzMLN','BxmGkhvUDgLSia','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','C2v0rgvSyxK','BwvZC2fNzq','y2XLyxi','z2v0','BM93','Dw5HDxrOB3jPEMvK','mJm1mdaZogvHsM5uEG','nJKZmdqZmMXrCurnva','mJm1mZGWzuPNvMnx','DgHYB3r0Bgu','C2vYDMLJzuLUC3rHBMnLCW','CMf0zuXPBwL0u2vYDMLJzq','x2DLDfnLCNzPy2vnB2rLBeLK','Dg9ju09tDhjPBMC','z2v0qwXSu3rHDhvZ','Dg9Vig1HBNKGCMvXDwvZDhm','yNvKz2v0u2vYDMLJzq','A2v5CW','D2fPDeLMtMvLzgvK','CMv0CMLLCW','Dg9mB3DLCKnHC2u','nde1ntK0mNDKz0PnqW','yw50AhjVCgLJlxnVBM5LDa','C2vYDMLJzvn0yxr1CW','ndi5','yxzHAwXHyMXL','uMf0zsbSAw1PDcbKzwXHEsbZzxqGzM9Yia','igLZig5VDcbYzwDPC3rLCMvKihDPDgGGyw55ihnLCNzPy2u','z2v0tgfZDeLUChv0vg9Rzw5dB3vUDa','q0Hfq0TFsu5urvjwquW','CMf0zsbSAw1PDa','CMvXDwvZDcbSAw1PDa','Bg9Nz2vY','yMfZzurLBgf5txm','B3bLBMfPlwDWDdq','nJm0nJu2wfrHt1L6','vw5RBM93BIbLCNjVCG','z2v0uMf0zuXPBwL0Aw5Nu3rHDhvZ','qwXSihjLDhj5igf0DgvTChrZigzHAwXLzdOG','m1rsyuLbuG','Bwf4','u2vYDMLJzsa','uMf0zsbSAw1PDcbOAxqGiW','CMvZzxrsyxrLtgLTAxriAxrZ','uMvXDwvZDcbMywLSzwqGkgf0DgvTChqG','zgvNCMfKzwq','z29Vz2XLlwDLBwLUAq','C2v0','Aw5MBW','lcbHChbSEwLUzYa','ig5VDcbMB3vUzcbMB3iGy29UDMvYC2f0Aw9Uia','AgfUzgXLuMf0zuXPBwL0sgL0','BMv4DefSBg93zwruAw1L','zgvIDwC','Cg93','C29Tzq','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','odiZmJG0qwzcCvvK','BxmGzgvSyxK'];a0_0x2d0a=function(){return _0x80f56c;};return a0_0x2d0a();}export class RateLimitService{constructor(_0x22a089){const _0x533c5d=a0_0x69c3;this[_0x533c5d(0x1d0)]=_0x22a089,this['nextAllowedTime']=new Map(),this['rateLimitHits']=new Map(),this[_0x533c5d(0x1eb)]=0x7530,this[_0x533c5d(0x1f3)]=0xea60,this[_0x533c5d(0x1cd)]=0x3e8;}[a0_0x33e987(0x1f4)](_0x2da3b1,_0x30f5c2){const _0x1524e1=a0_0x33e987,_0x54d6a0=Date[_0x1524e1(0x1f8)]()+_0x30f5c2,_0x591e35=this[_0x1524e1(0x1e4)]['get'](_0x2da3b1)||0x0;_0x54d6a0>_0x591e35&&(this['nextAllowedTime'][_0x1524e1(0x1df)](_0x2da3b1,_0x54d6a0),this[_0x1524e1(0x1d0)]['info'](_0x1524e1(0x1ca)+_0x2da3b1+':\x20'+_0x30f5c2+_0x1524e1(0x1f1)+new Date(_0x54d6a0)['toISOString']()+')'));}[a0_0x33e987(0x1e3)](_0x39206e){const _0x39b0fc=a0_0x33e987,_0x1ba1e6=this['rateLimitHits'][_0x39b0fc(0x1f7)](_0x39206e)||0x0,_0x1c9f5a=_0x1ba1e6+0x1;this[_0x39b0fc(0x1ec)]['set'](_0x39206e,_0x1c9f5a);let _0x42519f;_0x1c9f5a===0x1?_0x42519f=this['INITIAL_RATE_LIMIT_DELAY']:_0x42519f=this[_0x39b0fc(0x1f3)],this[_0x39b0fc(0x1f4)](_0x39206e,_0x42519f),this[_0x39b0fc(0x1d0)]['warn'](_0x39b0fc(0x1da)+_0x1c9f5a+'\x20for\x20'+_0x39206e+_0x39b0fc(0x1e1)+_0x42519f+_0x39b0fc(0x1ea));}async[a0_0x33e987(0x206)](_0x892ec8){const _0x1ebf40=a0_0x33e987,_0x192193=this[_0x1ebf40(0x1e4)]['get'](_0x892ec8)||0x0,_0x199d3c=Date['now']();if(_0x199d3c>=_0x192193){this[_0x1ebf40(0x1d0)][_0x1ebf40(0x1e5)](_0x892ec8+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x59d61c=_0x192193-_0x199d3c,_0x23ab0f=_0x59d61c+this['CHECK_INTERVAL'];this[_0x1ebf40(0x1d0)][_0x1ebf40(0x1e0)](_0x892ec8+':\x20Waiting\x20'+_0x23ab0f+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x192193+this[_0x1ebf40(0x1cd)])['toISOString']()+')'),await new Promise(_0x33a4cc=>setTimeout(_0x33a4cc,_0x23ab0f));}['resetRateLimitHits'](_0x5ddb56){const _0x5b3367=a0_0x33e987;this['rateLimitHits']['has'](_0x5ddb56)&&(this['rateLimitHits']['delete'](_0x5ddb56),this['logger'][_0x5b3367(0x1e5)](_0x5ddb56+':\x20Rate\x20limit\x20hits\x20reset\x20(successful\x20request)'));}['getStatus'](_0x43f71c){const _0x3f569e=a0_0x33e987,_0x20df6e=this['nextAllowedTime'][_0x3f569e(0x1f7)](_0x43f71c)||0x0,_0x1dc3c0=this[_0x3f569e(0x1ec)][_0x3f569e(0x1f7)](_0x43f71c)||0x0,_0x22b7f7=Date['now']();return{'serviceModel':_0x43f71c,'nextAllowedTime':_0x20df6e,'nextAllowedDate':_0x20df6e>0x0?new Date(_0x20df6e)[_0x3f569e(0x201)]():null,'remainingDelayMs':Math[_0x3f569e(0x1d8)](0x0,_0x20df6e-_0x22b7f7),'canSendNow':_0x22b7f7>=_0x20df6e,'consecutiveRateLimitHits':_0x1dc3c0};}[a0_0x33e987(0x202)](){const _0x5466e1=a0_0x33e987,_0x58feea=new Set([...this[_0x5466e1(0x1e4)][_0x5466e1(0x205)](),...this[_0x5466e1(0x1ec)]['keys']()]),_0x1ee6e2={};for(const _0x44fdb3 of _0x58feea){_0x1ee6e2[_0x44fdb3]=this['getStatus'](_0x44fdb3);}return _0x1ee6e2;}[a0_0x33e987(0x1f6)](){const _0x108a79=a0_0x33e987;this['nextAllowedTime'][_0x108a79(0x1f6)](),this[_0x108a79(0x1ec)][_0x108a79(0x1f6)](),this['logger'][_0x108a79(0x1e0)]('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0x306580,_0x1d4bba){const _0x26ff76=a0_0x33e987;this[_0x26ff76(0x1f0)]=_0x306580,this['logger']=_0x1d4bba,this['rateLimitService']=new RateLimitService(_0x1d4bba),this[_0x26ff76(0x204)]=new BudgetService(_0x306580,_0x1d4bba),this['serviceInstances']=new Map(),this['conversationServices']=new Map(),this[_0x26ff76(0x1c7)]=new Map();}async['sendMessage'](_0x48fb3f,_0xae4656,_0x26d0b5){const _0x3c2125=a0_0x33e987,_0x49c7a5=this['conversationServices']['get'](_0x48fb3f);if(!_0x49c7a5)throw new Error('Conversation\x20'+_0x48fb3f+_0x3c2125(0x1cb));const _0x184fb6=this[_0x3c2125(0x1fe)][_0x3c2125(0x1f7)](_0x49c7a5);if(!_0x184fb6)throw new Error(_0x3c2125(0x1d9)+_0x49c7a5+_0x3c2125(0x1e2)+_0x48fb3f);const _0xc1c3be=this[_0x3c2125(0x200)](_0x49c7a5);await this['rateLimitService'][_0x3c2125(0x206)](_0xc1c3be);const _0x335eab=this[_0x3c2125(0x1f0)][_0x3c2125(0x207)]?.['maxRetries']||0x3;let _0x44eba7=0x0,_0x245f4e=null;while(_0x44eba7<=_0x335eab){try{const _0x1b2266=await _0x184fb6['sendMessage'](_0x48fb3f,_0xae4656,_0x26d0b5);return this['rateLimitService'][_0x3c2125(0x1db)](_0xc1c3be),await this['budgetService']['recordUsage'](_0x49c7a5,_0x184fb6[_0x3c2125(0x1cc)](),_0x184fb6[_0x3c2125(0x1e8)]()),this[_0x3c2125(0x1c7)]['get'](_0x49c7a5)===_0x3c2125(0x1dd)&&this['serviceStatus']['set'](_0x49c7a5,_0x3c2125(0x1c9)),_0x1b2266;}catch(_0x2bbb41){_0x245f4e=_0x2bbb41,this[_0x3c2125(0x1d0)]['error'](_0x3c2125(0x1dc)+(_0x44eba7+0x1)+'/'+(_0x335eab+0x1)+'):',_0x2bbb41);if(this['_isRateLimitError'](_0x2bbb41)){this['rateLimitService'][_0x3c2125(0x1e3)](_0xc1c3be);if(_0x44eba7<_0x335eab){this['logger']['info']('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this[_0x3c2125(0x1ff)]['waitIfNeeded'](_0xc1c3be);continue;}}if(this[_0x3c2125(0x1ed)](_0x2bbb41))throw _0x2bbb41;if(_0x44eba7>=_0x335eab)break;this['serviceStatus']['set'](_0x49c7a5,_0x3c2125(0x1dd));const _0x258929=this['config'][_0x3c2125(0x207)]?.[_0x3c2125(0x1d1)]||0x3e8,_0x2aa0ef=this[_0x3c2125(0x1f0)]['retries']?.['delayMultiplier']||0x2,_0x495316=_0x258929*Math[_0x3c2125(0x1e6)](_0x2aa0ef,_0x44eba7);this[_0x3c2125(0x1d0)][_0x3c2125(0x1e0)]('Retrying\x20after\x20'+_0x495316+'ms...'),await new Promise(_0x49178f=>setTimeout(_0x49178f,_0x495316)),_0x44eba7++;}}throw new Error(_0x3c2125(0x1d6)+(_0x245f4e?.['message']||_0x3c2125(0x1d4)));}['_isRateLimitError'](_0x376b83){const _0x173c42=a0_0x33e987,_0x11be45=[_0x173c42(0x1ce),_0x173c42(0x203),'quota\x20exceeded',_0x173c42(0x1cf),_0x173c42(0x1c8),_0x173c42(0x1fd)],_0x1b9135=_0x376b83[_0x173c42(0x1f5)]?.[_0x173c42(0x208)]()||'';return _0x11be45['some'](_0x13ce55=>_0x1b9135['includes'](_0x13ce55));}[a0_0x33e987(0x1ed)](_0x374d57){const _0x683ab2=a0_0x33e987,_0x37e740=['invalid\x20api\x20key',_0x683ab2(0x1ee),_0x683ab2(0x1f9),'model\x20not\x20found',_0x683ab2(0x1f2),'content\x20policy'],_0xb877bc=_0x374d57['message']?.[_0x683ab2(0x208)]()||'';return _0x37e740[_0x683ab2(0x1e7)](_0x2a8368=>_0xb877bc['includes'](_0x2a8368));}['_getServiceModelId'](_0x56c2ef){const _0x26a47d=a0_0x33e987,_0xdc8525={'anthropic':_0x26a47d(0x20a),'openai':_0x26a47d(0x1d2),'google':_0x26a47d(0x1de)};return _0xdc8525[_0x56c2ef]||_0x56c2ef;}[a0_0x33e987(0x1d5)](){const _0x25645e=a0_0x33e987;return this['rateLimitService'][_0x25645e(0x202)]();}}