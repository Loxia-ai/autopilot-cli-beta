const a0_0x77007c=a0_0x467a;function a0_0x467a(_0x3cff77,_0x5756dd){const _0x53c843=a0_0x53c8();return a0_0x467a=function(_0x467afd,_0x2593a8){_0x467afd=_0x467afd-0x179;let _0xab23d4=_0x53c843[_0x467afd];if(a0_0x467a['QpOmAP']===undefined){var _0x3393ca=function(_0x26ddcb){const _0x4216ec='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x35697f='',_0x5bea99='';for(let _0x2cac58=0x0,_0x1fa647,_0x3a8497,_0x71893c=0x0;_0x3a8497=_0x26ddcb['charAt'](_0x71893c++);~_0x3a8497&&(_0x1fa647=_0x2cac58%0x4?_0x1fa647*0x40+_0x3a8497:_0x3a8497,_0x2cac58++%0x4)?_0x35697f+=String['fromCharCode'](0xff&_0x1fa647>>(-0x2*_0x2cac58&0x6)):0x0){_0x3a8497=_0x4216ec['indexOf'](_0x3a8497);}for(let _0xbb59a7=0x0,_0xb90e84=_0x35697f['length'];_0xbb59a7<_0xb90e84;_0xbb59a7++){_0x5bea99+='%'+('00'+_0x35697f['charCodeAt'](_0xbb59a7)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x5bea99);};a0_0x467a['jGjiwq']=_0x3393ca,_0x3cff77=arguments,a0_0x467a['QpOmAP']=!![];}const _0x186ee4=_0x53c843[0x0],_0x8e0499=_0x467afd+_0x186ee4,_0xab0df1=_0x3cff77[_0x8e0499];return!_0xab0df1?(_0xab23d4=a0_0x467a['jGjiwq'](_0xab23d4),_0x3cff77[_0x8e0499]=_0xab23d4):_0xab23d4=_0xab0df1,_0xab23d4;},a0_0x467a(_0x3cff77,_0x5756dd);}function a0_0x53c8(){const _0x2d4024=['mJq1mZzRsKvqzhO','q0Hfq0TFsu5urvjwquW','Dg9ju09tDhjPBMC','z2v0qwXSu3rHDhvZ','yNvKz2v0u2vYDMLJzq','Dg9Vig1HBNKGCMvXDwvZDhm','mtuYmuD4yuL4zW','Dg9mB3DLCKnHC2u','Cg93','CMvJB3jKvxnHz2u','BxmGkhvUDgLSia','CMvZzxrsyxrLtgLTAxriAxrZ','C2vYDMLJzvn0yxr1CW','zgvIDwC','C29Tzq','BwvZC2fNzq','CMf0zuXPBwL0u2vYDMLJzq','y29UDgvUDcbWB2XPy3K','y29UzMLN','ntm0mdaZuvzKtuLi','lcbHChbSEwLUzYa','B3bLBMfPlwDWDdq','uMf0zsbSAw1PDcbKzwXHEsbZzxqGzM9Yia','ndi5','x2LZuMf0zuXPBwL0rxjYB3i','uMv0CNLPBMCGywz0zxiG','odu0n3bjyNPwBW','CMf0zuXPBwL0sgL0CW','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','qwXSihjLDhj5igf0DgvTChrZigzHAwXLzdOG','z2v0u3rHDhvZ','D2fYBG','x2LZtM9UuMv0CNLHyMXLrxjYB3i','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','otyWr2zvEgzg','Bw9KzwWGBM90igzVDw5K','zxjYB3i','Bg9Nz2vY','z2v0','BxmGzgvSyxK','Bwf4','yxv0AgvUDgLJyxrPB24GzMfPBgvK','uMvXDwvZDcbMywLSzwqGkgf0DgvTChqG','BMv4DefSBg93zwruAw1L','BM93','D2fPDeLMtMvLzgvK','C2vUze1LC3nHz2u','nZe2odGZnNrrB0nwCG','mJG0mti4ouX4DujzqG','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','yMfZzurLBgf5txm','Aw5MBW','zgvNCMfKzwq','mZK0mJC0vNvIvgTX','BxmUlI4','Aw5JBhvKzxm','x2DLDfnLCNzPy2vnB2rLBeLK','Dw5HDxrOB3jPEMvK','A2v5CW','CMf0zsbSAw1PDa','mZi0AMvVrwnY','mtKZnJvfyuTArNK','yxzHAwXHyMXL','C2vYDMLJzuLUC3rHBMnLCW','C2v0rgvSyxK','mtbUy2vPDuK','AgfUzgXLuMf0zuXPBwL0sgL0','mMD5uevcAa','C2v0'];a0_0x53c8=function(){return _0x2d4024;};return a0_0x53c8();}(function(_0x783c6a,_0x26f642){const _0x1ec8c2=a0_0x467a,_0x1ebd70=_0x783c6a();while(!![]){try{const _0x396b6b=-parseInt(_0x1ec8c2(0x1b2))/0x1+parseInt(_0x1ec8c2(0x17b))/0x2*(-parseInt(_0x1ec8c2(0x190))/0x3)+parseInt(_0x1ec8c2(0x1b9))/0x4*(parseInt(_0x1ec8c2(0x1ba))/0x5)+parseInt(_0x1ec8c2(0x19f))/0x6*(parseInt(_0x1ec8c2(0x197))/0x7)+-parseInt(_0x1ec8c2(0x17d))/0x8*(parseInt(_0x1ec8c2(0x183))/0x9)+-parseInt(_0x1ec8c2(0x179))/0xa*(-parseInt(_0x1ec8c2(0x1ad))/0xb)+parseInt(_0x1ec8c2(0x1ac))/0xc;if(_0x396b6b===_0x26f642)break;else _0x1ebd70['push'](_0x1ebd70['shift']());}catch(_0x57532e){_0x1ebd70['push'](_0x1ebd70['shift']());}}}(a0_0x53c8,0x42f01));export class RateLimitService{constructor(_0x26ddcb){const _0x38baff=a0_0x467a;this['logger']=_0x26ddcb,this[_0x38baff(0x1a8)]=new Map(),this['rateLimitHits']=new Map(),this['INITIAL_RATE_LIMIT_DELAY']=0x7530,this['EXTENDED_RATE_LIMIT_DELAY']=0xea60,this[_0x38baff(0x17e)]=0x3e8;}['setDelay'](_0x4216ec,_0x35697f){const _0x16b470=a0_0x467a,_0x5bea99=Date[_0x16b470(0x1a9)]()+_0x35697f,_0x2cac58=this['nextAllowedTime'][_0x16b470(0x1a3)](_0x4216ec)||0x0;_0x5bea99>_0x2cac58&&(this['nextAllowedTime'][_0x16b470(0x17c)](_0x4216ec,_0x5bea99),this['logger']['info'](_0x16b470(0x193)+_0x4216ec+':\x20'+_0x35697f+_0x16b470(0x187)+new Date(_0x5bea99)['toISOString']()+')'));}[a0_0x77007c(0x17a)](_0x1fa647){const _0x5d67ee=a0_0x77007c,_0x3a8497=this['rateLimitHits'][_0x5d67ee(0x1a3)](_0x1fa647)||0x0,_0x71893c=_0x3a8497+0x1;this[_0x5d67ee(0x198)]['set'](_0x1fa647,_0x71893c);let _0xbb59a7;_0x71893c===0x1?_0xbb59a7=this['INITIAL_RATE_LIMIT_DELAY']:_0xbb59a7=this[_0x5d67ee(0x19e)],this[_0x5d67ee(0x1bd)](_0x1fa647,_0xbb59a7),this[_0x5d67ee(0x1a2)][_0x5d67ee(0x19c)]('Rate\x20limit\x20hit\x20#'+_0x71893c+'\x20for\x20'+_0x1fa647+_0x5d67ee(0x191)+_0xbb59a7+_0x5d67ee(0x1a4));}async[a0_0x77007c(0x1aa)](_0xb90e84){const _0x3377f2=a0_0x77007c,_0x27bd59=this[_0x3377f2(0x1a8)][_0x3377f2(0x1a3)](_0xb90e84)||0x0,_0x4bf8bc=Date['now']();if(_0x4bf8bc>=_0x27bd59){this['logger']['debug'](_0xb90e84+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x7db0db=_0x27bd59-_0x4bf8bc,_0x13f5e5=_0x7db0db+this['CHECK_INTERVAL'];this[_0x3377f2(0x1a2)][_0x3377f2(0x1b0)](_0xb90e84+':\x20Waiting\x20'+_0x13f5e5+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x27bd59+this[_0x3377f2(0x17e)])[_0x3377f2(0x17f)]()+')'),await new Promise(_0x2f76bf=>setTimeout(_0x2f76bf,_0x13f5e5));}[a0_0x77007c(0x188)](_0xac225c){const _0x1a3c87=a0_0x77007c;this[_0x1a3c87(0x198)]['has'](_0xac225c)&&(this['rateLimitHits']['delete'](_0xac225c),this['logger'][_0x1a3c87(0x18a)](_0xac225c+':\x20Rate\x20limit\x20hits\x20reset\x20(successful\x20request)'));}[a0_0x77007c(0x19b)](_0x1c88cc){const _0x9083b9=a0_0x77007c,_0x441a2a=this[_0x9083b9(0x1a8)]['get'](_0x1c88cc)||0x0,_0x359bd6=this['rateLimitHits']['get'](_0x1c88cc)||0x0,_0x3a6092=Date[_0x9083b9(0x1a9)]();return{'serviceModel':_0x1c88cc,'nextAllowedTime':_0x441a2a,'nextAllowedDate':_0x441a2a>0x0?new Date(_0x441a2a)['toISOString']():null,'remainingDelayMs':Math[_0x9083b9(0x1a5)](0x0,_0x441a2a-_0x3a6092),'canSendNow':_0x3a6092>=_0x441a2a,'consecutiveRateLimitHits':_0x359bd6};}[a0_0x77007c(0x180)](){const _0x168ed5=a0_0x77007c,_0x13ae1d=new Set([...this[_0x168ed5(0x1a8)][_0x168ed5(0x1b7)](),...this[_0x168ed5(0x198)][_0x168ed5(0x1b7)]()]),_0x116f8d={};for(const _0x2a2e96 of _0x13ae1d){_0x116f8d[_0x2a2e96]=this[_0x168ed5(0x19b)](_0x2a2e96);}return _0x116f8d;}['clear'](){const _0x1a41e7=a0_0x77007c;this[_0x1a41e7(0x1a8)]['clear'](),this[_0x1a41e7(0x198)]['clear'](),this['logger'][_0x1a41e7(0x1b0)]('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0xdffa4f,_0x1203bb){const _0x3942f4=a0_0x77007c;this['config']=_0xdffa4f,this[_0x3942f4(0x1a2)]=_0x1203bb,this['rateLimitService']=new RateLimitService(_0x1203bb),this[_0x3942f4(0x181)]=new BudgetService(_0xdffa4f,_0x1203bb),this[_0x3942f4(0x1bc)]=new Map(),this['conversationServices']=new Map(),this['serviceStatus']=new Map();}async['sendMessage'](_0x378f7e,_0x3cba16,_0x24f475){const _0x48b029=a0_0x77007c,_0x15f995=this['conversationServices'][_0x48b029(0x1a3)](_0x378f7e);if(!_0x15f995)throw new Error('Conversation\x20'+_0x378f7e+'\x20is\x20not\x20registered\x20with\x20any\x20service');const _0x1cdfc9=this['serviceInstances']['get'](_0x15f995);if(!_0x1cdfc9)throw new Error('Service\x20'+_0x15f995+'\x20not\x20found\x20for\x20conversation\x20'+_0x378f7e);const _0xee0857=this['_getServiceModelId'](_0x15f995);await this[_0x48b029(0x18d)][_0x48b029(0x1aa)](_0xee0857);const _0x3b2cfd=this[_0x48b029(0x18f)]['retries']?.['maxRetries']||0x3;let _0x480dc4=0x0,_0x31b0bc=null;while(_0x480dc4<=_0x3b2cfd){try{const _0x1c8592=await _0x1cdfc9[_0x48b029(0x1ab)](_0x378f7e,_0x3cba16,_0x24f475);return this[_0x48b029(0x18d)][_0x48b029(0x188)](_0xee0857),await this['budgetService'][_0x48b029(0x186)](_0x15f995,_0x1cdfc9['getLastInputTokenCount'](),_0x1cdfc9[_0x48b029(0x199)]()),this['serviceStatus'][_0x48b029(0x1a3)](_0x15f995)==='degraded'&&this[_0x48b029(0x189)]['set'](_0x15f995,_0x48b029(0x1bb)),_0x1c8592;}catch(_0x32b2c0){_0x31b0bc=_0x32b2c0,this[_0x48b029(0x1a2)][_0x48b029(0x1a1)](_0x48b029(0x1a7)+(_0x480dc4+0x1)+'/'+(_0x3b2cfd+0x1)+'):',_0x32b2c0);if(this['_isRateLimitError'](_0x32b2c0)){this['rateLimitService'][_0x48b029(0x17a)](_0xee0857);if(_0x480dc4<_0x3b2cfd){this[_0x48b029(0x1a2)]['info']('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x48b029(0x1aa)](_0xee0857);continue;}}if(this['_isNonRetryableError'](_0x32b2c0))throw _0x32b2c0;if(_0x480dc4>=_0x3b2cfd)break;this['serviceStatus'][_0x48b029(0x17c)](_0x15f995,_0x48b029(0x1b1));const _0x17b69b=this['config']['retries']?.[_0x48b029(0x1af)]||0x3e8,_0x312689=this[_0x48b029(0x18f)]['retries']?.['delayMultiplier']||0x2,_0x1c8c83=_0x17b69b*Math[_0x48b029(0x185)](_0x312689,_0x480dc4);this[_0x48b029(0x1a2)][_0x48b029(0x1b0)](_0x48b029(0x196)+_0x1c8c83+_0x48b029(0x1b3)),await new Promise(_0x47d6f9=>setTimeout(_0x47d6f9,_0x1c8c83)),_0x480dc4++;}}throw new Error(_0x48b029(0x19a)+(_0x31b0bc?.['message']||'Unknown\x20error'));}[a0_0x77007c(0x195)](_0x49ec4b){const _0x21186b=a0_0x77007c,_0x21c6ea=[_0x21186b(0x1b8),_0x21186b(0x182),'quota\x20exceeded','request\x20limit',_0x21186b(0x194),'throttle'],_0x2f8436=_0x49ec4b[_0x21186b(0x18c)]?.[_0x21186b(0x184)]()||'';return _0x21c6ea[_0x21186b(0x18b)](_0x3f338f=>_0x2f8436[_0x21186b(0x1b4)](_0x3f338f));}[a0_0x77007c(0x19d)](_0x2e3304){const _0x1c807a=a0_0x77007c,_0x4b977b=['invalid\x20api\x20key',_0x1c807a(0x1a6),_0x1c807a(0x1b6),_0x1c807a(0x1a0),_0x1c807a(0x1ae),_0x1c807a(0x18e)],_0x56cc03=_0x2e3304[_0x1c807a(0x18c)]?.[_0x1c807a(0x184)]()||'';return _0x4b977b[_0x1c807a(0x18b)](_0x894f6c=>_0x56cc03[_0x1c807a(0x1b4)](_0x894f6c));}[a0_0x77007c(0x1b5)](_0x1b17c2){const _0x4f3870=a0_0x77007c,_0x53da00={'anthropic':'anthropic-sonnet','openai':_0x4f3870(0x192),'google':'google-gemini'};return _0x53da00[_0x1b17c2]||_0x1b17c2;}['getRateLimitingStatus'](){const _0x3d3468=a0_0x77007c;return this[_0x3d3468(0x18d)][_0x3d3468(0x180)]();}}