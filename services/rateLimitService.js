const a0_0x5e3079=a0_0x5c0a;(function(_0xec9533,_0x5c93ac){const _0x224a47=a0_0x5c0a,_0x477d3a=_0xec9533();while(!![]){try{const _0x1e7747=parseInt(_0x224a47(0x131))/0x1*(parseInt(_0x224a47(0x139))/0x2)+parseInt(_0x224a47(0x141))/0x3*(parseInt(_0x224a47(0x138))/0x4)+parseInt(_0x224a47(0x13d))/0x5+-parseInt(_0x224a47(0x11a))/0x6+-parseInt(_0x224a47(0x137))/0x7*(parseInt(_0x224a47(0x13f))/0x8)+parseInt(_0x224a47(0x13b))/0x9+-parseInt(_0x224a47(0x12e))/0xa*(parseInt(_0x224a47(0x142))/0xb);if(_0x1e7747===_0x5c93ac)break;else _0x477d3a['push'](_0x477d3a['shift']());}catch(_0x1358eb){_0x477d3a['push'](_0x477d3a['shift']());}}}(a0_0xd42a,0x88195));function a0_0x5c0a(_0x2bb20f,_0x25e465){const _0xd42ac1=a0_0xd42a();return a0_0x5c0a=function(_0x5c0ac7,_0x42fe38){_0x5c0ac7=_0x5c0ac7-0x10a;let _0x2c3d98=_0xd42ac1[_0x5c0ac7];if(a0_0x5c0a['nFDIeG']===undefined){var _0x5e59ac=function(_0x3651c9){const _0x19b80d='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x390448='',_0x27e1c7='';for(let _0xf1b46=0x0,_0x2f51a4,_0x342e44,_0x354e20=0x0;_0x342e44=_0x3651c9['charAt'](_0x354e20++);~_0x342e44&&(_0x2f51a4=_0xf1b46%0x4?_0x2f51a4*0x40+_0x342e44:_0x342e44,_0xf1b46++%0x4)?_0x390448+=String['fromCharCode'](0xff&_0x2f51a4>>(-0x2*_0xf1b46&0x6)):0x0){_0x342e44=_0x19b80d['indexOf'](_0x342e44);}for(let _0x4e8052=0x0,_0x18ce87=_0x390448['length'];_0x4e8052<_0x18ce87;_0x4e8052++){_0x27e1c7+='%'+('00'+_0x390448['charCodeAt'](_0x4e8052)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x27e1c7);};a0_0x5c0a['ebMOLQ']=_0x5e59ac,_0x2bb20f=arguments,a0_0x5c0a['nFDIeG']=!![];}const _0x54e9b9=_0xd42ac1[0x0],_0x45f73d=_0x5c0ac7+_0x54e9b9,_0x19e39f=_0x2bb20f[_0x45f73d];return!_0x19e39f?(_0x2c3d98=a0_0x5c0a['ebMOLQ'](_0x2c3d98),_0x2bb20f[_0x45f73d]=_0x2c3d98):_0x2c3d98=_0x19e39f,_0x2c3d98;},a0_0x5c0a(_0x2bb20f,_0x25e465);}export class RateLimitService{constructor(_0x3651c9){const _0x336a12=a0_0x5c0a;this['logger']=_0x3651c9,this['nextAllowedTime']=new Map(),this[_0x336a12(0x129)]=new Map(),this[_0x336a12(0x135)]=0x7530,this[_0x336a12(0x126)]=0xea60,this['CHECK_INTERVAL']=0x3e8;}[a0_0x5e3079(0x12d)](_0x19b80d,_0x390448){const _0x271912=a0_0x5e3079,_0x27e1c7=Date[_0x271912(0x128)]()+_0x390448,_0xf1b46=this['nextAllowedTime'][_0x271912(0x10a)](_0x19b80d)||0x0;_0x27e1c7>_0xf1b46&&(this['nextAllowedTime']['set'](_0x19b80d,_0x27e1c7),this[_0x271912(0x143)]['info'](_0x271912(0x10f)+_0x19b80d+':\x20'+_0x390448+_0x271912(0x124)+new Date(_0x27e1c7)['toISOString']()+')'));}['handleRateLimitHit'](_0x2f51a4){const _0x1f82a5=a0_0x5e3079,_0x342e44=this[_0x1f82a5(0x129)][_0x1f82a5(0x10a)](_0x2f51a4)||0x0,_0x354e20=_0x342e44+0x1;this['rateLimitHits'][_0x1f82a5(0x12b)](_0x2f51a4,_0x354e20);let _0x4e8052;_0x354e20===0x1?_0x4e8052=this[_0x1f82a5(0x135)]:_0x4e8052=this[_0x1f82a5(0x126)],this[_0x1f82a5(0x12d)](_0x2f51a4,_0x4e8052),this[_0x1f82a5(0x143)]['warn']('Rate\x20limit\x20hit\x20#'+_0x354e20+'\x20for\x20'+_0x2f51a4+',\x20applying\x20'+_0x4e8052+'ms\x20delay');}async['waitIfNeeded'](_0x18ce87){const _0x3aebc9=a0_0x5e3079,_0x197a44=this[_0x3aebc9(0x123)][_0x3aebc9(0x10a)](_0x18ce87)||0x0,_0x202f4f=Date['now']();if(_0x202f4f>=_0x197a44){this[_0x3aebc9(0x143)][_0x3aebc9(0x13c)](_0x18ce87+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x58f858=_0x197a44-_0x202f4f,_0x4a5d95=_0x58f858+this['CHECK_INTERVAL'];this[_0x3aebc9(0x143)]['info'](_0x18ce87+_0x3aebc9(0x115)+_0x4a5d95+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x197a44+this['CHECK_INTERVAL'])['toISOString']()+')'),await new Promise(_0x1213b6=>setTimeout(_0x1213b6,_0x4a5d95));}['resetRateLimitHits'](_0x1d90f5){const _0x234fe4=a0_0x5e3079;this[_0x234fe4(0x129)]['has'](_0x1d90f5)&&(this[_0x234fe4(0x129)]['delete'](_0x1d90f5),this[_0x234fe4(0x143)]['debug'](_0x1d90f5+_0x234fe4(0x121)));}[a0_0x5e3079(0x134)](_0x5ef949){const _0x1aa707=a0_0x5e3079,_0x42bcc4=this['nextAllowedTime']['get'](_0x5ef949)||0x0,_0x23e0f4=this['rateLimitHits'][_0x1aa707(0x10a)](_0x5ef949)||0x0,_0x164e99=Date[_0x1aa707(0x128)]();return{'serviceModel':_0x5ef949,'nextAllowedTime':_0x42bcc4,'nextAllowedDate':_0x42bcc4>0x0?new Date(_0x42bcc4)['toISOString']():null,'remainingDelayMs':Math['max'](0x0,_0x42bcc4-_0x164e99),'canSendNow':_0x164e99>=_0x42bcc4,'consecutiveRateLimitHits':_0x23e0f4};}[a0_0x5e3079(0x110)](){const _0x4c1afb=a0_0x5e3079,_0x146ffe=new Set([...this[_0x4c1afb(0x123)]['keys'](),...this[_0x4c1afb(0x129)]['keys']()]),_0x2e5372={};for(const _0xeace5b of _0x146ffe){_0x2e5372[_0xeace5b]=this['getStatus'](_0xeace5b);}return _0x2e5372;}['clear'](){const _0xd18b88=a0_0x5e3079;this[_0xd18b88(0x123)][_0xd18b88(0x136)](),this['rateLimitHits']['clear'](),this['logger']['info']('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0xf517d4,_0x586f70){const _0x389fa4=a0_0x5e3079;this[_0x389fa4(0x11d)]=_0xf517d4,this['logger']=_0x586f70,this['rateLimitService']=new RateLimitService(_0x586f70),this['budgetService']=new BudgetService(_0xf517d4,_0x586f70),this['serviceInstances']=new Map(),this['conversationServices']=new Map(),this['serviceStatus']=new Map();}async[a0_0x5e3079(0x11c)](_0x3f617d,_0x3e594b,_0x5a081b){const _0x2a0d79=a0_0x5e3079,_0x5e7d1e=this['conversationServices'][_0x2a0d79(0x10a)](_0x3f617d);if(!_0x5e7d1e)throw new Error(_0x2a0d79(0x13e)+_0x3f617d+'\x20is\x20not\x20registered\x20with\x20any\x20service');const _0x2251ba=this[_0x2a0d79(0x12a)]['get'](_0x5e7d1e);if(!_0x2251ba)throw new Error('Service\x20'+_0x5e7d1e+_0x2a0d79(0x11e)+_0x3f617d);const _0x256246=this[_0x2a0d79(0x122)](_0x5e7d1e);await this['rateLimitService']['waitIfNeeded'](_0x256246);const _0x318099=this[_0x2a0d79(0x11d)]['retries']?.['maxRetries']||0x3;let _0x576688=0x0,_0x134e05=null;while(_0x576688<=_0x318099){try{const _0x407ac6=await _0x2251ba[_0x2a0d79(0x11c)](_0x3f617d,_0x3e594b,_0x5a081b);return this[_0x2a0d79(0x11f)]['resetRateLimitHits'](_0x256246),await this['budgetService'][_0x2a0d79(0x10c)](_0x5e7d1e,_0x2251ba['getLastInputTokenCount'](),_0x2251ba['getLastOutputTokenCount']()),this['serviceStatus']['get'](_0x5e7d1e)===_0x2a0d79(0x130)&&this['serviceStatus'][_0x2a0d79(0x12b)](_0x5e7d1e,'available'),_0x407ac6;}catch(_0x52154b){_0x134e05=_0x52154b,this['logger'][_0x2a0d79(0x133)](_0x2a0d79(0x10b)+(_0x576688+0x1)+'/'+(_0x318099+0x1)+'):',_0x52154b);if(this[_0x2a0d79(0x112)](_0x52154b)){this['rateLimitService']['handleRateLimitHit'](_0x256246);if(_0x576688<_0x318099){this['logger']['info']('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x2a0d79(0x120)](_0x256246);continue;}}if(this[_0x2a0d79(0x127)](_0x52154b))throw _0x52154b;if(_0x576688>=_0x318099)break;this['serviceStatus']['set'](_0x5e7d1e,'degraded');const _0x13a63e=this['config'][_0x2a0d79(0x116)]?.[_0x2a0d79(0x12f)]||0x3e8,_0xf92ee9=this['config'][_0x2a0d79(0x116)]?.[_0x2a0d79(0x118)]||0x2,_0x380451=_0x13a63e*Math[_0x2a0d79(0x12c)](_0xf92ee9,_0x576688);this['logger']['info']('Retrying\x20after\x20'+_0x380451+'ms...'),await new Promise(_0x58c50c=>setTimeout(_0x58c50c,_0x380451)),_0x576688++;}}throw new Error('All\x20retry\x20attempts\x20failed:\x20'+(_0x134e05?.[_0x2a0d79(0x119)]||_0x2a0d79(0x10e)));}['_isRateLimitError'](_0x54bdb8){const _0x58211b=a0_0x5e3079,_0x35d407=[_0x58211b(0x111),_0x58211b(0x140),'quota\x20exceeded',_0x58211b(0x11b),_0x58211b(0x113),_0x58211b(0x117)],_0x214c31=_0x54bdb8[_0x58211b(0x119)]?.['toLowerCase']()||'';return _0x35d407['some'](_0x48357b=>_0x214c31['includes'](_0x48357b));}['_isNonRetryableError'](_0x1de54c){const _0x4d46e0=a0_0x5e3079,_0x164806=['invalid\x20api\x20key',_0x4d46e0(0x132),'unauthorized',_0x4d46e0(0x114),'invalid\x20request\x20format',_0x4d46e0(0x10d)],_0x3d6097=_0x1de54c['message']?.['toLowerCase']()||'';return _0x164806[_0x4d46e0(0x125)](_0x56fe51=>_0x3d6097['includes'](_0x56fe51));}['_getServiceModelId'](_0x3dda6f){const _0x22f3b4=a0_0x5e3079,_0x413113={'anthropic':'anthropic-sonnet','openai':'openai-gpt4','google':_0x22f3b4(0x13a)};return _0x413113[_0x3dda6f]||_0x3dda6f;}['getRateLimitingStatus'](){return this['rateLimitService']['getAllStatus']();}}function a0_0xd42a(){const _0x307075=['BwvZC2fNzq','mZq0nJC3ofPrEvbitq','CMvXDwvZDcbSAw1PDa','C2vUze1LC3nHz2u','y29UzMLN','ig5VDcbMB3vUzcbMB3iGy29UDMvYC2f0Aw9Uia','CMf0zuXPBwL0u2vYDMLJzq','D2fPDeLMtMvLzgvK','oIbsyxrLigXPBwL0igHPDhmGCMvZzxqGkhn1y2nLC3nMDwWGCMvXDwvZDcK','x2DLDfnLCNzPy2vnB2rLBeLK','BMv4DefSBg93zwruAw1L','BxmGkhvUDgLSia','C29Tzq','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','x2LZtM9UuMv0CNLHyMXLrxjYB3i','BM93','CMf0zuXPBwL0sgL0CW','C2vYDMLJzuLUC3rHBMnLCW','C2v0','Cg93','C2v0rgvSyxK','mtbICKjqy2C','yMfZzurLBgf5txm','zgvNCMfKzwq','mxbvCwrLuW','yxv0AgvUDgLJyxrPB24GzMfPBgvK','zxjYB3i','z2v0u3rHDhvZ','su5jveLbtf9sqvrfx0XjtuLux0rftefz','y2XLyxi','n2Ltuu1wEa','mJqZmtmYthLQzNLL','mtiXmJm0mMrVr1Djva','z29Vz2XLlwDLBwLUAq','ntm0ndaYovnJB3f6rG','zgvIDwC','nJuZnJGWvLD3uNfW','q29UDMvYC2f0Aw9Uia','nJu4mtyYngLYv3LrBa','Dg9Vig1HBNKGCMvXDwvZDhm','ntfir1fgvMy','nduWmZa5mLHnCefUwq','Bg9Nz2vY','z2v0','uMvXDwvZDcbMywLSzwqGkgf0DgvTChqG','CMvJB3jKvxnHz2u','y29UDgvUDcbWB2XPy3K','vw5RBM93BIbLCNjVCG','uMf0zsbSAw1PDcbKzwXHEsbZzxqGzM9Yia','z2v0qwXSu3rHDhvZ','CMf0zsbSAw1PDa','x2LZuMf0zuXPBwL0rxjYB3i','ndi5','Bw9KzwWGBM90igzVDw5K','oIbxywL0Aw5Nia','CMv0CMLLCW','DgHYB3r0Bgu','zgvSyxLnDwX0AxbSAwvY'];a0_0xd42a=function(){return _0x307075;};return a0_0xd42a();}