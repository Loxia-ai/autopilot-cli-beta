function a0_0x2cdf(){const _0x3ecc3e=['CMf0zuXPBwL0sgL0CW','C2vYDMLJzuLUC3rHBMnLCW','Bwf4','BxmGkhvUDgLSia','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','C2vUze1LC3nHz2u','mtC2ndq3mxjmugf4rG','mtiXmJK3n3feDLflrW','Aw5JBhvKzxm','CMv0CMLLCW','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','AgfUzgXLuMf0zuXPBwL0sgL0','mtaXnZi3nwDXyKnHAq','Dg9mB3DLCKnHC2u','vw5RBM93BIbLCNjVCG','uMf0zsbSAw1PDcbOAxqGiW','mtuZmJuYsNLuCfD4','mJvYqunVCNG','mKXZswvpqW','BxmGyMvMB3jLihnLBMrPBMCGkhvUDgLSia','CMvZzxrsyxrLtgLTAxriAxrZ','BMv4DefSBg93zwruAw1L','uMf0zsbSAw1PDcbKzwXHEsbZzxqGzM9Yia','Cg93','y29UDgvUDcbWB2XPy3K','igzVCIa','z2v0','BwvZC2fNzq','DgHYB3r0Bgu','C2vYDMLJzvn0yxr1CW','y29UzMLN','y2XLyxi','D2fPDeLMtMvLzgvK','BM93','nZyXotuYoejmvNfRDG','A2v5CW','z2v0qwXSu3rHDhvZ','Bg9Nz2vY','C29Tzq','C2v0','q29UDMvYC2f0Aw9Uia','ndGYmJm0mZbIA291rM4','oIbxywL0Aw5Nia','z2v0tgfZDeLUChv0vg9Rzw5dB3vUDa','z2v0u3rHDhvZ','CMvXDwvZDcbSAw1PDa','mtfyAgffy0q','yxv0AgvUDgLJyxrPB24GzMfPBgvK','x2LZuMf0zuXPBwL0rxjYB3i','Dw5HDxrOB3jPEMvK','mtmWntuZnNruzgvisq','zgvIDwC','x2LZtM9UuMv0CNLHyMXLrxjYB3i','q0Hfq0TFsu5urvjwquW','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','Aw5MBW','CMf0zuXPBwL0u2vYDMLJzq','Dg9ju09tDhjPBMC','yNvKz2v0u2vYDMLJzq','mZbQDLnywLm','x2DLDfnLCNzPy2vnB2rLBeLK','CxvVDgeGzxHJzwvKzwq'];a0_0x2cdf=function(){return _0x3ecc3e;};return a0_0x2cdf();}const a0_0x484f22=a0_0xae56;function a0_0xae56(_0x8c18bc,_0x4a215e){const _0x2cdf77=a0_0x2cdf();return a0_0xae56=function(_0xae56bc,_0x2b44ff){_0xae56bc=_0xae56bc-0x190;let _0x4bcf1d=_0x2cdf77[_0xae56bc];if(a0_0xae56['FAUCYh']===undefined){var _0x3d51bd=function(_0x739f72){const _0x5a7ef9='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1c3d38='',_0x17940e='';for(let _0x284db7=0x0,_0x28c808,_0x5df88e,_0x175a70=0x0;_0x5df88e=_0x739f72['charAt'](_0x175a70++);~_0x5df88e&&(_0x28c808=_0x284db7%0x4?_0x28c808*0x40+_0x5df88e:_0x5df88e,_0x284db7++%0x4)?_0x1c3d38+=String['fromCharCode'](0xff&_0x28c808>>(-0x2*_0x284db7&0x6)):0x0){_0x5df88e=_0x5a7ef9['indexOf'](_0x5df88e);}for(let _0x5d2d96=0x0,_0x58c2f5=_0x1c3d38['length'];_0x5d2d96<_0x58c2f5;_0x5d2d96++){_0x17940e+='%'+('00'+_0x1c3d38['charCodeAt'](_0x5d2d96)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x17940e);};a0_0xae56['PvkBkJ']=_0x3d51bd,_0x8c18bc=arguments,a0_0xae56['FAUCYh']=!![];}const _0x589afe=_0x2cdf77[0x0],_0x2e0cd9=_0xae56bc+_0x589afe,_0x492bc8=_0x8c18bc[_0x2e0cd9];return!_0x492bc8?(_0x4bcf1d=a0_0xae56['PvkBkJ'](_0x4bcf1d),_0x8c18bc[_0x2e0cd9]=_0x4bcf1d):_0x4bcf1d=_0x492bc8,_0x4bcf1d;},a0_0xae56(_0x8c18bc,_0x4a215e);}(function(_0x4cc0ff,_0x583e5c){const _0x524f8e=a0_0xae56,_0x1e20d1=_0x4cc0ff();while(!![]){try{const _0x5cfc49=parseInt(_0x524f8e(0x1a3))/0x1*(-parseInt(_0x524f8e(0x1ae))/0x2)+parseInt(_0x524f8e(0x1a2))/0x3+parseInt(_0x524f8e(0x190))/0x4*(-parseInt(_0x524f8e(0x1ad))/0x5)+-parseInt(_0x524f8e(0x199))/0x6*(parseInt(_0x524f8e(0x1a8))/0x7)+-parseInt(_0x524f8e(0x1be))/0x8+parseInt(_0x524f8e(0x1ac))/0x9+parseInt(_0x524f8e(0x1c5))/0xa*(parseInt(_0x524f8e(0x1ca))/0xb);if(_0x5cfc49===_0x583e5c)break;else _0x1e20d1['push'](_0x1e20d1['shift']());}catch(_0x3df45e){_0x1e20d1['push'](_0x1e20d1['shift']());}}}(a0_0x2cdf,0xdc98d));export class RateLimitService{constructor(_0x739f72){const _0x5d3acb=a0_0xae56;this[_0x5d3acb(0x1c1)]=_0x739f72,this[_0x5d3acb(0x1b1)]=new Map(),this[_0x5d3acb(0x19c)]=new Map(),this['INITIAL_RATE_LIMIT_DELAY']=0x7530,this[_0x5d3acb(0x1a6)]=0xea60,this['CHECK_INTERVAL']=0x3e8;}['setDelay'](_0x5a7ef9,_0x1c3d38){const _0x2d4a00=a0_0xae56,_0x17940e=Date[_0x2d4a00(0x1bd)]()+_0x1c3d38,_0x284db7=this['nextAllowedTime'][_0x2d4a00(0x1b6)](_0x5a7ef9)||0x0;_0x17940e>_0x284db7&&(this['nextAllowedTime']['set'](_0x5a7ef9,_0x17940e),this['logger']['info'](_0x2d4a00(0x1b2)+_0x5a7ef9+':\x20'+_0x1c3d38+_0x2d4a00(0x19f)+new Date(_0x17940e)['toISOString']()+')'));}['handleRateLimitHit'](_0x28c808){const _0x14b778=a0_0xae56,_0x5df88e=this['rateLimitHits']['get'](_0x28c808)||0x0,_0x175a70=_0x5df88e+0x1;this[_0x14b778(0x19c)]['set'](_0x28c808,_0x175a70);let _0x5d2d96;_0x175a70===0x1?_0x5d2d96=this['INITIAL_RATE_LIMIT_DELAY']:_0x5d2d96=this['EXTENDED_RATE_LIMIT_DELAY'],this['setDelay'](_0x28c808,_0x5d2d96),this[_0x14b778(0x1c1)]['warn'](_0x14b778(0x1ab)+_0x175a70+_0x14b778(0x1b5)+_0x28c808+',\x20applying\x20'+_0x5d2d96+'ms\x20delay');}async['waitIfNeeded'](_0x58c2f5){const _0x127a69=a0_0xae56,_0xac4093=this['nextAllowedTime'][_0x127a69(0x1b6)](_0x58c2f5)||0x0,_0x4af76a=Date[_0x127a69(0x1bd)]();if(_0x4af76a>=_0xac4093){this['logger']['debug'](_0x58c2f5+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x31aced=_0xac4093-_0x4af76a,_0x2f551b=_0x31aced+this[_0x127a69(0x193)];this['logger'][_0x127a69(0x195)](_0x58c2f5+_0x127a69(0x1c6)+_0x2f551b+_0x127a69(0x1af)+new Date(_0xac4093+this[_0x127a69(0x193)])['toISOString']()+')'),await new Promise(_0x32439f=>setTimeout(_0x32439f,_0x2f551b));}[a0_0x484f22(0x1b0)](_0x2416a3){const _0x4ead50=a0_0x484f22;this['rateLimitHits']['has'](_0x2416a3)&&(this[_0x4ead50(0x19c)]['delete'](_0x2416a3),this['logger'][_0x4ead50(0x191)](_0x2416a3+':\x20Rate\x20limit\x20hits\x20reset\x20(successful\x20request)'));}['getStatus'](_0x341201){const _0x591c95=a0_0x484f22,_0x3714f1=this['nextAllowedTime'][_0x591c95(0x1b6)](_0x341201)||0x0,_0x101247=this[_0x591c95(0x19c)]['get'](_0x341201)||0x0,_0x1e3d40=Date['now']();return{'serviceModel':_0x341201,'nextAllowedTime':_0x3714f1,'nextAllowedDate':_0x3714f1>0x0?new Date(_0x3714f1)[_0x591c95(0x197)]():null,'remainingDelayMs':Math[_0x591c95(0x19e)](0x0,_0x3714f1-_0x1e3d40),'canSendNow':_0x1e3d40>=_0x3714f1,'consecutiveRateLimitHits':_0x101247};}[a0_0x484f22(0x1c0)](){const _0x24c8d2=a0_0x484f22,_0x2a63e4=new Set([...this[_0x24c8d2(0x1b1)]['keys'](),...this['rateLimitHits'][_0x24c8d2(0x1bf)]()]),_0x230771={};for(const _0x1f1633 of _0x2a63e4){_0x230771[_0x1f1633]=this[_0x24c8d2(0x1c8)](_0x1f1633);}return _0x230771;}['clear'](){const _0x175465=a0_0x484f22;this[_0x175465(0x1b1)][_0x175465(0x1bb)](),this[_0x175465(0x19c)][_0x175465(0x1bb)](),this['logger'][_0x175465(0x195)]('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0x20b4a7,_0x4e0826){const _0x15e558=a0_0x484f22;this[_0x15e558(0x1ba)]=_0x20b4a7,this[_0x15e558(0x1c1)]=_0x4e0826,this[_0x15e558(0x196)]=new RateLimitService(_0x4e0826),this[_0x15e558(0x198)]=new BudgetService(_0x20b4a7,_0x4e0826),this['serviceInstances']=new Map(),this['conversationServices']=new Map(),this[_0x15e558(0x1b9)]=new Map();}async[a0_0x484f22(0x1a1)](_0x5780e6,_0x266821,_0x4e4e22){const _0x21cab0=a0_0x484f22,_0x20cbb2=this['conversationServices'][_0x21cab0(0x1b6)](_0x5780e6);if(!_0x20cbb2)throw new Error(_0x21cab0(0x1c4)+_0x5780e6+'\x20is\x20not\x20registered\x20with\x20any\x20service');const _0x15c2fc=this[_0x21cab0(0x19d)][_0x21cab0(0x1b6)](_0x20cbb2);if(!_0x15c2fc)throw new Error('Service\x20'+_0x20cbb2+'\x20not\x20found\x20for\x20conversation\x20'+_0x5780e6);const _0x50e2f2=this[_0x21cab0(0x19a)](_0x20cbb2);await this[_0x21cab0(0x196)]['waitIfNeeded'](_0x50e2f2);const _0x4ecd25=this['config'][_0x21cab0(0x1a5)]?.['maxRetries']||0x3;let _0x373de2=0x0,_0x11d878=null;while(_0x373de2<=_0x4ecd25){try{const _0x34327e=await _0x15c2fc['sendMessage'](_0x5780e6,_0x266821,_0x4e4e22);return this['rateLimitService']['resetRateLimitHits'](_0x50e2f2),await this['budgetService']['recordUsage'](_0x20cbb2,_0x15c2fc[_0x21cab0(0x1c7)](),_0x15c2fc[_0x21cab0(0x1a0)]()),this[_0x21cab0(0x1b9)][_0x21cab0(0x1b6)](_0x20cbb2)==='degraded'&&this[_0x21cab0(0x1b9)][_0x21cab0(0x1c3)](_0x20cbb2,'available'),_0x34327e;}catch(_0x3445cf){_0x11d878=_0x3445cf,this['logger']['error']('Request\x20failed\x20(attempt\x20'+(_0x373de2+0x1)+'/'+(_0x4ecd25+0x1)+'):',_0x3445cf);if(this[_0x21cab0(0x1cc)](_0x3445cf)){this[_0x21cab0(0x196)][_0x21cab0(0x1a7)](_0x50e2f2);if(_0x373de2<_0x4ecd25){this[_0x21cab0(0x1c1)][_0x21cab0(0x195)]('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x21cab0(0x1bc)](_0x50e2f2);continue;}}if(this[_0x21cab0(0x192)](_0x3445cf))throw _0x3445cf;if(_0x373de2>=_0x4ecd25)break;this['serviceStatus']['set'](_0x20cbb2,'degraded');const _0x9533d7=this['config'][_0x21cab0(0x1a5)]?.['baseDelayMs']||0x3e8,_0x11d8b7=this['config'][_0x21cab0(0x1a5)]?.['delayMultiplier']||0x2,_0x4540b2=_0x9533d7*Math[_0x21cab0(0x1b3)](_0x11d8b7,_0x373de2);this['logger']['info']('Retrying\x20after\x20'+_0x4540b2+'ms...'),await new Promise(_0x5f17af=>setTimeout(_0x5f17af,_0x4540b2)),_0x373de2++;}}throw new Error('All\x20retry\x20attempts\x20failed:\x20'+(_0x11d878?.['message']||_0x21cab0(0x1aa)));}['_isRateLimitError'](_0x413bac){const _0x5d35ea=a0_0x484f22,_0x3482ee=['rate\x20limit','too\x20many\x20requests',_0x5d35ea(0x19b),_0x5d35ea(0x1c9),'429',_0x5d35ea(0x1b8)],_0x4a7136=_0x413bac[_0x5d35ea(0x1b7)]?.['toLowerCase']()||'';return _0x3482ee[_0x5d35ea(0x1c2)](_0xc5ea69=>_0x4a7136['includes'](_0xc5ea69));}['_isNonRetryableError'](_0x2b0349){const _0x55866a=a0_0x484f22,_0x233873=['invalid\x20api\x20key',_0x55866a(0x1cb),_0x55866a(0x1cd),'model\x20not\x20found',_0x55866a(0x194),_0x55866a(0x1b4)],_0x55b966=_0x2b0349[_0x55866a(0x1b7)]?.[_0x55866a(0x1a9)]()||'';return _0x233873['some'](_0x310d30=>_0x55b966[_0x55866a(0x1a4)](_0x310d30));}['_getServiceModelId'](_0x1c553a){const _0x7fe690={'anthropic':'anthropic-sonnet','openai':'openai-gpt4','google':'google-gemini'};return _0x7fe690[_0x1c553a]||_0x1c553a;}['getRateLimitingStatus'](){const _0x160547=a0_0x484f22;return this['rateLimitService'][_0x160547(0x1c0)]();}}