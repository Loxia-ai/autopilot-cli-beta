function a0_0x2820(_0x4d5955,_0x211fb6){const _0x39f2af=a0_0x39f2();return a0_0x2820=function(_0x282041,_0x48c425){_0x282041=_0x282041-0x143;let _0x546094=_0x39f2af[_0x282041];if(a0_0x2820['aVuvWu']===undefined){var _0x2eabeb=function(_0x2593cc){const _0x40bf9c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x3ac892='',_0x163168='';for(let _0x203b83=0x0,_0x3f720a,_0x521cf3,_0x263fd1=0x0;_0x521cf3=_0x2593cc['charAt'](_0x263fd1++);~_0x521cf3&&(_0x3f720a=_0x203b83%0x4?_0x3f720a*0x40+_0x521cf3:_0x521cf3,_0x203b83++%0x4)?_0x3ac892+=String['fromCharCode'](0xff&_0x3f720a>>(-0x2*_0x203b83&0x6)):0x0){_0x521cf3=_0x40bf9c['indexOf'](_0x521cf3);}for(let _0x5bbb53=0x0,_0x24f07e=_0x3ac892['length'];_0x5bbb53<_0x24f07e;_0x5bbb53++){_0x163168+='%'+('00'+_0x3ac892['charCodeAt'](_0x5bbb53)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x163168);};a0_0x2820['QYsMgm']=_0x2eabeb,_0x4d5955=arguments,a0_0x2820['aVuvWu']=!![];}const _0xcc68c=_0x39f2af[0x0],_0x5091b6=_0x282041+_0xcc68c,_0x46c871=_0x4d5955[_0x5091b6];return!_0x46c871?(_0x546094=a0_0x2820['QYsMgm'](_0x546094),_0x4d5955[_0x5091b6]=_0x546094):_0x546094=_0x46c871,_0x546094;},a0_0x2820(_0x4d5955,_0x211fb6);}const a0_0x3adbc4=a0_0x2820;(function(_0xac147d,_0x1c6c9a){const _0x22e970=a0_0x2820,_0x39c97f=_0xac147d();while(!![]){try{const _0x4c7967=parseInt(_0x22e970(0x159))/0x1*(-parseInt(_0x22e970(0x166))/0x2)+-parseInt(_0x22e970(0x174))/0x3+parseInt(_0x22e970(0x14d))/0x4*(-parseInt(_0x22e970(0x144))/0x5)+parseInt(_0x22e970(0x14e))/0x6+-parseInt(_0x22e970(0x170))/0x7+-parseInt(_0x22e970(0x162))/0x8+-parseInt(_0x22e970(0x15a))/0x9*(-parseInt(_0x22e970(0x145))/0xa);if(_0x4c7967===_0x1c6c9a)break;else _0x39c97f['push'](_0x39c97f['shift']());}catch(_0x40f089){_0x39c97f['push'](_0x39c97f['shift']());}}}(a0_0x39f2,0xd727b));function a0_0x39f2(){const _0x24db7a=['nfrHDuHvra','mZa0nZuWmK9rv0TrDG','Dg9Vig1HBNKGCMvXDwvZDhm','CMvZzxrsyxrLtgLTAxriAxrZ','C2vUze1LC3nHz2u','q0Hfq0TFsu5urvjwquW','qwXSihjLDhj5igf0DgvTChrZigzHAwXLzdOG','BM93','BMv4DefSBg93zwruAw1L','Dg9ju09tDhjPBMC','zgvSzxrL','x2LZtM9UuMv0CNLHyMXLrxjYB3i','mvjstLvYCa','ntu2ntmZCMfluufP','y2XLyxi','zgvIDwC','A2v5CW','yw50AhjVCgLJlxnVBM5LDa','DgHYB3r0Bgu','yNvKz2v0u2vYDMLJzq','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','mteXndyXndrurgDNy3i','igzVCIa','CMf0zuXPBwL0sgL0CW','B3bLBMfPlwDWDdq','nZmXnZmYCKHdyufW','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','C2vYDMLJzvn0yxr1CW','Bg9Nz2vY','C2v0','C29Tzq','x2DLDfnLCNzPy2vnB2rLBeLK','y29UDMvYC2f0Aw9Uu2vYDMLJzxm','su5jveLbtf9sqvrfx0XjtuLux0rftefz','uMf0zsbSAw1PDcbKzwXHEsbZzxqGzM9Yia','ndaXmdy3mvPPt25RCG','Aw5MBW','D2fPDeLMtMvLzgvK','q29UDMvYC2f0Aw9Uia','mZy4nZGZmuX3z1jiCG','Dg9mB3DLCKnHC2u','AgfUzgXLuMf0zuXPBwL0sgL0','y29UzMLN','zgvNCMfKzwq','Aw5JBhvKzxm','z2v0','C2vYDMLJzuLUC3rHBMnLCW','x2LZuMf0zuXPBwL0rxjYB3i','nta2mte5meDQrhHcyG','odaWEfrICw9u','ndi5','oIbsyxrLigXPBwL0igHPDhmGCMvZzxqGkhn1y2nLC3nMDwWGCMvXDwvZDcK','CMvXDwvZDcbSAw1PDa','CMf0zuXPBwL0u2vYDMLJzq','uMvXDwvZDcbMywLSzwqGkgf0DgvTChqG','z2v0uMf0zuXPBwL0Aw5Nu3rHDhvZ','CMv0CMLLCW'];a0_0x39f2=function(){return _0x24db7a;};return a0_0x39f2();}export class RateLimitService{constructor(_0x2593cc){const _0x228a71=a0_0x2820;this['logger']=_0x2593cc,this['nextAllowedTime']=new Map(),this['rateLimitHits']=new Map(),this[_0x228a71(0x16e)]=0x7530,this[_0x228a71(0x161)]=0xea60,this['CHECK_INTERVAL']=0x3e8;}['setDelay'](_0x40bf9c,_0x3ac892){const _0x1ce28b=a0_0x2820,_0x163168=Date[_0x1ce28b(0x154)]()+_0x3ac892,_0x203b83=this[_0x1ce28b(0x155)]['get'](_0x40bf9c)||0x0;_0x163168>_0x203b83&&(this[_0x1ce28b(0x155)]['set'](_0x40bf9c,_0x163168),this['logger'][_0x1ce28b(0x171)](_0x1ce28b(0x16f)+_0x40bf9c+':\x20'+_0x3ac892+'ms\x20(until\x20'+new Date(_0x163168)[_0x1ce28b(0x156)]()+')'));}[a0_0x3adbc4(0x176)](_0x3f720a){const _0x147393=a0_0x3adbc4,_0x521cf3=this['rateLimitHits']['get'](_0x3f720a)||0x0,_0x263fd1=_0x521cf3+0x1;this[_0x147393(0x164)]['set'](_0x3f720a,_0x263fd1);let _0x5bbb53;_0x263fd1===0x1?_0x5bbb53=this['INITIAL_RATE_LIMIT_DELAY']:_0x5bbb53=this[_0x147393(0x161)],this['setDelay'](_0x3f720a,_0x5bbb53),this[_0x147393(0x169)]['warn']('Rate\x20limit\x20hit\x20#'+_0x263fd1+_0x147393(0x163)+_0x3f720a+',\x20applying\x20'+_0x5bbb53+'ms\x20delay');}async[a0_0x3adbc4(0x172)](_0x24f07e){const _0x549cd8=a0_0x3adbc4,_0x1cf516=this['nextAllowedTime'][_0x549cd8(0x17a)](_0x24f07e)||0x0,_0x291380=Date[_0x549cd8(0x154)]();if(_0x291380>=_0x1cf516){this[_0x549cd8(0x169)]['debug'](_0x24f07e+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x26033a=_0x1cf516-_0x291380,_0x327ee7=_0x26033a+this[_0x549cd8(0x152)];this[_0x549cd8(0x169)]['info'](_0x24f07e+':\x20Waiting\x20'+_0x327ee7+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x1cf516+this[_0x549cd8(0x152)])['toISOString']()+')'),await new Promise(_0x53eb8c=>setTimeout(_0x53eb8c,_0x327ee7));}['resetRateLimitHits'](_0x192076){const _0x56a614=a0_0x3adbc4;this['rateLimitHits']['has'](_0x192076)&&(this['rateLimitHits'][_0x56a614(0x157)](_0x192076),this[_0x56a614(0x169)][_0x56a614(0x15c)](_0x192076+_0x56a614(0x147)));}['getStatus'](_0x3abf3a){const _0x458483=a0_0x3adbc4,_0x274ea2=this[_0x458483(0x155)][_0x458483(0x17a)](_0x3abf3a)||0x0,_0x1be456=this['rateLimitHits'][_0x458483(0x17a)](_0x3abf3a)||0x0,_0x4bd86e=Date[_0x458483(0x154)]();return{'serviceModel':_0x3abf3a,'nextAllowedTime':_0x274ea2,'nextAllowedDate':_0x274ea2>0x0?new Date(_0x274ea2)[_0x458483(0x156)]():null,'remainingDelayMs':Math['max'](0x0,_0x274ea2-_0x4bd86e),'canSendNow':_0x4bd86e>=_0x274ea2,'consecutiveRateLimitHits':_0x1be456};}['getAllStatus'](){const _0x54892f=a0_0x3adbc4,_0x15e7c8=new Set([...this['nextAllowedTime']['keys'](),...this[_0x54892f(0x164)][_0x54892f(0x15d)]()]),_0x2711cd={};for(const _0x279274 of _0x15e7c8){_0x2711cd[_0x279274]=this['getStatus'](_0x279274);}return _0x2711cd;}['clear'](){const _0x49d173=a0_0x3adbc4;this[_0x49d173(0x155)][_0x49d173(0x15b)](),this['rateLimitHits'][_0x49d173(0x15b)](),this[_0x49d173(0x169)][_0x49d173(0x171)]('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0x43c4ef,_0x45d9b8){const _0x7db523=a0_0x3adbc4;this[_0x7db523(0x177)]=_0x43c4ef,this[_0x7db523(0x169)]=_0x45d9b8,this[_0x7db523(0x149)]=new RateLimitService(_0x45d9b8),this['budgetService']=new BudgetService(_0x43c4ef,_0x45d9b8),this[_0x7db523(0x17b)]=new Map(),this[_0x7db523(0x16d)]=new Map(),this[_0x7db523(0x168)]=new Map();}async[a0_0x3adbc4(0x151)](_0x3790a5,_0x4854ae,_0x55bb1f){const _0x47b124=a0_0x3adbc4,_0x12c8d6=this[_0x47b124(0x16d)][_0x47b124(0x17a)](_0x3790a5);if(!_0x12c8d6)throw new Error(_0x47b124(0x173)+_0x3790a5+'\x20is\x20not\x20registered\x20with\x20any\x20service');const _0x4e1f2a=this['serviceInstances']['get'](_0x12c8d6);if(!_0x4e1f2a)throw new Error('Service\x20'+_0x12c8d6+'\x20not\x20found\x20for\x20conversation\x20'+_0x3790a5);const _0x1a4b15=this[_0x47b124(0x16c)](_0x12c8d6);await this[_0x47b124(0x149)]['waitIfNeeded'](_0x1a4b15);const _0xb1623b=this['config']['retries']?.['maxRetries']||0x3;let _0x571fd5=0x0,_0x544e5e=null;while(_0x571fd5<=_0xb1623b){try{const _0x3f4b60=await _0x4e1f2a[_0x47b124(0x151)](_0x3790a5,_0x4854ae,_0x55bb1f);return this['rateLimitService'][_0x47b124(0x150)](_0x1a4b15),await this[_0x47b124(0x160)]['recordUsage'](_0x12c8d6,_0x4e1f2a['getLastInputTokenCount'](),_0x4e1f2a['getLastOutputTokenCount']()),this[_0x47b124(0x168)]['get'](_0x12c8d6)===_0x47b124(0x178)&&this[_0x47b124(0x168)]['set'](_0x12c8d6,'available'),_0x3f4b60;}catch(_0x4051b3){_0x544e5e=_0x4051b3,this['logger']['error'](_0x47b124(0x14a)+(_0x571fd5+0x1)+'/'+(_0xb1623b+0x1)+'):',_0x4051b3);if(this[_0x47b124(0x143)](_0x4051b3)){this['rateLimitService'][_0x47b124(0x176)](_0x1a4b15);if(_0x571fd5<_0xb1623b){this[_0x47b124(0x169)]['info']('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService']['waitIfNeeded'](_0x1a4b15);continue;}}if(this['_isNonRetryableError'](_0x4051b3))throw _0x4051b3;if(_0x571fd5>=_0xb1623b)break;this[_0x47b124(0x168)][_0x47b124(0x16a)](_0x12c8d6,_0x47b124(0x178));const _0x59030e=this['config'][_0x47b124(0x14c)]?.['baseDelayMs']||0x3e8,_0x43d187=this[_0x47b124(0x177)][_0x47b124(0x14c)]?.['delayMultiplier']||0x2,_0x19e561=_0x59030e*Math['pow'](_0x43d187,_0x571fd5);this['logger'][_0x47b124(0x171)]('Retrying\x20after\x20'+_0x19e561+'ms...'),await new Promise(_0x289782=>setTimeout(_0x289782,_0x19e561)),_0x571fd5++;}}throw new Error(_0x47b124(0x153)+(_0x544e5e?.['message']||'Unknown\x20error'));}['_isRateLimitError'](_0x236148){const _0x2221f9=a0_0x3adbc4,_0x5cad47=['rate\x20limit',_0x2221f9(0x14f),'quota\x20exceeded',_0x2221f9(0x148),_0x2221f9(0x146),_0x2221f9(0x15f)],_0xc14ae8=_0x236148['message']?.[_0x2221f9(0x175)]()||'';return _0x5cad47['some'](_0x30b46a=>_0xc14ae8[_0x2221f9(0x179)](_0x30b46a));}[a0_0x3adbc4(0x158)](_0x1e828a){const _0x4f7d5a=a0_0x3adbc4,_0x4eeac2=['invalid\x20api\x20key','authentication\x20failed','unauthorized','model\x20not\x20found',_0x4f7d5a(0x167),'content\x20policy'],_0x2f84ff=_0x1e828a['message']?.['toLowerCase']()||'';return _0x4eeac2[_0x4f7d5a(0x16b)](_0x2a287c=>_0x2f84ff['includes'](_0x2a287c));}['_getServiceModelId'](_0x262328){const _0x4da0d5=a0_0x3adbc4,_0x485e28={'anthropic':_0x4da0d5(0x15e),'openai':_0x4da0d5(0x165),'google':'google-gemini'};return _0x485e28[_0x262328]||_0x262328;}[a0_0x3adbc4(0x14b)](){return this['rateLimitService']['getAllStatus']();}}