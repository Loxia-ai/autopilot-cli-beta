const a0_0x398be0=a0_0x542c;function a0_0x1423(){const _0x456f4a=['BxmGzgvSyxK','vw5RBM93BIbLCNjVCG','x2LZuMf0zuXPBwL0rxjYB3i','x2LZtM9UuMv0CNLHyMXLrxjYB3i','su5jveLbtf9sqvrfx0XjtuLux0rftefz','CMvJB3jKvxnHz2u','x2DLDfnLCNzPy2vnB2rLBeLK','CMvZzxrsyxrLtgLTAxriAxrZ','z2v0','Dg9mB3DLCKnHC2u','CMf0zuXPBwL0u2vYDMLJzq','AgfZ','lcbHChbSEwLUzYa','BMv4DefSBg93zwruAw1L','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','z2v0uMf0zuXPBwL0Aw5Nu3rHDhvZ','D2fPDeLMtMvLzgvK','CMvXDwvZDcbSAw1PDa','CMf0zuXPBwL0sgL0CW','yNvKz2v0u2vYDMLJzq','yxzHAwXHyMXL','ntK4nZa2u2vZB3fR','C2vUze1LC3nHz2u','mZGWmezhBxbhDq','zgvSyxLnDwX0AxbSAwvY','oIbsyxrLigXPBwL0igHPDhmGCMvZzxqGkhn1y2nLC3nMDwWGCMvXDwvZDcK','Dg9Vig1HBNKGCMvXDwvZDhm','Dw5HDxrOB3jPEMvK','y29UzMLN','BxmGkhvUDgLSia','igLZig5VDcbYzwDPC3rLCMvKihDPDgGGyw55ihnLCNzPy2u','mZqWodu0mtbdAMvdBKu','y2XLyxi','z2v0u3rHDhvZ','m09xCeLvDq','Aw5MBW','Bwf4uMv0CMLLCW','oIbszwfKEsb0BYbZzw5KicHUBYbKzwXHEsbUzwvKzwqP','q29UDMvYC2f0Aw9Uia','ntqXotC1mhvZzenHsW','C2v0rgvSyxK','Bw9KzwWGBM90igzVDw5K','Bg9Nz2vY','z2v0tgfZDeLUChv0vg9Rzw5dB3vUDa','igzVCIa','BM93','mJyWmZi2ohjhvwHyrG','ota1mZG0DLLeD0zT','C2v0','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','uMf0zsbSAw1PDcbOAxqGiW','CMf0zsbSAw1PDa','zgvSzxrL','ndi5','Aw5JBhvKzxm','mJa1mtuWmgjSrxrnsW','yMfZzurLBgf5txm','mtfgEe9dzgW','A2v5CW','Dg9ju09tDhjPBMC','mJe1mdf5qwvtrxi','zgvNCMfKzwq','CMv0CMLLCW','Bwf4','u2vYDMLJzsa','mtbos3DjqMy','zxjYB3i','AgfUzgXLuMf0zuXPBwL0sgL0','C2vYDMLJzvn0yxr1CW'];a0_0x1423=function(){return _0x456f4a;};return a0_0x1423();}(function(_0x1c44e9,_0x1bab0d){const _0x1d25fb=a0_0x542c,_0xaa47=_0x1c44e9();while(!![]){try{const _0x5a0b9f=-parseInt(_0x1d25fb(0xd6))/0x1+parseInt(_0x1d25fb(0xbc))/0x2*(-parseInt(_0x1d25fb(0xc9))/0x3)+-parseInt(_0x1d25fb(0xde))/0x4+-parseInt(_0x1d25fb(0xe8))/0x5*(-parseInt(_0x1d25fb(0xd5))/0x6)+-parseInt(_0x1d25fb(0xce))/0x7+parseInt(_0x1d25fb(0xbe))/0x8*(-parseInt(_0x1d25fb(0xe3))/0x9)+-parseInt(_0x1d25fb(0xc6))/0xa*(-parseInt(_0x1d25fb(0xe0))/0xb);if(_0x5a0b9f===_0x1bab0d)break;else _0xaa47['push'](_0xaa47['shift']());}catch(_0x5cd083){_0xaa47['push'](_0xaa47['shift']());}}}(a0_0x1423,0x9e9bc));function a0_0x542c(_0x3fc6cb,_0x5abf85){const _0x142342=a0_0x1423();return a0_0x542c=function(_0x542c99,_0x45880f){_0x542c99=_0x542c99-0xbb;let _0x5f57ef=_0x142342[_0x542c99];if(a0_0x542c['OQsAWT']===undefined){var _0x5f2b7c=function(_0x5da455){const _0x3b6287='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x134fe9='',_0xa5d05f='';for(let _0x2f4e3b=0x0,_0x2adcd0,_0x58496f,_0x2c3dbb=0x0;_0x58496f=_0x5da455['charAt'](_0x2c3dbb++);~_0x58496f&&(_0x2adcd0=_0x2f4e3b%0x4?_0x2adcd0*0x40+_0x58496f:_0x58496f,_0x2f4e3b++%0x4)?_0x134fe9+=String['fromCharCode'](0xff&_0x2adcd0>>(-0x2*_0x2f4e3b&0x6)):0x0){_0x58496f=_0x3b6287['indexOf'](_0x58496f);}for(let _0x482a6a=0x0,_0x10c958=_0x134fe9['length'];_0x482a6a<_0x10c958;_0x482a6a++){_0xa5d05f+='%'+('00'+_0x134fe9['charCodeAt'](_0x482a6a)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0xa5d05f);};a0_0x542c['yPoygp']=_0x5f2b7c,_0x3fc6cb=arguments,a0_0x542c['OQsAWT']=!![];}const _0x2b6e56=_0x142342[0x0],_0x5c0e84=_0x542c99+_0x2b6e56,_0x308902=_0x3fc6cb[_0x5c0e84];return!_0x308902?(_0x5f57ef=a0_0x542c['yPoygp'](_0x5f57ef),_0x3fc6cb[_0x5c0e84]=_0x5f57ef):_0x5f57ef=_0x308902,_0x5f57ef;},a0_0x542c(_0x3fc6cb,_0x5abf85);}export class RateLimitService{constructor(_0x5da455){const _0x36448f=a0_0x542c;this['logger']=_0x5da455,this['nextAllowedTime']=new Map(),this['rateLimitHits']=new Map(),this['INITIAL_RATE_LIMIT_DELAY']=0x7530,this[_0x36448f(0xfa)]=0xea60,this['CHECK_INTERVAL']=0x3e8;}[a0_0x398be0(0xcf)](_0x3b6287,_0x134fe9){const _0x149f5c=a0_0x398be0,_0xa5d05f=Date[_0x149f5c(0xd4)]()+_0x134fe9,_0x2f4e3b=this['nextAllowedTime'][_0x149f5c(0xf4)](_0x3b6287)||0x0;_0xa5d05f>_0x2f4e3b&&(this['nextAllowedTime']['set'](_0x3b6287,_0xa5d05f),this['logger']['info']('Rate\x20limit\x20delay\x20set\x20for\x20'+_0x3b6287+':\x20'+_0x134fe9+_0x149f5c(0xc4)+new Date(_0xa5d05f)[_0x149f5c(0xe2)]()+')'));}[a0_0x398be0(0xea)](_0x2adcd0){const _0x1b2c76=a0_0x398be0,_0x58496f=this['rateLimitHits']['get'](_0x2adcd0)||0x0,_0x2c3dbb=_0x58496f+0x1;this['rateLimitHits']['set'](_0x2adcd0,_0x2c3dbb);let _0x482a6a;_0x2c3dbb===0x1?_0x482a6a=this[_0x1b2c76(0xf0)]:_0x482a6a=this['EXTENDED_RATE_LIMIT_DELAY'],this['setDelay'](_0x2adcd0,_0x482a6a),this['logger']['warn'](_0x1b2c76(0xd9)+_0x2c3dbb+_0x1b2c76(0xd3)+_0x2adcd0+_0x1b2c76(0xf8)+_0x482a6a+_0x1b2c76(0xec));}async['waitIfNeeded'](_0x10c958){const _0x23dff3=a0_0x398be0,_0x5d19e6=this[_0x23dff3(0xf9)]['get'](_0x10c958)||0x0,_0x3d85b0=Date[_0x23dff3(0xd4)]();if(_0x3d85b0>=_0x5d19e6){this[_0x23dff3(0xd1)]['debug'](_0x10c958+_0x23dff3(0xcc));return;}const _0x7e7204=_0x5d19e6-_0x3d85b0,_0x5db7ae=_0x7e7204+this['CHECK_INTERVAL'];this['logger']['info'](_0x10c958+':\x20Waiting\x20'+_0x5db7ae+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x5d19e6+this['CHECK_INTERVAL'])['toISOString']()+')'),await new Promise(_0x58fc8a=>setTimeout(_0x58fc8a,_0x5db7ae));}['resetRateLimitHits'](_0xab8962){const _0x10179a=a0_0x398be0;this['rateLimitHits'][_0x10179a(0xf7)](_0xab8962)&&(this['rateLimitHits'][_0x10179a(0xdb)](_0xab8962),this['logger']['debug'](_0xab8962+_0x10179a(0xc0)));}[a0_0x398be0(0xc8)](_0x1bd8f0){const _0xedd400=a0_0x398be0,_0x269121=this['nextAllowedTime'][_0xedd400(0xf4)](_0x1bd8f0)||0x0,_0x38bd8a=this[_0xedd400(0xfe)][_0xedd400(0xf4)](_0x1bd8f0)||0x0,_0x2977d8=Date['now']();return{'serviceModel':_0x1bd8f0,'nextAllowedTime':_0x269121,'nextAllowedDate':_0x269121>0x0?new Date(_0x269121)[_0xedd400(0xe2)]():null,'remainingDelayMs':Math[_0xedd400(0xe6)](0x0,_0x269121-_0x2977d8),'canSendNow':_0x2977d8>=_0x269121,'consecutiveRateLimitHits':_0x38bd8a};}['getAllStatus'](){const _0x41c971=a0_0x398be0,_0x246f8c=new Set([...this['nextAllowedTime'][_0x41c971(0xe1)](),...this[_0x41c971(0xfe)]['keys']()]),_0x2135ce={};for(const _0x277f89 of _0x246f8c){_0x2135ce[_0x277f89]=this[_0x41c971(0xc8)](_0x277f89);}return _0x2135ce;}['clear'](){const _0xc0a70a=a0_0x398be0;this[_0xc0a70a(0xf9)][_0xc0a70a(0xc7)](),this['rateLimitHits']['clear'](),this['logger']['info']('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0xa93364,_0x4466da){const _0x805b2=a0_0x398be0;this[_0x805b2(0xc3)]=_0xa93364,this[_0x805b2(0xd1)]=_0x4466da,this[_0x805b2(0xf6)]=new RateLimitService(_0x4466da),this[_0x805b2(0xff)]=new BudgetService(_0xa93364,_0x4466da),this['serviceInstances']=new Map(),this['conversationServices']=new Map(),this['serviceStatus']=new Map();}async[a0_0x398be0(0xbd)](_0x5b680d,_0xc23440,_0x15fecd){const _0x2928c4=a0_0x398be0,_0x3ed8b8=this['conversationServices']['get'](_0x5b680d);if(!_0x3ed8b8)throw new Error(_0x2928c4(0xcd)+_0x5b680d+_0x2928c4(0xc5));const _0x45583b=this['serviceInstances'][_0x2928c4(0xf4)](_0x3ed8b8);if(!_0x45583b)throw new Error(_0x2928c4(0xe7)+_0x3ed8b8+'\x20not\x20found\x20for\x20conversation\x20'+_0x5b680d);const _0x44347f=this['_getServiceModelId'](_0x3ed8b8);await this['rateLimitService'][_0x2928c4(0xfc)](_0x44347f);const _0x5931df=this['config'][_0x2928c4(0xe5)]?.[_0x2928c4(0xcb)]||0x3;let _0x4d0a32=0x0,_0x367ffc=null;while(_0x4d0a32<=_0x5931df){try{const _0x347fc9=await _0x45583b['sendMessage'](_0x5b680d,_0xc23440,_0x15fecd);return this[_0x2928c4(0xf6)][_0x2928c4(0xf3)](_0x44347f),await this['budgetService'][_0x2928c4(0xf1)](_0x3ed8b8,_0x45583b[_0x2928c4(0xd2)](),_0x45583b[_0x2928c4(0xd8)]()),this[_0x2928c4(0xeb)][_0x2928c4(0xf4)](_0x3ed8b8)===_0x2928c4(0xe4)&&this[_0x2928c4(0xeb)][_0x2928c4(0xd7)](_0x3ed8b8,_0x2928c4(0xbb)),_0x347fc9;}catch(_0x59055c){_0x367ffc=_0x59055c,this['logger'][_0x2928c4(0xe9)]('Request\x20failed\x20(attempt\x20'+(_0x4d0a32+0x1)+'/'+(_0x5931df+0x1)+'):',_0x59055c);if(this[_0x2928c4(0xee)](_0x59055c)){this[_0x2928c4(0xf6)]['handleRateLimitHit'](_0x44347f);if(_0x4d0a32<_0x5931df){this[_0x2928c4(0xd1)][_0x2928c4(0xca)]('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x2928c4(0xfc)](_0x44347f);continue;}}if(this['_isNonRetryableError'](_0x59055c))throw _0x59055c;if(_0x4d0a32>=_0x5931df)break;this['serviceStatus'][_0x2928c4(0xd7)](_0x3ed8b8,_0x2928c4(0xe4));const _0x3b9178=this['config']['retries']?.[_0x2928c4(0xdf)]||0x3e8,_0x9d20ed=this['config']['retries']?.[_0x2928c4(0xbf)]||0x2,_0x1838c6=_0x3b9178*Math['pow'](_0x9d20ed,_0x4d0a32);this[_0x2928c4(0xd1)]['info']('Retrying\x20after\x20'+_0x1838c6+'ms...'),await new Promise(_0x423b32=>setTimeout(_0x423b32,_0x1838c6)),_0x4d0a32++;}}throw new Error('All\x20retry\x20attempts\x20failed:\x20'+(_0x367ffc?.['message']||_0x2928c4(0xed)));}[a0_0x398be0(0xee)](_0x7c8f2){const _0x162d40=a0_0x398be0,_0x5b60f8=[_0x162d40(0xda),_0x162d40(0xc1),'quota\x20exceeded',_0x162d40(0xfd),_0x162d40(0xdc),'throttle'],_0x26fd16=_0x7c8f2['message']?.[_0x162d40(0xf5)]()||'';return _0x5b60f8['some'](_0x295e8c=>_0x26fd16[_0x162d40(0xdd)](_0x295e8c));}[a0_0x398be0(0xef)](_0x503267){const _0x2528be=a0_0x398be0,_0x4046a7=['invalid\x20api\x20key','authentication\x20failed',_0x2528be(0xc2),_0x2528be(0xd0),'invalid\x20request\x20format','content\x20policy'],_0x2544a6=_0x503267['message']?.[_0x2528be(0xf5)]()||'';return _0x4046a7['some'](_0x17731d=>_0x2544a6['includes'](_0x17731d));}[a0_0x398be0(0xf2)](_0x578e38){const _0x55089c={'anthropic':'anthropic-sonnet','openai':'openai-gpt4','google':'google-gemini'};return _0x55089c[_0x578e38]||_0x578e38;}[a0_0x398be0(0xfb)](){return this['rateLimitService']['getAllStatus']();}}