const a0_0x58899e=a0_0x3fa5;(function(_0x26212b,_0x46d4a3){const _0x4c73c0=a0_0x3fa5,_0xc8d30e=_0x26212b();while(!![]){try{const _0x489bda=parseInt(_0x4c73c0(0x1e8))/0x1+-parseInt(_0x4c73c0(0x1dd))/0x2+-parseInt(_0x4c73c0(0x1e7))/0x3+parseInt(_0x4c73c0(0x1d1))/0x4*(parseInt(_0x4c73c0(0x1f0))/0x5)+parseInt(_0x4c73c0(0x1ec))/0x6*(-parseInt(_0x4c73c0(0x1f3))/0x7)+parseInt(_0x4c73c0(0x1ee))/0x8+parseInt(_0x4c73c0(0x1e4))/0x9;if(_0x489bda===_0x46d4a3)break;else _0xc8d30e['push'](_0xc8d30e['shift']());}catch(_0xa8afa9){_0xc8d30e['push'](_0xc8d30e['shift']());}}}(a0_0x184d,0x2c552));export class RateLimitService{constructor(_0x3e74ec){const _0x1152a2=a0_0x3fa5;this[_0x1152a2(0x1d0)]=_0x3e74ec,this[_0x1152a2(0x1ce)]=new Map(),this[_0x1152a2(0x1cf)]=new Map(),this['INITIAL_RATE_LIMIT_DELAY']=0x7530,this['EXTENDED_RATE_LIMIT_DELAY']=0xea60,this[_0x1152a2(0x1e0)]=0x3e8;}[a0_0x58899e(0x1f6)](_0x29230b,_0x35c08c){const _0x1cec2a=a0_0x58899e,_0x5dc398=Date[_0x1cec2a(0x1fe)]()+_0x35c08c,_0x562c1b=this[_0x1cec2a(0x1ce)]['get'](_0x29230b)||0x0;_0x5dc398>_0x562c1b&&(this[_0x1cec2a(0x1ce)][_0x1cec2a(0x1fa)](_0x29230b,_0x5dc398),this[_0x1cec2a(0x1d0)]['info']('Rate\x20limit\x20delay\x20set\x20for\x20'+_0x29230b+':\x20'+_0x35c08c+'ms\x20(until\x20'+new Date(_0x5dc398)[_0x1cec2a(0x1f2)]()+')'));}['handleRateLimitHit'](_0x5e55e9){const _0x34bc63=a0_0x58899e,_0x4f0375=this['rateLimitHits']['get'](_0x5e55e9)||0x0,_0x3fa8e3=_0x4f0375+0x1;this['rateLimitHits']['set'](_0x5e55e9,_0x3fa8e3);let _0x40e85f;_0x3fa8e3===0x1?_0x40e85f=this[_0x34bc63(0x1d8)]:_0x40e85f=this['EXTENDED_RATE_LIMIT_DELAY'],this[_0x34bc63(0x1f6)](_0x5e55e9,_0x40e85f),this['logger']['warn']('Rate\x20limit\x20hit\x20#'+_0x3fa8e3+_0x34bc63(0x1d4)+_0x5e55e9+_0x34bc63(0x1da)+_0x40e85f+'ms\x20delay');}async['waitIfNeeded'](_0x28d614){const _0x1d3315=a0_0x58899e,_0x125c88=this['nextAllowedTime'][_0x1d3315(0x1ff)](_0x28d614)||0x0,_0x42e8a9=Date[_0x1d3315(0x1fe)]();if(_0x42e8a9>=_0x125c88){this[_0x1d3315(0x1d0)]['debug'](_0x28d614+_0x1d3315(0x1ef));return;}const _0x3beb68=_0x125c88-_0x42e8a9,_0x514f28=_0x3beb68+this['CHECK_INTERVAL'];this[_0x1d3315(0x1d0)][_0x1d3315(0x1e2)](_0x28d614+':\x20Waiting\x20'+_0x514f28+'ms\x20before\x20sending\x20(until\x20'+new Date(_0x125c88+this[_0x1d3315(0x1e0)])['toISOString']()+')'),await new Promise(_0x2d2e00=>setTimeout(_0x2d2e00,_0x514f28));}['resetRateLimitHits'](_0x2b0188){const _0x3502b3=a0_0x58899e;this[_0x3502b3(0x1cf)]['has'](_0x2b0188)&&(this['rateLimitHits'][_0x3502b3(0x1d5)](_0x2b0188),this[_0x3502b3(0x1d0)][_0x3502b3(0x1f7)](_0x2b0188+':\x20Rate\x20limit\x20hits\x20reset\x20(successful\x20request)'));}[a0_0x58899e(0x1cd)](_0x5ef780){const _0x1e19f7=a0_0x58899e,_0x1a1651=this[_0x1e19f7(0x1ce)][_0x1e19f7(0x1ff)](_0x5ef780)||0x0,_0x404090=this['rateLimitHits'][_0x1e19f7(0x1ff)](_0x5ef780)||0x0,_0x24d737=Date[_0x1e19f7(0x1fe)]();return{'serviceModel':_0x5ef780,'nextAllowedTime':_0x1a1651,'nextAllowedDate':_0x1a1651>0x0?new Date(_0x1a1651)['toISOString']():null,'remainingDelayMs':Math[_0x1e19f7(0x200)](0x0,_0x1a1651-_0x24d737),'canSendNow':_0x24d737>=_0x1a1651,'consecutiveRateLimitHits':_0x404090};}[a0_0x58899e(0x1db)](){const _0x130549=a0_0x58899e,_0x1a5852=new Set([...this[_0x130549(0x1ce)][_0x130549(0x1eb)](),...this[_0x130549(0x1cf)][_0x130549(0x1eb)]()]),_0x5bd805={};for(const _0x53fa51 of _0x1a5852){_0x5bd805[_0x53fa51]=this[_0x130549(0x1cd)](_0x53fa51);}return _0x5bd805;}[a0_0x58899e(0x1d9)](){const _0x1a0f2a=a0_0x58899e;this[_0x1a0f2a(0x1ce)][_0x1a0f2a(0x1d9)](),this['rateLimitHits'][_0x1a0f2a(0x1d9)](),this['logger'][_0x1a0f2a(0x1e2)](_0x1a0f2a(0x1ea));}}function a0_0x184d(){const _0xd1a957=['mtC3mdyXnxDsvuz1Cq','D2fPDeLMtMvLzgvK','BxmUlI4','nJy1mtmWt01luwvl','mtGYodKZzgvdAMrI','CMv0CMLLCW','uMf0zsbSAw1PDgLUzYbZDgf0zsbJBgvHCMvK','A2v5CW','ntrQqMzss0G','x2DLDfnLCNzPy2vnB2rLBeLK','mJm1nJq0mefOBhbwua','oIbszwfKEsb0BYbZzw5KicHUBYbKzwXHEsbUzwvKzwqP','mty3nZG1nxPcAwzUsa','Cg93','Dg9ju09tDhjPBMC','mJC0mZm3ExfVA1zZ','uMvXDwvZDcbMywLSzwqGkgf0DgvTChqG','x2LZuMf0zuXPBwL0rxjYB3i','C2v0rgvSyxK','zgvIDwC','zxjYB3i','Bw9KzwWGBM90igzVDw5K','C2v0','CxvVDgeGzxHJzwvKzwq','yw50AhjVCgLJlxnVBM5LDa','C29Tzq','BM93','z2v0','Bwf4','vw5RBM93BIbLCNjVCG','Aw52ywXPzcbHCgKGA2v5','yNvKz2v0u2vYDMLJzq','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','z2v0u3rHDhvZ','BMv4DefSBg93zwruAw1L','CMf0zuXPBwL0sgL0CW','Bg9Nz2vY','nfjlqwnIra','C2vUze1LC3nHz2u','Dg9mB3DLCKnHC2u','igzVCIa','zgvSzxrL','CMf0zuXPBwL0u2vYDMLJzq','yxzHAwXHyMXL','su5jveLbtf9sqvrfx0XjtuLux0rftefz','y2XLyxi','lcbHChbSEwLUzYa','z2v0qwXSu3rHDhvZ','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','nta3ndC4wNLKz0Hi','igLZig5VDcbYzwDPC3rLCMvKihDPDgGGyw55ihnLCNzPy2u','BwvZC2fNzq','q0Hfq0TFsu5urvjwquW','C2vYDMLJzvn0yxr1CW','Aw5MBW','DgHYB3r0Bgu'];a0_0x184d=function(){return _0xd1a957;};return a0_0x184d();}function a0_0x3fa5(_0x30ccfe,_0x370d23){const _0x184df5=a0_0x184d();return a0_0x3fa5=function(_0x3fa595,_0x4df971){_0x3fa595=_0x3fa595-0x1cd;let _0x15dd4a=_0x184df5[_0x3fa595];if(a0_0x3fa5['ogBiZj']===undefined){var _0x455c8b=function(_0x3e74ec){const _0x29230b='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x35c08c='',_0x5dc398='';for(let _0x562c1b=0x0,_0x5e55e9,_0x4f0375,_0x3fa8e3=0x0;_0x4f0375=_0x3e74ec['charAt'](_0x3fa8e3++);~_0x4f0375&&(_0x5e55e9=_0x562c1b%0x4?_0x5e55e9*0x40+_0x4f0375:_0x4f0375,_0x562c1b++%0x4)?_0x35c08c+=String['fromCharCode'](0xff&_0x5e55e9>>(-0x2*_0x562c1b&0x6)):0x0){_0x4f0375=_0x29230b['indexOf'](_0x4f0375);}for(let _0x40e85f=0x0,_0x28d614=_0x35c08c['length'];_0x40e85f<_0x28d614;_0x40e85f++){_0x5dc398+='%'+('00'+_0x35c08c['charCodeAt'](_0x40e85f)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x5dc398);};a0_0x3fa5['pWumRC']=_0x455c8b,_0x30ccfe=arguments,a0_0x3fa5['ogBiZj']=!![];}const _0x362894=_0x184df5[0x0],_0x57d6d8=_0x3fa595+_0x362894,_0x2a7b25=_0x30ccfe[_0x57d6d8];return!_0x2a7b25?(_0x15dd4a=a0_0x3fa5['pWumRC'](_0x15dd4a),_0x30ccfe[_0x57d6d8]=_0x15dd4a):_0x15dd4a=_0x2a7b25,_0x15dd4a;},a0_0x3fa5(_0x30ccfe,_0x370d23);}export class EnhancedLLMService{constructor(_0xaff1e0,_0x44a849){this['config']=_0xaff1e0,this['logger']=_0x44a849,this['rateLimitService']=new RateLimitService(_0x44a849),this['budgetService']=new BudgetService(_0xaff1e0,_0x44a849),this['serviceInstances']=new Map(),this['conversationServices']=new Map(),this['serviceStatus']=new Map();}async[a0_0x58899e(0x1d2)](_0x59142f,_0x60a13c,_0x2db12a){const _0x42dd73=a0_0x58899e,_0x1b7ef3=this['conversationServices']['get'](_0x59142f);if(!_0x1b7ef3)throw new Error('Conversation\x20'+_0x59142f+_0x42dd73(0x1de));const _0x5c4829=this['serviceInstances'][_0x42dd73(0x1ff)](_0x1b7ef3);if(!_0x5c4829)throw new Error('Service\x20'+_0x1b7ef3+'\x20not\x20found\x20for\x20conversation\x20'+_0x59142f);const _0x1ebe81=this['_getServiceModelId'](_0x1b7ef3);await this[_0x42dd73(0x1d6)][_0x42dd73(0x1e5)](_0x1ebe81);const _0x51bd8e=this['config'][_0x42dd73(0x1e9)]?.['maxRetries']||0x3;let _0x28e680=0x0,_0x112b71=null;while(_0x28e680<=_0x51bd8e){try{const _0xdd225e=await _0x5c4829[_0x42dd73(0x1d2)](_0x59142f,_0x60a13c,_0x2db12a);return this['rateLimitService']['resetRateLimitHits'](_0x1ebe81),await this[_0x42dd73(0x203)]['recordUsage'](_0x1b7ef3,_0x5c4829['getLastInputTokenCount'](),_0x5c4829[_0x42dd73(0x204)]()),this[_0x42dd73(0x1e1)][_0x42dd73(0x1ff)](_0x1b7ef3)==='degraded'&&this['serviceStatus'][_0x42dd73(0x1fa)](_0x1b7ef3,_0x42dd73(0x1d7)),_0xdd225e;}catch(_0x5749de){_0x112b71=_0x5749de,this[_0x42dd73(0x1d0)][_0x42dd73(0x1f8)](_0x42dd73(0x1f4)+(_0x28e680+0x1)+'/'+(_0x51bd8e+0x1)+'):',_0x5749de);if(this[_0x42dd73(0x1f5)](_0x5749de)){this[_0x42dd73(0x1d6)]['handleRateLimitHit'](_0x1ebe81);if(_0x28e680<_0x51bd8e){this['logger'][_0x42dd73(0x1e2)]('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x42dd73(0x1e5)](_0x1ebe81);continue;}}if(this['_isNonRetryableError'](_0x5749de))throw _0x5749de;if(_0x28e680>=_0x51bd8e)break;this[_0x42dd73(0x1e1)]['set'](_0x1b7ef3,'degraded');const _0x47d168=this['config'][_0x42dd73(0x1e9)]?.['baseDelayMs']||0x3e8,_0x4b6176=this['config'][_0x42dd73(0x1e9)]?.['delayMultiplier']||0x2,_0x4abb47=_0x47d168*Math[_0x42dd73(0x1f1)](_0x4b6176,_0x28e680);this[_0x42dd73(0x1d0)][_0x42dd73(0x1e2)]('Retrying\x20after\x20'+_0x4abb47+_0x42dd73(0x1e6)),await new Promise(_0x2731ac=>setTimeout(_0x2731ac,_0x4abb47)),_0x28e680++;}}throw new Error('All\x20retry\x20attempts\x20failed:\x20'+(_0x112b71?.[_0x42dd73(0x1df)]||_0x42dd73(0x201)));}[a0_0x58899e(0x1f5)](_0x42ede4){const _0x29717c=a0_0x58899e,_0xf676dc=['rate\x20limit','too\x20many\x20requests',_0x29717c(0x1fb),'request\x20limit','429',_0x29717c(0x1e3)],_0x3da17c=_0x42ede4[_0x29717c(0x1df)]?.['toLowerCase']()||'';return _0xf676dc[_0x29717c(0x1fd)](_0x5f3ed7=>_0x3da17c['includes'](_0x5f3ed7));}['_isNonRetryableError'](_0x4ec8b2){const _0x9c4055=a0_0x58899e,_0x1b0c0c=[_0x9c4055(0x202),'authentication\x20failed','unauthorized',_0x9c4055(0x1f9),_0x9c4055(0x1dc),'content\x20policy'],_0x3f04ed=_0x4ec8b2['message']?.[_0x9c4055(0x1d3)]()||'';return _0x1b0c0c['some'](_0xec085b=>_0x3f04ed['includes'](_0xec085b));}[a0_0x58899e(0x1ed)](_0x1f4fa2){const _0x474682=a0_0x58899e,_0x2ce197={'anthropic':_0x474682(0x1fc),'openai':'openai-gpt4','google':'google-gemini'};return _0x2ce197[_0x1f4fa2]||_0x1f4fa2;}['getRateLimitingStatus'](){const _0x11713f=a0_0x58899e;return this[_0x11713f(0x1d6)]['getAllStatus']();}}