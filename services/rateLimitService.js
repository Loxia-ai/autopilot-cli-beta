function a0_0x76f6(){const _0x1eaf43=['CMf0zsbSAw1PDa','C2vYDMLJzvn0yxr1CW','zxjYB3i','CMf0zuXPBwL0sgL0CW','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','A2v5CW','Aw5JBhvKzxm','Dg9mB3DLCKnHC2u','BwvZC2fNzq','z2v0','mtu4mJC4odbKrgnNquG','q0Hfq0TFsu5urvjwquW','x2LZtM9UuMv0CNLHyMXLrxjYB3i','C2v0rgvSyxK','mtm4nty5ofvTzwzdwG','D2fYBG','uMf0zsbSAw1PDcbOAxqGiW','CxvVDgeGzxHJzwvKzwq','ndm1mtKWmhDQtwj0ra','BMv4DefSBg93zwruAw1L','x2LZuMf0zuXPBwL0rxjYB3i','AgfUzgXLuMf0zuXPBwL0sgL0','y29UDMvYC2f0Aw9Uu2vYDMLJzxm','BxmGkhvUDgLSia','yNvKz2v0u2vYDMLJzq','DgHYB3r0Bgu','C29Tzq','C2v0','mtqYmZq4mLLqy0ndAG','u2vYDMLJzsa','z2v0uMf0zuXPBwL0Aw5Nu3rHDhvZ','C2vUze1LC3nHz2u','Dg9ju09tDhjPBMC','D2fPDeLMtMvLzgvK','igzVCIa','y2XLyxi','Bg9Nz2vY','mZy0otaXnvrzDvzNEG','yw50AhjVCgLJlxnVBM5LDa','Aw52ywXPzcbYzxf1zxn0igzVCM1HDa','BxmGyMvMB3jLihnLBMrPBMCGkhvUDgLSia','z2v0qwXSu3rHDhvZ','mJG2odiXnMnisLjlua','zgvIDwC','mvzyz2LyzW','igLZig5VDcbYzwDPC3rLCMvKihDPDgGGyw55ihnLCNzPy2u','rvHuru5erurFuKfurv9msu1jvf9eruXbwq','CMv0CMLLCW','x2DLDfnLCNzPy2vnB2rLBeLK','Bwf4uMv0CMLLCW','z2v0u3rHDhvZ','uMv0CNLPBMCGywz0zxiG','Cg93','y29UzMLN','Aw5MBW','y29UDgvUDcbWB2XPy3K','oIbsyxrLigXPBwL0igHPDhmGCMvZzxqGkhn1y2nLC3nMDwWGCMvXDwvZDcK','zgvNCMfKzwq','mtu3mdi4n0feB1HbqW','CMf0zuXPBwL0u2vYDMLJzq','zgvSzxrL','Aw52ywXPzcbHCgKGA2v5'];a0_0x76f6=function(){return _0x1eaf43;};return a0_0x76f6();}const a0_0x50858c=a0_0x522d;function a0_0x522d(_0x5b7ed0,_0x5d320b){const _0x76f6b5=a0_0x76f6();return a0_0x522d=function(_0x522da4,_0x77231b){_0x522da4=_0x522da4-0x84;let _0x3e71fd=_0x76f6b5[_0x522da4];if(a0_0x522d['bCUxOE']===undefined){var _0x557323=function(_0x3c4f15){const _0x51633a='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x49bb84='',_0x27a3c7='';for(let _0x570f7b=0x0,_0x4f5b03,_0x5c9669,_0x48ab6a=0x0;_0x5c9669=_0x3c4f15['charAt'](_0x48ab6a++);~_0x5c9669&&(_0x4f5b03=_0x570f7b%0x4?_0x4f5b03*0x40+_0x5c9669:_0x5c9669,_0x570f7b++%0x4)?_0x49bb84+=String['fromCharCode'](0xff&_0x4f5b03>>(-0x2*_0x570f7b&0x6)):0x0){_0x5c9669=_0x51633a['indexOf'](_0x5c9669);}for(let _0xacc5d0=0x0,_0x1f7ff4=_0x49bb84['length'];_0xacc5d0<_0x1f7ff4;_0xacc5d0++){_0x27a3c7+='%'+('00'+_0x49bb84['charCodeAt'](_0xacc5d0)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x27a3c7);};a0_0x522d['xLetNt']=_0x557323,_0x5b7ed0=arguments,a0_0x522d['bCUxOE']=!![];}const _0x5e70d2=_0x76f6b5[0x0],_0x118ae1=_0x522da4+_0x5e70d2,_0x3d32aa=_0x5b7ed0[_0x118ae1];return!_0x3d32aa?(_0x3e71fd=a0_0x522d['xLetNt'](_0x3e71fd),_0x5b7ed0[_0x118ae1]=_0x3e71fd):_0x3e71fd=_0x3d32aa,_0x3e71fd;},a0_0x522d(_0x5b7ed0,_0x5d320b);}(function(_0xd25545,_0x1d3c89){const _0x175b4b=a0_0x522d,_0x9d37f7=_0xd25545();while(!![]){try{const _0x290440=-parseInt(_0x175b4b(0xba))/0x1*(parseInt(_0x175b4b(0x9c))/0x2)+-parseInt(_0x175b4b(0x8a))/0x3+parseInt(_0x175b4b(0xb8))/0x4+-parseInt(_0x175b4b(0xb3))/0x5+parseInt(_0x175b4b(0xaa))/0x6+-parseInt(_0x175b4b(0xa0))/0x7+parseInt(_0x175b4b(0x98))/0x8;if(_0x290440===_0x1d3c89)break;else _0x9d37f7['push'](_0x9d37f7['shift']());}catch(_0x35ec93){_0x9d37f7['push'](_0x9d37f7['shift']());}}}(a0_0x76f6,0x591cd));export class RateLimitService{constructor(_0x3c4f15){const _0x301562=a0_0x522d;this[_0x301562(0xb2)]=_0x3c4f15,this[_0x301562(0xa1)]=new Map(),this[_0x301562(0x91)]=new Map(),this['INITIAL_RATE_LIMIT_DELAY']=0x7530,this[_0x301562(0xbc)]=0xea60,this[_0x301562(0x99)]=0x3e8;}[a0_0x50858c(0x9b)](_0x51633a,_0x49bb84){const _0x3129b0=a0_0x50858c,_0x27a3c7=Date['now']()+_0x49bb84,_0x570f7b=this[_0x3129b0(0xa1)][_0x3129b0(0x97)](_0x51633a)||0x0;_0x27a3c7>_0x570f7b&&(this[_0x3129b0(0xa1)][_0x3129b0(0xa9)](_0x51633a,_0x27a3c7),this[_0x3129b0(0xb2)]['info']('Rate\x20limit\x20delay\x20set\x20for\x20'+_0x51633a+':\x20'+_0x49bb84+_0x3129b0(0xa5)+new Date(_0x27a3c7)[_0x3129b0(0xae)]()+')'));}[a0_0x50858c(0xa3)](_0x4f5b03){const _0x30ba26=a0_0x50858c,_0x5c9669=this[_0x30ba26(0x91)]['get'](_0x4f5b03)||0x0,_0x48ab6a=_0x5c9669+0x1;this['rateLimitHits'][_0x30ba26(0xa9)](_0x4f5b03,_0x48ab6a);let _0xacc5d0;_0x48ab6a===0x1?_0xacc5d0=this['INITIAL_RATE_LIMIT_DELAY']:_0xacc5d0=this['EXTENDED_RATE_LIMIT_DELAY'],this['setDelay'](_0x4f5b03,_0xacc5d0),this['logger'][_0x30ba26(0x9d)](_0x30ba26(0x9e)+_0x48ab6a+_0x30ba26(0xb0)+_0x4f5b03+',\x20applying\x20'+_0xacc5d0+'ms\x20delay');}async['waitIfNeeded'](_0x1f7ff4){const _0x7319aa=a0_0x50858c,_0x48eecf=this['nextAllowedTime']['get'](_0x1f7ff4)||0x0,_0x1bfa9e=Date['now']();if(_0x1bfa9e>=_0x48eecf){this['logger'][_0x7319aa(0xb9)](_0x1f7ff4+':\x20Ready\x20to\x20send\x20(no\x20delay\x20needed)');return;}const _0x753f6a=_0x48eecf-_0x1bfa9e,_0x2b8753=_0x753f6a+this[_0x7319aa(0x99)];this[_0x7319aa(0xb2)][_0x7319aa(0x86)](_0x1f7ff4+':\x20Waiting\x20'+_0x2b8753+_0x7319aa(0xb6)+new Date(_0x48eecf+this['CHECK_INTERVAL'])[_0x7319aa(0xae)]()+')'),await new Promise(_0x28eaf2=>setTimeout(_0x28eaf2,_0x2b8753));}['resetRateLimitHits'](_0x51fa31){const _0x4c3157=a0_0x50858c;this['rateLimitHits']['has'](_0x51fa31)&&(this['rateLimitHits'][_0x4c3157(0x8c)](_0x51fa31),this[_0x4c3157(0xb2)][_0x4c3157(0xb9)](_0x51fa31+_0x4c3157(0x88)));}[a0_0x50858c(0xc0)](_0x13caca){const _0x30079a=a0_0x50858c,_0x5dabad=this['nextAllowedTime'][_0x30079a(0x97)](_0x13caca)||0x0,_0x31ae88=this['rateLimitHits'][_0x30079a(0x97)](_0x13caca)||0x0,_0x789fd6=Date['now']();return{'serviceModel':_0x13caca,'nextAllowedTime':_0x5dabad,'nextAllowedDate':_0x5dabad>0x0?new Date(_0x5dabad)['toISOString']():null,'remainingDelayMs':Math['max'](0x0,_0x5dabad-_0x789fd6),'canSendNow':_0x789fd6>=_0x5dabad,'consecutiveRateLimitHits':_0x31ae88};}[a0_0x50858c(0xb7)](){const _0x48a954=a0_0x50858c,_0x88be73=new Set([...this['nextAllowedTime'][_0x48a954(0x93)](),...this['rateLimitHits']['keys']()]),_0x1d2b1c={};for(const _0x49cf53 of _0x88be73){_0x1d2b1c[_0x49cf53]=this[_0x48a954(0xc0)](_0x49cf53);}return _0x1d2b1c;}['clear'](){const _0x4c508d=a0_0x50858c;this[_0x4c508d(0xa1)][_0x4c508d(0xb1)](),this['rateLimitHits'][_0x4c508d(0xb1)](),this['logger']['info']('Rate\x20limiting\x20state\x20cleared');}}export class EnhancedLLMService{constructor(_0x211ff7,_0x5eeb5b){const _0x222445=a0_0x50858c;this[_0x222445(0x85)]=_0x211ff7,this['logger']=_0x5eeb5b,this[_0x222445(0x8b)]=new RateLimitService(_0x5eeb5b),this[_0x222445(0xa6)]=new BudgetService(_0x211ff7,_0x5eeb5b),this['serviceInstances']=new Map(),this[_0x222445(0xa4)]=new Map(),this[_0x222445(0x8f)]=new Map();}async[a0_0x50858c(0xad)](_0x2d7ad1,_0x2f71d5,_0x240d67){const _0x5cb521=a0_0x50858c,_0x5d514e=this[_0x5cb521(0xa4)]['get'](_0x2d7ad1);if(!_0x5d514e)throw new Error('Conversation\x20'+_0x2d7ad1+_0x5cb521(0xbb));const _0x3fd65b=this['serviceInstances']['get'](_0x5d514e);if(!_0x3fd65b)throw new Error(_0x5cb521(0xab)+_0x5d514e+'\x20not\x20found\x20for\x20conversation\x20'+_0x2d7ad1);const _0x19a7dc=this['_getServiceModelId'](_0x5d514e);await this['rateLimitService']['waitIfNeeded'](_0x19a7dc);const _0x59d7c2=this[_0x5cb521(0x85)]['retries']?.[_0x5cb521(0xbf)]||0x3;let _0xfbebd5=0x0,_0x5904c6=null;while(_0xfbebd5<=_0x59d7c2){try{const _0x2ce76c=await _0x3fd65b[_0x5cb521(0xad)](_0x2d7ad1,_0x2f71d5,_0x240d67);return this[_0x5cb521(0x8b)]['resetRateLimitHits'](_0x19a7dc),await this[_0x5cb521(0xa6)]['recordUsage'](_0x5d514e,_0x3fd65b['getLastInputTokenCount'](),_0x3fd65b[_0x5cb521(0x92)]()),this['serviceStatus'][_0x5cb521(0x97)](_0x5d514e)==='degraded'&&this['serviceStatus']['set'](_0x5d514e,'available'),_0x2ce76c;}catch(_0x39506c){_0x5904c6=_0x39506c,this[_0x5cb521(0xb2)][_0x5cb521(0x90)]('Request\x20failed\x20(attempt\x20'+(_0xfbebd5+0x1)+'/'+(_0x59d7c2+0x1)+'):',_0x39506c);if(this['_isRateLimitError'](_0x39506c)){this['rateLimitService']['handleRateLimitHit'](_0x19a7dc);if(_0xfbebd5<_0x59d7c2){this[_0x5cb521(0xb2)]['info']('Rate\x20limit\x20error\x20detected,\x20waiting\x20and\x20retrying...'),await this['rateLimitService'][_0x5cb521(0xaf)](_0x19a7dc);continue;}}if(this[_0x5cb521(0x9a)](_0x39506c))throw _0x39506c;if(_0xfbebd5>=_0x59d7c2)break;this['serviceStatus']['set'](_0x5d514e,_0x5cb521(0x89));const _0x92201e=this['config'][_0x5cb521(0xbd)]?.['baseDelayMs']||0x3e8,_0x47b2af=this['config']['retries']?.['delayMultiplier']||0x2,_0x28c85d=_0x92201e*Math[_0x5cb521(0x84)](_0x47b2af,_0xfbebd5);this['logger']['info'](_0x5cb521(0xc1)+_0x28c85d+'ms...'),await new Promise(_0x4af194=>setTimeout(_0x4af194,_0x28c85d)),_0xfbebd5++;}}throw new Error('All\x20retry\x20attempts\x20failed:\x20'+(_0x5904c6?.['message']||'Unknown\x20error'));}[a0_0x50858c(0xa2)](_0x30800f){const _0x500fe4=a0_0x50858c,_0x159fc5=[_0x500fe4(0x8e),'too\x20many\x20requests',_0x500fe4(0x9f),'request\x20limit','429',_0x500fe4(0xa7)],_0x1876f3=_0x30800f['message']?.[_0x500fe4(0x95)]()||'';return _0x159fc5[_0x500fe4(0xa8)](_0x587d16=>_0x1876f3['includes'](_0x587d16));}['_isNonRetryableError'](_0x49816e){const _0x3b93b5=a0_0x50858c,_0x423232=[_0x3b93b5(0x8d),'authentication\x20failed','unauthorized','model\x20not\x20found',_0x3b93b5(0xb5),_0x3b93b5(0x87)],_0x24fa55=_0x49816e[_0x3b93b5(0x96)]?.[_0x3b93b5(0x95)]()||'';return _0x423232['some'](_0x521a95=>_0x24fa55[_0x3b93b5(0x94)](_0x521a95));}[a0_0x50858c(0xbe)](_0x555ad1){const _0x27a0d1=a0_0x50858c,_0x2bbcc6={'anthropic':_0x27a0d1(0xb4),'openai':'openai-gpt4','google':'google-gemini'};return _0x2bbcc6[_0x555ad1]||_0x555ad1;}[a0_0x50858c(0xac)](){const _0x544a37=a0_0x50858c;return this['rateLimitService'][_0x544a37(0xb7)]();}}