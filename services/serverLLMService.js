const a0_0x4439d1=a0_0x4160;(function(_0x25a638,_0x3f3595){const _0x114266=a0_0x4160,_0x154afb=_0x25a638();while(!![]){try{const _0x37c89e=-parseInt(_0x114266(0x146))/0x1*(parseInt(_0x114266(0xf9))/0x2)+parseInt(_0x114266(0xa2))/0x3+parseInt(_0x114266(0x136))/0x4+parseInt(_0x114266(0xb0))/0x5+-parseInt(_0x114266(0xdd))/0x6*(parseInt(_0x114266(0xbb))/0x7)+parseInt(_0x114266(0xca))/0x8*(parseInt(_0x114266(0xc6))/0x9)+-parseInt(_0x114266(0xf0))/0xa*(parseInt(_0x114266(0xda))/0xb);if(_0x37c89e===_0x3f3595)break;else _0x154afb['push'](_0x154afb['shift']());}catch(_0x1a5c72){_0x154afb['push'](_0x154afb['shift']());}}}(a0_0x49d9,0xdc139));import a0_0x30c0e2 from'node-fetch';function a0_0x4160(_0x56ccf8,_0x17aa2c){const _0x49d94=a0_0x49d9();return a0_0x4160=function(_0x41607b,_0x5cffc7){_0x41607b=_0x41607b-0x9c;let _0x4c6312=_0x49d94[_0x41607b];if(a0_0x4160['YZaXAz']===undefined){var _0x19abed=function(_0x30c0e2){const _0x2274a7='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x383264='',_0x1ad640='';for(let _0x1876da=0x0,_0x572370,_0x28c838,_0x44381e=0x0;_0x28c838=_0x30c0e2['charAt'](_0x44381e++);~_0x28c838&&(_0x572370=_0x1876da%0x4?_0x572370*0x40+_0x28c838:_0x28c838,_0x1876da++%0x4)?_0x383264+=String['fromCharCode'](0xff&_0x572370>>(-0x2*_0x1876da&0x6)):0x0){_0x28c838=_0x2274a7['indexOf'](_0x28c838);}for(let _0x1894b0=0x0,_0x2ea79c=_0x383264['length'];_0x1894b0<_0x2ea79c;_0x1894b0++){_0x1ad640+='%'+('00'+_0x383264['charCodeAt'](_0x1894b0)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x1ad640);};a0_0x4160['oQnMqH']=_0x19abed,_0x56ccf8=arguments,a0_0x4160['YZaXAz']=!![];}const _0x277507=_0x49d94[0x0],_0x12c53f=_0x41607b+_0x277507,_0x5c4055=_0x56ccf8[_0x12c53f];return!_0x5c4055?(_0x4c6312=a0_0x4160['oQnMqH'](_0x4c6312),_0x56ccf8[_0x12c53f]=_0x4c6312):_0x4c6312=_0x5c4055,_0x4c6312;},a0_0x4160(_0x56ccf8,_0x17aa2c);}const DEFAULT_TIMEOUT_MS=0xea60,DEFAULT_MAX_RETRIES=0x3,DEFAULT_RETRY_DELAY_MS=0x7530,RETRY_DELAY_MULTIPLIER=0x2,API_VERSION='v1',HTTP_STATUS={'OK':0xc8,'CREATED':0xc9,'BAD_REQUEST':0x190,'UNAUTHORIZED':0x191,'FORBIDDEN':0x193,'NOT_FOUND':0x194,'TOO_MANY_REQUESTS':0x1ad,'INTERNAL_SERVER_ERROR':0x1f4,'BAD_GATEWAY':0x1f6,'SERVICE_UNAVAILABLE':0x1f7,'GATEWAY_TIMEOUT':0x1f8},ERROR_TYPES={'AUTHENTICATION':'authentication','NETWORK':a0_0x4439d1(0xa9),'TIMEOUT':a0_0x4439d1(0x14f),'RATE_LIMIT':a0_0x4439d1(0xd7),'SERVER':'server','VALIDATION':'validation','UNKNOWN':'unknown'},HTTP_STATUS_CODES={'REQUEST_ENTITY_TOO_LARGE':0x19d,'BAD_REQUEST':0x190,'UNAUTHORIZED':0x191,'FORBIDDEN':0x193,'NOT_FOUND':0x194,'TOO_MANY_REQUESTS':0x1ad,'INTERNAL_SERVER_ERROR':0x1f4},REQUEST_SIZE_ERROR_PATTERNS=['request\x20entity\x20too\x20large','payload\x20too\x20large','request\x20too\x20large','message\x20too\x20long','content\x20length\x20exceeds\x20limit'];export class ServerLLMService{constructor(_0x2274a7,_0x383264){const _0x20ff4f=a0_0x4439d1;this[_0x20ff4f(0xe9)]=_0x2274a7,this['logger']=_0x383264,this[_0x20ff4f(0x159)]=this['_validateServerUrl'](_0x2274a7[_0x20ff4f(0x159)]),this[_0x20ff4f(0xfd)]=null,this['isInitialized']=![],this[_0x20ff4f(0x14f)]=_0x2274a7['services']?.['server']?.['timeout']||DEFAULT_TIMEOUT_MS,this['maxRetries']=_0x2274a7[_0x20ff4f(0x150)]?.['server']?.['retries']||DEFAULT_MAX_RETRIES,this['requestId']=0x0,this[_0x20ff4f(0xcc)]=new Map(),this[_0x20ff4f(0x140)]=new Map(),this[_0x20ff4f(0xf4)]=null,this['conversations']=new Map(),this[_0x20ff4f(0x104)]=0x0,this['lastOutputTokenCount']=0x0,this[_0x20ff4f(0x153)]={'input':0x0,'output':0x0},this[_0x20ff4f(0x111)]['info']('Server\x20LLM\x20service\x20initialized',{'serverUrl':this[_0x20ff4f(0x159)],'timeout':this[_0x20ff4f(0x14f)],'maxRetries':this[_0x20ff4f(0xae)]});}['_validateServerUrl'](_0x1ad640){const _0x74168=a0_0x4439d1;if(!_0x1ad640)throw new Error(_0x74168(0xe3));try{const _0x1876da=new URL(_0x1ad640);if(!['http:',_0x74168(0xf8)]['includes'](_0x1876da[_0x74168(0x158)]))throw new Error(_0x74168(0xd1));return _0x1876da['toString']()[_0x74168(0xc2)](/\/$/,'');}catch(_0x572370){throw new Error('Invalid\x20server\x20URL:\x20'+_0x572370['message']);}}[a0_0x4439d1(0x12a)](_0x28c838){const _0x193f17=a0_0x4439d1;if(!_0x28c838||typeof _0x28c838!==_0x193f17(0x11b))return'conversation-'+Date['now']();let _0x44381e=_0x28c838['replace'](/\s+/g,'-')[_0x193f17(0xc2)](/[^a-zA-Z0-9_-]/g,'')[_0x193f17(0xc2)](/-+/g,'-')['replace'](/^-+|-+$/g,'')['toLowerCase']();if(!_0x44381e)_0x44381e=_0x193f17(0xc5)+Date[_0x193f17(0xfe)]();else _0x44381e[_0x193f17(0x11e)]>0x32&&(_0x44381e=_0x44381e[_0x193f17(0x131)](0x0,0x28)+'-'+Date[_0x193f17(0xfe)]()[_0x193f17(0x9e)]()['slice'](-0x8));return _0x44381e;}async['initialize'](){const _0x3fd106=a0_0x4439d1;if(this['isInitialized'])return;try{this['logger']['info'](_0x3fd106(0xff)),this[_0x3fd106(0xfd)]=await this[_0x3fd106(0xaa)]();if(!this[_0x3fd106(0xfd)])throw new Error(_0x3fd106(0x123));await this['_loadServerData'](),this['isInitialized']=!![],this[_0x3fd106(0x111)][_0x3fd106(0xdf)]('Server\x20LLM\x20service\x20initialized\x20successfully',{'modelsLoaded':this['availableModels'][_0x3fd106(0xf2)],'pricingModels':this[_0x3fd106(0x140)][_0x3fd106(0xf2)]});}catch(_0x1894b0){this[_0x3fd106(0x111)][_0x3fd106(0x154)](_0x3fd106(0xf7),_0x1894b0);throw _0x1894b0;}}async[a0_0x4439d1(0xb7)](){const _0x5ec9f7=a0_0x4439d1;await Promise[_0x5ec9f7(0xea)]([this[_0x5ec9f7(0xe1)](),this[_0x5ec9f7(0xd8)]()]),this[_0x5ec9f7(0x14d)]=!![];}async['_loadApiKey'](){const _0x12bb36=a0_0x4439d1;try{const _0x2ea79c=await import('os'),_0x288f14=await import(_0x12bb36(0x15a)),_0x583bd4=await import(_0x12bb36(0x139)),_0x3a7a2b=_0x288f14[_0x12bb36(0x100)](_0x2ea79c['homedir'](),'.loxia',_0x12bb36(0x14a)),_0x550f85=await _0x583bd4['readFile'](_0x3a7a2b,_0x12bb36(0xbc)),_0x59c8cb=JSON['parse'](_0x550f85);return this[_0x12bb36(0x10b)](_0x59c8cb[_0x12bb36(0xfd)]);}catch(_0x3c59c5){return this['logger'][_0x12bb36(0xd4)]('Failed to load API key from credentials file:',_0x3c59c5),null;}}async['_validateApiKey'](){const _0x51d0dd=a0_0x4439d1;try{const _0x544928=await this[_0x51d0dd(0x137)]('/auth/verify',{'method':'POST'});return _0x544928['ok'];}catch(_0x32d117){return this[_0x51d0dd(0x111)][_0x51d0dd(0xc1)](_0x51d0dd(0x14e),_0x32d117),![];}}async['_loadAvailableModels'](){const _0x2f9897=a0_0x4439d1;try{this['logger'][_0x2f9897(0xdf)]('Loading available models from server');const _0x185999=await this['_makeRequest'](_0x2f9897(0x130)),_0xa7d891=await _0x185999[_0x2f9897(0x114)]();if(!_0xa7d891['models']||!Array['isArray'](_0xa7d891[_0x2f9897(0xa3)]))throw new Error('Invalid models response from server');this[_0x2f9897(0xcc)][_0x2f9897(0x13e)]();for(const _0x2b82d1 of _0xa7d891[_0x2f9897(0xa3)]){this[_0x2f9897(0x148)](_0x2b82d1),this['availableModels']['set'](_0x2b82d1[_0x2f9897(0xaf)],{'name':_0x2b82d1['name'],'category':_0x2b82d1[_0x2f9897(0x12c)],'type':_0x2b82d1[_0x2f9897(0xdc)],'maxTokens':_0x2b82d1[_0x2f9897(0x14b)],'supportsVision':_0x2b82d1['supportsVision']||![],'supportsSystem':_0x2b82d1[_0x2f9897(0xeb)]!==![],'pricing':_0x2b82d1[_0x2f9897(0xa4)]||{}});}this[_0x2f9897(0x111)][_0x2f9897(0xdf)](_0x2f9897(0xe7)+this[_0x2f9897(0xcc)][_0x2f9897(0xf2)]+_0x2f9897(0x103));}catch(_0x2b47fa){this['logger']['error'](_0x2f9897(0xf1),_0x2b47fa);throw new Error(_0x2f9897(0x126)+_0x2b47fa['message']);}}[a0_0x4439d1(0x148)](_0x374dcb){const _0x50f43a=a0_0x4439d1,requiredFields=['name','category','type'];for(const _0x2a6390 of requiredFields){if(!_0x374dcb[_0x2a6390])throw new Error(_0x50f43a(0x143)+_0x2a6390);}if(_0x374dcb['type']!==_0x50f43a(0xe6)){if(typeof _0x374dcb['maxTokens']!=='number'||_0x374dcb['maxTokens']<=0x0)throw new Error(_0x50f43a(0x119)+_0x374dcb['name']);}}async['_loadPricingData'](){const _0x2e197f=a0_0x4439d1;try{this['logger']['info']('Loading pricing data from server');const _0x16eb08=await this[_0x2e197f(0x137)]('/usage/pricing'),_0x349b4d=await _0x16eb08[_0x2e197f(0x114)]();if(!_0x349b4d['pricing'])throw new Error('Invalid pricing response from server');this[_0x2e197f(0x140)][_0x2e197f(0x13e)]();for(const [_0x494388,_0x42c361]of Object['entries'](_0x349b4d['pricing'])){this[_0x2e197f(0x138)](_0x494388,_0x42c361),this[_0x2e197f(0x140)][_0x2e197f(0xed)](_0x494388,{'input':_0x42c361['input'],'output':_0x42c361['output'],'unit':_0x42c361[_0x2e197f(0xb1)]||'1K\x20tokens','currency':_0x42c361['currency']||_0x2e197f(0x128)});}this[_0x2e197f(0xf4)]=new Date()['toISOString'](),this[_0x2e197f(0x111)]['info']('Loaded\x20pricing\x20for\x20'+this[_0x2e197f(0x140)][_0x2e197f(0xf2)]+_0x2e197f(0xe5));}catch(_0x4b10a4){this[_0x2e197f(0x111)][_0x2e197f(0x154)](_0x2e197f(0xbe),_0x4b10a4);throw new Error(_0x2e197f(0xbd)+_0x4b10a4['message']);}}['_validatePricingData'](_0x530c08,_0xc6c400){const _0x450232=a0_0x4439d1;if(typeof _0xc6c400['input']!==_0x450232(0x110)||_0xc6c400[_0x450232(0x108)]<0x0)throw new Error('Invalid\x20input\x20pricing\x20for\x20model\x20'+_0x530c08);if(typeof _0xc6c400['output']!=='number'||_0xc6c400['output']<0x0)throw new Error(_0x450232(0x144)+_0x530c08);}async['getAvailableModels'](){const _0x118eea=a0_0x4439d1;!this[_0x118eea(0x14d)]&&await this['_loadServerData']();let _0x3e72dc=Array['from'](this['availableModels'][_0x118eea(0x152)]());return _0x3e72dc;}async['getPricingData'](){const _0x268f55=a0_0x4439d1;return!this[_0x268f55(0x14d)]&&await this['_loadServerData'](),new Map(this['pricingData']);}['getModelPricing'](_0x239f1){return this['pricingData']['get'](_0x239f1)||null;}[a0_0x4439d1(0xde)](_0xb1e94f){const _0x263e43=a0_0x4439d1;return typeof _0xb1e94f===_0x263e43(0x11b)&&_0xb1e94f['length']>0x0&&_0xb1e94f[_0x263e43(0x11e)]<=0x64&&/^[a-zA-Z0-9_-]+$/['test'](_0xb1e94f);}async['registerConversation'](_0x1d960b,_0x3ca153,_0x45d7eb=null){const _0x5a4e98=a0_0x4439d1,_0x26db10=_0x45d7eb||this['_getDefaultModel']();this['logger'][_0x5a4e98(0xdf)](_0x5a4e98(0xb5)+_0x1d960b);const _0x5b3d43=this['_sanitizeConversationId'](_0x1d960b);_0x5b3d43!==_0x1d960b&&this['logger']['info']('Sanitized\x20conversation\x20ID\x20from\x20\x22'+_0x1d960b+_0x5a4e98(0xce)+_0x5b3d43+'\x22');if(!this[_0x5a4e98(0xde)](_0x5b3d43))throw new Error('Failed\x20to\x20create\x20valid\x20conversation\x20ID\x20from:\x20'+_0x1d960b);this['conversations'][_0x5a4e98(0xed)](_0x5b3d43,{'originalId':_0x1d960b,'systemPrompt':_0x3ca153||'','messages':[],'model':_0x26db10,'createdAt':new Date()[_0x5a4e98(0xc9)](),'lastActivity':new Date()[_0x5a4e98(0xc9)]()}),_0x5b3d43!==_0x1d960b&&this['conversations']['set'](_0x1d960b,this['conversations'][_0x5a4e98(0xb4)](_0x5b3d43));}['_getDefaultModel'](){const _0x13f9f6=a0_0x4439d1,_0x515cae=[_0x13f9f6(0xab),_0x13f9f6(0x102),_0x13f9f6(0xf3)];for(const _0x272994 of _0x515cae){if(this[_0x13f9f6(0xcc)][_0x13f9f6(0xa1)](_0x272994))return _0x272994;}const _0x13105a=this[_0x13f9f6(0xcc)][_0x13f9f6(0x152)]()['next']()['value'];return _0x13105a?_0x13105a[_0x13f9f6(0xaf)]:_0x13f9f6(0xab);}async[a0_0x4439d1(0x113)](_0x1d47da,_0x52f68e,_0x28f86c){const _0x55ce8b=a0_0x4439d1;this['logger']['info'](_0x55ce8b(0xe0)+_0x1d47da);if(!this['isInitialized'])throw new Error('Service\x20not\x20initialized.\x20Call\x20initialize()\x20first.');if(!this[_0x55ce8b(0xfd)])throw new Error(_0x55ce8b(0x118));this[_0x55ce8b(0xd5)](_0x1d47da,_0x52f68e);const _0x40d4b6=this['_sanitizeConversationId'](_0x1d47da),_0x133280=this[_0x55ce8b(0xcb)][_0x55ce8b(0xa1)](_0x1d47da)?_0x1d47da:_0x40d4b6;if(!this[_0x55ce8b(0xcb)]['has'](_0x133280))throw new Error(_0x55ce8b(0x121)+_0x1d47da+'\x20not\x20found');const _0x146534=this['conversations']['get'](_0x133280);_0x28f86c&&(!_0x146534['messages']||_0x146534['messages']['length']===0x0)&&this[_0x55ce8b(0x11d)](_0x146534,_0x28f86c);const _0x467a1a=this['_buildChatRequestPayload'](_0x40d4b6,_0x52f68e,_0x146534);try{const _0x577118=await this['_sendChatRequest'](_0x467a1a);return this[_0x55ce8b(0x122)](_0x146534,_0x52f68e,_0x577118),_0x577118[_0x55ce8b(0x156)];}catch(_0xb4850e){this['logger'][_0x55ce8b(0x154)]('Error\x20sending\x20message\x20to\x20server:',_0xb4850e);throw this['_enhanceError'](_0xb4850e,_0x55ce8b(0x107));}}[a0_0x4439d1(0xd5)](_0x4b3210,_0x3241f1){const _0x4267d4=a0_0x4439d1;if(!_0x4b3210||typeof _0x4b3210!=='string')throw new Error(_0x4267d4(0xb2));if(!_0x3241f1||typeof _0x3241f1!==_0x4267d4(0x11b))throw new Error(_0x4267d4(0xb3));}['_updateConversationState'](_0x26d8da,_0x187700){const _0x47d634=a0_0x4439d1;_0x187700[_0x47d634(0x13c)]&&Array['isArray'](_0x187700['messages'])&&(_0x26d8da[_0x47d634(0x13c)]=_0x187700[_0x47d634(0x13c)]),_0x187700['systemPrompt']&&typeof _0x187700['systemPrompt']===_0x47d634(0x11b)&&(_0x26d8da[_0x47d634(0x142)]=_0x187700['systemPrompt']),_0x187700[_0x47d634(0x101)]&&this[_0x47d634(0xcc)]['has'](_0x187700['model'])&&(_0x26d8da['model']=_0x187700[_0x47d634(0x101)]),_0x26d8da[_0x47d634(0xee)]=new Date()[_0x47d634(0xc9)]();}[a0_0x4439d1(0x12d)](_0x3866ae,_0x93eed0,_0x1437cb){const _0x2ff348=a0_0x4439d1;return{'conversationId':_0x3866ae,'message':_0x93eed0[_0x2ff348(0xec)](),'systemPrompt':_0x1437cb['systemPrompt'],'messages':_0x1437cb[_0x2ff348(0x13c)]||[],'model':_0x1437cb[_0x2ff348(0x101)],'requestId':this['_generateRequestId'](),'options':{'temperature':0.7,'maxTokens':this['_getModelMaxTokens'](_0x1437cb['model'])}};}[a0_0x4439d1(0x10a)](){const _0x2129f7=a0_0x4439d1;return _0x2129f7(0xb8)+Date['now']()+'_'+ ++this['requestId'];}[a0_0x4439d1(0x13f)](_0x79f8c1){const _0x47878f=a0_0x4439d1,_0x5f5e01=this['availableModels'][_0x47878f(0xb4)](_0x79f8c1);return _0x5f5e01?_0x5f5e01[_0x47878f(0x14b)]:0xfa0;}async['_sendChatRequest'](_0x331317){const _0x487827=a0_0x4439d1;try{const _0x1bf2ea=await this['_makeRequest']('/llm/chat',{'method':'POST','body':JSON['stringify'](_0x331317)});if(!_0x1bf2ea['ok']){const _0x37c06f=await this[_0x487827(0xa0)](_0x1bf2ea),_0x15a18c=this['_createHttpError'](_0x1bf2ea[_0x487827(0xe4)],_0x37c06f['error']||_0x1bf2ea[_0x487827(0xba)]);throw _0x15a18c;}const _0x2cee04=await _0x1bf2ea['json']();return this['_validateChatResponse'](_0x2cee04),_0x2cee04;}catch(_0x477220){throw _0x477220;}}['_validateChatResponse'](_0x321d50){const _0x27ce41=a0_0x4439d1;if(!_0x321d50[_0x27ce41(0x156)]||typeof _0x321d50['content']!==_0x27ce41(0x11b))throw new Error(_0x27ce41(0xe8));if(_0x321d50[_0x27ce41(0xef)]&&typeof _0x321d50['usage']!==_0x27ce41(0xd6))throw new Error(_0x27ce41(0x120));}['_processChatResponse'](_0x27051d,_0x42cb9c,_0x33f0c5){const _0x338c2d=a0_0x4439d1;_0x33f0c5[_0x338c2d(0xef)]&&(this['lastInputTokenCount']=_0x33f0c5[_0x338c2d(0xef)][_0x338c2d(0x134)]||0x0,this[_0x338c2d(0xd3)]=_0x33f0c5[_0x338c2d(0xef)][_0x338c2d(0x127)]||0x0,this['tokenUsage'][_0x338c2d(0x108)]+=this[_0x338c2d(0x104)],this[_0x338c2d(0x153)]['output']+=this['lastOutputTokenCount']),_0x27051d[_0x338c2d(0x13c)]['push']({'role':_0x338c2d(0x10c),'content':_0x42cb9c},{'role':'assistant','content':_0x33f0c5['content']}),_0x27051d[_0x338c2d(0xee)]=new Date()[_0x338c2d(0xc9)]();}async['updateConversation'](_0x37349f,_0x46652b){const _0x32b1e9=a0_0x4439d1;this['logger'][_0x32b1e9(0xdf)](_0x32b1e9(0x11c)+_0x37349f);const _0x45b0fc=this[_0x32b1e9(0x12a)](_0x37349f),_0x5bb5d3=this[_0x32b1e9(0xcb)]['has'](_0x37349f)?_0x37349f:_0x45b0fc;if(!this[_0x32b1e9(0xcb)]['has'](_0x5bb5d3))throw new Error(_0x32b1e9(0x121)+_0x37349f+'\x20not\x20found');const _0x1d5b84=this[_0x32b1e9(0xcb)]['get'](_0x5bb5d3);this['_updateConversationState'](_0x1d5b84,_0x46652b);}async[a0_0x4439d1(0xc0)](_0x569229,_0x2e352e=null){const _0x522dd6=a0_0x4439d1;this[_0x522dd6(0x111)]['info']('Getting summary from server');if(!this[_0x522dd6(0x112)])throw new Error(_0x522dd6(0x117));if(!this['apiKey'])throw new Error('No\x20API\x20key\x20available.\x20Please\x20set\x20your\x20API\x20key\x20first.');if(!_0x569229||typeof _0x569229!=='string')throw new Error(_0x522dd6(0xbf));let _0x1b8d6b=_0x522dd6(0xac);if(_0x2e352e&&this[_0x522dd6(0xcb)][_0x522dd6(0xa1)](_0x2e352e)){const _0x2af9a6=this['conversations'][_0x522dd6(0xb4)](_0x2e352e);_0x1b8d6b=_0x2af9a6[_0x522dd6(0x101)],this[_0x522dd6(0x111)]['info'](_0x522dd6(0xa7)+_0x1b8d6b);}else this[_0x522dd6(0x111)]['warn']('No conversation ID provided or conversation not found, using default model for summary');try{const _0x2092af=await this['_makeRequest']('/llm/summary',{'method':'POST','body':JSON['stringify']({'prompt':_0x569229[_0x522dd6(0xec)](),'model':_0x1b8d6b})});if(!_0x2092af['ok']){const _0x37bd41=await this[_0x522dd6(0xa0)](_0x2092af);throw this[_0x522dd6(0x135)](_0x2092af[_0x522dd6(0xe4)],_0x37bd41[_0x522dd6(0x154)]||_0x2092af[_0x522dd6(0xba)]);}const _0x1442fc=await _0x2092af['json']();return _0x1442fc[_0x522dd6(0xef)]&&(this[_0x522dd6(0x104)]=_0x1442fc[_0x522dd6(0xef)]['input_tokens']||0x0,this['lastOutputTokenCount']=_0x1442fc[_0x522dd6(0xef)][_0x522dd6(0x127)]||0x0,this[_0x522dd6(0x153)][_0x522dd6(0x108)]+=this[_0x522dd6(0x104)],this[_0x522dd6(0x153)][_0x522dd6(0x157)]+=this[_0x522dd6(0xd3)]),_0x1442fc['content'];}catch(_0x29d3e5){this[_0x522dd6(0x111)][_0x522dd6(0x154)]('Error getting summary from server:',_0x29d3e5);throw this[_0x522dd6(0x105)](_0x29d3e5,'get_summary');}}async[a0_0x4439d1(0xc4)](_0x4db329,_0x42233c,_0x43222c={}){const _0x4f6668=a0_0x4439d1;this[_0x4f6668(0x111)]['info']('Getting image description from server');if(!this['isInitialized'])throw new Error(_0x4f6668(0x117));if(!this[_0x4f6668(0xfd)])throw new Error('No\x20API\x20key\x20available.\x20Please\x20set\x20your\x20API\x20key\x20first.');this['_validateImageDescriptionInputs'](_0x4db329,_0x42233c);try{const _0x36b230=await this['_makeRequest'](_0x4f6668(0x13d),{'method':'POST','body':JSON[_0x4f6668(0xd2)]({'image':_0x4db329,'prompt':_0x42233c['trim'](),'metadata':_0x43222c||{}})}),_0x12f901=await this[_0x4f6668(0xa0)](_0x36b230);if(!_0x36b230['ok'])throw this[_0x4f6668(0x135)](_0x36b230['status'],_0x12f901['error']||_0x36b230['statusText']);return _0x12f901['usage']&&(this['lastInputTokenCount']=_0x12f901[_0x4f6668(0xef)][_0x4f6668(0x134)]||0x0,this[_0x4f6668(0xd3)]=_0x12f901[_0x4f6668(0xef)]['output_tokens']||0x0,this[_0x4f6668(0x153)]['input']+=this[_0x4f6668(0x104)],this[_0x4f6668(0x153)][_0x4f6668(0x157)]+=this[_0x4f6668(0xd3)]),_0x12f901[_0x4f6668(0x156)];}catch(_0x31b6f2){this[_0x4f6668(0x111)][_0x4f6668(0x154)]('Error getting image description from server:',_0x31b6f2);throw this[_0x4f6668(0x105)](_0x31b6f2,_0x4f6668(0xf6));}}['_validateImageDescriptionInputs'](_0x12c565,_0x1723d7){const _0x205f35=a0_0x4439d1;if(!_0x12c565||typeof _0x12c565!=='string')throw new Error('Invalid\x20base64\x20image\x20data');if(!_0x1723d7||typeof _0x1723d7!==_0x205f35(0x11b))throw new Error('Invalid\x20image\x20description\x20prompt');if(_0x12c565['length']>0x32*0x400*0x400)throw new Error(_0x205f35(0x109));}async['estimateTokenCount'](_0xba324a){const _0x2895de=a0_0x4439d1,_0x13aab7=this['_sanitizeConversationId'](_0xba324a),_0x4c3da0=this['conversations']['has'](_0xba324a)?_0xba324a:_0x13aab7;if(!this[_0x2895de(0xcb)]['has'](_0x4c3da0))throw new Error(_0x2895de(0x121)+_0xba324a+_0x2895de(0xe2));const _0x3ee3f7=this[_0x2895de(0xcb)]['get'](_0x4c3da0);let _0x2e85c2=this['_estimateTokens'](_0x3ee3f7['systemPrompt']);for(const _0x3be113 of _0x3ee3f7['messages']){_0x2e85c2+=this['_estimateTokens'](_0x3be113[_0x2895de(0x156)]);}return _0x2e85c2;}['_estimateTokens'](_0x6d2cd4){const _0x5e80d5=a0_0x4439d1;if(!_0x6d2cd4||typeof _0x6d2cd4!==_0x5e80d5(0x11b))return 0x0;return Math['ceil'](_0x6d2cd4['length']/0x4);}[a0_0x4439d1(0x132)](_0x531c0c){const _0x6e0f2a=a0_0x4439d1;return this['availableModels'][_0x6e0f2a(0xa1)](_0x531c0c);}[a0_0x4439d1(0x11f)](){const _0x31f9a6=a0_0x4439d1;let _0x55223f=0x0;for(const _0x370451 of this[_0x31f9a6(0xcc)][_0x31f9a6(0x152)]()){_0x370451[_0x31f9a6(0x14b)]>_0x55223f&&(_0x55223f=_0x370451['maxTokens']);}return _0x55223f||0x186a0;}[a0_0x4439d1(0xb6)](){return this['lastInputTokenCount'];}[a0_0x4439d1(0xfc)](){return this['lastOutputTokenCount'];}[a0_0x4439d1(0x9f)](){const _0x101508=a0_0x4439d1;return{...this[_0x101508(0x153)]};}async[a0_0x4439d1(0x106)](){const _0x181112=a0_0x4439d1;this[_0x181112(0x111)]['info']('Refreshing pricing data from server'),await this[_0x181112(0xd8)]();}async[a0_0x4439d1(0x14c)](){const _0x13883f=a0_0x4439d1;try{const _0x14fffd=await this['_makeRequest'](_0x13883f(0xa6));if(!_0x14fffd['ok'])return{'status':_0x13883f(0x12b),'error':'HTTP\x20'+_0x14fffd[_0x13883f(0xe4)]+':\x20'+_0x14fffd[_0x13883f(0xba)]};const _0x118b58=await _0x14fffd[_0x13883f(0x114)]();return{'status':_0x13883f(0x10d),..._0x118b58};}catch(_0x1a8bb0){return{'status':_0x13883f(0x12b),'error':_0x1a8bb0[_0x13883f(0xfb)]};}}async['shutdown'](){const _0x592bb5=a0_0x4439d1;this[_0x592bb5(0x111)]['info']('Shutting\x20down\x20server\x20LLM\x20service'),this[_0x592bb5(0xcb)]['clear'](),this[_0x592bb5(0xcc)]['clear'](),this['pricingData']['clear'](),this[_0x592bb5(0x112)]=![],this[_0x592bb5(0xfd)]=null,this['logger']['info'](_0x592bb5(0x125));}async[a0_0x4439d1(0x137)](_0x5c954f,_0x5ca58c={}){const _0x1da9a5=a0_0x4439d1,_0x3acfbc=''+this[_0x1da9a5(0x159)]+_0x5c954f,_0x2e4b07={'method':_0x5ca58c['method']||_0x1da9a5(0x155),'headers':{'Content-Type':'application/json','User-Agent':_0x1da9a5(0xa8),..._0x5ca58c['headers']},'timeout':this['timeout'],..._0x5ca58c};this[_0x1da9a5(0xfd)]&&(_0x2e4b07['headers']['Authorization']='Bearer\x20'+this['apiKey']);try{const _0x39d2e1=await a0_0x30c0e2(_0x3acfbc,_0x2e4b07);return _0x39d2e1;}catch(_0xa5dd35){throw this[_0x1da9a5(0xc8)](_0xa5dd35,_0x3acfbc);}}async['_safeJsonParse'](_0x1f3a55){try{return await _0x1f3a55['json']();}catch(_0x75c25c){return{};}}['_enhanceError'](_0xbdabbc,_0x1144a9){const _0x1115aa=a0_0x4439d1,_0x4598a3=new Error(_0x1144a9+'\x20failed:\x20'+_0xbdabbc[_0x1115aa(0xfb)]);return _0x4598a3['operation']=_0x1144a9,_0x4598a3['originalError']=_0xbdabbc,_0x4598a3['errorType']=this[_0x1115aa(0x9d)](_0xbdabbc),_0x4598a3;}[a0_0x4439d1(0x135)](_0x41e84f,_0x259c6b){const _0x5e0356=a0_0x4439d1,_0x350ac4=new Error(_0x5e0356(0x141)+_0x41e84f+':\x20'+_0x259c6b);return _0x350ac4[_0x5e0356(0xe4)]=_0x41e84f,_0x350ac4['errorType']=this[_0x5e0356(0x145)](_0x41e84f),_0x350ac4;}[a0_0x4439d1(0xc8)](_0x5e581f,_0x51820a){const _0xe84d6b=a0_0x4439d1,_0xebeb5=new Error('Network\x20request\x20failed:\x20'+_0x5e581f['message']);_0xebeb5[_0xe84d6b(0x147)]=_0x51820a,_0xebeb5['originalError']=_0x5e581f,_0xebeb5[_0xe84d6b(0xc7)]=ERROR_TYPES[_0xe84d6b(0x10e)];if(_0x5e581f['code']===_0xe84d6b(0x12e))_0xebeb5['message']='Connection\x20refused.\x20Server\x20may\x20be\x20down.';else{if(_0x5e581f[_0xe84d6b(0xcd)]===_0xe84d6b(0x124))_0xebeb5['message']=_0xe84d6b(0x151);else(_0x5e581f[_0xe84d6b(0xcd)]==='ETIMEDOUT'||_0x5e581f[_0xe84d6b(0xaf)]===_0xe84d6b(0x129))&&(_0xebeb5['message']=_0xe84d6b(0x13a),_0xebeb5[_0xe84d6b(0xc7)]=ERROR_TYPES['TIMEOUT']);}return _0xebeb5;}[a0_0x4439d1(0x9d)](_0x263515){const _0x16618f=a0_0x4439d1;if(_0x263515[_0x16618f(0xe4)])return this['_classifyHttpError'](_0x263515[_0x16618f(0xe4)]);if(_0x263515[_0x16618f(0xcd)]===_0x16618f(0x12e)||_0x263515['code']==='ENOTFOUND')return ERROR_TYPES[_0x16618f(0x10e)];if(_0x263515[_0x16618f(0xcd)]===_0x16618f(0xc3)||_0x263515[_0x16618f(0xaf)]===_0x16618f(0x129))return ERROR_TYPES[_0x16618f(0x115)];return ERROR_TYPES[_0x16618f(0x133)];}['_classifyHttpError'](_0x8467e1){const _0x3656cd=a0_0x4439d1;switch(_0x8467e1){case HTTP_STATUS[_0x3656cd(0x12f)]:case HTTP_STATUS[_0x3656cd(0x10f)]:return ERROR_TYPES[_0x3656cd(0xd0)];case HTTP_STATUS['BAD_REQUEST']:return ERROR_TYPES[_0x3656cd(0x149)];case HTTP_STATUS[_0x3656cd(0x11a)]:return ERROR_TYPES['RATE_LIMIT'];case HTTP_STATUS[_0x3656cd(0xfa)]:case HTTP_STATUS[_0x3656cd(0xf5)]:case HTTP_STATUS['SERVICE_UNAVAILABLE']:case HTTP_STATUS['GATEWAY_TIMEOUT']:return ERROR_TYPES[_0x3656cd(0x13b)];default:return ERROR_TYPES['UNKNOWN'];}}[a0_0x4439d1(0x9c)](_0x55b1b3){const _0x1ae9e2=a0_0x4439d1,_0x50138f=[ERROR_TYPES['AUTHENTICATION'],ERROR_TYPES[_0x1ae9e2(0x149)]],_0x34ac43=[HTTP_STATUS[_0x1ae9e2(0xd9)],HTTP_STATUS[_0x1ae9e2(0x12f)],HTTP_STATUS['FORBIDDEN'],HTTP_STATUS['NOT_FOUND']];return _0x50138f['includes'](_0x55b1b3['errorType'])||_0x34ac43[_0x1ae9e2(0xcf)](_0x55b1b3['status']);}['_delay'](_0x410ec0){return new Promise(_0x13746e=>setTimeout(_0x13746e,_0x410ec0));}['_decryptKey'](_0x37f8e9){const _0x7eacc6=a0_0x4439d1,_0x4ca5ea=_0x7eacc6(0x116),_0x3b005d=Buffer[_0x7eacc6(0xad)](_0x37f8e9,_0x7eacc6(0xa5))[_0x7eacc6(0x9e)]();let _0x2e5d49='';for(let _0x4a4869=0x0;_0x4a4869<_0x3b005d[_0x7eacc6(0x11e)];_0x4a4869++){_0x2e5d49+=String[_0x7eacc6(0xdb)](_0x3b005d[_0x7eacc6(0xb9)](_0x4a4869)^_0x4ca5ea[_0x7eacc6(0xb9)](_0x4a4869%_0x4ca5ea['length']));}return _0x2e5d49;}}function a0_0x49d9(){const _0x1a702e=['C2L6zq','yxP1CMuTB3bLBMfPlwDWDdm1','BgfZDfbYAwnPBMDvCgrHDgu','qKfex0DbvevxqvK','z2v0x2LTywDLx2rLC2nYAxb0Aw9U','rMfPBgvKihrVigLUAxrPywXPEMuGC2vYDMvYieXmtsbZzxj2AwnLoG','Ahr0Chm6','nMDKwKDstW','su5urvjoquXFu0vsvKvsx0vsuK9s','BwvZC2fNzq','z2v0tgfZDe91Dhb1DfrVA2vUq291BNq','yxbPs2v5','BM93','sw5PDgLHBgL6Aw5NihnLCNzLCIbmte0GC2vYDMLJzq','AM9PBG','Bw9KzwW','yw50AhjVCgLJlxnVBM5LDa','ig1VzgvSCYbMCM9TihnLCNzLCG','BgfZDeLUChv0vg9Rzw5dB3vUDa','x2vUAgfUy2vfCNjVCG','CMvMCMvZAfbYAwnPBMDeyxrH','C2vUzf9TzxnZywDL','Aw5WDxq','sw1Hz2uGzgf0ysb0B28GBgfYz2u','x2DLBMvYyxrLuMvXDwvZDeLK','x2rLy3j5ChrlzxK','DxnLCG','AgvHBhrOEq','tKvuv09ssW','rK9sqKLerevo','BNvTyMvY','Bg9Nz2vY','AxnjBML0AwfSAxPLza','C2vUze1LC3nHz2u','ANnVBG','veLnru9vva','Bg94AweTBg9JywWTA2v5','u2vYDMLJzsbUB3qGAw5PDgLHBgL6zwqUienHBgWGAw5PDgLHBgL6zsGPigzPCNn0lG','tM8GqvbjigTLEsbHDMfPBgfIBguUifbSzwfZzsbZzxqGEw91CIbbueKGA2v5igzPCNn0lG','sw52ywXPzcbTyxHuB2TLBNmGzM9Yig1VzgvSia','ve9px01btLLFuKvrvuvtvfm','C3rYAw5N','vxbKyxrPBMCGC2vYDMvYignVBNzLCNnHDgLVBJOG','x3vWzgf0zunVBNzLCNnHDgLVBLn0yxrL','BgvUz3rO','z2v0twf4q29UDgv4DfnPEMu','sw52ywXPzcbYzxnWB25ZztOGAw52ywXPzcb1C2fNzsbKyxrH','q29UDMvYC2f0Aw9Uia','x3bYB2nLC3ndAgf0uMvZCg9UC2u','tM8GqvbjigTLEsbMB3vUzc4GugXLyxnLihj1BIaIBg94AweGA2v5ic0TC2v0idX5B3vYlwfWAs1RzxK+iIbMAxjZDc4','ru5pvezpvu5e','u2vYDMvYieXmtsbZzxj2AwnLihnODxqGzg93BIbZDwnJzxnZzNvSBhK','rMfPBgvKihrVigXVywqGBw9KzwXZoIa','B3v0Chv0x3rVA2vUCW','vvne','qwjVCNrfCNjVCG','x3nHBML0AxPLq29UDMvYC2f0Aw9Uswq','Dw5OzwfSDgH5','y2f0zwDVCNK','x2j1AwXKq2HHDfjLCxvLC3rqyxLSB2fK','runptK5sruzvu0ve','vu5bvvrit1jjwKve','l2XSBs9TB2rLBhm','C3vIC3rYAw5N','C3vWCg9YDhnnB2rLBa','vu5ltK9xtG','Aw5WDxrFDg9Rzw5Z','x2nYzwf0zuH0DhbfCNjVCG','mte0ntKYmg5ps29iEq','x21HA2vszxf1zxn0','x3zHBgLKyxrLuhjPy2LUz0rHDge','zNmVChjVBwLZzxm','uMvXDwvZDcb0Aw1LB3v0lIbtzxj2zxiGBwf5igjLig92zxjSB2fKzwqU','u0vsvKvs','BwvZC2fNzxm','l2XSBs92AxnPB24','y2XLyxi','x2DLDe1VzgvStwf4vg9Rzw5Z','ChjPy2LUz0rHDge','sfruuca','C3LZDgvTuhjVBxb0','tw9KzwWGBwLZC2LUzYbYzxf1AxjLzcbMAwvSzdOG','sw52ywXPzcbVDxrWDxqGChjPy2LUzYbMB3iGBw9KzwWG','x2nSyxnZAwz5shr0CevYCM9Y','mtq4mZu3s21qqKzQ','DxjS','x3zHBgLKyxrLtw9KzwXeyxrH','vKfmsurbveLptG','y3jLzgvUDgLHBhm','Bwf4vg9Rzw5Z','z2v0u2vYDMvYsgvHBhrO','Bg9HzgvKu2vYDMvYrgf0yq','qvbjigTLEsb2ywXPzgf0Aw9UigzHAwXLzdO','DgLTzw91Da','C2vYDMLJzxm','re5tigXVB2T1CcbMywLSzwqUienOzwnRihnLCNzLCIbvuKWU','DMfSDwvZ','Dg9Rzw5vC2fNzq','zxjYB3i','r0vu','y29UDgvUDa','B3v0Chv0','ChjVDg9JB2W','C2vYDMvYvxjS','Cgf0Aa','x2LZtM9UuMv0CNLHyMXLrxjYB3i','x2nSyxnZAwz5rxjYB3i','Dg9tDhjPBMC','z2v0vg9Rzw5vC2fNzq','x3nHzMvkC29UugfYC2u','AgfZ','mZm3mJa3mLv2D3PuDG','Bw9KzwXZ','ChjPy2LUzW','yMfZzty0','l2HLywX0Aa','vxnPBMCGy29UDMvYC2f0Aw9Uig1VzgvSigzVCIbZDw1Tyxj5oIa','tg94AweTq0XjlZeUmc4W','BMv0D29YAW','x2XVywrbCgLlzxK','yxP1CMuTB3bLBMfPlwDWDdq','yxP1CMuTywKTCgHPna','zNjVBq','Bwf4uMv0CMLLCW','BMfTzq','mJi1nta1mg9oB0HJvG','Dw5PDa','sw52ywXPzcbJB252zxjZyxrPB24Gsuq','sw52ywXPzcbTzxnZywDLignVBNrLBNq','z2v0','uMvNAxn0zxjPBMCGy29UDMvYC2f0Aw9UihDPDgGGC2vYDMvYoIa','z2v0tgfZDeLUChv0vg9Rzw5dB3vUDa','x2XVywrtzxj2zxjeyxrH','CMvXxW','y2HHCKnVzgvbDa','C3rHDhvZvgv4Da','mte5ENPJA2Lf','DxrMoa','rMfPBgvKihrVigXVywqGChjPy2LUzZOG','rMfPBgvKihrVigXVywqGChjPy2LUzYbKyxrHoG','sw52ywXPzcbZDw1Tyxj5ihbYB21WDa','z2v0u3vTBwfYEq','D2fYBG','CMvWBgfJzq','rvrjtuvet1vu','z2v0sw1Hz2vezxnJCMLWDgLVBG','y29UDMvYC2f0Aw9Ulq','mZKZmJe5vKLPCeve','zxjYB3juExbL','x2nYzwf0zu5LDhDVCMTfCNjVCG','Dg9ju09tDhjPBMC','mZeYzuPVChrO','y29UDMvYC2f0Aw9UCW','yxzHAwXHyMXLtw9KzwXZ','y29Kzq','iIb0BYaI','Aw5JBhvKzxm','qvvusevoveLdqvrjt04','u2vYDMvYifvstcbTDxn0ihvZzsbivfrqig9YieHuvfbtihbYB3rVy29S','C3rYAw5NAwz5','BgfZDe91Dhb1DfrVA2vUq291BNq','zgvIDwC','x3zHBgLKyxrLu2vUze1LC3nHz2vjBNb1Dhm','B2jQzwn0','CMf0zv9SAw1PDa','x2XVywrqCMLJAw5Nrgf0yq','qKfex1jfuvvfu1q','nZmXnxb0EuDRBW','zNjVBunOyxjdB2rL','DhLWzq','mZy0mJeYqLHgq2XN','x2LZvMfSAwrdB252zxjZyxrPB25jza','Aw5MBW','u2vUzgLUzYbTzxnZywDLihrVihnLCNzLCIbMB3iGy29UDMvYC2f0Aw9UoIa','x2XVywrbDMfPBgfIBgvnB2rLBhm','ig5VDcbMB3vUza','u2vYDMvYifvstcbPCYbYzxf1AxjLza','C3rHDhvZ','ig1VzgvSCW','Aw1Hz2uTz2vUzxjHDgLVBG','tg9HzgvKia','sw52ywXPzcbYzxnWB25ZztOGBwLZC2LUzYbVCIbPBNzHBgLKignVBNrLBNq','y29UzMLN','ywXS','C3vWCg9YDhntExn0zw0','DhjPBq','C2v0','BgfZDefJDgL2Axr5','DxnHz2u','mtC4ntbQAKntuu8','rMfPBgvKihrVigXVywqGyxzHAwXHyMXLig1VzgvSCZO'];a0_0x49d9=function(){return _0x1a702e;};return a0_0x49d9();}