const a0_0x30c42e=a0_0x2937;function a0_0x4776(){const _0x2605e3=['u2vUzgLUzYbTzxnZywDLihrVihnLCNzLCIbMB3iGy29UDMvYC2f0Aw9UoIa','u2vYDMvYifvstcbPCYbYzxf1AxjLza','x2nYzwf0zuH0DhbfCNjVCG','rMfPBgvKihrVigXVywqGChjPy2LUzYbKyxrHoG','C3vIC3rYAw5N','Aw5JBhvKzxm','B3bLCMf0Aw9U','x3zHBgLKyxrLq2HHDfjLC3bVBNnL','x2LZvMfSAwrdB252zxjZyxrPB25jza','rvrjtuvet1vu','D2fYBG','z2v0tw9KzwXqCMLJAw5N','BwvZC2fNzxm','x2DLDerLzMf1BhrnB2rLBa','Dg9ju09tDhjPBMC','AxnjBML0AwfSAxPLza','Bw9KzwXZ','l2HLywX0Aa','Bw9KzwW','BM93','CgfYC2u','yxP1CMuTB3bLBMfPlwDWDdq','x3vWzgf0zunVBNzLCNnHDgLVBLn0yxrL','DgLTzw91Da','y2f0zwDVCNK','mtyZmJyZmMvzsNnita','z2v0vg9Rzw5vC2fNzq','yxP1CMuTB3bLBMfPlwDWDdm1','CMf0zv9SAw1PDa','mJy2odC5D0jHzxnM','C3rHDhvZ','ue9tva','r0furvDbwv9usu1ft1vu','y2HHCKnVzgvbDa','AgfZ','zNjVBunOyxjdB2rL','mJu3nZKWnKnrtw9KEq','Dw5PDa','C2vYDMvY','rMfPBgvKihrVigXVywqGChjPy2LUzZOG','veLnru9vva','x2XVywrtzxj2zxjeyxrH','C2L6zq','BgfZDfbYAwnPBMDvCgrHDgu','Dw5OzwfSDgH5','C2v0','C2H1DgrVD24','Bwf4vg9Rzw5Z','x3nHBML0AxPLq29UDMvYC2f0Aw9Uswq','x3bYB2nLC3ndAgf0uMvZCg9UC2u','lMXVEgLH','tK9ux0zpvu5e','mJi4mdmYAg5pAfjy','qvbjigTLEsb2ywXPzgf0Aw9UigzHAwXLzdO','u2vYDMvYieXmtsbZzxj2AwnLihnODxqGzg93BIbZDwnJzxnZzNvSBhK','x3zHBgLKyxrLu2vYDMvYvxjS','tM8GqvbjigTLEsbHDMfPBgfIBguUifbSzwfZzsbZzxqGEw91CIbbueKGA2v5igzPCNn0lG','AM9PBG','Bwf4uMv0CMLLCW','y29Kzq','x2vZDgLTyxrLvg9Rzw5Z','x2XVywrbDMfPBgfIBgvnB2rLBhm','x3zHBgLKyxrLtw9KzwXeyxrH','Bwv0Ag9K','AxnbCNjHEq','nej1sNvjvG','qMvHCMvYia','u2fUAxrPEMvKignVBNzLCNnHDgLVBIbjrcbMCM9Tici','y3jLzgvUDgLHBhm','sw52ywXPzcbPBNb1DcbWCMLJAw5NigzVCIbTB2rLBca','Ag9TzwrPCG','y29UDgvUDa','y29UDMvYC2f0Aw9UCW','sw52ywXPzcbZzxj2zxiGvvjmoIa','tM8GqvbjigTLEsbMB3vUzc4GugXLyxnLihj1BIaIBg94AweGA2v5ic0TC2v0idX5B3vYlwfWAs1RzxK+iIbMAxjZDc4','yxv0AgvUDgLJyxrPB24','CMvNAxn0zxjdB252zxjZyxrPB24','y2XLyxi','DxnHz2u','B3v0Chv0x3rVA2vUCW','Bg94AweTBg9JywWTA2v5','z2v0','l2XSBs9TB2rLBhm','Bg9Nz2vY','CMvXDwvZDcb0B28GBgfYz2u','x2rLy3j5ChrlzxK','C2vYDMvYvxjS','z2v0sw1Hz2vezxnJCMLWDgLVBG','BgfZDeLUChv0vg9Rzw5dB3vUDa','z2v0qxzHAwXHyMXLtw9KzwXZ','DhLWzq','yxbPs2v5','u2vYDMvYieXmtsbZzxj2AwnLigLUAxrPywXPEMvKihn1y2nLC3nMDwXSEq','ig1VzgvSCW','q29UDMvYC2f0Aw9Uia','BwvZC2fNzq','y29UDMvYC2f0Aw9Ulq','vu5bvvrit1jjwKve','z2v0u3vTBwfYEq','ig5VDcbMB3vUza','x21HA2vszxf1zxn0','BgfZDe91Dhb1DfrVA2vUq291BNq','tKvuv09ssW','Ahr0CdO','l2f1DgGVDMvYAwz5','z2v0x3n1Bw1HCNK','Aw1Hz2uTz2vUzxjHDgLVBG','Aw5MBW','ChjPy2LUzW','C3LZDgvTuhjVBxb0','odbNyMfzzNq','qvvusevoveLdqvrjt04','Dg9Rzw5vC2fNzq','ChvZAa','C3vWCg9YDhnwAxnPB24','sw52ywXPzcbPBwfNzsbKzxnJCMLWDgLVBIbWCM9TChq','DhjPBq','rMfPBgvKihrVigXVywqGyxzHAwXHyMXLig1VzgvSCZO','x3zHBgLKyxrLqxbPs2v5','Aw5PDgLHBgL6zq','sw5PDgLHBgL6Aw5NihnLCNzLCIbmte0GC2vYDMLJzq','DMfSDwu','BgfZDefJDgL2Axr5','u2vYDMvYieXmtsbZzxj2AwnLigLUAxrPywXPEMvK','x2XVywrbCgLlzxK','x2nSyxnZAwz5rxjYB3i','nJu1mJnWz3LmEwS','BNvTyMvY','u0vsvKvs','rxjYB3iGC2vUzgLUzYbTzxnZywDLihrVihnLCNzLCJO','sw52ywXPzcbIyxnLnJqGAw1Hz2uGzgf0yq','tg9HzgvKia','yxzHAwXHyMXLtw9KzwXZ','x3zHBgLKyxrLuhjPy2LUz0rHDge','rK9sqKLerevo','x2vUAgfUy2vfCNjVCG','yxnZAxn0yw50','Aw5WDxrFDg9Rzw5Z','CMvXxW','zxjYB3i','qKfex1jfuvvfu1q','mta1mtiWnNzOAvPxtG','B3v0Chv0','BgvUz3rO','x2nSyxnZAwz5shr0CevYCM9Y','C3rYAw5N','C3rHDhvZvgv4Da','ANnVBG','Bg9HzgvKu2vYDMvYrgf0yq','x3nLBMrdAgf0uMvXDwvZDa','rMfPBgvKihrVignYzwf0zsb2ywXPzcbJB252zxjZyxrPB24GsuqGzNjVBtOG','qxv0Ag9YAxPHDgLVBG','CMvWBgfJzq','C2vUzf9TzxnZywDL','zgvIDwC','z2v0uhjPy2LUz0rHDge','sfruuca','x3zHBgLKyxrLu2vUze1LC3nHz2vjBNb1Dhm','C3rYAw5NAwz5','Ahr0Chm6','CMvXDwvZDeLK','u2vYDMLJzsbUB3qGAw5PDgLHBgL6zwqUienHBgWGAw5PDgLHBgL6zsGPigzPCNn0lG','nJi4nefNzfnMEG','l2XSBs92AxnPB24','AgvHBhrOEq','Dg9tDhjPBMC','B3jPz2LUywXfCNjVCG','zNjVBq','x2DLBMvYyxrLuMvXDwvZDeLK','BMfTzq','ChjPy2LUz0rHDge','Aw5WDxq','vu5ltK9xtG','z2v0tgfZDeLUChv0vg9Rzw5dB3vUDa','x2DLDe1VzgvStwf4vg9Rzw5Z','DxnLCG','vKfmsurbveLptG','x2nYzwf0zu5LDhDVCMTfCNjVCG','uMvNAxn0zxjPBMCGy29UDMvYC2f0Aw9UihDPDgGGC2vYDMvYoIa','y29UDgvUDcbSzw5NDgGGzxHJzwvKCYbSAw1PDa','C2vUze1LC3nHz2u'];a0_0x4776=function(){return _0x2605e3;};return a0_0x4776();}(function(_0x4b99e1,_0x3a9e62){const _0x88e6eb=a0_0x2937,_0x289356=_0x4b99e1();while(!![]){try{const _0x264a5a=parseInt(_0x88e6eb(0x127))/0x1+-parseInt(_0x88e6eb(0x96))/0x2*(parseInt(_0x88e6eb(0xd3))/0x3)+-parseInt(_0x88e6eb(0xf7))/0x4*(-parseInt(_0x88e6eb(0xc3))/0x5)+-parseInt(_0x88e6eb(0xe2))/0x6+parseInt(_0x88e6eb(0x89))/0x7+-parseInt(_0x88e6eb(0x123))/0x8+parseInt(_0x88e6eb(0x79))/0x9;if(_0x264a5a===_0x3a9e62)break;else _0x289356['push'](_0x289356['shift']());}catch(_0x517420){_0x289356['push'](_0x289356['shift']());}}}(a0_0x4776,0x2de9f));import a0_0x459568 from'node-fetch';const DEFAULT_TIMEOUT_MS=0xea60,DEFAULT_MAX_RETRIES=0x3,DEFAULT_RETRY_DELAY_MS=0x7530,RETRY_DELAY_MULTIPLIER=0x2,API_VERSION='v1',HTTP_STATUS={'OK':0xc8,'CREATED':0xc9,'BAD_REQUEST':0x190,'UNAUTHORIZED':0x191,'FORBIDDEN':0x193,'NOT_FOUND':0x194,'TOO_MANY_REQUESTS':0x1ad,'INTERNAL_SERVER_ERROR':0x1f4,'BAD_GATEWAY':0x1f6,'SERVICE_UNAVAILABLE':0x1f7,'GATEWAY_TIMEOUT':0x1f8},ERROR_TYPES={'AUTHENTICATION':a0_0x30c42e(0xa0),'NETWORK':'network','TIMEOUT':a0_0x30c42e(0x121),'RATE_LIMIT':a0_0x30c42e(0x126),'SERVER':a0_0x30c42e(0x7b),'VALIDATION':'validation','UNKNOWN':'unknown'},HTTP_STATUS_CODES={'REQUEST_ENTITY_TOO_LARGE':0x19d,'BAD_REQUEST':0x190,'UNAUTHORIZED':0x191,'FORBIDDEN':0x193,'NOT_FOUND':0x194,'TOO_MANY_REQUESTS':0x1ad,'INTERNAL_SERVER_ERROR':0x1f4},REQUEST_SIZE_ERROR_PATTERNS=['request\x20entity\x20too\x20large','payload\x20too\x20large',a0_0x30c42e(0xa9),'message\x20too\x20long',a0_0x30c42e(0x108)];function a0_0x2937(_0x108963,_0x448155){const _0x4776a8=a0_0x4776();return a0_0x2937=function(_0x29377a,_0x1b5e8c){_0x29377a=_0x29377a-0x79;let _0x23fcc0=_0x4776a8[_0x29377a];if(a0_0x2937['OKJSvy']===undefined){var _0x5f0696=function(_0x459568){const _0x73579='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x339bea='',_0xd3a96e='';for(let _0x210a51=0x0,_0x3ea0a7,_0xc6e8c3,_0x412d64=0x0;_0xc6e8c3=_0x459568['charAt'](_0x412d64++);~_0xc6e8c3&&(_0x3ea0a7=_0x210a51%0x4?_0x3ea0a7*0x40+_0xc6e8c3:_0xc6e8c3,_0x210a51++%0x4)?_0x339bea+=String['fromCharCode'](0xff&_0x3ea0a7>>(-0x2*_0x210a51&0x6)):0x0){_0xc6e8c3=_0x73579['indexOf'](_0xc6e8c3);}for(let _0x2a7b48=0x0,_0x4d2d72=_0x339bea['length'];_0x2a7b48<_0x4d2d72;_0x2a7b48++){_0xd3a96e+='%'+('00'+_0x339bea['charCodeAt'](_0x2a7b48)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0xd3a96e);};a0_0x2937['bveEDy']=_0x5f0696,_0x108963=arguments,a0_0x2937['OKJSvy']=!![];}const _0x5b52ab=_0x4776a8[0x0],_0x355ba3=_0x29377a+_0x5b52ab,_0x1d40ed=_0x108963[_0x355ba3];return!_0x1d40ed?(_0x23fcc0=a0_0x2937['bveEDy'](_0x23fcc0),_0x108963[_0x355ba3]=_0x23fcc0):_0x23fcc0=_0x1d40ed,_0x23fcc0;},a0_0x2937(_0x108963,_0x448155);}export class ServerLLMService{constructor(_0x73579,_0x339bea){const _0x589aa5=a0_0x30c42e;this['config']=_0x73579,this['logger']=_0x339bea,this[_0x589aa5(0xab)]=this['_validateServerUrl'](_0x73579[_0x589aa5(0xab)]),this['apiKey']=null,this[_0x589aa5(0x119)]=![],this['timeout']=_0x73579['services']?.['server']?.[_0x589aa5(0x121)]||DEFAULT_TIMEOUT_MS,this[_0x589aa5(0x8f)]=_0x73579['services']?.[_0x589aa5(0x7b)]?.['retries']||DEFAULT_MAX_RETRIES,this[_0x589aa5(0xf5)]=0x0,this['availableModels']=new Map(),this['pricingData']=new Map(),this['lastPricingUpdate']=null,this['conversations']=new Map(),this[_0x589aa5(0xad)]=0x0,this[_0x589aa5(0xba)]=0x0,this[_0x589aa5(0xc5)]={'input':0x0,'output':0x0},this[_0x589aa5(0xa8)][_0x589aa5(0xc0)](_0x589aa5(0xd0),{'serverUrl':this[_0x589aa5(0xab)],'timeout':this[_0x589aa5(0x121)],'maxRetries':this['maxRetries']});}[a0_0x30c42e(0x8c)](_0xd3a96e){const _0x4b8eb=a0_0x30c42e;if(!_0xd3a96e)throw new Error(_0x4b8eb(0x10b));try{const _0x210a51=new URL(_0xd3a96e);if(![_0x4b8eb(0xbc),_0x4b8eb(0xf4)]['includes'](_0x210a51['protocol']))throw new Error('Server\x20URL\x20must\x20use\x20HTTP\x20or\x20HTTPS\x20protocol');return _0x210a51[_0x4b8eb(0xfa)]()['replace'](/\/$/,'');}catch(_0x3ea0a7){throw new Error(_0x4b8eb(0x9e)+_0x3ea0a7[_0x4b8eb(0xb4)]);}}['_sanitizeConversationId'](_0xc6e8c3){const _0x43e7d8=a0_0x30c42e;if(!_0xc6e8c3||typeof _0xc6e8c3!==_0x43e7d8(0xe6))return _0x43e7d8(0xb5)+Date['now']();let _0x412d64=_0xc6e8c3['replace'](/\s+/g,'-')[_0x43e7d8(0xed)](/[^a-zA-Z0-9_-]/g,'')[_0x43e7d8(0xed)](/-+/g,'-')['replace'](/^-+|-+$/g,'')['toLowerCase']();if(!_0x412d64)_0x412d64=_0x43e7d8(0xb5)+Date[_0x43e7d8(0x11d)]();else _0x412d64['length']>0x32&&(_0x412d64=_0x412d64[_0x43e7d8(0x10e)](0x0,0x28)+'-'+Date[_0x43e7d8(0x11d)]()[_0x43e7d8(0xfa)]()['slice'](-0x8));return _0x412d64;}async[a0_0x30c42e(0xcc)](){const _0x2e1f23=a0_0x30c42e;if(this[_0x2e1f23(0x119)])return;try{this['logger']['info'](_0x2e1f23(0xcd)),this[_0x2e1f23(0xb0)]=await this['_loadApiKey']();if(!this['apiKey'])throw new Error(_0x2e1f23(0x9f));await this[_0x2e1f23(0x7e)](),this['isInitialized']=!![],this[_0x2e1f23(0xa8)]['info'](_0x2e1f23(0xb1),{'modelsLoaded':this[_0x2e1f23(0xd9)][_0x2e1f23(0x7f)],'pricingModels':this['pricingData'][_0x2e1f23(0x7f)]});}catch(_0x2a7b48){this['logger'][_0x2e1f23(0xe0)]('Failed\x20to\x20initialize\x20server\x20LLM\x20service:',_0x2a7b48);throw _0x2a7b48;}}async[a0_0x30c42e(0x7e)](){const _0x2c9585=a0_0x30c42e;await Promise['all']([this[_0x2c9585(0x92)](),this['_loadPricingData']()]),this['loadedServerData']=!![];}async[a0_0x30c42e(0xd1)](){const _0x24959e=a0_0x30c42e;try{const _0x4d2d72=await import('os'),_0x256fac=await import('path'),_0x5dc6b6=await import('fs/promises'),_0x3874b4=_0x256fac[_0x24959e(0x8e)](_0x4d2d72[_0x24959e(0x9b)](),_0x24959e(0x87),_0x24959e(0x99)),_0x2e4a70=await _0x5dc6b6['readFile'](_0x3874b4,'utf8'),_0x5514b6=JSON[_0x24959e(0x11e)](_0x2e4a70);return this[_0x24959e(0xaa)](_0x5514b6[_0x24959e(0xb0)]);}catch(_0x111f63){return this['logger'][_0x24959e(0xef)]('Failed to load API key from credentials file:',_0x111f63),null;}}async[a0_0x30c42e(0xcb)](){const _0x519aef=a0_0x30c42e;try{const _0x3d4e98=await this['_makeRequest'](_0x519aef(0xbd),{'method':_0x519aef(0x129)});return _0x3d4e98['ok'];}catch(_0x1bd292){return this[_0x519aef(0xa8)]['warn'](_0x519aef(0x8a),_0x1bd292),![];}}async['_loadAvailableModels'](){const _0x195a51=a0_0x30c42e;try{this[_0x195a51(0xa8)]['info']('Loading available models from server');const _0x282943=await this[_0x195a51(0xb9)](_0x195a51(0xa7)),_0x5a8958=await _0x282943['json']();if(!_0x5a8958[_0x195a51(0x11a)]||!Array[_0x195a51(0x95)](_0x5a8958['models']))throw new Error('Invalid models response from server');this[_0x195a51(0xd9)]['clear']();for(const _0x19c4ae of _0x5a8958['models']){this['_validateModelData'](_0x19c4ae),this[_0x195a51(0xd9)][_0x195a51(0x82)](_0x19c4ae[_0x195a51(0xfe)],{'name':_0x19c4ae[_0x195a51(0xfe)],'category':_0x19c4ae[_0x195a51(0x122)],'type':_0x19c4ae[_0x195a51(0xaf)],'maxTokens':_0x19c4ae[_0x195a51(0x84)],'supportsVision':_0x19c4ae[_0x195a51(0xc7)]||![],'supportsSystem':_0x19c4ae['supportsSystem']!==![],'pricing':_0x19c4ae['pricing']||{}});}this[_0x195a51(0xa8)]['info'](_0x195a51(0xd8)+this[_0x195a51(0xd9)]['size']+'\x20models\x20from\x20server');}catch(_0xe3add8){this[_0x195a51(0xa8)][_0x195a51(0xe0)](_0x195a51(0xca),_0xe3add8);throw new Error('Failed\x20to\x20load\x20models:\x20'+_0xe3add8[_0x195a51(0xb4)]);}}[a0_0x30c42e(0x93)](_0x514989){const _0x48516c=a0_0x30c42e,requiredFields=['name','category','type'];for(const _0x15ad7d of requiredFields){if(!_0x514989[_0x15ad7d])throw new Error('Model\x20missing\x20required\x20field:\x20'+_0x15ad7d);}if(_0x514989[_0x48516c(0xaf)]!==_0x48516c(0xbf)){if(typeof _0x514989['maxTokens']!==_0x48516c(0xd4)||_0x514989[_0x48516c(0x84)]<=0x0)throw new Error('Invalid\x20maxTokens\x20for\x20model\x20'+_0x514989[_0x48516c(0xfe)]);}}async['_loadPricingData'](){const _0x1eaced=a0_0x30c42e;try{this[_0x1eaced(0xa8)]['info']('Loading pricing data from server');const _0xb19529=await this['_makeRequest']('/usage/pricing'),_0x513557=await _0xb19529['json']();if(!_0x513557['pricing'])throw new Error('Invalid pricing response from server');this[_0x1eaced(0xff)][_0x1eaced(0xa2)]();for(const [_0x5a41f7,_0x21e220]of Object['entries'](_0x513557[_0x1eaced(0xc1)])){this[_0x1eaced(0xda)](_0x5a41f7,_0x21e220),this[_0x1eaced(0xff)]['set'](_0x5a41f7,{'input':_0x21e220['input'],'output':_0x21e220['output'],'unit':_0x21e220[_0x1eaced(0x7a)]||'1K\x20tokens','currency':_0x21e220['currency']||'USD'});}this[_0x1eaced(0x80)]=new Date()['toISOString'](),this['logger'][_0x1eaced(0xc0)]('Loaded\x20pricing\x20for\x20'+this['pricingData']['size']+_0x1eaced(0xb2));}catch(_0x5ec82b){this[_0x1eaced(0xa8)][_0x1eaced(0xe0)](_0x1eaced(0x10d),_0x5ec82b);throw new Error(_0x1eaced(0x7c)+_0x5ec82b[_0x1eaced(0xb4)]);}}['_validatePricingData'](_0x171133,_0x2cf0c9){const _0x5c00a5=a0_0x30c42e;if(typeof _0x2cf0c9['input']!==_0x5c00a5(0xd4)||_0x2cf0c9[_0x5c00a5(0x100)]<0x0)throw new Error(_0x5c00a5(0x9a)+_0x171133);if(typeof _0x2cf0c9[_0x5c00a5(0xe3)]!==_0x5c00a5(0xd4)||_0x2cf0c9[_0x5c00a5(0xe3)]<0x0)throw new Error('Invalid\x20output\x20pricing\x20for\x20model\x20'+_0x171133);}async[a0_0x30c42e(0xae)](){const _0x2d1999=a0_0x30c42e;!this[_0x2d1999(0xe9)]&&await this[_0x2d1999(0x7e)]();let _0x1ba871=Array[_0x2d1999(0xfc)](this[_0x2d1999(0xd9)]['values']());return _0x1ba871;}async[a0_0x30c42e(0xf0)](){const _0x456535=a0_0x30c42e;return!this[_0x456535(0xe9)]&&await this['_loadServerData'](),new Map(this['pricingData']);}[a0_0x30c42e(0x115)](_0x1a05e1){const _0x423bdf=a0_0x30c42e;return this[_0x423bdf(0xff)]['get'](_0x1a05e1)||null;}[a0_0x30c42e(0x112)](_0x5c1b55){const _0x10460a=a0_0x30c42e;return typeof _0x5c1b55==='string'&&_0x5c1b55[_0x10460a(0xe4)]>0x0&&_0x5c1b55['length']<=0x64&&/^[a-zA-Z0-9_-]+$/['test'](_0x5c1b55);}async[a0_0x30c42e(0xa1)](_0x394de5,_0x4eb0c3,_0x110e3b=null){const _0x5edcee=a0_0x30c42e,_0xb0be42=_0x110e3b||this[_0x5edcee(0x117)]();this[_0x5edcee(0xa8)]['info'](_0x5edcee(0x107)+_0x394de5);const _0x3377f0=this['_sanitizeConversationId'](_0x394de5);_0x3377f0!==_0x394de5&&this['logger'][_0x5edcee(0xc0)](_0x5edcee(0x98)+_0x394de5+'\x22\x20to\x20\x22'+_0x3377f0+'\x22');if(!this['_isValidConversationId'](_0x3377f0))throw new Error(_0x5edcee(0xeb)+_0x394de5);this[_0x5edcee(0x9d)][_0x5edcee(0x82)](_0x3377f0,{'originalId':_0x394de5,'systemPrompt':_0x4eb0c3||'','messages':[],'model':_0xb0be42,'createdAt':new Date()[_0x5edcee(0x118)](),'lastActivity':new Date()[_0x5edcee(0x118)]()}),_0x3377f0!==_0x394de5&&this[_0x5edcee(0x9d)]['set'](_0x394de5,this[_0x5edcee(0x9d)][_0x5edcee(0xa6)](_0x3377f0));}['_getDefaultModel'](){const _0x495a96=a0_0x30c42e,_0xfd4d2c=['azure-openai-gpt4','anthropic-sonnet',_0x495a96(0x125)];for(const _0x555e2f of _0xfd4d2c){if(this['availableModels']['has'](_0x555e2f))return _0x555e2f;}const _0x5c6c60=this[_0x495a96(0xd9)]['values']()['next']()[_0x495a96(0xce)];return _0x5c6c60?_0x5c6c60[_0x495a96(0xfe)]:_0x495a96(0x11f);}async[a0_0x30c42e(0x109)](_0x3b2628,_0x1dbba2,_0x356d0a){const _0x34252c=a0_0x30c42e;this['logger']['info'](_0x34252c(0x10a)+_0x3b2628);if(!this[_0x34252c(0x119)])throw new Error(_0x34252c(0xf6));if(!this['apiKey'])throw new Error(_0x34252c(0x8d));this[_0x34252c(0xf2)](_0x3b2628,_0x1dbba2);const _0x22dddd=this['_sanitizeConversationId'](_0x3b2628),_0x49e7e3=this['conversations']['has'](_0x3b2628)?_0x3b2628:_0x22dddd;if(!this['conversations'][_0x34252c(0x12c)](_0x49e7e3))throw new Error(_0x34252c(0xb3)+_0x3b2628+_0x34252c(0xb8));const _0x1e6c2e=this[_0x34252c(0x9d)]['get'](_0x49e7e3);_0x356d0a&&(!_0x1e6c2e[_0x34252c(0x116)]||_0x1e6c2e[_0x34252c(0x116)]['length']===0x0)&&this[_0x34252c(0x120)](_0x1e6c2e,_0x356d0a);const _0x163250=this['_buildChatRequestPayload'](_0x22dddd,_0x1dbba2,_0x1e6c2e);try{const _0x250a07=await this['_sendChatRequest'](_0x163250);return this[_0x34252c(0x86)](_0x1e6c2e,_0x1dbba2,_0x250a07),_0x250a07[_0x34252c(0x9c)];}catch(_0x56361b){this['logger']['error'](_0x34252c(0xd6),_0x56361b);throw this[_0x34252c(0xdc)](_0x56361b,_0x34252c(0xee));}}['_validateSendMessageInputs'](_0x384b9d,_0x344c64){if(!_0x384b9d||typeof _0x384b9d!=='string')throw new Error('Invalid\x20conversation\x20ID');if(!_0x344c64||typeof _0x344c64!=='string')throw new Error('Invalid\x20message\x20content');}['_updateConversationState'](_0x3142e5,_0x3b8a68){const _0x5af33b=a0_0x30c42e;_0x3b8a68[_0x5af33b(0x116)]&&Array[_0x5af33b(0x95)](_0x3b8a68[_0x5af33b(0x116)])&&(_0x3142e5[_0x5af33b(0x116)]=_0x3b8a68[_0x5af33b(0x116)]),_0x3b8a68['systemPrompt']&&typeof _0x3b8a68[_0x5af33b(0xc2)]==='string'&&(_0x3142e5[_0x5af33b(0xc2)]=_0x3b8a68['systemPrompt']),_0x3b8a68[_0x5af33b(0x11c)]&&this[_0x5af33b(0xd9)]['has'](_0x3b8a68['model'])&&(_0x3142e5['model']=_0x3b8a68[_0x5af33b(0x11c)]),_0x3142e5[_0x5af33b(0xcf)]=new Date()['toISOString']();}['_buildChatRequestPayload'](_0x1a6b44,_0x3777de,_0x24c4a7){const _0x3a7024=a0_0x30c42e;return{'conversationId':_0x1a6b44,'message':_0x3777de[_0x3a7024(0xc9)](),'systemPrompt':_0x24c4a7['systemPrompt'],'messages':_0x24c4a7['messages']||[],'model':_0x24c4a7[_0x3a7024(0x11c)],'requestId':this[_0x3a7024(0xfd)](),'options':{'temperature':0.7,'maxTokens':this['_getModelMaxTokens'](_0x24c4a7[_0x3a7024(0x11c)])}};}[a0_0x30c42e(0xfd)](){const _0x14c8dc=a0_0x30c42e;return _0x14c8dc(0xdf)+Date[_0x14c8dc(0x11d)]()+'_'+ ++this[_0x14c8dc(0xf5)];}[a0_0x30c42e(0x103)](_0x456d2b){const _0x16f4eb=a0_0x30c42e,_0xc92a1a=this[_0x16f4eb(0xd9)][_0x16f4eb(0xa6)](_0x456d2b);return _0xc92a1a?_0xc92a1a[_0x16f4eb(0x84)]:0xfa0;}async[a0_0x30c42e(0xea)](_0x20a171){const _0x1b0266=a0_0x30c42e;try{const _0x1b49b0=await this[_0x1b0266(0xb9)]('/llm/chat',{'method':'POST','body':JSON[_0x1b0266(0xf3)](_0x20a171)});if(!_0x1b49b0['ok']){const _0x19b4f9=await this['_safeJsonParse'](_0x1b49b0),_0x2d9b53=this['_createHttpError'](_0x1b49b0[_0x1b0266(0x128)],_0x19b4f9[_0x1b0266(0xe0)]||_0x1b49b0['statusText']);throw _0x2d9b53;}const _0x5823eb=await _0x1b49b0['json']();return this[_0x1b0266(0x111)](_0x5823eb),_0x5823eb;}catch(_0xc5f97e){throw _0xc5f97e;}}['_validateChatResponse'](_0xac2887){const _0x5ce712=a0_0x30c42e;if(!_0xac2887[_0x5ce712(0x9c)]||typeof _0xac2887['content']!=='string')throw new Error('Invalid\x20response:\x20missing\x20or\x20invalid\x20content');if(_0xac2887[_0x5ce712(0xa3)]&&typeof _0xac2887['usage']!=='object')throw new Error('Invalid\x20response:\x20invalid\x20usage\x20data');}['_processChatResponse'](_0x2ad410,_0x5efce8,_0x4da54a){const _0x35c0f9=a0_0x30c42e;_0x4da54a['usage']&&(this[_0x35c0f9(0xad)]=_0x4da54a[_0x35c0f9(0xa3)][_0x35c0f9(0xde)]||0x0,this[_0x35c0f9(0xba)]=_0x4da54a['usage']['output_tokens']||0x0,this['tokenUsage'][_0x35c0f9(0x100)]+=this[_0x35c0f9(0xad)],this[_0x35c0f9(0xc5)]['output']+=this['lastOutputTokenCount']),_0x2ad410['messages'][_0x35c0f9(0xc6)]({'role':_0x35c0f9(0x104),'content':_0x5efce8},{'role':_0x35c0f9(0xdd),'content':_0x4da54a['content']}),_0x2ad410[_0x35c0f9(0xcf)]=new Date()[_0x35c0f9(0x118)]();}async['updateConversation'](_0x4505af,_0x34f016){const _0x1fa295=a0_0x30c42e;this['logger'][_0x1fa295(0xc0)]('Updating\x20server\x20conversation:\x20'+_0x4505af);const _0x4f9b73=this[_0x1fa295(0x85)](_0x4505af),_0x4ea438=this['conversations'][_0x1fa295(0x12c)](_0x4505af)?_0x4505af:_0x4f9b73;if(!this[_0x1fa295(0x9d)]['has'](_0x4ea438))throw new Error('Conversation\x20'+_0x4505af+_0x1fa295(0xb8));const _0x98c6bd=this['conversations'][_0x1fa295(0xa6)](_0x4ea438);this['_updateConversationState'](_0x98c6bd,_0x34f016);}async[a0_0x30c42e(0xb7)](_0x419a9d,_0x2048bc=null){const _0x3b6996=a0_0x30c42e;this['logger']['info']('Getting summary from server');if(!this['isInitialized'])throw new Error('Service\x20not\x20initialized.\x20Call\x20initialize()\x20first.');if(!this[_0x3b6996(0xb0)])throw new Error(_0x3b6996(0x8d));if(!_0x419a9d||typeof _0x419a9d!==_0x3b6996(0xe6))throw new Error('Invalid\x20summary\x20prompt');let _0x3adb08='azure-ai-phi4';if(_0x2048bc&&this[_0x3b6996(0x9d)]['has'](_0x2048bc)){const _0x50d08a=this['conversations'][_0x3b6996(0xa6)](_0x2048bc);_0x3adb08=_0x50d08a['model'],this['logger'][_0x3b6996(0xc0)]('Using\x20conversation\x20model\x20for\x20summary:\x20'+_0x3adb08);}else this[_0x3b6996(0xa8)][_0x3b6996(0x114)]('No conversation ID provided or conversation not found, using default model for summary');try{const _0x54720e=await this['_makeRequest']('/llm/summary',{'method':'POST','body':JSON['stringify']({'prompt':_0x419a9d[_0x3b6996(0xc9)](),'model':_0x3adb08})});if(!_0x54720e['ok']){const _0x236f90=await this['_safeJsonParse'](_0x54720e);throw this['_createHttpError'](_0x54720e['status'],_0x236f90[_0x3b6996(0xe0)]||_0x54720e['statusText']);}const _0x1311ce=await _0x54720e['json']();return _0x1311ce['usage']&&(this[_0x3b6996(0xad)]=_0x1311ce[_0x3b6996(0xa3)]['input_tokens']||0x0,this[_0x3b6996(0xba)]=_0x1311ce['usage'][_0x3b6996(0xa4)]||0x0,this['tokenUsage'][_0x3b6996(0x100)]+=this[_0x3b6996(0xad)],this[_0x3b6996(0xc5)][_0x3b6996(0xe3)]+=this[_0x3b6996(0xba)]),_0x1311ce[_0x3b6996(0x9c)];}catch(_0x45afcf){this['logger'][_0x3b6996(0xe0)]('Error getting summary from server:',_0x45afcf);throw this['_enhanceError'](_0x45afcf,_0x3b6996(0xbe));}}async[a0_0x30c42e(0xac)](_0x37902f,_0x492144,_0x219ff9={}){const _0xf98245=a0_0x30c42e;this[_0xf98245(0xa8)]['info']('Getting image description from server');if(!this['isInitialized'])throw new Error(_0xf98245(0xf6));if(!this['apiKey'])throw new Error(_0xf98245(0x8d));this['_validateImageDescriptionInputs'](_0x37902f,_0x492144);try{const _0x1a83d5=await this['_makeRequest'](_0xf98245(0xf8),{'method':_0xf98245(0x129),'body':JSON['stringify']({'image':_0x37902f,'prompt':_0x492144['trim'](),'metadata':_0x219ff9||{}})}),_0x4f28ae=await this['_safeJsonParse'](_0x1a83d5);if(!_0x1a83d5['ok'])throw this[_0xf98245(0x10c)](_0x1a83d5['status'],_0x4f28ae['error']||_0x1a83d5['statusText']);return _0x4f28ae['usage']&&(this['lastInputTokenCount']=_0x4f28ae['usage'][_0xf98245(0xde)]||0x0,this[_0xf98245(0xba)]=_0x4f28ae['usage']['output_tokens']||0x0,this[_0xf98245(0xc5)][_0xf98245(0x100)]+=this['lastInputTokenCount'],this['tokenUsage'][_0xf98245(0xe3)]+=this['lastOutputTokenCount']),_0x4f28ae[_0xf98245(0x9c)];}catch(_0x4688b5){this[_0xf98245(0xa8)][_0xf98245(0xe0)]('Error getting image description from server:',_0x4688b5);throw this['_enhanceError'](_0x4688b5,'get_image_description');}}['_validateImageDescriptionInputs'](_0x4f944c,_0x551c66){const _0x49869a=a0_0x30c42e;if(!_0x4f944c||typeof _0x4f944c!==_0x49869a(0xe6))throw new Error(_0x49869a(0xd7));if(!_0x551c66||typeof _0x551c66!==_0x49869a(0xe6))throw new Error(_0x49869a(0xc8));if(_0x4f944c[_0x49869a(0xe4)]>0x32*0x400*0x400)throw new Error('Image\x20data\x20too\x20large');}async['estimateTokenCount'](_0x31994d){const _0xccc4b4=a0_0x30c42e,_0x2998f9=this['_sanitizeConversationId'](_0x31994d),_0x1fb16b=this[_0xccc4b4(0x9d)]['has'](_0x31994d)?_0x31994d:_0x2998f9;if(!this['conversations']['has'](_0x1fb16b))throw new Error(_0xccc4b4(0xb3)+_0x31994d+'\x20not\x20found');const _0x4d2046=this[_0xccc4b4(0x9d)][_0xccc4b4(0xa6)](_0x1fb16b);let _0x258635=this['_estimateTokens'](_0x4d2046[_0xccc4b4(0xc2)]);for(const _0x429151 of _0x4d2046['messages']){_0x258635+=this[_0xccc4b4(0x91)](_0x429151[_0xccc4b4(0x9c)]);}return _0x258635;}['_estimateTokens'](_0x46c5b0){const _0x41602a=a0_0x30c42e;if(!_0x46c5b0||typeof _0x46c5b0!=='string')return 0x0;return Math['ceil'](_0x46c5b0[_0x41602a(0xe4)]/0x4);}['supportsModel'](_0x2a387e){const _0x3aba7b=a0_0x30c42e;return this['availableModels'][_0x3aba7b(0x12c)](_0x2a387e);}['getMaxContextSize'](){const _0x2197fe=a0_0x30c42e;let _0x511147=0x0;for(const _0x5450ba of this['availableModels']['values']()){_0x5450ba[_0x2197fe(0x84)]>_0x511147&&(_0x511147=_0x5450ba[_0x2197fe(0x84)]);}return _0x511147||0x186a0;}[a0_0x30c42e(0x102)](){const _0x1ec104=a0_0x30c42e;return this[_0x1ec104(0xad)];}['getLastOutputTokenCount'](){return this['lastOutputTokenCount'];}[a0_0x30c42e(0x124)](){return{...this['tokenUsage']};}async['refreshPricingData'](){const _0x1f6ec2=a0_0x30c42e;this[_0x1f6ec2(0xa8)]['info']('Refreshing pricing data from server'),await this['_loadPricingData']();}async['getServerHealth'](){const _0x42473c=a0_0x30c42e;try{const _0x474288=await this['_makeRequest'](_0x42473c(0x11b));if(!_0x474288['ok'])return{'status':_0x42473c(0x81),'error':'HTTP\x20'+_0x474288['status']+':\x20'+_0x474288[_0x42473c(0xe7)]};const _0x287f2a=await _0x474288['json']();return{'status':_0x42473c(0xf9),..._0x287f2a};}catch(_0x592914){return{'status':'unhealthy','error':_0x592914[_0x42473c(0xb4)]};}}async[a0_0x30c42e(0x83)](){const _0x3c0001=a0_0x30c42e;this[_0x3c0001(0xa8)]['info']('Shutting\x20down\x20server\x20LLM\x20service'),this['conversations'][_0x3c0001(0xa2)](),this['availableModels']['clear'](),this['pricingData']['clear'](),this[_0x3c0001(0x119)]=![],this[_0x3c0001(0xb0)]=null,this['logger'][_0x3c0001(0xc0)](_0x3c0001(0x8b));}async['_makeRequest'](_0x2b95f0,_0xe045a7={}){const _0x4e3d4e=a0_0x30c42e,_0x4e3df7=''+this[_0x4e3d4e(0xab)]+_0x2b95f0,_0x5efe37={'method':_0xe045a7[_0x4e3d4e(0x94)]||'GET','headers':{'Content-Type':'application/json','User-Agent':'Loxia-CLI/1.0.0',..._0xe045a7['headers']},'timeout':this['timeout'],..._0xe045a7};this[_0x4e3d4e(0xb0)]&&(_0x5efe37['headers'][_0x4e3d4e(0xec)]=_0x4e3d4e(0x97)+this['apiKey']);try{const _0x519f4d=await a0_0x459568(_0x4e3df7,_0x5efe37);return _0x519f4d;}catch(_0x26cc75){throw this['_createNetworkError'](_0x26cc75,_0x4e3df7);}}async['_safeJsonParse'](_0x139c50){const _0x37c474=a0_0x30c42e;try{return await _0x139c50[_0x37c474(0xe8)]();}catch(_0x115436){return{};}}[a0_0x30c42e(0xdc)](_0x1f52aa,_0x289156){const _0x103162=a0_0x30c42e,_0x1ff9a3=new Error(_0x289156+'\x20failed:\x20'+_0x1f52aa[_0x103162(0xb4)]);return _0x1ff9a3[_0x103162(0x110)]=_0x289156,_0x1ff9a3['originalError']=_0x1f52aa,_0x1ff9a3['errorType']=this[_0x103162(0xd2)](_0x1f52aa),_0x1ff9a3;}[a0_0x30c42e(0x10c)](_0x62dd4b,_0x1235de){const _0x4336b4=a0_0x30c42e,_0x2e6f85=new Error(_0x4336b4(0xf1)+_0x62dd4b+':\x20'+_0x1235de);return _0x2e6f85['status']=_0x62dd4b,_0x2e6f85['errorType']=this[_0x4336b4(0xe5)](_0x62dd4b),_0x2e6f85;}[a0_0x30c42e(0x106)](_0xf7ac9e,_0x8c2fa8){const _0x20a074=a0_0x30c42e,_0x2da86f=new Error('Network\x20request\x20failed:\x20'+_0xf7ac9e[_0x20a074(0xb4)]);_0x2da86f['url']=_0x8c2fa8,_0x2da86f[_0x20a074(0xfb)]=_0xf7ac9e,_0x2da86f['errorType']=ERROR_TYPES[_0x20a074(0xbb)];if(_0xf7ac9e['code']==='ECONNREFUSED')_0x2da86f['message']='Connection\x20refused.\x20Server\x20may\x20be\x20down.';else{if(_0xf7ac9e['code']==='ENOTFOUND')_0x2da86f['message']='DNS\x20lookup\x20failed.\x20Check\x20server\x20URL.';else(_0xf7ac9e[_0x20a074(0x90)]===_0x20a074(0x113)||_0xf7ac9e['name']==='AbortError')&&(_0x2da86f[_0x20a074(0xb4)]='Request\x20timeout.\x20Server\x20may\x20be\x20overloaded.',_0x2da86f['errorType']=ERROR_TYPES[_0x20a074(0x7d)]);}return _0x2da86f;}['_classifyError'](_0x30bb21){const _0x4ad2ac=a0_0x30c42e;if(_0x30bb21[_0x4ad2ac(0x128)])return this['_classifyHttpError'](_0x30bb21['status']);if(_0x30bb21[_0x4ad2ac(0x90)]==='ECONNREFUSED'||_0x30bb21[_0x4ad2ac(0x90)]==='ENOTFOUND')return ERROR_TYPES[_0x4ad2ac(0xbb)];if(_0x30bb21[_0x4ad2ac(0x90)]===_0x4ad2ac(0x113)||_0x30bb21['name']==='AbortError')return ERROR_TYPES['TIMEOUT'];return ERROR_TYPES['UNKNOWN'];}['_classifyHttpError'](_0x2f84b6){const _0x147e73=a0_0x30c42e;switch(_0x2f84b6){case HTTP_STATUS[_0x147e73(0xb6)]:case HTTP_STATUS[_0x147e73(0xdb)]:return ERROR_TYPES[_0x147e73(0xc4)];case HTTP_STATUS['BAD_REQUEST']:return ERROR_TYPES['VALIDATION'];case HTTP_STATUS['TOO_MANY_REQUESTS']:return ERROR_TYPES['RATE_LIMIT'];case HTTP_STATUS['INTERNAL_SERVER_ERROR']:case HTTP_STATUS['BAD_GATEWAY']:case HTTP_STATUS['SERVICE_UNAVAILABLE']:case HTTP_STATUS[_0x147e73(0x12a)]:return ERROR_TYPES[_0x147e73(0xd5)];default:return ERROR_TYPES[_0x147e73(0x101)];}}['_isNonRetryableError'](_0x1ae7aa){const _0xe68cce=a0_0x30c42e,_0x28c7be=[ERROR_TYPES[_0xe68cce(0xc4)],ERROR_TYPES[_0xe68cce(0x105)]],_0x30a9cf=[HTTP_STATUS[_0xe68cce(0xe1)],HTTP_STATUS[_0xe68cce(0xb6)],HTTP_STATUS['FORBIDDEN'],HTTP_STATUS[_0xe68cce(0x88)]];return _0x28c7be[_0xe68cce(0x10f)](_0x1ae7aa['errorType'])||_0x30a9cf[_0xe68cce(0x10f)](_0x1ae7aa['status']);}['_delay'](_0x496b3b){return new Promise(_0x203975=>setTimeout(_0x203975,_0x496b3b));}['_decryptKey'](_0x54af5c){const _0x1d7ec4=a0_0x30c42e,_0x5decc0=_0x1d7ec4(0xa5),_0x6b50a4=Buffer[_0x1d7ec4(0xfc)](_0x54af5c,'base64')[_0x1d7ec4(0xfa)]();let _0x1aa3c7='';for(let _0x196157=0x0;_0x196157<_0x6b50a4['length'];_0x196157++){_0x1aa3c7+=String[_0x1d7ec4(0x12d)](_0x6b50a4[_0x1d7ec4(0x12b)](_0x196157)^_0x5decc0['charCodeAt'](_0x196157%_0x5decc0[_0x1d7ec4(0xe4)]));}return _0x1aa3c7;}}