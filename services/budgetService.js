const a0_0x21010f=a0_0x1938;(function(_0x1c0770,_0x589b02){const _0x29421d=a0_0x1938,_0x3be7fc=_0x1c0770();while(!![]){try{const _0x3c6ea6=-parseInt(_0x29421d(0x104))/0x1*(parseInt(_0x29421d(0xf9))/0x2)+parseInt(_0x29421d(0x125))/0x3*(-parseInt(_0x29421d(0x158))/0x4)+parseInt(_0x29421d(0x12b))/0x5*(parseInt(_0x29421d(0x126))/0x6)+-parseInt(_0x29421d(0x14e))/0x7*(-parseInt(_0x29421d(0xef))/0x8)+-parseInt(_0x29421d(0x11a))/0x9*(parseInt(_0x29421d(0x147))/0xa)+-parseInt(_0x29421d(0x10e))/0xb*(-parseInt(_0x29421d(0x143))/0xc)+parseInt(_0x29421d(0x150))/0xd;if(_0x3c6ea6===_0x589b02)break;else _0x3be7fc['push'](_0x3be7fc['shift']());}catch(_0x2d1d8c){_0x3be7fc['push'](_0x3be7fc['shift']());}}}(a0_0x818c,0xd8f01));import{promises as a0_0x4711b0}from'fs';import a0_0xde9d08 from'path';const DEFAULT_USAGE_DIR='./.loxia-budget',USAGE_FILENAME=a0_0x21010f(0xf6),SESSION_PREFIX=a0_0x21010f(0x175),PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':'Budget\x20amount\x20must\x20be\x20a\x20positive\x20number','INVALID_TOKENS':a0_0x21010f(0xfc),'INVALID_SERVICE':'Service\x20name\x20must\x20be\x20a\x20non-empty\x20string','BUDGET_EXCEEDED':a0_0x21010f(0x148),'PRICING_UNAVAILABLE':a0_0x21010f(0x114),'FILE_SYSTEM_ERROR':'File\x20system\x20operation\x20failed'};function a0_0x818c(){const _0x3b1625=['x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','zMfSBgjHy2S','x2nOzwnRqNvKz2v0u3rHDhvZ','yNvKz2v0','C2f2zvvZywDLrgf0yq','su5wquXjrf9btu9vtLq','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','yNjLywTKB3DUqNLnB2rLBa','muSGDg9Rzw5Z','C3rHDhvZ','C2v0','mtmYofndCLveEG','z2v0q29ZDevZDgLTyxrL','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','BgfZDfnHDMvKq29ZDa','Bw9KzwXvC2fNzq','zw50CMLLCW','ig1VzgvSCYbMCM9TihnLCNzLCG','DxnHz2uUANnVBG','z3b0ltq','D2fYBG','mKreuwXiCq','BgfZDfvWzgf0zwq','AgvHBhrOEq','vg9Rzw4Gy291BNrZig11C3qGyMuGBM9Ulw5Lz2f0AxzLig51BwjLCNm','x2nHBgn1Bgf0zunVC3q','zNjVBq','Aw5MBW','qNvKz2v0ia','Dg90ywXpDxrWDxruB2TLBNm','uMvZzxr0Aw5NihvZywDLigrHDge','Dw5SAw5R','mJe0otC5z2f1B2HJ','qNvKz2v0igXPBwL0oIaK','igv4y2vLzhmGBgLTAxqGB2yGja','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG','rMLSzsbZExn0zw0GywnJzxnZigLZC3vLCW','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','C2XPy2u','C291CMnL','su5wquXjrf9trvjwsunf','y29Kzq','odC5nZu4Ag56DKHi','rMfPBgvKihrVihnHDMuGDxnHz2uGzgf0ytO','zw5KC1DPDgG','x2v4Cg9YDfrVq3n2','C2vYDMvYteXnu2vYDMLJzq','tg9HzgvKihbYzxzPB3vZihvZywDLigrHDge','uhjPy2LUzYbPBMzVCM1HDgLVBIb1BMf2ywLSywjSzq','DxnHz2veAxi','CMvTywLUAw5NqNvKz2v0','uhjVy2vLzcb3AxrOig9WzxjHDgLVBI4','C2vYDMvY','B3v0Chv0vg9Rzw5Z','mtqWmJuWnKrfBuPIAG','y29UzMLN','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','yNjLywTKB3DUqNLtzxj2AwnL','C29UBMv0','qNvKz2v0igXPBwL0ihnLDcb0BYaK','C3rYAw5N','z2v0vxnHz2vszxbVCNq','Aw5JBhvKzxm','Aw5WDxq','jsb1C2vK','m3j0qMfAtW','mtC1ogn4tfDtBq','y3vYCMvUy3K','C2vZC2LVBLn0yxj0','Bwf4','BgfZDfbYAwnPBMDvCgrHDgu','mtaZmtv3CgLxuuS','t3bLCMf0Aw9UigLZihDPDgHPBIbIDwrNzxqGz3vPzgvSAw5LCY4','Dg9ju09tDhjPBMC','zMLSDgvY','oIaK','CgvYy2vUDgfNzvvZzwq','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','ywXS','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','vg90ywWGy29ZDdOGja','zgvIDwC','ihjLCxvLC3rZkqO','zxn0Aw1HDgu','Dg90ywXjBNb1DfrVA2vUCW','vxnHz2u6ia','z2v0uhjPy2LUz0rHDge','BwfW','ChjPy2LUz0LUzM8','yNvKz2v0u3rHDhvZ','z2v0','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','pt09ifvtquDfifjfue9svca9pt0k','ChvZAa','BgvUz3rO','mtjfsw9SywG','yNvKz2v0sw1Wywn0','C3rHDa','BMfTzq','mtbkzNjdwNe','qNvKz2v0igXPBwL0igv4y2vLzgvK','AgfYzeXPBwL0','Dg9gAxHLza','BM9YBwfS','Dg9mB2nHBgvtDhjPBMC','uMvJB3jKAw5NihvZywDLigzVCIa','nZiXEfjgqNbO','z2v0tw9KzwXqCMLJAw5N','mtm4mJe2mdbgsMPnvxK','BwvZC2fNzq','C3rYAw5NAwz5','rKLmrv9twvnuru1Frvjst1i','u2vYDMLJzsW','y29ZDa','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','yNvKz2v0tgLTAxq','mJaYmtm4mhD2vvjOva','Cgf0Aa','Dg90ywXdB3n0','BgLTAxq','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','lMPZB24','Dw5PDa','rxjYB3iGAw5PDgLHBgL6Aw5NihvZywDLigrHDgeGzgLYzwn0B3j5oG','Aw5WDxruB2TLBNm','BM93','C2vYDMLJzvvZywDL','x3zHBgLKyxrLqNvKz2v0qw1VDw50','u2H1DhrPBMCGzg93BIbIDwrNzxqGC2vYDMLJzq','AM9PBG','ChjPy2LUz0rHDge','x2vUC3vYzvvZywDLrgLYzwn0B3j5','x2DLBMvYyxrLu2vZC2LVBKLK','qLver0vux0vyq0vfreve','BwTKAxi','su5wquXjrf9ut0TftLm','CMvXDwvZDenVDw50','DxnHz2u','y2XLyxi','D2fYBMLUz0XLDMvS','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','C2H1DgrVD24','C2L6zq','CMvHzezPBgu','zgvNCMfKzwq','C2vZC2LVBL8','uhjPy2LUzYb1CgrHDguGywXYzwfKEsbPBIbWCM9NCMvZCW','x2LUAxrPywXPEMvvC2fNzurHDge','DxrMltG','y3n2','z2v0qNvKz2v0vxnHz2u','x2DLDevZDgLTyxrLzfbYAwnPBMC','A2v5CW','B3v0Chv0','D3jPDgvgAwXL','zxjYB3i','Bg9Nz2vY','AxnZDwvZ','x2XVywrcDwrNzxrmAw1PDa','CMvZzxrvC2fNzurHDge','z2v0vgLTzq','cLbYAwnPBMCGC291CMnLoIa','Dg9tDhjPBMC'];a0_0x818c=function(){return _0x3b1625;};return a0_0x818c();}function a0_0x1938(_0x3c057e,_0x2ac8d1){const _0x818c09=a0_0x818c();return a0_0x1938=function(_0x1938f2,_0x5c8bb9){_0x1938f2=_0x1938f2-0xee;let _0x4267dc=_0x818c09[_0x1938f2];if(a0_0x1938['eFJklB']===undefined){var _0xe40314=function(_0x4711b0){const _0xde9d08='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x358324='',_0x11548b='';for(let _0x51efeb=0x0,_0x2d9f3a,_0x4ecf75,_0x38be75=0x0;_0x4ecf75=_0x4711b0['charAt'](_0x38be75++);~_0x4ecf75&&(_0x2d9f3a=_0x51efeb%0x4?_0x2d9f3a*0x40+_0x4ecf75:_0x4ecf75,_0x51efeb++%0x4)?_0x358324+=String['fromCharCode'](0xff&_0x2d9f3a>>(-0x2*_0x51efeb&0x6)):0x0){_0x4ecf75=_0xde9d08['indexOf'](_0x4ecf75);}for(let _0xa72254=0x0,_0x32f253=_0x358324['length'];_0xa72254<_0x32f253;_0xa72254++){_0x11548b+='%'+('00'+_0x358324['charCodeAt'](_0xa72254)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x11548b);};a0_0x1938['wpdQiW']=_0xe40314,_0x3c057e=arguments,a0_0x1938['eFJklB']=!![];}const _0x217082=_0x818c09[0x0],_0x4ca0b3=_0x1938f2+_0x217082,_0x426705=_0x3c057e[_0x4ca0b3];return!_0x426705?(_0x4267dc=a0_0x1938['wpdQiW'](_0x4267dc),_0x3c057e[_0x4ca0b3]=_0x4267dc):_0x4267dc=_0x426705,_0x4267dc;},a0_0x1938(_0x3c057e,_0x2ac8d1);}export class BudgetService{constructor(_0x358324,_0x11548b,_0x51efeb=null){const _0x50fc71=a0_0x21010f;this['config']=_0x358324,this[_0x50fc71(0x180)]=_0x11548b,this['serverLLMService']=_0x51efeb,this[_0x50fc71(0x16d)]=this[_0x50fc71(0x177)](),this[_0x50fc71(0x157)]=this['_loadBudgetLimit'](),this[_0x50fc71(0x149)]=_0x358324['budget']?.[_0x50fc71(0x149)]||![],this[_0x50fc71(0x166)]=new Map(),this['lastPricingUpdate']=null,this['pricingUpdateInProgress']=![],this[_0x50fc71(0x115)]=_0x358324[_0x50fc71(0x18a)]?.[_0x50fc71(0x115)]||DEFAULT_USAGE_DIR,this['logger']['info']('Budget\x20service\x20initialized',{'budgetLimit':this['budgetLimit'],'hardLimit':this['hardLimit'],'usageDir':this[_0x50fc71(0x115)],'hasPricingService':!!this[_0x50fc71(0x112)]}),this['_loadUsageData']()['catch'](_0x2d9f3a=>{const _0x5476f8=_0x50fc71;this[_0x5476f8(0x180)][_0x5476f8(0xf8)]('Failed\x20to\x20load\x20previous\x20usage\x20data:',_0x2d9f3a);});}[a0_0x21010f(0x177)](){const _0x15dab0=a0_0x21010f;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()[_0x15dab0(0x12d)](),'sessionId':this[_0x15dab0(0x168)](),'lastUpdated':new Date()['toISOString']()};}['_generateSessionId'](){const _0x58a503=a0_0x21010f,_0x4ecf75=Date[_0x58a503(0x161)]()[_0x58a503(0x186)](0x24),_0x38be75=Math['random']()[_0x58a503(0x186)](0x24)[_0x58a503(0x10a)](0x2);return _0x4ecf75+'_'+_0x38be75;}[a0_0x21010f(0x182)](){const _0x499aa0=a0_0x21010f,_0xa72254=this['config'][_0x499aa0(0x18a)]?.[_0x499aa0(0x15b)];if(_0xa72254!==undefined&&_0xa72254!==null)return this[_0x499aa0(0x163)](_0xa72254);return null;}async[a0_0x21010f(0x13f)](){const _0x552947=a0_0x21010f;if(!this['serverLLMService'])return this[_0x552947(0x180)][_0x552947(0x135)]('No\x20server\x20LLM\x20service\x20available\x20for\x20pricing\x20updates'),![];if(this['pricingUpdateInProgress'])return this['logger']['debug'](_0x552947(0x176)),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this[_0x552947(0x180)]['info']('Updating pricing data from server');const _0x32f253=await this[_0x552947(0x112)][_0x552947(0x13a)]();if(_0x32f253['size']===0x0)return this[_0x552947(0x180)][_0x552947(0xf8)]('No pricing data received from server'),![];this[_0x552947(0x166)][_0x552947(0x16e)]();for(const [_0x585ec0,_0x2a57d1]of _0x32f253['entries']()){this[_0x552947(0x166)][_0x552947(0xee)](_0x585ec0,{'input':_0x2a57d1['input'],'output':_0x2a57d1[_0x552947(0x17d)],'unit':_0x2a57d1[_0x552947(0x15e)]||'1K\x20tokens','currency':_0x2a57d1[_0x552947(0x127)]||'USD'});}return this['lastPricingUpdate']=new Date()['toISOString'](),this['logger'][_0x552947(0xff)]('Updated\x20pricing\x20for\x20'+this[_0x552947(0x166)][_0x552947(0x172)]+_0x552947(0xf5)),!![];}catch(_0x28f45a){return this['logger'][_0x552947(0x17f)]('Failed to update pricing from server:',_0x28f45a),![];}finally{this[_0x552947(0x15c)]=![];}}['_shouldUpdatePricing'](){const _0x30f9ff=a0_0x21010f;if(!this['lastPricingUpdate'])return!![];const _0x21579c=Date['now']()-new Date(this['lastPricingUpdate'])[_0x30f9ff(0x184)]();return _0x21579c>PRICING_REFRESH_THRESHOLD_MS;}[a0_0x21010f(0x14f)](_0x245b4b){const _0x30d430=a0_0x21010f;if(!_0x245b4b||typeof _0x245b4b!==_0x30d430(0x120))return this['logger']['warn']('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this['pricingData'][_0x30d430(0x13e)](_0x245b4b)||null;}['getAllPricing'](){return this['serverLLMService']['getPricingData']();}async['recordUsage'](_0xefcc4a,_0x475bab,_0x15cdce,_0xf01022){const _0x2570bf=a0_0x21010f;this['logger'][_0x2570bf(0xff)](_0x2570bf(0x14d)+_0xefcc4a+'/'+_0x475bab,{'inputTokens':_0x15cdce,'outputTokens':_0xf01022,'service':_0xefcc4a,'model':_0x475bab}),this[_0x2570bf(0x156)](_0xefcc4a,_0x475bab,_0x15cdce,_0xf01022),await this['updatePricingFromServer']();const _0x3128be=this[_0x2570bf(0xfd)](_0x475bab,_0x15cdce,_0xf01022);!_0x3128be['success']&&this[_0x2570bf(0x180)]['warn']('Pricing\x20unavailable\x20for\x20model\x20'+_0x475bab+',\x20using\x20estimate');this['_updateUsageData'](_0xefcc4a,_0x475bab,_0x15cdce,_0xf01022,_0x3128be[_0x2570bf(0x15a)]);const _0x3de407=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x4fcc81={'service':_0xefcc4a,'model':_0x475bab,'inputTokens':_0x15cdce,'outputTokens':_0xf01022,'cost':_0x3128be,'budgetStatus':_0x3de407,'timestamp':new Date()['toISOString']()};return this[_0x2570bf(0x180)][_0x2570bf(0x135)]('Usage\x20recorded\x20successfully',_0x4fcc81),_0x4fcc81;}['_validateUsageInputs'](_0x34a9d6,_0x1d8099,_0x576e5f,_0xba77ae){const _0x5781f1=a0_0x21010f;if(!_0x34a9d6||typeof _0x34a9d6!==_0x5781f1(0x120))throw new Error(ERROR_MESSAGES[_0x5781f1(0x10c)]);if(!_0x1d8099||typeof _0x1d8099!=='string')throw new Error('Model\x20name\x20must\x20be\x20a\x20non-empty\x20string');if(typeof _0x576e5f!=='number'||_0x576e5f<0x0)throw new Error(ERROR_MESSAGES[_0x5781f1(0x16b)]);if(typeof _0xba77ae!=='number'||_0xba77ae<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);}[a0_0x21010f(0xfd)](_0x3136b3,_0x31db85,_0x4ea9b9){const _0xb17c51=a0_0x21010f,_0x152490=this['getModelPricing'](_0x3136b3);if(!_0x152490){const _0xc42c29=this['_getEstimatedPricing'](_0x3136b3),_0x231b1c=_0x31db85/0x3e8*_0xc42c29['input'],_0x301f09=_0x4ea9b9/0x3e8*_0xc42c29['output'];return{'success':![],'inputCost':_0x231b1c,'outputCost':_0x301f09,'totalCost':_0x231b1c+_0x301f09,'currency':'USD','unit':_0xb17c51(0x18f),'estimated':!![],'reason':'Pricing\x20data\x20unavailable\x20for\x20model'};}const _0x4aec00=_0x31db85/0x3e8*_0x152490[_0xb17c51(0x123)],_0x1b8160=_0x4ea9b9/0x3e8*_0x152490[_0xb17c51(0x17d)];return{'success':!![],'inputCost':_0x4aec00,'outputCost':_0x1b8160,'totalCost':_0x4aec00+_0x1b8160,'currency':_0x152490[_0xb17c51(0x127)],'unit':_0x152490[_0xb17c51(0x15e)],'estimated':![]};}[a0_0x21010f(0x17b)](_0x5980a5){const _0x41f5cc=a0_0x21010f,_0x5b29b1=_0x5980a5['toLowerCase']();if(_0x5b29b1[_0x41f5cc(0x122)]('opus')||_0x5b29b1['includes'](_0x41f5cc(0xf7)))return{'input':0.015,'output':0.075};else{if(_0x5b29b1[_0x41f5cc(0x122)](_0x41f5cc(0x11e))||_0x5b29b1[_0x41f5cc(0x122)]('gpt-3.5'))return{'input':0.003,'output':0.015};else{if(_0x5b29b1[_0x41f5cc(0x122)]('haiku')||_0x5b29b1[_0x41f5cc(0x122)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}['_updateUsageData'](_0x6cbc69,_0x2a58d8,_0x3db099,_0x197444,_0x56f30a){const _0x34cea1=a0_0x21010f;this['usage'][_0x34cea1(0x138)]+=_0x3db099,this[_0x34cea1(0x16d)][_0x34cea1(0x101)]+=_0x197444,this['usage']['totalCost']+=_0x56f30a,this[_0x34cea1(0x16d)][_0x34cea1(0xfa)]=new Date()[_0x34cea1(0x12d)](),!this['usage']['serviceUsage'][_0x6cbc69]&&(this[_0x34cea1(0x16d)][_0x34cea1(0x162)][_0x6cbc69]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage']['serviceUsage'][_0x6cbc69][_0x34cea1(0x160)]+=_0x3db099,this['usage']['serviceUsage'][_0x6cbc69]['outputTokens']+=_0x197444,this[_0x34cea1(0x16d)]['serviceUsage'][_0x6cbc69]['cost']+=_0x56f30a,this[_0x34cea1(0x16d)][_0x34cea1(0x162)][_0x6cbc69]['requestCount']+=0x1,!this['usage']['modelUsage'][_0x2a58d8]&&(this[_0x34cea1(0x16d)][_0x34cea1(0xf3)][_0x2a58d8]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage']['modelUsage'][_0x2a58d8]['inputTokens']+=_0x3db099,this['usage']['modelUsage'][_0x2a58d8][_0x34cea1(0x119)]+=_0x197444,this['usage']['modelUsage'][_0x2a58d8][_0x34cea1(0x155)]+=_0x56f30a,this['usage'][_0x34cea1(0xf3)][_0x2a58d8]['requestCount']+=0x1;}[a0_0x21010f(0x189)](){const _0x3880ca=a0_0x21010f,_0x5c8b0f={'withinBudget':!![],'budgetLimit':this['budgetLimit'],'totalSpent':this['usage']['totalCost'],'remainingBudget':null,'percentageUsed':null,'warningLevel':'normal'};if(this[_0x3880ca(0x157)]!==null){_0x5c8b0f[_0x3880ca(0x116)]=Math[_0x3880ca(0x129)](0x0,this[_0x3880ca(0x157)]-this['usage'][_0x3880ca(0x15a)]),_0x5c8b0f['percentageUsed']=this['usage'][_0x3880ca(0x15a)]/this[_0x3880ca(0x157)]*0x64,_0x5c8b0f['withinBudget']=this['usage']['totalCost']<=this[_0x3880ca(0x157)];if(_0x5c8b0f['percentageUsed']>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x5c8b0f[_0x3880ca(0x16f)]='critical';else _0x5c8b0f['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x5c8b0f[_0x3880ca(0x16f)]='warning');_0x5c8b0f['warningLevel']!==_0x3880ca(0x14b)&&this['logger']['warn'](_0x3880ca(0x100)+_0x5c8b0f[_0x3880ca(0x16f)]+':\x20'+_0x5c8b0f['percentageUsed'][_0x3880ca(0x14a)](0x1)+_0x3880ca(0x124),{'totalSpent':this['usage'][_0x3880ca(0x15a)],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x5c8b0f[_0x3880ca(0x116)]});if(!_0x5c8b0f['withinBudget']&&this['hardLimit']){const _0x1f4928=new Error(ERROR_MESSAGES['BUDGET_EXCEEDED']+':\x20$'+this[_0x3880ca(0x16d)][_0x3880ca(0x15a)]['toFixed'](0x2)+_0x3880ca(0x106)+this[_0x3880ca(0x157)]['toFixed'](0x2));_0x1f4928[_0x3880ca(0x10d)]=_0x3880ca(0x169),_0x1f4928[_0x3880ca(0x13d)]=_0x5c8b0f;throw _0x1f4928;}}return _0x5c8b0f;}async['setBudgetLimit'](_0x4b75a6){const _0x45922d=a0_0x21010f,_0xe7f61e=this[_0x45922d(0x163)](_0x4b75a6);this[_0x45922d(0x157)]=_0xe7f61e,this[_0x45922d(0x11b)]['budget']=this['config'][_0x45922d(0x18a)]||{},this['config'][_0x45922d(0x18a)]['limit']=_0xe7f61e,this[_0x45922d(0x180)][_0x45922d(0xff)](_0x45922d(0x11f)+_0xe7f61e['toFixed'](0x2),{'previousLimit':this[_0x45922d(0x157)],'newLimit':_0xe7f61e}),await this[_0x45922d(0x18b)]();}[a0_0x21010f(0x163)](_0x35111b){const _0x316813=a0_0x21010f;if(typeof _0x35111b!=='number'||_0x35111b<0x0||!isFinite(_0x35111b))throw new Error(ERROR_MESSAGES[_0x316813(0x18c)]);return _0x35111b;}async['getBudgetUsage'](){const _0x399d8a=a0_0x21010f;await this['updatePricingFromServer']();const _0x510c9a={'totalSpent':this[_0x399d8a(0x16d)][_0x399d8a(0x15a)],'budgetLimit':this[_0x399d8a(0x157)],'inputTokens':this[_0x399d8a(0x16d)]['totalInputTokens'],'outputTokens':this[_0x399d8a(0x16d)]['totalOutputTokens'],'remainingBudget':this[_0x399d8a(0x157)]!==null?Math[_0x399d8a(0x129)](0x0,this['budgetLimit']-this[_0x399d8a(0x16d)][_0x399d8a(0x15a)]):null,'percentageUsed':this['budgetLimit']!==null?this[_0x399d8a(0x16d)]['totalCost']/this[_0x399d8a(0x157)]*0x64:null,'sessionStart':this['usage'][_0x399d8a(0x128)],'lastUpdated':this['usage']['lastUpdated'],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this[_0x399d8a(0x12a)],'modelsWithPricing':this['pricingData'][_0x399d8a(0x172)],'source':this[_0x399d8a(0x112)]?'server':'fallback'}};for(const [_0x5eed91,_0x298127]of Object[_0x399d8a(0xf4)](this[_0x399d8a(0x16d)]['serviceUsage'])){_0x510c9a['breakdownByService'][_0x5eed91]={'cost':_0x298127[_0x399d8a(0x155)],'inputTokens':_0x298127[_0x399d8a(0x160)],'outputTokens':_0x298127[_0x399d8a(0x119)],'requestCount':_0x298127['requestCount']};}for(const [_0x1eb495,_0x639b63]of Object['entries'](this['usage']['modelUsage'])){_0x510c9a['breakdownByModel'][_0x1eb495]={'cost':_0x639b63['cost'],'inputTokens':_0x639b63['inputTokens'],'outputTokens':_0x639b63['outputTokens'],'requestCount':_0x639b63[_0x399d8a(0x16c)]};}return _0x510c9a;}async[a0_0x21010f(0x121)](){const _0x6b59da=a0_0x21010f,_0x4d84ea=await this[_0x6b59da(0x17a)]();let _0x3c0bc9=_0x6b59da(0x140);_0x3c0bc9+=_0x6b59da(0x134)+_0x4d84ea['totalSpent'][_0x6b59da(0x14a)](0x4)+'\x0a',_0x3c0bc9+='Total\x20input\x20tokens:\x20'+_0x4d84ea['inputTokens'][_0x6b59da(0x14c)]()+'\x0a',_0x3c0bc9+='Total\x20output\x20tokens:\x20'+_0x4d84ea[_0x6b59da(0x119)][_0x6b59da(0x14c)]()+'\x0a';_0x4d84ea[_0x6b59da(0x157)]!==null&&(_0x3c0bc9+=_0x6b59da(0x105)+_0x4d84ea['budgetLimit'][_0x6b59da(0x14a)](0x2)+'\x0a',_0x3c0bc9+='Remaining:\x20$'+_0x4d84ea[_0x6b59da(0x116)]['toFixed'](0x4)+'\x0a',_0x3c0bc9+=_0x6b59da(0x139)+_0x4d84ea['percentageUsed']['toFixed'](0x1)+'%\x0a');_0x3c0bc9+=_0x6b59da(0x185)+_0x4d84ea['pricingInfo'][_0x6b59da(0x10b)]+'\x0a',_0x3c0bc9+='Models\x20with\x20pricing:\x20'+_0x4d84ea[_0x6b59da(0x13c)]['modelsWithPricing']+'\x0a';if(Object['keys'](_0x4d84ea['breakdownByService'])[_0x6b59da(0x142)]>0x0){_0x3c0bc9+='\x0a===\x20BREAKDOWN\x20BY\x20SERVICE\x20===\x0a';for(const [_0x5e3dcd,_0x3790e0]of Object[_0x6b59da(0xf4)](_0x4d84ea[_0x6b59da(0x11d)])){_0x3c0bc9+=_0x5e3dcd+_0x6b59da(0x12f)+_0x3790e0[_0x6b59da(0x155)][_0x6b59da(0x14a)](0x4)+'\x20('+_0x3790e0[_0x6b59da(0x16c)]+_0x6b59da(0x136);}}if(Object[_0x6b59da(0x17c)](_0x4d84ea['breakdownByModel'])[_0x6b59da(0x142)]>0x0){_0x3c0bc9+='\x0a===\x20BREAKDOWN\x20BY\x20MODEL\x20===\x0a';for(const [_0x3919a7,_0x52c01d]of Object[_0x6b59da(0xf4)](_0x4d84ea[_0x6b59da(0x18e)])){_0x3c0bc9+=_0x3919a7+_0x6b59da(0x12f)+_0x52c01d['cost']['toFixed'](0x4)+'\x20('+_0x52c01d['requestCount']+'\x20requests)\x0a';}}return _0x3c0bc9;}async[a0_0x21010f(0x133)](){const _0xebb640=a0_0x21010f,_0x2b39fe=0.1,_0x344d2a=this[_0xebb640(0x16d)][_0xebb640(0xf2)]||0x0;this['usage']['totalCost']-_0x344d2a>=_0x2b39fe&&(await this[_0xebb640(0x18b)](),this[_0xebb640(0x16d)][_0xebb640(0xf2)]=this[_0xebb640(0x16d)]['totalCost']);}async['_loadUsageData'](){const _0x265731=a0_0x21010f;try{await this[_0x265731(0x167)]();const _0x271349=a0_0xde9d08[_0x265731(0x165)](this['usageDir'],USAGE_FILENAME);try{const _0x438c24=await a0_0x4711b0[_0x265731(0x173)](_0x271349,_0x265731(0x178)),_0x1ffbc1=JSON['parse'](_0x438c24);this[_0x265731(0x16d)]['totalInputTokens']=_0x1ffbc1[_0x265731(0x138)]||0x0,this['usage']['totalOutputTokens']=_0x1ffbc1['totalOutputTokens']||0x0,this['usage'][_0x265731(0x15a)]=_0x1ffbc1['totalCost']||0x0,this[_0x265731(0x16d)][_0x265731(0x162)]=_0x1ffbc1['serviceUsage']||{},this[_0x265731(0x16d)]['modelUsage']=_0x1ffbc1[_0x265731(0xf3)]||{},this[_0x265731(0x180)][_0x265731(0xff)](_0x265731(0x113),{'totalCost':this[_0x265731(0x16d)][_0x265731(0x15a)],'totalTokens':this['usage']['totalInputTokens']+this[_0x265731(0x16d)][_0x265731(0x101)]});}catch(_0x187a38){_0x187a38['code']!=='ENOENT'&&this['logger']['warn']('Failed\x20to\x20load\x20usage\x20data:',_0x187a38);}}catch(_0x427add){this[_0x265731(0x180)]['warn'](_0x265731(0x15f),_0x427add);}}async[a0_0x21010f(0x167)](){const _0x59c91a=a0_0x21010f;try{await a0_0x4711b0[_0x59c91a(0x16a)](this[_0x59c91a(0x115)],{'recursive':!![]});}catch(_0x4dc54a){throw new Error(ERROR_MESSAGES[_0x59c91a(0x153)]+':\x20'+_0x4dc54a['message']);}}async['saveUsageData'](){const _0x32df30=a0_0x21010f;try{await this['_ensureUsageDirectory'](),this['usage']['sessionEnd']=new Date()['toISOString']();const _0x55fb32=a0_0xde9d08['join'](this['usageDir'],USAGE_FILENAME);await a0_0x4711b0['writeFile'](_0x55fb32,JSON[_0x32df30(0x152)](this[_0x32df30(0x16d)],null,0x2),_0x32df30(0x178));const _0x3dc90a=a0_0xde9d08['join'](this['usageDir'],''+SESSION_PREFIX+this[_0x32df30(0x16d)]['sessionId']+'.json');await a0_0x4711b0['writeFile'](_0x3dc90a,JSON['stringify'](this[_0x32df30(0x16d)],null,0x2),'utf-8'),await this['_cleanupOldSessionFiles'](),this[_0x32df30(0x180)]['info'](_0x32df30(0x18d),{'totalCost':this['usage']['totalCost'],'sessionId':this['usage']['sessionId']});}catch(_0x586830){this['logger'][_0x32df30(0x17f)](_0x32df30(0x10f),_0x586830);throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x586830[_0x32df30(0x151)]);}}async[a0_0x21010f(0x187)](){const _0x422685=a0_0x21010f;try{const _0x5c5cf8=await a0_0x4711b0['readdir'](this[_0x422685(0x115)]),_0x423ebc=_0x5c5cf8['filter'](_0x199b5c=>_0x199b5c['startsWith'](SESSION_PREFIX)&&_0x199b5c[_0x422685(0x110)](_0x422685(0x15d)))[_0x422685(0x13b)](_0xa5b4d=>({'name':_0xa5b4d,'path':a0_0xde9d08['join'](this['usageDir'],_0xa5b4d)}));if(_0x423ebc['length']<=MAX_SESSION_FILES)return;const _0x16b019=await Promise[_0x422685(0x132)](_0x423ebc['map'](async _0x28cc80=>{const _0x235886=_0x422685;try{const _0x1e49f1=await a0_0x4711b0[_0x235886(0x145)](_0x28cc80[_0x235886(0x159)]);return{..._0x28cc80,'mtime':_0x1e49f1['mtime']};}catch(_0x5a0b9a){return null;}})),_0x46a466=_0x16b019[_0x422685(0x12e)](_0x5061e9=>_0x5061e9!==null)['sort']((_0x2394ae,_0x4c367c)=>_0x4c367c['mtime']-_0x2394ae['mtime']),_0x200fa5=_0x46a466[_0x422685(0x10a)](MAX_SESSION_FILES);for(const _0x1a5357 of _0x200fa5){try{await a0_0x4711b0['unlink'](_0x1a5357['path']),this[_0x422685(0x180)][_0x422685(0x135)]('Removed\x20old\x20session\x20file:\x20'+_0x1a5357['name']);}catch(_0x4e6247){this[_0x422685(0x180)][_0x422685(0xf8)](_0x422685(0x109)+_0x1a5357[_0x422685(0x146)]+':',_0x4e6247);}}_0x200fa5['length']>0x0&&this['logger']['info']('Cleaned\x20up\x20'+_0x200fa5[_0x422685(0x142)]+'\x20old\x20session\x20files');}catch(_0x2486c0){this[_0x422685(0x180)][_0x422685(0xf8)](_0x422685(0x131),_0x2486c0);}}async[a0_0x21010f(0x183)](_0x1aa04b=![]){const _0x5f09ac=a0_0x21010f;this['logger'][_0x5f09ac(0xff)](_0x5f09ac(0x102),{'preserveTotal':_0x1aa04b});if(!_0x1aa04b)this[_0x5f09ac(0x16d)]=this['_initializeUsageData']();else{const _0x574c04=this[_0x5f09ac(0x16d)]['totalCost'],_0x5a162b=this[_0x5f09ac(0x16d)][_0x5f09ac(0x138)],_0xb7717f=this['usage']['totalOutputTokens'];this['usage']=this['_initializeUsageData'](),this['usage'][_0x5f09ac(0x15a)]=_0x574c04,this['usage']['totalInputTokens']=_0x5a162b,this[_0x5f09ac(0x16d)]['totalOutputTokens']=_0xb7717f;}await this[_0x5f09ac(0x18b)]();}async['exportUsageData'](_0x339237='json'){const _0x29d23d=a0_0x21010f,_0x3f0987=await this[_0x29d23d(0x17a)]();if(_0x339237===_0x29d23d(0x179))return this[_0x29d23d(0x111)](_0x3f0987);return JSON[_0x29d23d(0x152)](_0x3f0987,null,0x2);}[a0_0x21010f(0x111)](_0x189f12){const _0x2b44be=a0_0x21010f,_0x4b153a=['Category,Service/Model,Cost,InputTokens,OutputTokens,RequestCount'];for(const [_0x240110,_0x42a81c]of Object[_0x2b44be(0xf4)](_0x189f12[_0x2b44be(0x11d)])){_0x4b153a[_0x2b44be(0x141)](_0x2b44be(0x154)+_0x240110+','+_0x42a81c[_0x2b44be(0x155)]+','+_0x42a81c[_0x2b44be(0x160)]+','+_0x42a81c[_0x2b44be(0x119)]+','+_0x42a81c[_0x2b44be(0x16c)]);}for(const [_0xc61c2c,_0x287013]of Object['entries'](_0x189f12['breakdownByModel'])){_0x4b153a[_0x2b44be(0x141)]('Model,'+_0xc61c2c+','+_0x287013['cost']+','+_0x287013['inputTokens']+','+_0x287013['outputTokens']+','+_0x287013[_0x2b44be(0x16c)]);}return _0x4b153a[_0x2b44be(0x165)]('\x0a');}[a0_0x21010f(0xf0)](_0xb03b80,_0x23f377,_0x59c6cf){const _0x2e34ec=a0_0x21010f;this[_0x2e34ec(0x156)](_0x2e34ec(0x137),_0xb03b80,_0x23f377,_0x59c6cf);const _0x11a37d=this['_calculateCost'](_0xb03b80,_0x23f377,_0x59c6cf),_0xfd54b6={'model':_0xb03b80,'estimatedInputTokens':_0x23f377,'estimatedOutputTokens':_0x59c6cf,'estimatedCost':_0x11a37d[_0x2e34ec(0x15a)],..._0x11a37d,'budgetImpact':null};if(this['budgetLimit']!==null){const _0x5dc40c=this[_0x2e34ec(0x16d)][_0x2e34ec(0x15a)]+_0x11a37d['totalCost'];_0xfd54b6['budgetImpact']={'currentSpent':this['usage']['totalCost'],'afterOperation':_0x5dc40c,'remainingAfter':Math['max'](0x0,this['budgetLimit']-_0x5dc40c),'wouldExceedBudget':_0x5dc40c>this['budgetLimit'],'percentageAfter':_0x5dc40c/this['budgetLimit']*0x64};}return _0xfd54b6;}['checkBudgetForOperation'](_0x4c3621,_0x2bb00,_0x439c40){const _0x5a2f56=a0_0x21010f,_0x4b7f41=this['getCostEstimate'](_0x4c3621,_0x2bb00,_0x439c40);return{'canProceed':this['budgetLimit']===null||!_0x4b7f41[_0x5a2f56(0x144)]?.['wouldExceedBudget'],'estimate':_0x4b7f41,'recommendation':this['_getBudgetRecommendation'](_0x4b7f41)};}['_getBudgetRecommendation'](_0x24a900){const _0x53b9de=a0_0x21010f;if(this['budgetLimit']===null)return _0x53b9de(0x107);if(!_0x24a900['budgetImpact'])return _0x53b9de(0x117);const {percentageAfter:_0x1a10cd,wouldExceedBudget:_0x591859}=_0x24a900['budgetImpact'];if(_0x591859)return'Operation\x20would\x20exceed\x20budget\x20limit.\x20Consider\x20increasing\x20budget\x20or\x20using\x20a\x20less\x20expensive\x20model.';if(_0x1a10cd>BUDGET_CRITICAL_THRESHOLD*0x64)return'Operation\x20would\x20use\x20most\x20of\x20your\x20budget.\x20Monitor\x20usage\x20carefully.';if(_0x1a10cd>BUDGET_WARNING_THRESHOLD*0x64)return'Operation\x20would\x20use\x20significant\x20portion\x20of\x20budget.\x20Consider\x20cost\x20optimization.';return _0x53b9de(0x12c);}['getPricingInfo'](){const _0x4e7def=a0_0x21010f,_0x525f85=Array[_0x4e7def(0xfe)](this['pricingData'][_0x4e7def(0xf4)]())[_0x4e7def(0x13b)](([_0x218174,_0x61a37a])=>({'model':_0x218174,'inputPrice':_0x61a37a[_0x4e7def(0x123)],'outputPrice':_0x61a37a['output'],'unit':_0x61a37a['unit'],'currency':_0x61a37a['currency']}));return{'models':_0x525f85,'lastUpdate':this[_0x4e7def(0x12a)],'source':this['serverLLMService']?_0x4e7def(0x118):_0x4e7def(0x188),'totalModels':this['pricingData']['size']};}async['healthCheck'](){const _0x9a5098=a0_0x21010f,_0x3f48c3={'status':_0x9a5098(0xfb),'issues':[],'metrics':{'totalCost':this['usage'][_0x9a5098(0x15a)],'totalTokens':this['usage'][_0x9a5098(0x138)]+this['usage']['totalOutputTokens'],'modelsWithPricing':this['pricingData'][_0x9a5098(0x172)],'budgetLimit':this['budgetLimit']}};try{await this[_0x9a5098(0x167)]();const _0x1b2313=a0_0xde9d08[_0x9a5098(0x165)](this[_0x9a5098(0x115)],'.health-check');await a0_0x4711b0[_0x9a5098(0x17e)](_0x1b2313,'test'),await a0_0x4711b0[_0x9a5098(0x103)](_0x1b2313);}catch(_0xce0d3d){_0x3f48c3['status']='degraded',_0x3f48c3[_0x9a5098(0x181)]['push'](_0x9a5098(0x108));}this[_0x9a5098(0x166)]['size']===0x0&&(_0x3f48c3[_0x9a5098(0x190)]=_0x9a5098(0x174),_0x3f48c3[_0x9a5098(0x181)][_0x9a5098(0x141)]('No\x20pricing\x20data\x20available'));if(this[_0x9a5098(0x12a)]){const _0xe8972c=(Date[_0x9a5098(0x161)]()-new Date(this['lastPricingUpdate'])['getTime']())/(0x3e8*0x3c*0x3c);_0xe8972c>0x18&&_0x3f48c3[_0x9a5098(0x181)][_0x9a5098(0x141)](_0x9a5098(0xf1));}if(this[_0x9a5098(0x157)]!==null){const _0x8ce08c=this['_checkBudgetStatus']();_0x8ce08c['warningLevel']!=='normal'&&_0x3f48c3[_0x9a5098(0x181)][_0x9a5098(0x141)]('Budget\x20'+_0x8ce08c[_0x9a5098(0x16f)]+':\x20'+_0x8ce08c[_0x9a5098(0x130)][_0x9a5098(0x14a)](0x1)+_0x9a5098(0x124));}return _0x3f48c3['issues']['length']>0x0&&_0x3f48c3['status']===_0x9a5098(0xfb)&&(_0x3f48c3['status']='warning'),_0x3f48c3;}async[a0_0x21010f(0x171)](){const _0xe78339=a0_0x21010f;this['logger']['info'](_0xe78339(0x164));try{await this[_0xe78339(0x18b)](),this[_0xe78339(0x166)]['clear'](),this[_0xe78339(0x180)][_0xe78339(0xff)](_0xe78339(0x170));}catch(_0x144126){this['logger']['error'](_0xe78339(0x11c),_0x144126);throw _0x144126;}}}