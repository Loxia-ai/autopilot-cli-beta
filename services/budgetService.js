function a0_0x5029(_0x553954,_0x5c9b0f){const _0x377c39=a0_0x377c();return a0_0x5029=function(_0x502991,_0x2d11b5){_0x502991=_0x502991-0x121;let _0x280289=_0x377c39[_0x502991];if(a0_0x5029['pOLCVN']===undefined){var _0x59164f=function(_0x232803){const _0x39c951='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x5e220a='',_0x10a50a='';for(let _0x4ee501=0x0,_0x52ca0c,_0x4fe1d6,_0x38478d=0x0;_0x4fe1d6=_0x232803['charAt'](_0x38478d++);~_0x4fe1d6&&(_0x52ca0c=_0x4ee501%0x4?_0x52ca0c*0x40+_0x4fe1d6:_0x4fe1d6,_0x4ee501++%0x4)?_0x5e220a+=String['fromCharCode'](0xff&_0x52ca0c>>(-0x2*_0x4ee501&0x6)):0x0){_0x4fe1d6=_0x39c951['indexOf'](_0x4fe1d6);}for(let _0x3de93e=0x0,_0x1c0a3b=_0x5e220a['length'];_0x3de93e<_0x1c0a3b;_0x3de93e++){_0x10a50a+='%'+('00'+_0x5e220a['charCodeAt'](_0x3de93e)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x10a50a);};a0_0x5029['UPhOjD']=_0x59164f,_0x553954=arguments,a0_0x5029['pOLCVN']=!![];}const _0x891576=_0x377c39[0x0],_0x1a36f0=_0x502991+_0x891576,_0x2bba93=_0x553954[_0x1a36f0];return!_0x2bba93?(_0x280289=a0_0x5029['UPhOjD'](_0x280289),_0x553954[_0x1a36f0]=_0x280289):_0x280289=_0x2bba93,_0x280289;},a0_0x5029(_0x553954,_0x5c9b0f);}const a0_0x10c410=a0_0x5029;(function(_0xaf0b19,_0xb508){const _0x571a59=a0_0x5029,_0x2bb544=_0xaf0b19();while(!![]){try{const _0x39a89e=parseInt(_0x571a59(0x130))/0x1+-parseInt(_0x571a59(0x19e))/0x2+-parseInt(_0x571a59(0x16b))/0x3+-parseInt(_0x571a59(0x16a))/0x4+-parseInt(_0x571a59(0x128))/0x5+-parseInt(_0x571a59(0x17d))/0x6*(parseInt(_0x571a59(0x152))/0x7)+parseInt(_0x571a59(0x187))/0x8;if(_0x39a89e===_0xb508)break;else _0x2bb544['push'](_0x2bb544['shift']());}catch(_0x35cffd){_0x2bb544['push'](_0x2bb544['shift']());}}}(a0_0x377c,0xf20b6));import{promises as a0_0x232803}from'fs';import a0_0x39c951 from'path';const DEFAULT_USAGE_DIR='./.loxia-budget',USAGE_FILENAME='usage.json',SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':'Budget\x20amount\x20must\x20be\x20a\x20positive\x20number','INVALID_TOKENS':'Token\x20counts\x20must\x20be\x20non-negative\x20numbers','INVALID_SERVICE':'Service\x20name\x20must\x20be\x20a\x20non-empty\x20string','BUDGET_EXCEEDED':'Budget\x20limit\x20exceeded','PRICING_UNAVAILABLE':a0_0x10c410(0x1b6),'FILE_SYSTEM_ERROR':'File\x20system\x20operation\x20failed'};function a0_0x377c(){const _0x4c729a=['C3rHDhvZ','z2v0uhjPy2LUz0LUzM8','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','CMvTywLUAw5NqNvKz2v0','uMvTywLUAw5NoIaK','x3vWzgf0zvvZywDLrgf0yq','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','t3bLCMf0Aw9UihDVDwXKihvZzsbZAwDUAwzPy2fUDcbWB3j0Aw9Uig9Migj1zgDLDc4Gq29UC2LKzxiGy29ZDcbVChrPBwL6yxrPB24U','BwfW','C2H1DgrVD24','lMHLywX0Ac1JAgvJAW','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','CgvYy2vUDgfNzvvZzwq','zxjYB3i','AgvHBhrOEq','mJHLufLlzNu','B3v0Chv0vg9Rzw5Z','C2vYDMLJzvvZywDL','Dg9gAxHLza','Aw5JBhvKzxm','x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','z2v0qNvKz2v0vxnHz2u','Bw9KzwXvC2fNzq','z2v0q29ZDevZDgLTyxrL','AM9PBG','BgvUz3rO','rKLmrv9twvnuru1Frvjst1i','AxnZDwvZ','z3b0ltq','ChvZAa','z2v0qwXSuhjPy2LUzW','vg90ywWGB3v0Chv0ihrVA2vUCZOG','D2fYBG','Bwf4','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG','x2v4Cg9YDfrVq3n2','BM9YBwfS','C2XPy2u','Dg90ywXdB3n0','mJK0odG2ognvtwjHDq','nZK5mta3rNftEgX2','CMfUzg9T','x2XVywrcDwrNzxrmAw1PDa','DxnHz2u','C3rHCNrZv2L0Aa','uMvZzxr0Aw5NihvZywDLigrHDge','Dg90ywXjBNb1DfrVA2vUCW','z2v0vgLTzq','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','C29YDa','y29UzMLN','qNvKz2v0igXPBwL0ihnLDcb0BYaK','y3vYCMvUy3K','pt09ifvtquDfifjfue9svca9pt0k','tw9KzwXZihDPDgGGChjPy2LUzZOG','su5wquXjrf9trvjwsunf','Aw5MBW','ig1VzgvSCYbMCM9TihnLCNzLCG','mJm5ndmZnKjlEMzVta','C3rYAw5N','C3rHDa','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','AgfYzeXPBwL0','Dg9tDhjPBMC','oIaK','cLbYAwnPBMCGC291CMnLoIa','uMvTB3zLzcbVBgqGC2vZC2LVBIbMAwXLoIa','zxHWB3j0vxnHz2veyxrH','mZu0nJKYotzttvfuC28','jsb1C2vK','C29UBMv0','igv4y2vLzhmGBgLTAxqGB2yGja','vg90ywWGAw5WDxqGDg9Rzw5ZoIa','Cgf0Aa','Dg9mB3DLCKnHC2u','z2v0uhjPy2LUz0rHDge','BgLTAxq','su5wquXjrf9btu9vtLq','zw50CMLLCW','x2XVywrvC2fNzurHDge','DxnHz2veAxi','D2fYBMLUz0XLDMvS','DxrMltG','t3bLCMf0Aw9UihDVDwXKihvZzsbTB3n0ig9MihLVDxiGyNvKz2v0lIbnB25PDg9YihvZywDLignHCMvMDwXSEs4','Dg9mB2nHBgvtDhjPBMC','y29ZDa','ywXS','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','y3jPDgLJywW','z3b0ltmUnq','zMfSBgjHy2S','oduXode4Effrq05u','x3nOB3vSzfvWzgf0zvbYAwnPBMC','Aw5WDxruB2TLBNm','D2L0AgLUqNvKz2v0','yNjLywTKB3DUqNLtzxj2AwnL','A2v5CW','CMvXDwvZDenVDw50','ru5pru5u','x2vUC3vYzvvZywDLrgLYzwn0B3j5','x3zHBgLKyxrLqNvKz2v0qw1VDw50','y2XLyxi','yNvKz2v0sw1Wywn0','yNjLywTKB3DUqNLnB2rLBa','BgfZDfnHDMvKq29ZDa','BM93','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','zgvIDwC','zMLSDgvY','AgvHBhrOq2HLy2S','C2vZC2LVBLn0yxj0','x2LUAxrPywXPEMvvC2fNzurHDge','z2v0vxnHz2vszxbVCNq','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','y29Kzq','uhjPy2LUzYbPBMzVCM1HDgLVBIb1BMf2ywLSywjSzq','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','uMvJB3jKAw5NihvZywDLigzVCIa','rMLSzsbZExn0zw0GywnJzxnZigLZC3vLCW','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','C2f2zvvZywDLrgf0yq','C2vYDMvY','Dg9ju09tDhjPBMC','Dg90ywXpDxrWDxruB2TLBNm','AgfPA3u','Aw5WDxq','ChjPy2LUz0rHDge','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','z2v0','ode2nZe0mhDPDgXVEa','rMfPBgvKihrVihnHDMuGDxnHz2uGzgf0ytO','uhjVy2vLzcb3AxrOig9WzxjHDgLVBI4','cJ09psbcuKvbs0rpv04GqLKGu0vsvKLdrsa9pt0k','CMvHzgrPCG','lMPZB24','C3rYAw5NAwz5','BwvZC2fNzq','mtiXnJG5owH2y2TfCa','qLver0vux0vyq0vfreve','ChjPy2LUz0LUzM8','B3v0Chv0','z2v0tw9KzwXqCMLJAw5N','BgfZDfbYAwnPBMDvCgrHDgu','Bg9Nz2vY','x2nOzwnRqNvKz2v0u3rHDhvZ','C2vYDMvYteXnu2vYDMLJzq','yNvKz2v0','B3b1CW','C3vJy2vZCW','Dw5PDa','C2L6zq','yNvKz2v0tgLTAxq','CMvJB3jKvxnHz2u','su5wquXjrf9ut0TftLm','CgfYC2u','BxrPBwu'];a0_0x377c=function(){return _0x4c729a;};return a0_0x377c();}export class BudgetService{constructor(_0x5e220a,_0x10a50a,_0x4ee501=null){const _0x4204e1=a0_0x10c410;this['config']=_0x5e220a,this['logger']=_0x10a50a,this[_0x4204e1(0x138)]=_0x4ee501,this[_0x4204e1(0x16e)]=this['_initializeUsageData'](),this['budgetLimit']=this[_0x4204e1(0x16d)](),this[_0x4204e1(0x181)]=_0x5e220a[_0x4204e1(0x139)]?.[_0x4204e1(0x181)]||![],this[_0x4204e1(0x125)]=new Map(),this[_0x4204e1(0x135)]=null,this[_0x4204e1(0x1b7)]=![],this[_0x4204e1(0x193)]=_0x5e220a[_0x4204e1(0x139)]?.[_0x4204e1(0x193)]||DEFAULT_USAGE_DIR,this[_0x4204e1(0x136)][_0x4204e1(0x17b)]('Budget\x20service\x20initialized',{'budgetLimit':this[_0x4204e1(0x13e)],'hardLimit':this['hardLimit'],'usageDir':this['usageDir'],'hasPricingService':!!this[_0x4204e1(0x138)]}),this['_loadUsageData']()['catch'](_0x52ca0c=>{const _0x7e4f53=_0x4204e1;this[_0x7e4f53(0x136)][_0x7e4f53(0x163)]('Failed\x20to\x20load\x20previous\x20usage\x20data:',_0x52ca0c);});}['_initializeUsageData'](){const _0x4974e9=a0_0x10c410;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()['toISOString'](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()[_0x4974e9(0x121)]()};}['_generateSessionId'](){const _0x46c9c9=a0_0x10c410,_0x4fe1d6=Date[_0x46c9c9(0x1ac)]()[_0x46c9c9(0x182)](0x24),_0x38478d=Math[_0x46c9c9(0x16c)]()[_0x46c9c9(0x182)](0x24)['slice'](0x2);return _0x4fe1d6+'_'+_0x38478d;}[a0_0x10c410(0x16d)](){const _0x22297c=a0_0x10c410,_0x3de93e=this['config'][_0x22297c(0x139)]?.['limit'];if(_0x3de93e!==undefined&&_0x3de93e!==null)return this['_validateBudgetAmount'](_0x3de93e);return null;}async[a0_0x10c410(0x126)](){const _0x4ba49f=a0_0x10c410;if(!this['serverLLMService'])return this[_0x4ba49f(0x136)]['debug']('No\x20server\x20LLM\x20service\x20available\x20for\x20pricing\x20updates'),![];if(this[_0x4ba49f(0x1b7)])return this[_0x4ba49f(0x136)]['debug']('Pricing\x20update\x20already\x20in\x20progress'),![];if(!this['_shouldUpdatePricing']())return!![];this[_0x4ba49f(0x1b7)]=!![];try{this[_0x4ba49f(0x136)]['info']('Updating pricing data from server');const _0x1c0a3b=await this['serverLLMService'][_0x4ba49f(0x18e)]();if(_0x1c0a3b[_0x4ba49f(0x13d)]===0x0)return this[_0x4ba49f(0x136)]['warn']('No pricing data received from server'),![];this[_0x4ba49f(0x125)]['clear']();for(const [_0x5d7438,_0xd45c1e]of _0x1c0a3b[_0x4ba49f(0x191)]()){this['pricingData']['set'](_0x5d7438,{'input':_0xd45c1e['input'],'output':_0xd45c1e[_0x4ba49f(0x133)],'unit':_0xd45c1e[_0x4ba49f(0x13c)]||'1K\x20tokens','currency':_0xd45c1e[_0x4ba49f(0x177)]||'USD'});}return this[_0x4ba49f(0x135)]=new Date()['toISOString'](),this[_0x4ba49f(0x136)][_0x4ba49f(0x17b)]('Updated\x20pricing\x20for\x20'+this['pricingData']['size']+_0x4ba49f(0x17c)),!![];}catch(_0x47cf1f){return this[_0x4ba49f(0x136)][_0x4ba49f(0x150)]('Failed to update pricing from server:',_0x47cf1f),![];}finally{this[_0x4ba49f(0x1b7)]=![];}}[a0_0x10c410(0x19f)](){const _0x3f29b5=a0_0x10c410;if(!this['lastPricingUpdate'])return!![];const _0xccd448=Date[_0x3f29b5(0x1ac)]()-new Date(this['lastPricingUpdate'])[_0x3f29b5(0x172)]();return _0xccd448>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0x390f28){const _0x7fdd46=a0_0x10c410;if(!_0x390f28||typeof _0x390f28!=='string')return this[_0x7fdd46(0x136)]['warn']('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this['pricingData'][_0x7fdd46(0x127)](_0x390f28)||null;}[a0_0x10c410(0x161)](){return this['serverLLMService']['getPricingData']();}async[a0_0x10c410(0x13f)](_0xdd11f9,_0x9d5d54,_0x8a5886,_0x454c91){const _0x667c3f=a0_0x10c410;this[_0x667c3f(0x136)]['info'](_0x667c3f(0x1b8)+_0xdd11f9+'/'+_0x9d5d54,{'inputTokens':_0x8a5886,'outputTokens':_0x454c91,'service':_0xdd11f9,'model':_0x9d5d54}),this[_0x667c3f(0x14e)](_0xdd11f9,_0x9d5d54,_0x8a5886,_0x454c91),await this[_0x667c3f(0x126)]();const _0x5d035e=this['_calculateCost'](_0x9d5d54,_0x8a5886,_0x454c91);!_0x5d035e[_0x667c3f(0x13b)]&&this['logger'][_0x667c3f(0x163)]('Pricing\x20unavailable\x20for\x20model\x20'+_0x9d5d54+',\x20using\x20estimate');this[_0x667c3f(0x148)](_0xdd11f9,_0x9d5d54,_0x8a5886,_0x454c91,_0x5d035e[_0x667c3f(0x169)]);const _0x538f95=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x43ad1a={'service':_0xdd11f9,'model':_0x9d5d54,'inputTokens':_0x8a5886,'outputTokens':_0x454c91,'cost':_0x5d035e,'budgetStatus':_0x538f95,'timestamp':new Date()['toISOString']()};return this[_0x667c3f(0x136)]['debug']('Usage\x20recorded\x20successfully',_0x43ad1a),_0x43ad1a;}[a0_0x10c410(0x14e)](_0x1eb872,_0x5d9814,_0x18d621,_0x438b36){const _0x65181=a0_0x10c410;if(!_0x1eb872||typeof _0x1eb872!=='string')throw new Error(ERROR_MESSAGES[_0x65181(0x17a)]);if(!_0x5d9814||typeof _0x5d9814!==_0x65181(0x17e))throw new Error('Model\x20name\x20must\x20be\x20a\x20non-empty\x20string');if(typeof _0x18d621!=='number'||_0x18d621<0x0)throw new Error(ERROR_MESSAGES[_0x65181(0x140)]);if(typeof _0x438b36!=='number'||_0x438b36<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);}['_calculateCost'](_0x5ac322,_0x5e05a0,_0x535bf9){const _0x46961e=a0_0x10c410,_0x188fb3=this[_0x46961e(0x134)](_0x5ac322);if(!_0x188fb3){const _0x517abd=this['_getEstimatedPricing'](_0x5ac322),_0x4be1ce=_0x5e05a0/0x3e8*_0x517abd[_0x46961e(0x124)],_0x127172=_0x535bf9/0x3e8*_0x517abd['output'];return{'success':![],'inputCost':_0x4be1ce,'outputCost':_0x127172,'totalCost':_0x4be1ce+_0x127172,'currency':'USD','unit':'1K\x20tokens','estimated':!![],'reason':'Pricing\x20data\x20unavailable\x20for\x20model'};}const _0x37882a=_0x5e05a0/0x3e8*_0x188fb3[_0x46961e(0x124)],_0x4eb142=_0x535bf9/0x3e8*_0x188fb3['output'];return{'success':!![],'inputCost':_0x37882a,'outputCost':_0x4eb142,'totalCost':_0x37882a+_0x4eb142,'currency':_0x188fb3['currency'],'unit':_0x188fb3['unit'],'estimated':![]};}['_getEstimatedPricing'](_0x33c320){const _0xb81aa8=a0_0x10c410,_0x2b8ca2=_0x33c320[_0xb81aa8(0x18d)]();if(_0x2b8ca2[_0xb81aa8(0x156)](_0xb81aa8(0x13a))||_0x2b8ca2[_0xb81aa8(0x156)](_0xb81aa8(0x15f)))return{'input':0.015,'output':0.075};else{if(_0x2b8ca2['includes'](_0xb81aa8(0x189))||_0x2b8ca2[_0xb81aa8(0x156)](_0xb81aa8(0x19c)))return{'input':0.003,'output':0.015};else{if(_0x2b8ca2[_0xb81aa8(0x156)](_0xb81aa8(0x123))||_0x2b8ca2[_0xb81aa8(0x156)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}[a0_0x10c410(0x148)](_0x27fce4,_0x37c62b,_0x5a0db0,_0x47cfff,_0xff1604){const _0x1c3dbf=a0_0x10c410;this[_0x1c3dbf(0x16e)]['totalInputTokens']+=_0x5a0db0,this[_0x1c3dbf(0x16e)][_0x1c3dbf(0x122)]+=_0x47cfff,this[_0x1c3dbf(0x16e)][_0x1c3dbf(0x169)]+=_0xff1604,this[_0x1c3dbf(0x16e)]['lastUpdated']=new Date()[_0x1c3dbf(0x121)](),!this[_0x1c3dbf(0x16e)][_0x1c3dbf(0x154)][_0x27fce4]&&(this['usage']['serviceUsage'][_0x27fce4]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x1c3dbf(0x16e)]['serviceUsage'][_0x27fce4][_0x1c3dbf(0x1a0)]+=_0x5a0db0,this[_0x1c3dbf(0x16e)]['serviceUsage'][_0x27fce4]['outputTokens']+=_0x47cfff,this['usage'][_0x1c3dbf(0x154)][_0x27fce4]['cost']+=_0xff1604,this[_0x1c3dbf(0x16e)][_0x1c3dbf(0x154)][_0x27fce4][_0x1c3dbf(0x1a4)]+=0x1,!this['usage'][_0x1c3dbf(0x159)][_0x37c62b]&&(this['usage'][_0x1c3dbf(0x159)][_0x37c62b]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage'][_0x1c3dbf(0x159)][_0x37c62b][_0x1c3dbf(0x1a0)]+=_0x5a0db0,this['usage']['modelUsage'][_0x37c62b]['outputTokens']+=_0x47cfff,this['usage'][_0x1c3dbf(0x159)][_0x37c62b][_0x1c3dbf(0x198)]+=_0xff1604,this[_0x1c3dbf(0x16e)][_0x1c3dbf(0x159)][_0x37c62b]['requestCount']+=0x1;}['_checkBudgetStatus'](){const _0x1c4327=a0_0x10c410,_0x3298d0={'withinBudget':!![],'budgetLimit':this[_0x1c4327(0x13e)],'totalSpent':this['usage'][_0x1c4327(0x169)],'remainingBudget':null,'percentageUsed':null,'warningLevel':_0x1c4327(0x167)};if(this['budgetLimit']!==null){_0x3298d0[_0x1c4327(0x146)]=Math['max'](0x0,this['budgetLimit']-this['usage']['totalCost']),_0x3298d0[_0x1c4327(0x14f)]=this[_0x1c4327(0x16e)][_0x1c4327(0x169)]/this[_0x1c4327(0x13e)]*0x64,_0x3298d0[_0x1c4327(0x1a1)]=this[_0x1c4327(0x16e)]['totalCost']<=this['budgetLimit'];if(_0x3298d0[_0x1c4327(0x14f)]>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x3298d0['warningLevel']=_0x1c4327(0x19b);else _0x3298d0['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x3298d0['warningLevel']='warning');_0x3298d0['warningLevel']!==_0x1c4327(0x167)&&this['logger'][_0x1c4327(0x163)]('Budget\x20'+_0x3298d0['warningLevel']+':\x20'+_0x3298d0['percentageUsed'][_0x1c4327(0x155)](0x1)+'%\x20used',{'totalSpent':this['usage']['totalCost'],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x3298d0[_0x1c4327(0x146)]});if(!_0x3298d0['withinBudget']&&this['hardLimit']){const _0x2c30c2=new Error(ERROR_MESSAGES[_0x1c4327(0x131)]+_0x1c4327(0x183)+this['usage']['totalCost']['toFixed'](0x2)+_0x1c4327(0x18a)+this['budgetLimit'][_0x1c4327(0x155)](0x2));_0x2c30c2[_0x1c4327(0x1b5)]='BUDGET_EXCEEDED',_0x2c30c2['budgetStatus']=_0x3298d0;throw _0x2c30c2;}}return _0x3298d0;}async['setBudgetLimit'](_0x43ff00){const _0x483b82=a0_0x10c410,_0x46a930=this['_validateBudgetAmount'](_0x43ff00);this['budgetLimit']=_0x46a930,this['config'][_0x483b82(0x139)]=this[_0x483b82(0x175)]['budget']||{},this[_0x483b82(0x175)][_0x483b82(0x139)][_0x483b82(0x18f)]=_0x46a930,this['logger'][_0x483b82(0x17b)](_0x483b82(0x176)+_0x46a930['toFixed'](0x2),{'previousLimit':this['budgetLimit'],'newLimit':_0x46a930}),await this[_0x483b82(0x1bb)]();}[a0_0x10c410(0x1a7)](_0x59400b){const _0x443426=a0_0x10c410;if(typeof _0x59400b!=='number'||_0x59400b<0x0||!isFinite(_0x59400b))throw new Error(ERROR_MESSAGES[_0x443426(0x190)]);return _0x59400b;}async['getBudgetUsage'](){const _0x4826d1=a0_0x10c410;await this[_0x4826d1(0x126)]();const _0x241b53={'totalSpent':this[_0x4826d1(0x16e)]['totalCost'],'budgetLimit':this[_0x4826d1(0x13e)],'inputTokens':this[_0x4826d1(0x16e)]['totalInputTokens'],'outputTokens':this[_0x4826d1(0x16e)][_0x4826d1(0x122)],'remainingBudget':this[_0x4826d1(0x13e)]!==null?Math['max'](0x0,this['budgetLimit']-this['usage'][_0x4826d1(0x169)]):null,'percentageUsed':this[_0x4826d1(0x13e)]!==null?this['usage'][_0x4826d1(0x169)]/this[_0x4826d1(0x13e)]*0x64:null,'sessionStart':this[_0x4826d1(0x16e)][_0x4826d1(0x1b1)],'lastUpdated':this['usage']['lastUpdated'],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this[_0x4826d1(0x135)],'modelsWithPricing':this['pricingData'][_0x4826d1(0x13d)],'source':this[_0x4826d1(0x138)]?_0x4826d1(0x1bc):_0x4826d1(0x19d)}};for(const [_0x3025b4,_0x360755]of Object[_0x4826d1(0x191)](this['usage']['serviceUsage'])){_0x241b53[_0x4826d1(0x1a2)][_0x3025b4]={'cost':_0x360755['cost'],'inputTokens':_0x360755[_0x4826d1(0x1a0)],'outputTokens':_0x360755['outputTokens'],'requestCount':_0x360755[_0x4826d1(0x1a4)]};}for(const [_0x524ff7,_0x506c3]of Object['entries'](this[_0x4826d1(0x16e)]['modelUsage'])){_0x241b53[_0x4826d1(0x1aa)][_0x524ff7]={'cost':_0x506c3['cost'],'inputTokens':_0x506c3[_0x4826d1(0x1a0)],'outputTokens':_0x506c3[_0x4826d1(0x153)],'requestCount':_0x506c3[_0x4826d1(0x1a4)]};}return _0x241b53;}async[a0_0x10c410(0x1b3)](){const _0x374b93=a0_0x10c410,_0x19f381=await this['getBudgetUsage']();let _0x16f010=_0x374b93(0x178);_0x16f010+='Total\x20cost:\x20$'+_0x19f381['totalSpent'][_0x374b93(0x155)](0x4)+'\x0a',_0x16f010+=_0x374b93(0x18b)+_0x19f381[_0x374b93(0x1a0)]['toLocaleString']()+'\x0a',_0x16f010+=_0x374b93(0x162)+_0x19f381[_0x374b93(0x153)][_0x374b93(0x197)]()+'\x0a';_0x19f381[_0x374b93(0x13e)]!==null&&(_0x16f010+='Budget\x20limit:\x20$'+_0x19f381['budgetLimit']['toFixed'](0x2)+'\x0a',_0x16f010+=_0x374b93(0x147)+_0x19f381['remainingBudget'][_0x374b93(0x155)](0x4)+'\x0a',_0x16f010+='Usage:\x20'+_0x19f381['percentageUsed'][_0x374b93(0x155)](0x1)+'%\x0a');_0x16f010+=_0x374b93(0x184)+_0x19f381[_0x374b93(0x132)]['source']+'\x0a',_0x16f010+=_0x374b93(0x179)+_0x19f381[_0x374b93(0x132)]['modelsWithPricing']+'\x0a';if(Object[_0x374b93(0x1a3)](_0x19f381[_0x374b93(0x1a2)])['length']>0x0){_0x16f010+=_0x374b93(0x12b);for(const [_0x59a7aa,_0x1800d7]of Object[_0x374b93(0x191)](_0x19f381[_0x374b93(0x1a2)])){_0x16f010+=_0x59a7aa+':\x20$'+_0x1800d7[_0x374b93(0x198)][_0x374b93(0x155)](0x4)+'\x20('+_0x1800d7[_0x374b93(0x1a4)]+'\x20requests)\x0a';}}if(Object['keys'](_0x19f381[_0x374b93(0x1aa)])[_0x374b93(0x15c)]>0x0){_0x16f010+='\x0a===\x20BREAKDOWN\x20BY\x20MODEL\x20===\x0a';for(const [_0x36318a,_0x3d1431]of Object['entries'](_0x19f381['breakdownByModel'])){_0x16f010+=_0x36318a+':\x20$'+_0x3d1431[_0x374b93(0x198)][_0x374b93(0x155)](0x4)+'\x20('+_0x3d1431['requestCount']+'\x20requests)\x0a';}}return _0x16f010;}async[a0_0x10c410(0x1ba)](){const _0x160d6b=a0_0x10c410,_0x46f792=0.1,_0x18fc0a=this[_0x160d6b(0x16e)]['lastSavedCost']||0x0;this['usage']['totalCost']-_0x18fc0a>=_0x46f792&&(await this['saveUsageData'](),this[_0x160d6b(0x16e)][_0x160d6b(0x1ab)]=this[_0x160d6b(0x16e)][_0x160d6b(0x169)]);}async[a0_0x10c410(0x192)](){const _0x5d74ae=a0_0x10c410;try{await this[_0x5d74ae(0x1a6)]();const _0x2287c0=a0_0x39c951[_0x5d74ae(0x15b)](this[_0x5d74ae(0x193)],USAGE_FILENAME);try{const _0x3a2252=await a0_0x232803['readFile'](_0x2287c0,'utf-8'),_0x3c092c=JSON[_0x5d74ae(0x141)](_0x3a2252);this['usage'][_0x5d74ae(0x171)]=_0x3c092c['totalInputTokens']||0x0,this[_0x5d74ae(0x16e)]['totalOutputTokens']=_0x3c092c['totalOutputTokens']||0x0,this[_0x5d74ae(0x16e)][_0x5d74ae(0x169)]=_0x3c092c[_0x5d74ae(0x169)]||0x0,this['usage']['serviceUsage']=_0x3c092c['serviceUsage']||{},this['usage']['modelUsage']=_0x3c092c['modelUsage']||{},this['logger'][_0x5d74ae(0x17b)]('Loaded\x20previous\x20usage\x20data',{'totalCost':this['usage'][_0x5d74ae(0x169)],'totalTokens':this[_0x5d74ae(0x16e)][_0x5d74ae(0x171)]+this[_0x5d74ae(0x16e)]['totalOutputTokens']});}catch(_0x3cb4ae){_0x3cb4ae[_0x5d74ae(0x1b5)]!==_0x5d74ae(0x1a5)&&this['logger'][_0x5d74ae(0x163)]('Failed\x20to\x20load\x20usage\x20data:',_0x3cb4ae);}}catch(_0x4a1325){this['logger']['warn']('Error\x20initializing\x20usage\x20data\x20directory:',_0x4a1325);}}async[a0_0x10c410(0x1a6)](){const _0x38575a=a0_0x10c410;try{await a0_0x232803['mkdir'](this[_0x38575a(0x193)],{'recursive':!![]});}catch(_0x244d4c){throw new Error(ERROR_MESSAGES[_0x38575a(0x15d)]+':\x20'+_0x244d4c[_0x38575a(0x12f)]);}}async[a0_0x10c410(0x1bb)](){const _0x144d62=a0_0x10c410;try{await this['_ensureUsageDirectory'](),this['usage']['sessionEnd']=new Date()['toISOString']();const _0x446387=a0_0x39c951[_0x144d62(0x15b)](this[_0x144d62(0x193)],USAGE_FILENAME);await a0_0x232803['writeFile'](_0x446387,JSON['stringify'](this[_0x144d62(0x16e)],null,0x2),'utf-8');const _0x4fd6f9=a0_0x39c951['join'](this['usageDir'],''+SESSION_PREFIX+this['usage']['sessionId']+'.json');await a0_0x232803['writeFile'](_0x4fd6f9,JSON[_0x144d62(0x12e)](this[_0x144d62(0x16e)],null,0x2),_0x144d62(0x195)),await this[_0x144d62(0x157)](),this['logger']['info'](_0x144d62(0x19a),{'totalCost':this[_0x144d62(0x16e)]['totalCost'],'sessionId':this[_0x144d62(0x16e)]['sessionId']});}catch(_0x14ed15){this[_0x144d62(0x136)]['error'](_0x144d62(0x129),_0x14ed15);throw new Error(ERROR_MESSAGES[_0x144d62(0x15d)]+':\x20'+_0x14ed15[_0x144d62(0x12f)]);}}async['_cleanupOldSessionFiles'](){const _0x6571e2=a0_0x10c410;try{const _0x204f6f=await a0_0x232803[_0x6571e2(0x12c)](this['usageDir']),_0x1a9884=_0x204f6f[_0x6571e2(0x1af)](_0xd5db70=>_0xd5db70[_0x6571e2(0x16f)](SESSION_PREFIX)&&_0xd5db70['endsWith'](_0x6571e2(0x12d)))[_0x6571e2(0x14b)](_0x400f31=>({'name':_0x400f31,'path':a0_0x39c951['join'](this[_0x6571e2(0x193)],_0x400f31)}));if(_0x1a9884['length']<=MAX_SESSION_FILES)return;const _0xa423f=await Promise[_0x6571e2(0x199)](_0x1a9884[_0x6571e2(0x14b)](async _0x2847e9=>{const _0x43ea30=_0x6571e2;try{const _0x985a2a=await a0_0x232803[_0x43ea30(0x17f)](_0x2847e9['path']);return{..._0x2847e9,'mtime':_0x985a2a['mtime']};}catch(_0x559e77){return null;}})),_0x5df28e=_0xa423f['filter'](_0x30beaa=>_0x30beaa!==null)[_0x6571e2(0x174)]((_0x40259d,_0x39b152)=>_0x39b152['mtime']-_0x40259d[_0x6571e2(0x142)]),_0x2592e6=_0x5df28e[_0x6571e2(0x168)](MAX_SESSION_FILES);for(const _0x39f647 of _0x2592e6){try{await a0_0x232803['unlink'](_0x39f647[_0x6571e2(0x18c)]),this['logger'][_0x6571e2(0x1ae)](_0x6571e2(0x185)+_0x39f647['name']);}catch(_0x285269){this[_0x6571e2(0x136)]['warn'](_0x6571e2(0x173)+_0x39f647['name']+':',_0x285269);}}_0x2592e6['length']>0x0&&this['logger']['info']('Cleaned\x20up\x20'+_0x2592e6['length']+'\x20old\x20session\x20files');}catch(_0x52541f){this['logger']['warn'](_0x6571e2(0x149),_0x52541f);}}async['resetUsageData'](_0x538492=![]){const _0x11c43b=a0_0x10c410;this[_0x11c43b(0x136)][_0x11c43b(0x17b)](_0x11c43b(0x170),{'preserveTotal':_0x538492});if(!_0x538492)this['usage']=this['_initializeUsageData']();else{const _0x13d4b2=this['usage'][_0x11c43b(0x169)],_0x1dc7f1=this['usage']['totalInputTokens'],_0x3edded=this['usage']['totalOutputTokens'];this[_0x11c43b(0x16e)]=this[_0x11c43b(0x1b2)](),this['usage'][_0x11c43b(0x169)]=_0x13d4b2,this['usage']['totalInputTokens']=_0x1dc7f1,this['usage'][_0x11c43b(0x122)]=_0x3edded;}await this[_0x11c43b(0x1bb)]();}async[a0_0x10c410(0x186)](_0x1dc395='json'){const _0x25ddaa=a0_0x10c410,_0x18da20=await this[_0x25ddaa(0x158)]();if(_0x1dc395==='csv')return this[_0x25ddaa(0x166)](_0x18da20);return JSON['stringify'](_0x18da20,null,0x2);}[a0_0x10c410(0x166)](_0x3b8b61){const _0x34f368=a0_0x10c410,_0x38b0ff=['Category,Service/Model,Cost,InputTokens,OutputTokens,RequestCount'];for(const [_0x9ac94,_0x419d52]of Object['entries'](_0x3b8b61[_0x34f368(0x1a2)])){_0x38b0ff['push']('Service,'+_0x9ac94+','+_0x419d52['cost']+','+_0x419d52['inputTokens']+','+_0x419d52['outputTokens']+','+_0x419d52[_0x34f368(0x1a4)]);}for(const [_0x501776,_0x2fa9d2]of Object[_0x34f368(0x191)](_0x3b8b61[_0x34f368(0x1aa)])){_0x38b0ff['push']('Model,'+_0x501776+','+_0x2fa9d2[_0x34f368(0x198)]+','+_0x2fa9d2[_0x34f368(0x1a0)]+','+_0x2fa9d2['outputTokens']+','+_0x2fa9d2[_0x34f368(0x1a4)]);}return _0x38b0ff[_0x34f368(0x15b)]('\x0a');}[a0_0x10c410(0x15a)](_0x5ac059,_0x2a30d6,_0x85fda){const _0x19e5b7=a0_0x10c410;this['_validateUsageInputs']('estimate',_0x5ac059,_0x2a30d6,_0x85fda);const _0x361a68=this['_calculateCost'](_0x5ac059,_0x2a30d6,_0x85fda),_0x1f810d={'model':_0x5ac059,'estimatedInputTokens':_0x2a30d6,'estimatedOutputTokens':_0x85fda,'estimatedCost':_0x361a68['totalCost'],..._0x361a68,'budgetImpact':null};if(this['budgetLimit']!==null){const _0x139102=this[_0x19e5b7(0x16e)]['totalCost']+_0x361a68['totalCost'];_0x1f810d['budgetImpact']={'currentSpent':this[_0x19e5b7(0x16e)]['totalCost'],'afterOperation':_0x139102,'remainingAfter':Math[_0x19e5b7(0x164)](0x0,this[_0x19e5b7(0x13e)]-_0x139102),'wouldExceedBudget':_0x139102>this[_0x19e5b7(0x13e)],'percentageAfter':_0x139102/this[_0x19e5b7(0x13e)]*0x64};}return _0x1f810d;}['checkBudgetForOperation'](_0x2a4b4b,_0x587d8f,_0x1081d5){const _0x49a13d=a0_0x10c410,_0x8d526f=this['getCostEstimate'](_0x2a4b4b,_0x587d8f,_0x1081d5);return{'canProceed':this[_0x49a13d(0x13e)]===null||!_0x8d526f[_0x49a13d(0x1a9)]?.['wouldExceedBudget'],'estimate':_0x8d526f,'recommendation':this['_getBudgetRecommendation'](_0x8d526f)};}[a0_0x10c410(0x180)](_0x282e35){const _0x248000=a0_0x10c410;if(this['budgetLimit']===null)return _0x248000(0x165);if(!_0x282e35[_0x248000(0x1a9)])return _0x248000(0x12a);const {percentageAfter:_0x5455be,wouldExceedBudget:_0x7c97d}=_0x282e35[_0x248000(0x1a9)];if(_0x7c97d)return'Operation\x20would\x20exceed\x20budget\x20limit.\x20Consider\x20increasing\x20budget\x20or\x20using\x20a\x20less\x20expensive\x20model.';if(_0x5455be>BUDGET_CRITICAL_THRESHOLD*0x64)return _0x248000(0x196);if(_0x5455be>BUDGET_WARNING_THRESHOLD*0x64)return _0x248000(0x14a);return'Operation\x20is\x20within\x20budget\x20guidelines.';}[a0_0x10c410(0x144)](){const _0x10bc43=a0_0x10c410,_0x1f4947=Array['from'](this[_0x10bc43(0x125)]['entries']())['map'](([_0x330102,_0x53938d])=>({'model':_0x330102,'inputPrice':_0x53938d[_0x10bc43(0x124)],'outputPrice':_0x53938d['output'],'unit':_0x53938d[_0x10bc43(0x13c)],'currency':_0x53938d['currency']}));return{'models':_0x1f4947,'lastUpdate':this['lastPricingUpdate'],'source':this['serverLLMService']?'server':_0x10bc43(0x19d),'totalModels':this[_0x10bc43(0x125)]['size']};}async[a0_0x10c410(0x1b0)](){const _0xbf4882=a0_0x10c410,_0x24261b={'status':'healthy','issues':[],'metrics':{'totalCost':this[_0xbf4882(0x16e)]['totalCost'],'totalTokens':this[_0xbf4882(0x16e)]['totalInputTokens']+this[_0xbf4882(0x16e)][_0xbf4882(0x122)],'modelsWithPricing':this[_0xbf4882(0x125)][_0xbf4882(0x13d)],'budgetLimit':this[_0xbf4882(0x13e)]}};try{await this[_0xbf4882(0x1a6)]();const _0xf87dcf=a0_0x39c951['join'](this['usageDir'],_0xbf4882(0x14d));await a0_0x232803['writeFile'](_0xf87dcf,'test'),await a0_0x232803['unlink'](_0xf87dcf);}catch(_0x707f1e){_0x24261b[_0xbf4882(0x143)]='degraded',_0x24261b[_0xbf4882(0x15e)][_0xbf4882(0x160)](_0xbf4882(0x1b9));}this[_0xbf4882(0x125)][_0xbf4882(0x13d)]===0x0&&(_0x24261b['status']='degraded',_0x24261b['issues']['push']('No\x20pricing\x20data\x20available'));if(this[_0xbf4882(0x135)]){const _0x58029a=(Date['now']()-new Date(this[_0xbf4882(0x135)])['getTime']())/(0x3e8*0x3c*0x3c);_0x58029a>0x18&&_0x24261b['issues']['push'](_0xbf4882(0x1ad));}if(this['budgetLimit']!==null){const _0x5d637f=this[_0xbf4882(0x137)]();_0x5d637f[_0xbf4882(0x194)]!=='normal'&&_0x24261b[_0xbf4882(0x15e)]['push']('Budget\x20'+_0x5d637f['warningLevel']+':\x20'+_0x5d637f[_0xbf4882(0x14f)]['toFixed'](0x1)+_0xbf4882(0x188));}return _0x24261b['issues'][_0xbf4882(0x15c)]>0x0&&_0x24261b[_0xbf4882(0x143)]===_0xbf4882(0x151)&&(_0x24261b['status']='warning'),_0x24261b;}async[a0_0x10c410(0x14c)](){const _0x1ef77c=a0_0x10c410;this[_0x1ef77c(0x136)][_0x1ef77c(0x17b)]('Shutting\x20down\x20budget\x20service');try{await this[_0x1ef77c(0x1bb)](),this[_0x1ef77c(0x125)][_0x1ef77c(0x1a8)](),this['logger'][_0x1ef77c(0x17b)](_0x1ef77c(0x1b4));}catch(_0x1d8be0){this[_0x1ef77c(0x136)][_0x1ef77c(0x150)](_0x1ef77c(0x145),_0x1d8be0);throw _0x1d8be0;}}}