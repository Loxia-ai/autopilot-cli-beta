const a0_0x272548=a0_0x2c30;function a0_0x2c30(_0x5d4f1d,_0x5c36c7){const _0x27f7fb=a0_0x27f7();return a0_0x2c30=function(_0x2c309b,_0x26ccd8){_0x2c309b=_0x2c309b-0x95;let _0x1aeb9d=_0x27f7fb[_0x2c309b];if(a0_0x2c30['jzxAeY']===undefined){var _0x9b3151=function(_0x2d8a9c){const _0x56a53e='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x22924a='',_0x1efa57='';for(let _0x4d9021=0x0,_0x141eba,_0x5aeb78,_0xa05a29=0x0;_0x5aeb78=_0x2d8a9c['charAt'](_0xa05a29++);~_0x5aeb78&&(_0x141eba=_0x4d9021%0x4?_0x141eba*0x40+_0x5aeb78:_0x5aeb78,_0x4d9021++%0x4)?_0x22924a+=String['fromCharCode'](0xff&_0x141eba>>(-0x2*_0x4d9021&0x6)):0x0){_0x5aeb78=_0x56a53e['indexOf'](_0x5aeb78);}for(let _0xd5e418=0x0,_0xeea207=_0x22924a['length'];_0xd5e418<_0xeea207;_0xd5e418++){_0x1efa57+='%'+('00'+_0x22924a['charCodeAt'](_0xd5e418)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x1efa57);};a0_0x2c30['UWUKnc']=_0x9b3151,_0x5d4f1d=arguments,a0_0x2c30['jzxAeY']=!![];}const _0x9e84fd=_0x27f7fb[0x0],_0x10afe1=_0x2c309b+_0x9e84fd,_0xe0be80=_0x5d4f1d[_0x10afe1];return!_0xe0be80?(_0x1aeb9d=a0_0x2c30['UWUKnc'](_0x1aeb9d),_0x5d4f1d[_0x10afe1]=_0x1aeb9d):_0x1aeb9d=_0xe0be80,_0x1aeb9d;},a0_0x2c30(_0x5d4f1d,_0x5c36c7);}(function(_0x364c30,_0x4917cd){const _0x4a759d=a0_0x2c30,_0x37575a=_0x364c30();while(!![]){try{const _0xfc3acf=parseInt(_0x4a759d(0xb6))/0x1+parseInt(_0x4a759d(0xca))/0x2*(-parseInt(_0x4a759d(0x111))/0x3)+-parseInt(_0x4a759d(0x103))/0x4*(parseInt(_0x4a759d(0xbf))/0x5)+-parseInt(_0x4a759d(0xaf))/0x6+parseInt(_0x4a759d(0xef))/0x7+parseInt(_0x4a759d(0x121))/0x8*(parseInt(_0x4a759d(0xa0))/0x9)+parseInt(_0x4a759d(0x96))/0xa;if(_0xfc3acf===_0x4917cd)break;else _0x37575a['push'](_0x37575a['shift']());}catch(_0x332976){_0x37575a['push'](_0x37575a['shift']());}}}(a0_0x27f7,0x76ca8));import{promises as a0_0x2d8a9c}from'fs';import a0_0x56a53e from'path';const DEFAULT_USAGE_DIR=a0_0x272548(0xd0),USAGE_FILENAME='usage.json',SESSION_PREFIX=a0_0x272548(0x10b),PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':a0_0x272548(0xc3),'INVALID_TOKENS':'Token\x20counts\x20must\x20be\x20non-negative\x20numbers','INVALID_SERVICE':'Service\x20name\x20must\x20be\x20a\x20non-empty\x20string','BUDGET_EXCEEDED':'Budget\x20limit\x20exceeded','PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':a0_0x272548(0x10d)};function a0_0x27f7(){const _0x3cff3d=['y29ZDa','BgfZDfvWzgf0zwq','ihjLCxvLC3rZkqO','Dw5SAw5R','C2vYDMvYteXnu2vYDMLJzq','Bw9KzwXvC2fNzq','Aw5MBW','mZi4odyXngrrAe9TAW','C3rHCNrZv2L0Aa','u2H1DhrPBMCGzg93BIbIDwrNzxqGC2vYDMLJzq','zw5KC1DPDgG','D2L0AgLUqNvKz2v0','B3v0Chv0vg9Rzw5Z','rMfPBgvKihrVigXVywqGChjLDMLVDxmGDxnHz2uGzgf0ytO','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','zxn0Aw1HDgu','tw9KzwWS','sw52ywXPzcbTB2rLBcbUyw1LihbYB3zPzgvKigzVCIbWCMLJAw5NigXVB2T1Ca','BgLTAxq','Aw5WDxq','su5wquXjrf9ut0TftLm','Dg90ywXjBNb1DfrVA2vUCW','q2XLyw5Lzcb1Cca','z2v0','tw9KzwWGBMfTzsbTDxn0igjLigeGBM9UlwvTChr5ihn0CMLUzW','y2XLyxi','D291BgrfEgnLzwrcDwrNzxq','mtCZmKDVt0rfBW','yNjLywTKB3DUqNLnB2rLBa','ChvZAa','CMvXDwvZDenVDw50','C3rHDhvZ','Dg9ju09tDhjPBMC','uhjPy2LUzYb1BMf2ywLSywjSzsbMB3iGBw9KzwWG','C2vZC2LVBLn0yxj0','C2vZC2LVBL8','pt09ifvtquDfifjfue9svca9pt0k','rMLSzsbZExn0zw0GB3bLCMf0Aw9UigzHAwXLza','B3v0Chv0','Dg90ywXpDxrWDxruB2TLBNm','zgvNCMfKzwq','nZjdCKz4BeW','D2fYBMLUzW','AgvHBhrOEq','vg90ywWGy29ZDdOGja','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','AgfYzeXPBwL0','BMfTzq','x3zHBgLKyxrLqNvKz2v0qw1VDw50','z2v0tw9KzwXqCMLJAw5N','C3rYAw5N','Dw5PDa','yNvKz2v0tgLTAxq','C2XPy2u','C2vYDMvY','BM9YBwfS','DxnHz2veAxi','oejeru9OvG','z2v0qNvKz2v0vxnHz2u','ChjPy2LUz0LUzM8','yNvKz2v0','qNvKz2v0ihnLCNzPy2uGAw5PDgLHBgL6zwq','D2fYBMLUz0XLDMvS','zgvIDwC','D2fYBG','C2vZC2LVBKvUza','cLbYAwnPBMCGC291CMnLoIa','t3bLCMf0Aw9UihDVDwXKigv4y2vLzcbIDwrNzxqGBgLTAxqUienVBNnPzgvYigLUy3jLyxnPBMCGyNvKz2v0ig9YihvZAw5NigeGBgvZCYbLEhbLBNnPDMuGBw9KzwWU','ndK0nJeYmhDMte1ouW','muSGDg9Rzw5Z','z2v0q29ZDevZDgLTyxrL','ig1VzgvSCYbMCM9TihnLCNzLCG','BxrPBwu','CMvZzxrvC2fNzurHDge','DgvZDa','C3rYAw5NAwz5','Bg9Nz2vY','qLver0vux0vyq0vfreve','nJG3ndiWyLfStgnV','x2vUC3vYzvvZywDLrgLYzwn0B3j5','z3b0ltq','y3vYCMvUy3K','zMfSBgjHy2S','BwfW','ANnVBG','Bwf4','BNvTyMvY','ywXS','Aw5JBhvKzxm','y29UzMLN','Dg90ywXtCgvUDa','C2H1DgrVD24','x2nOzwnRqNvKz2v0u3rHDhvZ','mtCYotiWuwvzu1P1','z3b0ltmUnq','CgfYC2u','zw50CMLLCW','uhjVy2vLzcb3AxrOig9WzxjHDgLVBI4','vvne','ChjPy2LUz0rHDge','ntmZnZq4qNL0uwXI','BgvUz3rO','z2v0uhjPy2LUz0rHDge','AgvHBhrOq2HLy2S','y3jPDgLJywW','C2L6zq','A2v5CW','CMvHzgrPCG','t3bLCMf0Aw9UihDVDwXKihvZzsbTB3n0ig9MihLVDxiGyNvKz2v0lIbnB25PDg9YihvZywDLignHCMvMDwXSEs4','mtCZme5XuNnMsq','vg90ywWGAw5WDxqGDg9Rzw5ZoIa','qNvKz2v0ia','z2v0vxnHz2vszxbVCNq','qNvKz2v0igfTB3vUDcbTDxn0igjLigeGCg9ZAxrPDMuGBNvTyMvY','z2v0uhjPy2LUz0LUzM8','DxnHz2u','x2DLBMvYyxrLu2vZC2LVBKLK','x2nHBgn1Bgf0zunVC3q','cJ09psbcuKvbs0rpv04GqLKGtu9eruWGpt09cG','rKLmrv9twvnuru1Frvjst1i','nZu3nZH0yurfuNO','AxnZDwvZ','jsb1C2vK','BgfZDfbYAwnPBMDvCgrHDgu','vxnHz2uGCMvJB3jKzwqGC3vJy2vZC2z1BgX5','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','lI8UBg94AweTyNvKz2v0','BwvZC2fNzq','x2v4Cg9YDfrVq3n2','zMLSDgvY','AM9PBG','CMvTywLUAw5NqNvKz2v0','Dg90ywXdB3n0','BM93','Aw5WDxruB2TLBNm','C2f2zvvZywDLrgf0yq','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','BgfZDfnHDMvKq29ZDa','tg9HzgvKihbYzxzPB3vZihvZywDLigrHDge','DxrMltG','x2LUAxrPywXPEMvvC2fNzurHDge','oIaK','Dg9gAxHLza','uhjPy2LUzYb1CgrHDguGywXYzwfKEsbPBIbWCM9NCMvZCW','yNvKz2v0sw1Wywn0','C2vYDMLJzvvZywDL','x3vWzgf0zvvZywDLrgf0yq','x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','C29UBMv0','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG'];a0_0x27f7=function(){return _0x3cff3d;};return a0_0x27f7();}export class BudgetService{constructor(_0x22924a,_0x1efa57,_0x4d9021=null){const _0x4e64f9=a0_0x272548;this[_0x4e64f9(0xab)]=_0x22924a,this['logger']=_0x1efa57,this[_0x4e64f9(0xec)]=_0x4d9021,this['usage']=this[_0x4e64f9(0xde)](),this[_0x4e64f9(0x11c)]=this['_loadBudgetLimit'](),this[_0x4e64f9(0x116)]=_0x22924a[_0x4e64f9(0x124)]?.[_0x4e64f9(0x116)]||![],this['pricingData']=new Map(),this[_0x4e64f9(0xcd)]=null,this['pricingUpdateInProgress']=![],this['usageDir']=_0x22924a[_0x4e64f9(0x124)]?.['usageDir']||DEFAULT_USAGE_DIR,this['logger'][_0x4e64f9(0xee)](_0x4e64f9(0x125),{'budgetLimit':this['budgetLimit'],'hardLimit':this['hardLimit'],'usageDir':this[_0x4e64f9(0x120)],'hasPricingService':!!this[_0x4e64f9(0xec)]}),this['_loadUsageData']()['catch'](_0x141eba=>{const _0x5cd456=_0x4e64f9;this[_0x5cd456(0x9e)]['warn'](_0x5cd456(0xf5),_0x141eba);});}['_initializeUsageData'](){const _0x188608=a0_0x272548;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()[_0x188608(0x108)](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()['toISOString']()};}[a0_0x272548(0xc6)](){const _0x5aeb78=Date['now']()['toString'](0x24),_0xa05a29=Math['random']()['toString'](0x24)['slice'](0x2);return _0x5aeb78+'_'+_0xa05a29;}['_loadBudgetLimit'](){const _0x7ba52c=a0_0x272548,_0xd5e418=this['config'][_0x7ba52c(0x124)]?.[_0x7ba52c(0xfa)];if(_0xd5e418!==undefined&&_0xd5e418!==null)return this['_validateBudgetAmount'](_0xd5e418);return null;}async['updatePricingFromServer'](){const _0x74a891=a0_0x272548;if(!this[_0x74a891(0xec)])return this['logger'][_0x74a891(0x127)]('No\x20server\x20LLM\x20service\x20available\x20for\x20pricing\x20updates'),![];if(this['pricingUpdateInProgress'])return this[_0x74a891(0x9e)][_0x74a891(0x127)](_0x74a891(0xe1)),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this[_0x74a891(0x9e)]['info']('Updating pricing data from server');const _0xeea207=await this[_0x74a891(0xec)][_0x74a891(0xb8)]();if(_0xeea207['size']===0x0)return this[_0x74a891(0x9e)][_0x74a891(0x128)]('No pricing data received from server'),![];this['pricingData']['clear']();for(const [_0x598f12,_0x436eda]of _0xeea207[_0x74a891(0xb2)]()){this['pricingData']['set'](_0x598f12,{'input':_0x436eda['input'],'output':_0x436eda['output'],'unit':_0x436eda['unit']||'1K\x20tokens','currency':_0x436eda['currency']||_0x74a891(0xb4)});}return this['lastPricingUpdate']=new Date()['toISOString'](),this['logger'][_0x74a891(0xee)]('Updated\x20pricing\x20for\x20'+this['pricingData'][_0x74a891(0xbb)]+_0x74a891(0x99)),!![];}catch(_0xd1f14a){return this[_0x74a891(0x9e)]['error']('Failed to update pricing from server:',_0xd1f14a),![];}finally{this['pricingUpdateInProgress']=![];}}['_shouldUpdatePricing'](){const _0x4b9720=a0_0x272548;if(!this['lastPricingUpdate'])return!![];const _0x42c9f9=Date['now']()-new Date(this[_0x4b9720(0xcd)])['getTime']();return _0x42c9f9>PRICING_REFRESH_THRESHOLD_MS;}[a0_0x272548(0x119)](_0x423ea3){const _0x1a6f09=a0_0x272548;if(!_0x423ea3||typeof _0x423ea3!=='string')return this['logger'][_0x1a6f09(0x128)](_0x1a6f09(0xf9)),null;return this[_0x1a6f09(0xb5)][_0x1a6f09(0xff)](_0x423ea3)||null;}['getAllPricing'](){return this['serverLLMService']['getPricingData']();}async['recordUsage'](_0x10d029,_0x2d11ec,_0x3a73ba,_0x28e0ef){const _0x24a633=a0_0x272548;this[_0x24a633(0x9e)][_0x24a633(0xee)]('Recording\x20usage\x20for\x20'+_0x10d029+'/'+_0x2d11ec,{'inputTokens':_0x3a73ba,'outputTokens':_0x28e0ef,'service':_0x10d029,'model':_0x2d11ec}),this[_0x24a633(0xcf)](_0x10d029,_0x2d11ec,_0x3a73ba,_0x28e0ef),await this['updatePricingFromServer']();const _0x3cd3cb=this[_0x24a633(0xc7)](_0x2d11ec,_0x3a73ba,_0x28e0ef);!_0x3cd3cb['success']&&this['logger'][_0x24a633(0x128)](_0x24a633(0x109)+_0x2d11ec+',\x20using\x20estimate');this['_updateUsageData'](_0x10d029,_0x2d11ec,_0x3a73ba,_0x28e0ef,_0x3cd3cb['totalCost']);const _0x1145e0=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x2a163a={'service':_0x10d029,'model':_0x2d11ec,'inputTokens':_0x3a73ba,'outputTokens':_0x28e0ef,'cost':_0x3cd3cb,'budgetStatus':_0x1145e0,'timestamp':new Date()[_0x24a633(0x108)]()};return this['logger'][_0x24a633(0x127)](_0x24a633(0xce),_0x2a163a),_0x2a163a;}['_validateUsageInputs'](_0x4872f5,_0x5e9d0b,_0x4dfad6,_0x1920c3){const _0x365019=a0_0x272548;if(!_0x4872f5||typeof _0x4872f5!==_0x365019(0x11a))throw new Error(ERROR_MESSAGES['INVALID_SERVICE']);if(!_0x5e9d0b||typeof _0x5e9d0b!==_0x365019(0x11a))throw new Error(_0x365019(0x100));if(typeof _0x4dfad6!==_0x365019(0xa8)||_0x4dfad6<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);if(typeof _0x1920c3!==_0x365019(0xa8)||_0x1920c3<0x0)throw new Error(ERROR_MESSAGES[_0x365019(0xfc)]);}[a0_0x272548(0xc7)](_0x14ea0c,_0x37c398,_0x321b3b){const _0x4cfdbd=a0_0x272548,_0x18c551=this['getModelPricing'](_0x14ea0c);if(!_0x18c551){const _0x3a5e14=this['_getEstimatedPricing'](_0x14ea0c),_0x4755db=_0x37c398/0x3e8*_0x3a5e14['input'],_0x1ef3e5=_0x321b3b/0x3e8*_0x3a5e14[_0x4cfdbd(0x10e)];return{'success':![],'inputCost':_0x4755db,'outputCost':_0x1ef3e5,'totalCost':_0x4755db+_0x1ef3e5,'currency':'USD','unit':_0x4cfdbd(0x97),'estimated':!![],'reason':'Pricing\x20data\x20unavailable\x20for\x20model'};}const _0x5065c2=_0x37c398/0x3e8*_0x18c551[_0x4cfdbd(0xfb)],_0x3f6697=_0x321b3b/0x3e8*_0x18c551['output'];return{'success':!![],'inputCost':_0x5065c2,'outputCost':_0x3f6697,'totalCost':_0x5065c2+_0x3f6697,'currency':_0x18c551['currency'],'unit':_0x18c551[_0x4cfdbd(0x11b)],'estimated':![]};}['_getEstimatedPricing'](_0x2f8eab){const _0xc61aec=a0_0x272548,_0x3c849b=_0x2f8eab['toLowerCase']();if(_0x3c849b[_0xc61aec(0xaa)]('opus')||_0x3c849b[_0xc61aec(0xaa)](_0xc61aec(0xa2)))return{'input':0.015,'output':0.075};else{if(_0x3c849b['includes'](_0xc61aec(0xe6))||_0x3c849b[_0xc61aec(0xaa)](_0xc61aec(0xb0)))return{'input':0.003,'output':0.015};else{if(_0x3c849b[_0xc61aec(0xaa)]('haiku')||_0x3c849b[_0xc61aec(0xaa)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}[a0_0x272548(0xe4)](_0x91c08d,_0x11c0c4,_0x255c5,_0x4e62a8,_0x1e1695){const _0x1add86=a0_0x272548;this[_0x1add86(0xc5)][_0x1add86(0xfd)]+=_0x255c5,this[_0x1add86(0xc5)]['totalOutputTokens']+=_0x4e62a8,this[_0x1add86(0xc5)]['totalCost']+=_0x1e1695,this['usage']['lastUpdated']=new Date()[_0x1add86(0x108)](),!this[_0x1add86(0xc5)]['serviceUsage'][_0x91c08d]&&(this[_0x1add86(0xc5)]['serviceUsage'][_0x91c08d]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x1add86(0xc5)][_0x1add86(0xe3)][_0x91c08d]['inputTokens']+=_0x255c5,this['usage']['serviceUsage'][_0x91c08d][_0x1add86(0xf4)]+=_0x4e62a8,this[_0x1add86(0xc5)][_0x1add86(0xe3)][_0x91c08d]['cost']+=_0x1e1695,this['usage'][_0x1add86(0xe3)][_0x91c08d][_0x1add86(0x106)]+=0x1,!this['usage']['modelUsage'][_0x11c0c4]&&(this[_0x1add86(0xc5)]['modelUsage'][_0x11c0c4]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x1add86(0xc5)][_0x1add86(0xed)][_0x11c0c4][_0x1add86(0xd8)]+=_0x255c5,this[_0x1add86(0xc5)][_0x1add86(0xed)][_0x11c0c4][_0x1add86(0xf4)]+=_0x4e62a8,this[_0x1add86(0xc5)]['modelUsage'][_0x11c0c4][_0x1add86(0xe8)]+=_0x1e1695,this['usage'][_0x1add86(0xed)][_0x11c0c4]['requestCount']+=0x1;}[a0_0x272548(0xae)](){const _0x3ead07=a0_0x272548,_0x8b9f73={'withinBudget':!![],'budgetLimit':this[_0x3ead07(0x11c)],'totalSpent':this[_0x3ead07(0xc5)][_0x3ead07(0xd6)],'remainingBudget':null,'percentageUsed':null,'warningLevel':_0x3ead07(0x11f)};if(this['budgetLimit']!==null){_0x8b9f73[_0x3ead07(0xd5)]=Math[_0x3ead07(0xa7)](0x0,this['budgetLimit']-this[_0x3ead07(0xc5)][_0x3ead07(0xd6)]),_0x8b9f73['percentageUsed']=this['usage']['totalCost']/this[_0x3ead07(0x11c)]*0x64,_0x8b9f73[_0x3ead07(0xf3)]=this[_0x3ead07(0xc5)][_0x3ead07(0xd6)]<=this['budgetLimit'];if(_0x8b9f73['percentageUsed']>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x8b9f73[_0x3ead07(0x126)]=_0x3ead07(0xba);else _0x8b9f73['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x8b9f73['warningLevel']=_0x3ead07(0x112));_0x8b9f73[_0x3ead07(0x126)]!=='normal'&&this[_0x3ead07(0x9e)]['warn'](_0x3ead07(0xc1)+_0x8b9f73[_0x3ead07(0x126)]+':\x20'+_0x8b9f73['percentageUsed'][_0x3ead07(0xe0)](0x1)+_0x3ead07(0xcc),{'totalSpent':this['usage'][_0x3ead07(0xd6)],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x8b9f73[_0x3ead07(0xd5)]});if(!_0x8b9f73['withinBudget']&&this[_0x3ead07(0x116)]){const _0x239464=new Error(ERROR_MESSAGES[_0x3ead07(0x9f)]+_0x3ead07(0xdf)+this[_0x3ead07(0xc5)]['totalCost']['toFixed'](0x2)+'\x20exceeds\x20limit\x20of\x20$'+this[_0x3ead07(0x11c)][_0x3ead07(0xe0)](0x2));_0x239464['code']='BUDGET_EXCEEDED',_0x239464['budgetStatus']=_0x8b9f73;throw _0x239464;}}return _0x8b9f73;}async['setBudgetLimit'](_0x22df8e){const _0x356c74=a0_0x272548,_0x4aba8a=this[_0x356c74(0x118)](_0x22df8e);this['budgetLimit']=_0x4aba8a,this['config']['budget']=this['config']['budget']||{},this['config']['budget']['limit']=_0x4aba8a,this['logger']['info']('Budget\x20limit\x20set\x20to\x20$'+_0x4aba8a[_0x356c74(0xe0)](0x2),{'previousLimit':this['budgetLimit'],'newLimit':_0x4aba8a}),await this[_0x356c74(0xd9)]();}['_validateBudgetAmount'](_0x5370eb){if(typeof _0x5370eb!=='number'||_0x5370eb<0x0||!isFinite(_0x5370eb))throw new Error(ERROR_MESSAGES['INVALID_AMOUNT']);return _0x5370eb;}async[a0_0x272548(0x122)](){const _0x26a30a=a0_0x272548;await this['updatePricingFromServer']();const _0x27a675={'totalSpent':this[_0x26a30a(0xc5)]['totalCost'],'budgetLimit':this[_0x26a30a(0x11c)],'inputTokens':this['usage']['totalInputTokens'],'outputTokens':this['usage']['totalOutputTokens'],'remainingBudget':this['budgetLimit']!==null?Math['max'](0x0,this[_0x26a30a(0x11c)]-this[_0x26a30a(0xc5)][_0x26a30a(0xd6)]):null,'percentageUsed':this['budgetLimit']!==null?this['usage'][_0x26a30a(0xd6)]/this[_0x26a30a(0x11c)]*0x64:null,'sessionStart':this[_0x26a30a(0xc5)][_0x26a30a(0x10a)],'lastUpdated':this[_0x26a30a(0xc5)][_0x26a30a(0xe9)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this['lastPricingUpdate'],'modelsWithPricing':this['pricingData']['size'],'source':this['serverLLMService']?_0x26a30a(0x11e):_0x26a30a(0xa4)}};for(const [_0x4b0302,_0x18875a]of Object['entries'](this['usage']['serviceUsage'])){_0x27a675['breakdownByService'][_0x4b0302]={'cost':_0x18875a[_0x26a30a(0xe8)],'inputTokens':_0x18875a['inputTokens'],'outputTokens':_0x18875a['outputTokens'],'requestCount':_0x18875a['requestCount']};}for(const [_0x2ba24b,_0x35ece8]of Object[_0x26a30a(0xb2)](this[_0x26a30a(0xc5)]['modelUsage'])){_0x27a675[_0x26a30a(0x104)][_0x2ba24b]={'cost':_0x35ece8['cost'],'inputTokens':_0x35ece8['inputTokens'],'outputTokens':_0x35ece8['outputTokens'],'requestCount':_0x35ece8[_0x26a30a(0x106)]};}return _0x27a675;}async[a0_0x272548(0xc2)](){const _0x4d90df=a0_0x272548,_0x439b19=await this[_0x4d90df(0x122)]();let _0x225b60=_0x4d90df(0x10c);_0x225b60+=_0x4d90df(0x114)+_0x439b19[_0x4d90df(0xac)][_0x4d90df(0xe0)](0x4)+'\x0a',_0x225b60+=_0x4d90df(0xc0)+_0x439b19['inputTokens']['toLocaleString']()+'\x0a',_0x225b60+='Total\x20output\x20tokens:\x20'+_0x439b19['outputTokens']['toLocaleString']()+'\x0a';_0x439b19[_0x4d90df(0x11c)]!==null&&(_0x225b60+='Budget\x20limit:\x20$'+_0x439b19[_0x4d90df(0x11c)][_0x4d90df(0xe0)](0x2)+'\x0a',_0x225b60+='Remaining:\x20$'+_0x439b19[_0x4d90df(0xd5)][_0x4d90df(0xe0)](0x4)+'\x0a',_0x225b60+='Usage:\x20'+_0x439b19['percentageUsed']['toFixed'](0x1)+'%\x0a');_0x225b60+=_0x4d90df(0x12a)+_0x439b19[_0x4d90df(0x123)]['source']+'\x0a',_0x225b60+='Models\x20with\x20pricing:\x20'+_0x439b19['pricingInfo']['modelsWithPricing']+'\x0a';if(Object['keys'](_0x439b19['breakdownByService'])['length']>0x0){_0x225b60+='\x0a===\x20BREAKDOWN\x20BY\x20SERVICE\x20===\x0a';for(const [_0x2f010a,_0x5b24f3]of Object['entries'](_0x439b19['breakdownByService'])){_0x225b60+=_0x2f010a+':\x20$'+_0x5b24f3['cost']['toFixed'](0x4)+'\x20('+_0x5b24f3['requestCount']+'\x20requests)\x0a';}}if(Object[_0x4d90df(0xbc)](_0x439b19[_0x4d90df(0x104)])[_0x4d90df(0xb7)]>0x0){_0x225b60+=_0x4d90df(0xc8);for(const [_0x35e363,_0x5afd35]of Object['entries'](_0x439b19[_0x4d90df(0x104)])){_0x225b60+=_0x35e363+':\x20$'+_0x5afd35[_0x4d90df(0xe8)]['toFixed'](0x4)+'\x20('+_0x5afd35['requestCount']+_0x4d90df(0xea);}}return _0x225b60;}async[a0_0x272548(0xf6)](){const _0x416a95=a0_0x272548,_0x37ed13=0.1,_0x150a19=this[_0x416a95(0xc5)]['lastSavedCost']||0x0;this['usage']['totalCost']-_0x150a19>=_0x37ed13&&(await this[_0x416a95(0xd9)](),this[_0x416a95(0xc5)][_0x416a95(0xdb)]=this[_0x416a95(0xc5)][_0x416a95(0xd6)]);}async['_loadUsageData'](){const _0x55b340=a0_0x272548;try{await this['_ensureUsageDirectory']();const _0x244143=a0_0x56a53e['join'](this[_0x55b340(0x120)],USAGE_FILENAME);try{const _0x29f17a=await a0_0x2d8a9c['readFile'](_0x244143,'utf-8'),_0x105efb=JSON[_0x55b340(0xb1)](_0x29f17a);this[_0x55b340(0xc5)][_0x55b340(0xfd)]=_0x105efb[_0x55b340(0xfd)]||0x0,this['usage']['totalOutputTokens']=_0x105efb[_0x55b340(0x10f)]||0x0,this['usage']['totalCost']=_0x105efb['totalCost']||0x0,this[_0x55b340(0xc5)][_0x55b340(0xe3)]=_0x105efb[_0x55b340(0xe3)]||{},this[_0x55b340(0xc5)]['modelUsage']=_0x105efb['modelUsage']||{},this[_0x55b340(0x9e)][_0x55b340(0xee)](_0x55b340(0xdc),{'totalCost':this[_0x55b340(0xc5)]['totalCost'],'totalTokens':this[_0x55b340(0xc5)][_0x55b340(0xfd)]+this[_0x55b340(0xc5)]['totalOutputTokens']});}catch(_0x4ff6b6){_0x4ff6b6['code']!=='ENOENT'&&this['logger']['warn']('Failed\x20to\x20load\x20usage\x20data:',_0x4ff6b6);}}catch(_0x386f38){this['logger'][_0x55b340(0x128)]('Error\x20initializing\x20usage\x20data\x20directory:',_0x386f38);}}async['_ensureUsageDirectory'](){const _0x57d027=a0_0x272548;try{await a0_0x2d8a9c['mkdir'](this['usageDir'],{'recursive':!![]});}catch(_0x3d2c30){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x3d2c30[_0x57d027(0xd1)]);}}async[a0_0x272548(0xd9)](){const _0x548b85=a0_0x272548;try{await this[_0x548b85(0xa1)](),this['usage'][_0x548b85(0x129)]=new Date()['toISOString']();const _0x353cad=a0_0x56a53e['join'](this['usageDir'],USAGE_FILENAME);await a0_0x2d8a9c['writeFile'](_0x353cad,JSON[_0x548b85(0x9d)](this[_0x548b85(0xc5)],null,0x2),_0x548b85(0xdd));const _0x36a686=a0_0x56a53e[_0x548b85(0xd4)](this[_0x548b85(0x120)],''+SESSION_PREFIX+this['usage']['sessionId']+'.json');await a0_0x2d8a9c['writeFile'](_0x36a686,JSON[_0x548b85(0x9d)](this[_0x548b85(0xc5)],null,0x2),'utf-8'),await this[_0x548b85(0xe5)](),this[_0x548b85(0x9e)]['info']('Usage\x20data\x20saved\x20successfully',{'totalCost':this['usage'][_0x548b85(0xd6)],'sessionId':this['usage']['sessionId']});}catch(_0x6b2d23){this[_0x548b85(0x9e)]['error']('Failed\x20to\x20save\x20usage\x20data:',_0x6b2d23);throw new Error(ERROR_MESSAGES[_0x548b85(0xc9)]+':\x20'+_0x6b2d23['message']);}}async['_cleanupOldSessionFiles'](){const _0x430ba9=a0_0x272548;try{const _0x1331a5=await a0_0x2d8a9c[_0x430ba9(0xbd)](this['usageDir']),_0x2c364a=_0x1331a5[_0x430ba9(0xd3)](_0x5c63a4=>_0x5c63a4[_0x430ba9(0xf0)](SESSION_PREFIX)&&_0x5c63a4[_0x430ba9(0xf2)]('.json'))['map'](_0x4d4755=>({'name':_0x4d4755,'path':a0_0x56a53e[_0x430ba9(0xd4)](this['usageDir'],_0x4d4755)}));if(_0x2c364a['length']<=MAX_SESSION_FILES)return;const _0xe00c08=await Promise[_0x430ba9(0xa9)](_0x2c364a[_0x430ba9(0xa5)](async _0x59de44=>{try{const _0xfcf700=await a0_0x2d8a9c['stat'](_0x59de44['path']);return{..._0x59de44,'mtime':_0xfcf700['mtime']};}catch(_0x5bf729){return null;}})),_0x186fec=_0xe00c08[_0x430ba9(0xd3)](_0x47b696=>_0x47b696!==null)['sort']((_0xf168ba,_0x5266ef)=>_0x5266ef[_0x430ba9(0x9a)]-_0xf168ba['mtime']),_0x1229bc=_0x186fec[_0x430ba9(0x11d)](MAX_SESSION_FILES);for(const _0x1d743d of _0x1229bc){try{await a0_0x2d8a9c[_0x430ba9(0xeb)](_0x1d743d['path']),this[_0x430ba9(0x9e)]['debug']('Removed\x20old\x20session\x20file:\x20'+_0x1d743d['name']);}catch(_0xbae16e){this[_0x430ba9(0x9e)][_0x430ba9(0x128)]('Failed\x20to\x20remove\x20session\x20file\x20'+_0x1d743d[_0x430ba9(0x117)]+':',_0xbae16e);}}_0x1229bc['length']>0x0&&this[_0x430ba9(0x9e)][_0x430ba9(0xee)](_0x430ba9(0xfe)+_0x1229bc[_0x430ba9(0xb7)]+'\x20old\x20session\x20files');}catch(_0x5e7eee){this[_0x430ba9(0x9e)]['warn']('Failed\x20to\x20cleanup\x20old\x20session\x20files:',_0x5e7eee);}}async[a0_0x272548(0x9b)](_0x16825f=![]){const _0x218077=a0_0x272548;this['logger']['info']('Resetting\x20usage\x20data',{'preserveTotal':_0x16825f});if(!_0x16825f)this['usage']=this['_initializeUsageData']();else{const _0x41b24c=this['usage']['totalCost'],_0x1399b1=this['usage'][_0x218077(0xfd)],_0x25e259=this[_0x218077(0xc5)][_0x218077(0x10f)];this[_0x218077(0xc5)]=this[_0x218077(0xde)](),this['usage'][_0x218077(0xd6)]=_0x41b24c,this['usage']['totalInputTokens']=_0x1399b1,this['usage']['totalOutputTokens']=_0x25e259;}await this[_0x218077(0xd9)]();}async['exportUsageData'](_0x54b710=a0_0x272548(0xa6)){const _0x423f73=a0_0x272548,_0x29406f=await this['getBudgetUsage']();if(_0x54b710==='csv')return this['_exportToCsv'](_0x29406f);return JSON[_0x423f73(0x9d)](_0x29406f,null,0x2);}[a0_0x272548(0xd2)](_0x4bf5b7){const _0x510f08=a0_0x272548,_0x154bf2=['Category,Service/Model,Cost,InputTokens,OutputTokens,RequestCount'];for(const [_0x3885e0,_0x1510f5]of Object[_0x510f08(0xb2)](_0x4bf5b7['breakdownByService'])){_0x154bf2['push']('Service,'+_0x3885e0+','+_0x1510f5[_0x510f08(0xe8)]+','+_0x1510f5[_0x510f08(0xd8)]+','+_0x1510f5['outputTokens']+','+_0x1510f5[_0x510f08(0x106)]);}for(const [_0x5f5730,_0x3d1ad8]of Object['entries'](_0x4bf5b7['breakdownByModel'])){_0x154bf2[_0x510f08(0x105)](_0x510f08(0xf8)+_0x5f5730+','+_0x3d1ad8[_0x510f08(0xe8)]+','+_0x3d1ad8['inputTokens']+','+_0x3d1ad8[_0x510f08(0xf4)]+','+_0x3d1ad8[_0x510f08(0x106)]);}return _0x154bf2[_0x510f08(0xd4)]('\x0a');}['getCostEstimate'](_0x4c2547,_0x4511ca,_0x46d141){const _0x3d0fe8=a0_0x272548;this['_validateUsageInputs'](_0x3d0fe8(0xf7),_0x4c2547,_0x4511ca,_0x46d141);const _0x300ac5=this['_calculateCost'](_0x4c2547,_0x4511ca,_0x46d141),_0x4d7ee6={'model':_0x4c2547,'estimatedInputTokens':_0x4511ca,'estimatedOutputTokens':_0x46d141,'estimatedCost':_0x300ac5['totalCost'],..._0x300ac5,'budgetImpact':null};if(this[_0x3d0fe8(0x11c)]!==null){const _0x213f6a=this[_0x3d0fe8(0xc5)]['totalCost']+_0x300ac5['totalCost'];_0x4d7ee6[_0x3d0fe8(0xe2)]={'currentSpent':this['usage']['totalCost'],'afterOperation':_0x213f6a,'remainingAfter':Math[_0x3d0fe8(0xa7)](0x0,this['budgetLimit']-_0x213f6a),'wouldExceedBudget':_0x213f6a>this['budgetLimit'],'percentageAfter':_0x213f6a/this[_0x3d0fe8(0x11c)]*0x64};}return _0x4d7ee6;}['checkBudgetForOperation'](_0x25bb27,_0x1f1f66,_0x9ea335){const _0x2214d1=a0_0x272548,_0x4eeed9=this[_0x2214d1(0x98)](_0x25bb27,_0x1f1f66,_0x9ea335);return{'canProceed':this[_0x2214d1(0x11c)]===null||!_0x4eeed9['budgetImpact']?.[_0x2214d1(0x102)],'estimate':_0x4eeed9,'recommendation':this[_0x2214d1(0x115)](_0x4eeed9)};}['_getBudgetRecommendation'](_0x243858){const _0x319f90=a0_0x272548;if(this[_0x319f90(0x11c)]===null)return _0x319f90(0xe7);if(!_0x243858[_0x319f90(0xe2)])return _0x319f90(0xb3);const {percentageAfter:_0x4db4a8,wouldExceedBudget:_0x3886c0}=_0x243858['budgetImpact'];if(_0x3886c0)return _0x319f90(0x95);if(_0x4db4a8>BUDGET_CRITICAL_THRESHOLD*0x64)return _0x319f90(0xbe);if(_0x4db4a8>BUDGET_WARNING_THRESHOLD*0x64)return'Operation\x20would\x20use\x20significant\x20portion\x20of\x20budget.\x20Consider\x20cost\x20optimization.';return'Operation\x20is\x20within\x20budget\x20guidelines.';}[a0_0x272548(0xc4)](){const _0xa73732=a0_0x272548,_0x27bc56=Array['from'](this['pricingData'][_0xa73732(0xb2)]())['map'](([_0x3bde78,_0x2068da])=>({'model':_0x3bde78,'inputPrice':_0x2068da[_0xa73732(0xfb)],'outputPrice':_0x2068da['output'],'unit':_0x2068da['unit'],'currency':_0x2068da[_0xa73732(0xa3)]}));return{'models':_0x27bc56,'lastUpdate':this[_0xa73732(0xcd)],'source':this['serverLLMService']?'server':_0xa73732(0xa4),'totalModels':this['pricingData']['size']};}async[a0_0x272548(0xb9)](){const _0x38391b=a0_0x272548,_0x59b6a9={'status':_0x38391b(0x113),'issues':[],'metrics':{'totalCost':this[_0x38391b(0xc5)]['totalCost'],'totalTokens':this['usage']['totalInputTokens']+this['usage'][_0x38391b(0x10f)],'modelsWithPricing':this['pricingData']['size'],'budgetLimit':this[_0x38391b(0x11c)]}};try{await this[_0x38391b(0xa1)]();const _0x26efab=a0_0x56a53e[_0x38391b(0xd4)](this['usageDir'],'.health-check');await a0_0x2d8a9c['writeFile'](_0x26efab,_0x38391b(0x9c)),await a0_0x2d8a9c[_0x38391b(0xeb)](_0x26efab);}catch(_0x312d51){_0x59b6a9['status']='degraded',_0x59b6a9[_0x38391b(0xcb)]['push']('File\x20system\x20access\x20issues');}this['pricingData'][_0x38391b(0xbb)]===0x0&&(_0x59b6a9[_0x38391b(0x107)]=_0x38391b(0x110),_0x59b6a9[_0x38391b(0xcb)]['push']('No\x20pricing\x20data\x20available'));if(this['lastPricingUpdate']){const _0x217990=(Date[_0x38391b(0xd7)]()-new Date(this[_0x38391b(0xcd)])['getTime']())/(0x3e8*0x3c*0x3c);_0x217990>0x18&&_0x59b6a9[_0x38391b(0xcb)][_0x38391b(0x105)](_0x38391b(0xda));}if(this['budgetLimit']!==null){const _0x736e16=this[_0x38391b(0xae)]();_0x736e16['warningLevel']!=='normal'&&_0x59b6a9[_0x38391b(0xcb)]['push']('Budget\x20'+_0x736e16['warningLevel']+':\x20'+_0x736e16['percentageUsed']['toFixed'](0x1)+_0x38391b(0xcc));}return _0x59b6a9['issues'][_0x38391b(0xb7)]>0x0&&_0x59b6a9[_0x38391b(0x107)]===_0x38391b(0x113)&&(_0x59b6a9[_0x38391b(0x107)]='warning'),_0x59b6a9;}async[a0_0x272548(0xad)](){const _0x4745ce=a0_0x272548;this[_0x4745ce(0x9e)][_0x4745ce(0xee)](_0x4745ce(0xf1));try{await this[_0x4745ce(0xd9)](),this['pricingData'][_0x4745ce(0x101)](),this['logger'][_0x4745ce(0xee)]('Budget\x20service\x20shut\x20down\x20successfully');}catch(_0x288a6b){this[_0x4745ce(0x9e)]['error']('Error\x20during\x20budget\x20service\x20shutdown:',_0x288a6b);throw _0x288a6b;}}}