const a0_0x175033=a0_0x3a2e;(function(_0x1b34b1,_0x3a0530){const _0x30b031=a0_0x3a2e,_0x4bc47b=_0x1b34b1();while(!![]){try{const _0x2b88f7=parseInt(_0x30b031(0x1ae))/0x1*(parseInt(_0x30b031(0x1b7))/0x2)+-parseInt(_0x30b031(0x1b8))/0x3*(parseInt(_0x30b031(0x156))/0x4)+parseInt(_0x30b031(0x168))/0x5+-parseInt(_0x30b031(0x13b))/0x6+-parseInt(_0x30b031(0x17b))/0x7*(-parseInt(_0x30b031(0x19a))/0x8)+-parseInt(_0x30b031(0x15f))/0x9*(parseInt(_0x30b031(0x15a))/0xa)+parseInt(_0x30b031(0x163))/0xb;if(_0x2b88f7===_0x3a0530)break;else _0x4bc47b['push'](_0x4bc47b['shift']());}catch(_0x2b1fe2){_0x4bc47b['push'](_0x4bc47b['shift']());}}}(a0_0x3aca,0x6bb98));import{promises as a0_0x7257bd}from'fs';import a0_0x3c4abd from'path';const DEFAULT_USAGE_DIR='./.loxia-budget',USAGE_FILENAME='usage.json',SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':a0_0x175033(0x171),'INVALID_TOKENS':a0_0x175033(0x1ca),'INVALID_SERVICE':a0_0x175033(0x1a7),'BUDGET_EXCEEDED':a0_0x175033(0x179),'PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':'File\x20system\x20operation\x20failed'};function a0_0x3aca(){const _0x11970a=['mZq3odi2mfPzzwHXwG','AM9PBG','BgfZDfvWzgf0zwq','zMLSDgvY','C2XPy2u','y29ZDa','Dg9mB2nHBgvtDhjPBMC','zxjYB3i','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','Dw5SAw5R','Dg90ywXjBNb1DfrVA2vUCW','CMvZzxrvC2fNzurHDge','y2HLy2TcDwrNzxrgB3jpCgvYyxrPB24','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','Dw5PDa','z3b0ltmUnq','qLver0vux0vyq0vfreve','Dg90ywXdB3n0','C2vYDMvYteXnu2vYDMLJzq','D2L0AgLUqNvKz2v0','x3zHBgLKyxrLqNvKz2v0qw1VDw50','C3rYAw5N','Bw9KzwXvC2fNzq','x2XVywrvC2fNzurHDge','ANnVBG','ChvZAa','BwfW','mJq4menRz0PQuG','y2XLyxi','rMfPBgvKihrVigXVywqGChjLDMLVDxmGDxnHz2uGzgf0ytO','cLbYAwnPBMCGC291CMnLoIa','mJbgtu91wK8','uhjPy2LUzYb1BMf2ywLSywjSzsbMB3iGBw9KzwWG','vxbKyxrLzcbWCMLJAw5NigzVCIa','BxrPBwu','BgvUz3rO','mJC1mJq3ouHRu3DxCq','x2LUAxrPywXPEMvvC2fNzurHDge','uMvZzxr0Aw5NihvZywDLigrHDge','A2v5CW','mteZmdiYndDTzLbQr0K','BM93','su5wquXjrf9ut0TftLm','DxnHz2u','y2f0y2G','mtaWndKXmhjHs1nzAq','q2XLyw5Lzcb1Cca','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','z2v0qNvKz2v0vxnHz2u','D2fYBG','Aw5MBW','Aw5WDxruB2TLBNm','vxnHz2u6ia','B3v0Chv0','qNvKz2v0igfTB3vUDcbTDxn0igjLigeGCg9ZAxrPDMuGBNvTyMvY','Dg9gAxHLza','q2f0zwDVCNKSu2vYDMLJzs9nB2rLBcXdB3n0leLUChv0vg9Rzw5Zle91Dhb1DfrVA2vUCYXszxf1zxn0q291BNq','BgLTAxq','vxnHz2uGCMvJB3jKzwqGC3vJy2vZC2z1BgX5','Bg9Nz2vY','C2vYDMvY','su5wquXjrf9btu9vtLq','qNvKz2v0igXPBwL0igv4y2vLzgvK','Aw5JBhvKzxm','odu5mte3AfjwBuHc','C2H1DgrVD24','z2v0tw9KzwXqCMLJAw5N','zgvIDwC','BM9YBwfS','x2nHBgn1Bgf0zunVC3q','tM8GChjPy2LUzYbKyxrHigf2ywLSywjSzq','yNjLywTKB3DUqNLnB2rLBa','Dg90ywXpDxrWDxruB2TLBNm','yNvKz2v0sw1Wywn0','x2DLBMvYyxrLu2vZC2LVBKLK','cJ09psbcuKvbs0rpv04GqLKGtu9eruWGpt09cG','lcb1C2LUzYbLC3rPBwf0zq','CMvTywLUAw5NqNvKz2v0','BgfZDfnHDMvKq29ZDa','qNvKz2v0igXPBwL0oIaK','BwvZC2fNzq','y29UzMLN','AgfPA3u','C2vYDMLJzvvZywDL','DxnHz2veAxi','AgvHBhrOEq','zNjVBq','Dg9mB3DLCKnHC2u','igv4y2vLzhmGBgLTAxqGB2yGja','oIaK','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','x3nOB3vSzfvWzgf0zvbYAwnPBMC','BNvTyMvY','D291BgrfEgnLzwrcDwrNzxq','CMvXDwvZDenVDw50','mJrJs3rkqMm','Dg9tDhjPBMC','tg9HzgvKihbYzxzPB3vZihvZywDLigrHDge','CgvYy2vUDgfNzvvZzwq','D2fYBMLUz0XLDMvS','y29Kzq','uMvTB3zLzcbVBgqGC2vZC2LVBIbMAwXLoIa','x2vUC3vYzvvZywDLrgLYzwn0B3j5','AgvHBhrOq2HLy2S','uhjPy2LUzYb1CgrHDguGywXYzwfKEsbPBIbWCM9NCMvZCW','z2v0q29ZDevZDgLTyxrL','AxnZDwvZ','C2f2zvvZywDLrgf0yq','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','z2v0vgLTzq','ig1VzgvSCYbMCM9TihnLCNzLCG','x2v4Cg9YDfrVq3n2','Dg9ju09tDhjPBMC','qNvKz2v0igXPBwL0ihnLDcb0BYaK','yNvKz2v0u3rHDhvZ','mwnSBfrMCW','CMvJB3jKvxnHz2u','qNvKz2v0ihnLCNzPy2uGAw5PDgLHBgL6zwq','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','x2XVywrcDwrNzxrmAw1PDa','Cgf0Aa','C3rHDa','C3rHDhvZ','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','mtaWmdy4mg1HrMH5vG','mJi0n3rSwgvLDa','CgfYC2u','x2nOzwnRqNvKz2v0u3rHDhvZ','zw50CMLLCW','zgvNCMfKzwq','rMfPBgvKihrVihnHDMuGDxnHz2uGzgf0ytO','muSGDg9Rzw5Z','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','x2DLDevZDgLTyxrLzfbYAwnPBMC','u2vYDMLJzsW','ru5pru5u','z2v0','pt09ifvtquDfifjfue9svca9pt0k','jsb1C2vK','AgfYzeXPBwL0','yNvKz2v0tgLTAxq','C2L6zq','z2v0vxnHz2vszxbVCNq','vg9Rzw4Gy291BNrZig11C3qGyMuGBM9Ulw5Lz2f0AxzLig51BwjLCNm','lMPZB24','B3v0Chv0vg9Rzw5Z','C291CMnL','yNvKz2v0','DxrMltG','y3vYCMvUy3K','ChjPy2LUz0rHDge','vg90ywWGB3v0Chv0ihrVA2vUCZOG','C2v0','tw9KzwWS','t3bLCMf0Aw9UihDVDwXKigv4y2vLzcbIDwrNzxqGBgLTAxqUienVBNnPzgvYigLUy3jLyxnPBMCGyNvKz2v0ig9YihvZAw5NigeGBgvZCYbLEhbLBNnPDMuGBw9KzwWU','BgfZDfbYAwnPBMDvCgrHDgu','D2fYBMLUzW'];a0_0x3aca=function(){return _0x11970a;};return a0_0x3aca();}function a0_0x3a2e(_0xd05219,_0x262a1a){const _0x3acad7=a0_0x3aca();return a0_0x3a2e=function(_0x3a2eb5,_0x5811e4){_0x3a2eb5=_0x3a2eb5-0x12e;let _0x2e8029=_0x3acad7[_0x3a2eb5];if(a0_0x3a2e['UYQPfC']===undefined){var _0x119aa2=function(_0x7257bd){const _0x3c4abd='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x4e339d='',_0xf80483='';for(let _0x111811=0x0,_0x375a51,_0x386916,_0x254213=0x0;_0x386916=_0x7257bd['charAt'](_0x254213++);~_0x386916&&(_0x375a51=_0x111811%0x4?_0x375a51*0x40+_0x386916:_0x386916,_0x111811++%0x4)?_0x4e339d+=String['fromCharCode'](0xff&_0x375a51>>(-0x2*_0x111811&0x6)):0x0){_0x386916=_0x3c4abd['indexOf'](_0x386916);}for(let _0x2afec8=0x0,_0x44453b=_0x4e339d['length'];_0x2afec8<_0x44453b;_0x2afec8++){_0xf80483+='%'+('00'+_0x4e339d['charCodeAt'](_0x2afec8)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0xf80483);};a0_0x3a2e['cPgXPX']=_0x119aa2,_0xd05219=arguments,a0_0x3a2e['UYQPfC']=!![];}const _0x5cfe56=_0x3acad7[0x0],_0xa0171=_0x3a2eb5+_0x5cfe56,_0xe58da0=_0xd05219[_0xa0171];return!_0xe58da0?(_0x2e8029=a0_0x3a2e['cPgXPX'](_0x2e8029),_0xd05219[_0xa0171]=_0x2e8029):_0x2e8029=_0xe58da0,_0x2e8029;},a0_0x3a2e(_0xd05219,_0x262a1a);}export class BudgetService{constructor(_0x4e339d,_0xf80483,_0x111811=null){const _0x23e32b=a0_0x175033;this[_0x23e32b(0x18c)]=_0x4e339d,this['logger']=_0xf80483,this['serverLLMService']=_0x111811,this['usage']=this['_initializeUsageData'](),this['budgetLimit']=this[_0x23e32b(0x1b2)](),this['hardLimit']=_0x4e339d['budget']?.['hardLimit']||![],this[_0x23e32b(0x134)]=new Map(),this['lastPricingUpdate']=null,this[_0x23e32b(0x1b6)]=![],this[_0x23e32b(0x18f)]=_0x4e339d[_0x23e32b(0x131)]?.['usageDir']||DEFAULT_USAGE_DIR,this['logger'][_0x23e32b(0x16d)](_0x23e32b(0x1b0),{'budgetLimit':this['budgetLimit'],'hardLimit':this[_0x23e32b(0x1c6)],'usageDir':this[_0x23e32b(0x18f)],'hasPricingService':!!this[_0x23e32b(0x14d)]}),this['_loadUsageData']()[_0x23e32b(0x167)](_0x375a51=>{const _0x2664d1=_0x23e32b;this[_0x2664d1(0x176)]['warn'](_0x2664d1(0x158),_0x375a51);});}['_initializeUsageData'](){const _0x4a8a8c=a0_0x175033;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()[_0x4a8a8c(0x1ab)](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()[_0x4a8a8c(0x1ab)]()};}[a0_0x175033(0x185)](){const _0x342ea3=a0_0x175033,_0x386916=Date['now']()[_0x342ea3(0x19b)](0x24),_0x254213=Math['random']()[_0x342ea3(0x19b)](0x24)[_0x342ea3(0x13f)](0x2);return _0x386916+'_'+_0x254213;}['_loadBudgetLimit'](){const _0x41860f=a0_0x175033,_0x2afec8=this[_0x41860f(0x18c)][_0x41860f(0x131)]?.['limit'];if(_0x2afec8!==undefined&&_0x2afec8!==null)return this[_0x41860f(0x14f)](_0x2afec8);return null;}async[a0_0x175033(0x148)](){const _0x8471eb=a0_0x175033;if(!this['serverLLMService'])return this['logger']['debug']('No\x20server\x20LLM\x20service\x20available\x20for\x20pricing\x20updates'),![];if(this[_0x8471eb(0x1b6)])return this[_0x8471eb(0x176)]['debug'](_0x8471eb(0x1a3)),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this['logger'][_0x8471eb(0x16d)]('Updating pricing data from server');const _0x44453b=await this[_0x8471eb(0x14d)]['getPricingData']();if(_0x44453b[_0x8471eb(0x1c8)]===0x0)return this[_0x8471eb(0x176)]['warn']('No pricing data received from server'),![];this['pricingData'][_0x8471eb(0x157)]();for(const [_0x4076d8,_0x597349]of _0x44453b['entries']()){this[_0x8471eb(0x134)][_0x8471eb(0x136)](_0x4076d8,{'input':_0x597349['input'],'output':_0x597349[_0x8471eb(0x170)],'unit':_0x597349[_0x8471eb(0x149)]||_0x8471eb(0x1be),'currency':_0x597349['currency']||'USD'});}return this[_0x8471eb(0x139)]=new Date()[_0x8471eb(0x1ab)](),this['logger'][_0x8471eb(0x16d)](_0x8471eb(0x15c)+this[_0x8471eb(0x134)][_0x8471eb(0x1c8)]+_0x8471eb(0x1a9)),!![];}catch(_0x35da30){return this['logger']['error']('Failed to update pricing from server:',_0x35da30),![];}finally{this[_0x8471eb(0x1b6)]=![];}}[a0_0x175033(0x196)](){const _0x266b2a=a0_0x175033;if(!this[_0x266b2a(0x139)])return!![];const _0x4b9b9a=Date['now']()-new Date(this['lastPricingUpdate'])[_0x266b2a(0x1a8)]();return _0x4b9b9a>PRICING_REFRESH_THRESHOLD_MS;}[a0_0x175033(0x17d)](_0xfe09e4){const _0x2f8b7f=a0_0x175033;if(!_0xfe09e4||typeof _0xfe09e4!==_0x2f8b7f(0x150))return this['logger'][_0x2f8b7f(0x16c)]('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this[_0x2f8b7f(0x134)][_0x2f8b7f(0x1c3)](_0xfe09e4)||null;}['getAllPricing'](){const _0x17b4dc=a0_0x175033;return this[_0x17b4dc(0x14d)]['getPricingData']();}async[a0_0x175033(0x1af)](_0x51336e,_0x39fbfd,_0x327014,_0x3a347d){const _0x3abc83=a0_0x175033;this[_0x3abc83(0x176)][_0x3abc83(0x16d)]('Recording\x20usage\x20for\x20'+_0x51336e+'/'+_0x39fbfd,{'inputTokens':_0x327014,'outputTokens':_0x3a347d,'service':_0x51336e,'model':_0x39fbfd}),this['_validateUsageInputs'](_0x51336e,_0x39fbfd,_0x327014,_0x3a347d),await this[_0x3abc83(0x148)]();const _0x49b498=this['_calculateCost'](_0x39fbfd,_0x327014,_0x3a347d);!_0x49b498['success']&&this[_0x3abc83(0x176)]['warn'](_0x3abc83(0x15b)+_0x39fbfd+_0x3abc83(0x187));this['_updateUsageData'](_0x51336e,_0x39fbfd,_0x327014,_0x3a347d,_0x49b498['totalCost']);const _0x4c4be4=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x39ed8d={'service':_0x51336e,'model':_0x39fbfd,'inputTokens':_0x327014,'outputTokens':_0x3a347d,'cost':_0x49b498,'budgetStatus':_0x4c4be4,'timestamp':new Date()['toISOString']()};return this[_0x3abc83(0x176)][_0x3abc83(0x17e)](_0x3abc83(0x175),_0x39ed8d),_0x39ed8d;}[a0_0x175033(0x143)](_0x3725c1,_0x468a18,_0x43c9ed,_0xeae723){const _0x22ab62=a0_0x175033;if(!_0x3725c1||typeof _0x3725c1!=='string')throw new Error(ERROR_MESSAGES['INVALID_SERVICE']);if(!_0x468a18||typeof _0x468a18!==_0x22ab62(0x150))throw new Error('Model\x20name\x20must\x20be\x20a\x20non-empty\x20string');if(typeof _0x43c9ed!==_0x22ab62(0x197)||_0x43c9ed<0x0)throw new Error(ERROR_MESSAGES[_0x22ab62(0x165)]);if(typeof _0xeae723!=='number'||_0xeae723<0x0)throw new Error(ERROR_MESSAGES[_0x22ab62(0x165)]);}[a0_0x175033(0x180)](_0x36a405,_0x5067bc,_0x2bd485){const _0x413199=a0_0x175033,_0x40fe23=this['getModelPricing'](_0x36a405);if(!_0x40fe23){const _0x3858f5=this[_0x413199(0x1c0)](_0x36a405),_0x46e01d=_0x5067bc/0x3e8*_0x3858f5['input'],_0x158afb=_0x2bd485/0x3e8*_0x3858f5[_0x413199(0x170)];return{'success':![],'inputCost':_0x46e01d,'outputCost':_0x158afb,'totalCost':_0x46e01d+_0x158afb,'currency':'USD','unit':_0x413199(0x1be),'estimated':!![],'reason':'Pricing\x20data\x20unavailable\x20for\x20model'};}const _0x517103=_0x5067bc/0x3e8*_0x40fe23['input'],_0x30f223=_0x2bd485/0x3e8*_0x40fe23[_0x413199(0x170)];return{'success':!![],'inputCost':_0x517103,'outputCost':_0x30f223,'totalCost':_0x517103+_0x30f223,'currency':_0x40fe23[_0x413199(0x133)],'unit':_0x40fe23[_0x413199(0x149)],'estimated':![]};}['_getEstimatedPricing'](_0x567e2e){const _0x120aa7=a0_0x175033,_0x3c5977=_0x567e2e[_0x120aa7(0x192)]();if(_0x3c5977['includes']('opus')||_0x3c5977['includes']('gpt-4'))return{'input':0.015,'output':0.075};else{if(_0x3c5977[_0x120aa7(0x17a)]('sonnet')||_0x3c5977['includes'](_0x120aa7(0x14a)))return{'input':0.003,'output':0.015};else{if(_0x3c5977['includes'](_0x120aa7(0x18d))||_0x3c5977[_0x120aa7(0x17a)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}['_updateUsageData'](_0x426876,_0x253206,_0x2c8179,_0x20710e,_0x4078c3){const _0x2defcb=a0_0x175033;this['usage'][_0x2defcb(0x145)]+=_0x2c8179,this[_0x2defcb(0x166)]['totalOutputTokens']+=_0x20710e,this['usage'][_0x2defcb(0x14c)]+=_0x4078c3,this[_0x2defcb(0x166)]['lastUpdated']=new Date()['toISOString'](),!this[_0x2defcb(0x166)][_0x2defcb(0x18e)][_0x426876]&&(this['usage']['serviceUsage'][_0x426876]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage'][_0x2defcb(0x18e)][_0x426876]['inputTokens']+=_0x2c8179,this[_0x2defcb(0x166)][_0x2defcb(0x18e)][_0x426876][_0x2defcb(0x12f)]+=_0x20710e,this['usage']['serviceUsage'][_0x426876][_0x2defcb(0x140)]+=_0x4078c3,this[_0x2defcb(0x166)]['serviceUsage'][_0x426876][_0x2defcb(0x199)]+=0x1,!this['usage'][_0x2defcb(0x151)][_0x253206]&&(this[_0x2defcb(0x166)]['modelUsage'][_0x253206]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage']['modelUsage'][_0x253206]['inputTokens']+=_0x2c8179,this[_0x2defcb(0x166)][_0x2defcb(0x151)][_0x253206]['outputTokens']+=_0x20710e,this['usage']['modelUsage'][_0x253206]['cost']+=_0x4078c3,this['usage']['modelUsage'][_0x253206]['requestCount']+=0x1;}[a0_0x175033(0x1ba)](){const _0x36e7d7=a0_0x175033,_0x447640={'withinBudget':!![],'budgetLimit':this[_0x36e7d7(0x1c7)],'totalSpent':this['usage'][_0x36e7d7(0x14c)],'remainingBudget':null,'percentageUsed':null,'warningLevel':_0x36e7d7(0x17f)};if(this['budgetLimit']!==null){_0x447640['remainingBudget']=Math['max'](0x0,this['budgetLimit']-this[_0x36e7d7(0x166)][_0x36e7d7(0x14c)]),_0x447640[_0x36e7d7(0x19d)]=this[_0x36e7d7(0x166)][_0x36e7d7(0x14c)]/this[_0x36e7d7(0x1c7)]*0x64,_0x447640[_0x36e7d7(0x14e)]=this['usage'][_0x36e7d7(0x14c)]<=this[_0x36e7d7(0x1c7)];if(_0x447640[_0x36e7d7(0x19d)]>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x447640[_0x36e7d7(0x19e)]='critical';else _0x447640['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x447640['warningLevel']=_0x36e7d7(0x13a));_0x447640['warningLevel']!=='normal'&&this['logger']['warn']('Budget\x20'+_0x447640['warningLevel']+':\x20'+_0x447640['percentageUsed']['toFixed'](0x1)+_0x36e7d7(0x1c5),{'totalSpent':this[_0x36e7d7(0x166)][_0x36e7d7(0x14c)],'budgetLimit':this[_0x36e7d7(0x1c7)],'remainingBudget':_0x447640[_0x36e7d7(0x188)]});if(!_0x447640[_0x36e7d7(0x14e)]&&this[_0x36e7d7(0x1c6)]){const _0x23edae=new Error(ERROR_MESSAGES[_0x36e7d7(0x14b)]+':\x20$'+this[_0x36e7d7(0x166)]['totalCost'][_0x36e7d7(0x172)](0x2)+_0x36e7d7(0x193)+this[_0x36e7d7(0x1c7)][_0x36e7d7(0x172)](0x2));_0x23edae[_0x36e7d7(0x19f)]='BUDGET_EXCEEDED',_0x23edae[_0x36e7d7(0x1ad)]=_0x447640;throw _0x23edae;}}return _0x447640;}async['setBudgetLimit'](_0x278ed1){const _0x3a108d=a0_0x175033,_0x573faa=this[_0x3a108d(0x14f)](_0x278ed1);this['budgetLimit']=_0x573faa,this[_0x3a108d(0x18c)][_0x3a108d(0x131)]=this[_0x3a108d(0x18c)][_0x3a108d(0x131)]||{},this[_0x3a108d(0x18c)]['budget'][_0x3a108d(0x174)]=_0x573faa,this[_0x3a108d(0x176)]['info'](_0x3a108d(0x1ac)+_0x573faa[_0x3a108d(0x172)](0x2),{'previousLimit':this['budgetLimit'],'newLimit':_0x573faa}),await this[_0x3a108d(0x1a6)]();}[a0_0x175033(0x14f)](_0x42691f){const _0x14f0d6=a0_0x175033;if(typeof _0x42691f!==_0x14f0d6(0x197)||_0x42691f<0x0||!isFinite(_0x42691f))throw new Error(ERROR_MESSAGES[_0x14f0d6(0x178)]);return _0x42691f;}async[a0_0x175033(0x16b)](){const _0x564e72=a0_0x175033;await this[_0x564e72(0x148)]();const _0x557686={'totalSpent':this['usage'][_0x564e72(0x14c)],'budgetLimit':this['budgetLimit'],'inputTokens':this[_0x564e72(0x166)][_0x564e72(0x145)],'outputTokens':this[_0x564e72(0x166)]['totalOutputTokens'],'remainingBudget':this['budgetLimit']!==null?Math['max'](0x0,this['budgetLimit']-this['usage'][_0x564e72(0x14c)]):null,'percentageUsed':this['budgetLimit']!==null?this[_0x564e72(0x166)]['totalCost']/this[_0x564e72(0x1c7)]*0x64:null,'sessionStart':this[_0x564e72(0x166)]['sessionStart'],'lastUpdated':this['usage'][_0x564e72(0x13d)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this['lastPricingUpdate'],'modelsWithPricing':this['pricingData']['size'],'source':this[_0x564e72(0x14d)]?'server':'fallback'}};for(const [_0xc7d96c,_0x450f37]of Object[_0x564e72(0x1bb)](this[_0x564e72(0x166)][_0x564e72(0x18e)])){_0x557686['breakdownByService'][_0xc7d96c]={'cost':_0x450f37['cost'],'inputTokens':_0x450f37[_0x564e72(0x16e)],'outputTokens':_0x450f37['outputTokens'],'requestCount':_0x450f37['requestCount']};}for(const [_0x17a6fb,_0x4b19f1]of Object['entries'](this['usage']['modelUsage'])){_0x557686[_0x564e72(0x182)][_0x17a6fb]={'cost':_0x4b19f1[_0x564e72(0x140)],'inputTokens':_0x4b19f1[_0x564e72(0x16e)],'outputTokens':_0x4b19f1['outputTokens'],'requestCount':_0x4b19f1['requestCount']};}return _0x557686;}async[a0_0x175033(0x1c9)](){const _0x1d5aca=a0_0x175033,_0x8a83ce=await this[_0x1d5aca(0x16b)]();let _0x2c195b=_0x1d5aca(0x1c4);_0x2c195b+='Total\x20cost:\x20$'+_0x8a83ce['totalSpent'][_0x1d5aca(0x172)](0x4)+'\x0a',_0x2c195b+='Total\x20input\x20tokens:\x20'+_0x8a83ce['inputTokens'][_0x1d5aca(0x141)]()+'\x0a',_0x2c195b+=_0x1d5aca(0x135)+_0x8a83ce['outputTokens'][_0x1d5aca(0x141)]()+'\x0a';_0x8a83ce['budgetLimit']!==null&&(_0x2c195b+=_0x1d5aca(0x18a)+_0x8a83ce[_0x1d5aca(0x1c7)][_0x1d5aca(0x172)](0x2)+'\x0a',_0x2c195b+='Remaining:\x20$'+_0x8a83ce[_0x1d5aca(0x188)][_0x1d5aca(0x172)](0x4)+'\x0a',_0x2c195b+=_0x1d5aca(0x16f)+_0x8a83ce[_0x1d5aca(0x19d)]['toFixed'](0x1)+'%\x0a');_0x2c195b+=_0x1d5aca(0x159)+_0x8a83ce['pricingInfo'][_0x1d5aca(0x130)]+'\x0a',_0x2c195b+='Models\x20with\x20pricing:\x20'+_0x8a83ce['pricingInfo']['modelsWithPricing']+'\x0a';if(Object['keys'](_0x8a83ce['breakdownByService'])['length']>0x0){_0x2c195b+='\x0a===\x20BREAKDOWN\x20BY\x20SERVICE\x20===\x0a';for(const [_0x32c466,_0x454650]of Object['entries'](_0x8a83ce['breakdownByService'])){_0x2c195b+=_0x32c466+_0x1d5aca(0x194)+_0x454650['cost']['toFixed'](0x4)+'\x20('+_0x454650[_0x1d5aca(0x199)]+'\x20requests)\x0a';}}if(Object[_0x1d5aca(0x162)](_0x8a83ce['breakdownByModel'])[_0x1d5aca(0x15e)]>0x0){_0x2c195b+=_0x1d5aca(0x186);for(const [_0x357f80,_0x578f24]of Object['entries'](_0x8a83ce['breakdownByModel'])){_0x2c195b+=_0x357f80+':\x20$'+_0x578f24[_0x1d5aca(0x140)][_0x1d5aca(0x172)](0x4)+'\x20('+_0x578f24['requestCount']+'\x20requests)\x0a';}}return _0x2c195b;}async[a0_0x175033(0x16a)](){const _0x4ae4dd=a0_0x175033,_0x590f94=0.1,_0x2cd1e1=this[_0x4ae4dd(0x166)][_0x4ae4dd(0x189)]||0x0;this[_0x4ae4dd(0x166)][_0x4ae4dd(0x14c)]-_0x2cd1e1>=_0x590f94&&(await this['saveUsageData'](),this['usage'][_0x4ae4dd(0x189)]=this[_0x4ae4dd(0x166)][_0x4ae4dd(0x14c)]);}async[a0_0x175033(0x152)](){const _0x40c36a=a0_0x175033;try{await this['_ensureUsageDirectory']();const _0xa50345=a0_0x3c4abd[_0x40c36a(0x13c)](this[_0x40c36a(0x18f)],USAGE_FILENAME);try{const _0x286a34=await a0_0x7257bd['readFile'](_0xa50345,_0x40c36a(0x132)),_0x4b44db=JSON[_0x40c36a(0x1b9)](_0x286a34);this[_0x40c36a(0x166)]['totalInputTokens']=_0x4b44db[_0x40c36a(0x145)]||0x0,this[_0x40c36a(0x166)]['totalOutputTokens']=_0x4b44db[_0x40c36a(0x183)]||0x0,this['usage']['totalCost']=_0x4b44db[_0x40c36a(0x14c)]||0x0,this[_0x40c36a(0x166)][_0x40c36a(0x18e)]=_0x4b44db['serviceUsage']||{},this['usage']['modelUsage']=_0x4b44db['modelUsage']||{},this[_0x40c36a(0x176)][_0x40c36a(0x16d)](_0x40c36a(0x19c),{'totalCost':this[_0x40c36a(0x166)][_0x40c36a(0x14c)],'totalTokens':this[_0x40c36a(0x166)]['totalInputTokens']+this[_0x40c36a(0x166)]['totalOutputTokens']});}catch(_0xf81ad9){_0xf81ad9['code']!==_0x40c36a(0x1c2)&&this[_0x40c36a(0x176)][_0x40c36a(0x16c)]('Failed\x20to\x20load\x20usage\x20data:',_0xf81ad9);}}catch(_0x541a80){this['logger'][_0x40c36a(0x16c)]('Error\x20initializing\x20usage\x20data\x20directory:',_0x541a80);}}async['_ensureUsageDirectory'](){const _0x27222d=a0_0x175033;try{await a0_0x7257bd['mkdir'](this[_0x27222d(0x18f)],{'recursive':!![]});}catch(_0x95de80){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x95de80[_0x27222d(0x18b)]);}}async['saveUsageData'](){const _0x20b8f5=a0_0x175033;try{await this['_ensureUsageDirectory'](),this[_0x20b8f5(0x166)]['sessionEnd']=new Date()[_0x20b8f5(0x1ab)]();const _0x2a4fb2=a0_0x3c4abd['join'](this['usageDir'],USAGE_FILENAME);await a0_0x7257bd['writeFile'](_0x2a4fb2,JSON['stringify'](this['usage'],null,0x2),'utf-8');const _0x42fc75=a0_0x3c4abd[_0x20b8f5(0x13c)](this[_0x20b8f5(0x18f)],''+SESSION_PREFIX+this[_0x20b8f5(0x166)]['sessionId']+'.json');await a0_0x7257bd['writeFile'](_0x42fc75,JSON['stringify'](this[_0x20b8f5(0x166)],null,0x2),'utf-8'),await this['_cleanupOldSessionFiles'](),this[_0x20b8f5(0x176)][_0x20b8f5(0x16d)](_0x20b8f5(0x1b1),{'totalCost':this['usage'][_0x20b8f5(0x14c)],'sessionId':this[_0x20b8f5(0x166)]['sessionId']});}catch(_0x4eed58){this['logger'][_0x20b8f5(0x142)](_0x20b8f5(0x1bd),_0x4eed58);throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x4eed58['message']);}}async['_cleanupOldSessionFiles'](){const _0x531ffe=a0_0x175033;try{const _0x5c7d45=await a0_0x7257bd['readdir'](this['usageDir']),_0x42f6a3=_0x5c7d45[_0x531ffe(0x13e)](_0x452ad1=>_0x452ad1['startsWith'](SESSION_PREFIX)&&_0x452ad1['endsWith'](_0x531ffe(0x12e)))['map'](_0x25bf1b=>({'name':_0x25bf1b,'path':a0_0x3c4abd[_0x531ffe(0x13c)](this[_0x531ffe(0x18f)],_0x25bf1b)}));if(_0x42f6a3[_0x531ffe(0x15e)]<=MAX_SESSION_FILES)return;const _0x1b2e58=await Promise['all'](_0x42f6a3[_0x531ffe(0x155)](async _0x41f6d1=>{const _0x122fca=_0x531ffe;try{const _0x9e375d=await a0_0x7257bd[_0x122fca(0x1b4)](_0x41f6d1[_0x122fca(0x1b3)]);return{..._0x41f6d1,'mtime':_0x9e375d['mtime']};}catch(_0x184873){return null;}})),_0x35a6e3=_0x1b2e58[_0x531ffe(0x13e)](_0x516471=>_0x516471!==null)['sort']((_0x286ff0,_0x565c30)=>_0x565c30['mtime']-_0x286ff0[_0x531ffe(0x15d)]),_0x4075c2=_0x35a6e3['slice'](MAX_SESSION_FILES);for(const _0x51dc38 of _0x4075c2){try{await a0_0x7257bd[_0x531ffe(0x144)](_0x51dc38[_0x531ffe(0x1b3)]),this[_0x531ffe(0x176)][_0x531ffe(0x17e)](_0x531ffe(0x1a0)+_0x51dc38['name']);}catch(_0x1d464d){this['logger'][_0x531ffe(0x16c)]('Failed\x20to\x20remove\x20session\x20file\x20'+_0x51dc38['name']+':',_0x1d464d);}}_0x4075c2[_0x531ffe(0x15e)]>0x0&&this[_0x531ffe(0x176)]['info'](_0x531ffe(0x169)+_0x4075c2[_0x531ffe(0x15e)]+'\x20old\x20session\x20files');}catch(_0x37e810){this['logger'][_0x531ffe(0x16c)](_0x531ffe(0x1bf),_0x37e810);}}async[a0_0x175033(0x146)](_0x264d7d=![]){const _0x23f18c=a0_0x175033;this[_0x23f18c(0x176)]['info'](_0x23f18c(0x161),{'preserveTotal':_0x264d7d});if(!_0x264d7d)this[_0x23f18c(0x166)]=this['_initializeUsageData']();else{const _0x278944=this['usage'][_0x23f18c(0x14c)],_0x335440=this[_0x23f18c(0x166)][_0x23f18c(0x145)],_0xb2a2de=this['usage']['totalOutputTokens'];this['usage']=this[_0x23f18c(0x160)](),this['usage']['totalCost']=_0x278944,this[_0x23f18c(0x166)][_0x23f18c(0x145)]=_0x335440,this[_0x23f18c(0x166)]['totalOutputTokens']=_0xb2a2de;}await this['saveUsageData']();}async['exportUsageData'](_0x271b8f=a0_0x175033(0x153)){const _0x26c93f=a0_0x175033,_0x394e84=await this['getBudgetUsage']();if(_0x271b8f==='csv')return this[_0x26c93f(0x1aa)](_0x394e84);return JSON['stringify'](_0x394e84,null,0x2);}['_exportToCsv'](_0x42840f){const _0xd17090=a0_0x175033,_0x4d24db=[_0xd17090(0x173)];for(const [_0x57ac77,_0x408008]of Object[_0xd17090(0x1bb)](_0x42840f['breakdownByService'])){_0x4d24db[_0xd17090(0x154)](_0xd17090(0x1c1)+_0x57ac77+','+_0x408008['cost']+','+_0x408008['inputTokens']+','+_0x408008['outputTokens']+','+_0x408008[_0xd17090(0x199)]);}for(const [_0x4b1f64,_0x173c65]of Object[_0xd17090(0x1bb)](_0x42840f['breakdownByModel'])){_0x4d24db['push'](_0xd17090(0x137)+_0x4b1f64+','+_0x173c65['cost']+','+_0x173c65['inputTokens']+','+_0x173c65['outputTokens']+','+_0x173c65['requestCount']);}return _0x4d24db['join']('\x0a');}['getCostEstimate'](_0x398113,_0x4234f5,_0x52dbba){const _0x3175fe=a0_0x175033;this['_validateUsageInputs']('estimate',_0x398113,_0x4234f5,_0x52dbba);const _0x5ac250=this['_calculateCost'](_0x398113,_0x4234f5,_0x52dbba),_0x692443={'model':_0x398113,'estimatedInputTokens':_0x4234f5,'estimatedOutputTokens':_0x52dbba,'estimatedCost':_0x5ac250[_0x3175fe(0x14c)],..._0x5ac250,'budgetImpact':null};if(this[_0x3175fe(0x1c7)]!==null){const _0x3635e8=this['usage'][_0x3175fe(0x14c)]+_0x5ac250[_0x3175fe(0x14c)];_0x692443[_0x3175fe(0x184)]={'currentSpent':this[_0x3175fe(0x166)][_0x3175fe(0x14c)],'afterOperation':_0x3635e8,'remainingAfter':Math['max'](0x0,this[_0x3175fe(0x1c7)]-_0x3635e8),'wouldExceedBudget':_0x3635e8>this['budgetLimit'],'percentageAfter':_0x3635e8/this[_0x3175fe(0x1c7)]*0x64};}return _0x692443;}[a0_0x175033(0x147)](_0x4d3e2,_0x33ed60,_0x565ded){const _0x53e1c8=a0_0x175033,_0x2c2c5d=this[_0x53e1c8(0x1a4)](_0x4d3e2,_0x33ed60,_0x565ded);return{'canProceed':this[_0x53e1c8(0x1c7)]===null||!_0x2c2c5d[_0x53e1c8(0x184)]?.[_0x53e1c8(0x198)],'estimate':_0x2c2c5d,'recommendation':this['_getBudgetRecommendation'](_0x2c2c5d)};}[a0_0x175033(0x195)](_0x3c3514){const _0x3d21fa=a0_0x175033;if(this['budgetLimit']===null)return'No\x20budget\x20limit\x20set.\x20Consider\x20setting\x20a\x20budget\x20for\x20cost\x20control.';if(!_0x3c3514['budgetImpact'])return'Proceed\x20with\x20operation.';const {percentageAfter:_0x418079,wouldExceedBudget:_0x377dc8}=_0x3c3514[_0x3d21fa(0x184)];if(_0x377dc8)return _0x3d21fa(0x138);if(_0x418079>BUDGET_CRITICAL_THRESHOLD*0x64)return'Operation\x20would\x20use\x20most\x20of\x20your\x20budget.\x20Monitor\x20usage\x20carefully.';if(_0x418079>BUDGET_WARNING_THRESHOLD*0x64)return'Operation\x20would\x20use\x20significant\x20portion\x20of\x20budget.\x20Consider\x20cost\x20optimization.';return'Operation\x20is\x20within\x20budget\x20guidelines.';}['getPricingInfo'](){const _0x4df478=a0_0x175033,_0x5a1481=Array[_0x4df478(0x191)](this['pricingData']['entries']())[_0x4df478(0x155)](([_0x14fd3e,_0x14f54f])=>({'model':_0x14fd3e,'inputPrice':_0x14f54f['input'],'outputPrice':_0x14f54f[_0x4df478(0x170)],'unit':_0x14f54f[_0x4df478(0x149)],'currency':_0x14f54f[_0x4df478(0x133)]}));return{'models':_0x5a1481,'lastUpdate':this['lastPricingUpdate'],'source':this[_0x4df478(0x14d)]?_0x4df478(0x177):'fallback','totalModels':this[_0x4df478(0x134)]['size']};}async[a0_0x175033(0x1a2)](){const _0x3f616c=a0_0x175033,_0xff45b4={'status':_0x3f616c(0x190),'issues':[],'metrics':{'totalCost':this['usage'][_0x3f616c(0x14c)],'totalTokens':this['usage'][_0x3f616c(0x145)]+this[_0x3f616c(0x166)]['totalOutputTokens'],'modelsWithPricing':this['pricingData']['size'],'budgetLimit':this[_0x3f616c(0x1c7)]}};try{await this[_0x3f616c(0x1a1)]();const _0x4e515f=a0_0x3c4abd['join'](this[_0x3f616c(0x18f)],'.health-check');await a0_0x7257bd['writeFile'](_0x4e515f,'test'),await a0_0x7257bd['unlink'](_0x4e515f);}catch(_0x4aec06){_0xff45b4[_0x3f616c(0x1b5)]=_0x3f616c(0x1bc),_0xff45b4['issues']['push']('File\x20system\x20access\x20issues');}this['pricingData']['size']===0x0&&(_0xff45b4['status']=_0x3f616c(0x1bc),_0xff45b4[_0x3f616c(0x1a5)][_0x3f616c(0x154)](_0x3f616c(0x181)));if(this['lastPricingUpdate']){const _0xc6bfde=(Date[_0x3f616c(0x164)]()-new Date(this['lastPricingUpdate'])['getTime']())/(0x3e8*0x3c*0x3c);_0xc6bfde>0x18&&_0xff45b4['issues']['push']('Pricing\x20data\x20is\x20stale\x20(>24\x20hours\x20old)');}if(this['budgetLimit']!==null){const _0x1d2580=this['_checkBudgetStatus']();_0x1d2580[_0x3f616c(0x19e)]!==_0x3f616c(0x17f)&&_0xff45b4[_0x3f616c(0x1a5)]['push']('Budget\x20'+_0x1d2580[_0x3f616c(0x19e)]+':\x20'+_0x1d2580[_0x3f616c(0x19d)]['toFixed'](0x1)+_0x3f616c(0x1c5));}return _0xff45b4[_0x3f616c(0x1a5)][_0x3f616c(0x15e)]>0x0&&_0xff45b4[_0x3f616c(0x1b5)]==='healthy'&&(_0xff45b4['status']=_0x3f616c(0x13a)),_0xff45b4;}async[a0_0x175033(0x17c)](){const _0x26918c=a0_0x175033;this['logger'][_0x26918c(0x16d)]('Shutting\x20down\x20budget\x20service');try{await this['saveUsageData'](),this['pricingData']['clear'](),this['logger']['info']('Budget\x20service\x20shut\x20down\x20successfully');}catch(_0x1114de){this[_0x26918c(0x176)]['error']('Error\x20during\x20budget\x20service\x20shutdown:',_0x1114de);throw _0x1114de;}}}