const a0_0x28a540=a0_0x1242;function a0_0x1242(_0x2ab0a5,_0x240e56){const _0x268799=a0_0x2687();return a0_0x1242=function(_0x1242b6,_0x2a048e){_0x1242b6=_0x1242b6-0x13b;let _0x38938c=_0x268799[_0x1242b6];if(a0_0x1242['SazzHI']===undefined){var _0x387d6f=function(_0x3a1b8e){const _0x649a16='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x191b45='',_0x348f5f='';for(let _0x31e048=0x0,_0xb36a3e,_0x3f4d2e,_0x103261=0x0;_0x3f4d2e=_0x3a1b8e['charAt'](_0x103261++);~_0x3f4d2e&&(_0xb36a3e=_0x31e048%0x4?_0xb36a3e*0x40+_0x3f4d2e:_0x3f4d2e,_0x31e048++%0x4)?_0x191b45+=String['fromCharCode'](0xff&_0xb36a3e>>(-0x2*_0x31e048&0x6)):0x0){_0x3f4d2e=_0x649a16['indexOf'](_0x3f4d2e);}for(let _0x4dd4da=0x0,_0x46103f=_0x191b45['length'];_0x4dd4da<_0x46103f;_0x4dd4da++){_0x348f5f+='%'+('00'+_0x191b45['charCodeAt'](_0x4dd4da)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x348f5f);};a0_0x1242['QUFCrA']=_0x387d6f,_0x2ab0a5=arguments,a0_0x1242['SazzHI']=!![];}const _0x53beef=_0x268799[0x0],_0x1031ee=_0x1242b6+_0x53beef,_0x4617c7=_0x2ab0a5[_0x1031ee];return!_0x4617c7?(_0x38938c=a0_0x1242['QUFCrA'](_0x38938c),_0x2ab0a5[_0x1031ee]=_0x38938c):_0x38938c=_0x4617c7,_0x38938c;},a0_0x1242(_0x2ab0a5,_0x240e56);}(function(_0x3875d7,_0x3de4cc){const _0x4ad1b1=a0_0x1242,_0x391501=_0x3875d7();while(!![]){try{const _0x24c870=parseInt(_0x4ad1b1(0x193))/0x1*(parseInt(_0x4ad1b1(0x146))/0x2)+parseInt(_0x4ad1b1(0x153))/0x3*(parseInt(_0x4ad1b1(0x1a5))/0x4)+parseInt(_0x4ad1b1(0x15e))/0x5*(-parseInt(_0x4ad1b1(0x144))/0x6)+parseInt(_0x4ad1b1(0x1df))/0x7+parseInt(_0x4ad1b1(0x1ac))/0x8*(-parseInt(_0x4ad1b1(0x186))/0x9)+-parseInt(_0x4ad1b1(0x173))/0xa+parseInt(_0x4ad1b1(0x18e))/0xb;if(_0x24c870===_0x3de4cc)break;else _0x391501['push'](_0x391501['shift']());}catch(_0x29a5b9){_0x391501['push'](_0x391501['shift']());}}}(a0_0x2687,0xdf5e3));import{promises as a0_0x3a1b8e}from'fs';function a0_0x2687(){const _0x320ab1=['cJ09psbcuKvbs0rpv04GqLKGu0vsvKLdrsa9pt0k','C2f2zvvZywDLrgf0yq','ANnVBG','x2LUAxrPywXPEMvvC2fNzurHDge','vvne','CgvYy2vUDgfNzvvZzwq','nZq2nJCWtMLiuujR','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','C3rHDhvZ','DxnHz2u','BwfW','BgfZDfbYAwnPBMDvCgrHDgu','y3vYCMvUy3K','rKLmrv9twvnuru1Frvjst1i','AgfYzeXPBwL0','ihjLCxvLC3rZkqO','x2XVywrcDwrNzxrmAw1PDa','nZq1v1ndzxHr','BM9YBwfS','rMLSzsbZExn0zw0GywnJzxnZigLZC3vLCW','C2vZC2LVBKLK','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','uMvZzxr0Aw5NihvZywDLigrHDge','Bwf4','t3bLCMf0Aw9UihDVDwXKihvZzsbZAwDUAwzPy2fUDcbWB3j0Aw9Uig9Migj1zgDLDc4Gq29UC2LKzxiGy29ZDcbVChrPBwL6yxrPB24U','vxnHz2uGCMvJB3jKzwqGC3vJy2vZC2z1BgX5','A2v5CW','Aw5MBW','BMfTzq','C2L6zq','CMvHzezPBgu','qNvKz2v0ia','CMvXDwvZDenVDw50','su5wquXjrf9trvjwsunf','Aw5JBhvKzxm','x2DLDevZDgLTyxrLzfbYAwnPBMC','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','uMvTB3zLzcbVBgqGC2vZC2LVBIbMAwXLoIa','mte4mdG0mdbxy3jmqKK','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','C3rYAw5N','C3rHCNrZv2L0Aa','x2vUC3vYzvvZywDLrgLYzwn0B3j5','ywXS','y3jPDgLJywW','tw9KzwXZihDPDgGGChjPy2LUzZOG','D2fYBG','qLver0vux0vyq0vfreve','x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','Dw5SAw5R','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG','yNvKz2v0','BxrPBwu','CMvTywLUAw5NqNvKz2v0','zgvNCMfKzwq','y2f0y2G','ChvZAa','oxPABuXuEG','zw50CMLLCW','ig9SzcbZzxnZAw9UigzPBgvZ','qNvKz2v0igXPBwL0oIaK','z2v0','BgvUz3rO','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','muSGDg9Rzw5Z','mtm2mJaXodLRDMrhteG','yNjLywTKB3DUqNLtzxj2AwnL','z2v0vgLTzq','su5wquXjrf9ut0TftLm','y29ZDa','mtaXA09tEvjf','DxnHz2uUANnVBG','Aw5WDxq','t3bLCMf0Aw9UihDVDwXKigv4y2vLzcbIDwrNzxqGBgLTAxqUienVBNnPzgvYigLUy3jLyxnPBMCGyNvKz2v0ig9YihvZAw5NigeGBgvZCYbLEhbLBNnPDMuGBw9KzwWU','C2vZC2LVBLn0yxj0','oIaK','AxnZDwvZ','B3v0Chv0','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','z2v0q29ZDevZDgLTyxrL','ChjPy2LUz0rHDge','yNvKz2v0tgLTAxq','cJ09psbcuKvbs0rpv04GqLKGtu9eruWGpt09cG','AgfPA3u','C3rHDa','su5wquXjrf9btu9vtLq','zxHWB3j0vxnHz2veyxrH','u2vYDMLJzsW','nefYwvzeCG','qNvKz2v0igfTB3vUDcbTDxn0igjLigeGCg9ZAxrPDMuGBNvTyMvY','C3rYAw5NAwz5','x2v4Cg9YDfrVq3n2','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','z2v0vxnHz2vszxbVCNq','qNvKz2v0ihnLCNzPy2uGAw5PDgLHBgL6zwq','ody2mZK0ng10B2TYwG','zw5KC1DPDgG','BgLTAxq','x3zHBgLKyxrLqNvKz2v0qw1VDw50','C2XPy2u','Dg9gAxHLza','vxnHz2u6ia','AM9PBG','BNvTyMvY','C2vYDMvY','uMvJB3jKAw5NihvZywDLigzVCIa','BgfZDfvWzgf0zwq','DgvZDa','lI8UBg94AweTyNvKz2v0','D3jPDgvgAwXL','rMLSzsbZExn0zw0GB3bLCMf0Aw9UigzHAwXLza','C29YDa','Dg90ywXtCgvUDa','Dw5PDa','Cgf0Aa','zMLSDgvY','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','zxn0Aw1HDgu','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','CMvJB3jKvxnHz2u','Dg90ywXjBNb1DfrVA2vUCW','yNvKz2v0u3rHDhvZ','z2v0qNvKz2v0vxnHz2u','ChjPy2LUz0LUzM8','y3n2','Bw9KzwXZv2L0AfbYAwnPBMC','sw52ywXPzcbTB2rLBcbUyw1LihbYB3zPzgvKigzVCIbWCMLJAw5NigXVB2T1Ca','rMfPBgvKihrVigXVywqGChjLDMLVDxmGDxnHz2uGzgf0ytO','t3bLCMf0Aw9UihDVDwXKihvZzsbTB3n0ig9MihLVDxiGyNvKz2v0lIbnB25PDg9YihvZywDLignHCMvMDwXSEs4','z2v0uhjPy2LUz0rHDge','rxjYB3iGAw5PDgLHBgL6Aw5NihvZywDLigrHDgeGzgLYzwn0B3j5oG','zgvIDwC','C2vYDMvYteXnu2vYDMLJzq','z2v0qwXSuhjPy2LUzW','B3v0Chv0vg9Rzw5Z','Dg9tDhjPBMC','tM8GC2vYDMvYieXmtsbZzxj2AwnLigf2ywLSywjSzsbMB3iGChjPy2LUzYb1CgrHDgvZ','z3b0ltq','t3bLCMf0Aw9UigLZihDPDgHPBIbIDwrNzxqGz3vPzgvSAw5LCY4','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','x2nHBgn1Bgf0zunVC3q','y29UzMLN','DxrMltG','yNjLywTKB3DUqNLnB2rLBa','D2fYBMLUz0XLDMvS','C2vYDMLJzvvZywDL','mteYmZu2mJnvzhnKAg4','Bg9Nz2vY','D2fYBMLUzW','AgvHBhrOEq','Bw9KzwXvC2fNzq','q2f0zwDVCNKSu2vYDMLJzs9nB2rLBcXdB3n0leLUChv0vg9Rzw5Zle91Dhb1DfrVA2vUCYXszxf1zxn0q291BNq','Dg90ywXdB3n0','zxjYB3i','pt09ifvtquDfifjfue9svca9pt0k','vg90ywWGB3v0Chv0ihrVA2vUCZOG','CgfYC2u','BwvZC2fNzq','Dg90ywXpDxrWDxruB2TLBNm','Dg9mB2nHBgvtDhjPBMC','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','vg9Rzw4Gy291BNrZig11C3qGyMuGBM9Ulw5Lz2f0AxzLig51BwjLCNm','y2HLy2TcDwrNzxrgB3jpCgvYyxrPB24','mZG2otrYC0DpBNG','DxnHz2veAxi','mJa3ndjRv3zbwuS','uhjPy2LUzYbPBMzVCM1HDgLVBIb1BMf2ywLSywjSzq','vxbKyxrLzcbWCMLJAw5NigzVCIa','Aw5WDxruB2TLBNm','BgfZDfnHDMvKq29ZDa','q2XLyw5Lzcb1Cca','Dg9ju09tDhjPBMC'];a0_0x2687=function(){return _0x320ab1;};return a0_0x2687();}import a0_0x649a16 from'path';const DEFAULT_USAGE_DIR=a0_0x28a540(0x1b9),USAGE_FILENAME=a0_0x28a540(0x194),SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':a0_0x28a540(0x1a6),'INVALID_TOKENS':a0_0x28a540(0x142),'INVALID_SERVICE':a0_0x28a540(0x1d8),'BUDGET_EXCEEDED':'Budget\x20limit\x20exceeded','PRICING_UNAVAILABLE':a0_0x28a540(0x147),'FILE_SYSTEM_ERROR':a0_0x28a540(0x1bb)};export class BudgetService{constructor(_0x191b45,_0x348f5f,_0x31e048=null){const _0x516574=a0_0x28a540;this['config']=_0x191b45,this[_0x516574(0x1e0)]=_0x348f5f,this['serverLLMService']=_0x31e048,this[_0x516574(0x156)]=this[_0x516574(0x150)](),this['budgetLimit']=this[_0x516574(0x15d)](),this[_0x516574(0x15b)]=_0x191b45['budget']?.[_0x516574(0x15b)]||![],this[_0x516574(0x19d)]=new Map(),this['lastPricingUpdate']=null,this['pricingUpdateInProgress']=![],this[_0x516574(0x145)]=_0x191b45['budget']?.[_0x516574(0x145)]||DEFAULT_USAGE_DIR,this['logger']['info'](_0x516574(0x1ab),{'budgetLimit':this[_0x516574(0x19e)],'hardLimit':this['hardLimit'],'usageDir':this[_0x516574(0x145)],'hasPricingService':!!this[_0x516574(0x1d1)]}),this['_loadUsageData']()[_0x516574(0x184)](_0xb36a3e=>{const _0x13ca63=_0x516574;this[_0x13ca63(0x1e0)]['warn'](_0x13ca63(0x1cc),_0xb36a3e);});}['_initializeUsageData'](){const _0x20b165=a0_0x28a540;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()[_0x20b165(0x14c)](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()[_0x20b165(0x14c)]()};}['_generateSessionId'](){const _0x5e10ea=a0_0x28a540,_0x3f4d2e=Date['now']()['toString'](0x24),_0x103261=Math['random']()[_0x5e10ea(0x1d4)](0x24)['slice'](0x2);return _0x3f4d2e+'_'+_0x103261;}[a0_0x28a540(0x15d)](){const _0x8c84d8=a0_0x28a540,_0x4dd4da=this['config']['budget']?.[_0x8c84d8(0x1ae)];if(_0x4dd4da!==undefined&&_0x4dd4da!==null)return this[_0x8c84d8(0x1af)](_0x4dd4da);return null;}async[a0_0x28a540(0x171)](){const _0x1d903f=a0_0x28a540;if(!this['serverLLMService'])return this['logger']['debug'](_0x1d903f(0x1d5)),![];if(this[_0x1d903f(0x141)])return this['logger'][_0x1d903f(0x1d0)]('Pricing\x20update\x20already\x20in\x20progress'),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this[_0x1d903f(0x1e0)]['info']('Updating pricing data from server');const _0x46103f=await this[_0x1d903f(0x1d1)]['getPricingData']();if(_0x46103f['size']===0x0)return this['logger']['warn']('No pricing data received from server'),![];this['pricingData']['clear']();for(const [_0xf40ea4,_0x3a344a]of _0x46103f['entries']()){this['pricingData']['set'](_0xf40ea4,{'input':_0x3a344a['input'],'output':_0x3a344a[_0x1d903f(0x19a)],'unit':_0x3a344a[_0x1d903f(0x1be)]||'1K\x20tokens','currency':_0x3a344a[_0x1d903f(0x159)]||_0x1d903f(0x151)});}return this[_0x1d903f(0x158)]=new Date()['toISOString'](),this[_0x1d903f(0x1e0)]['info'](_0x1d903f(0x148)+this['pricingData'][_0x1d903f(0x16a)]+'\x20models\x20from\x20server'),!![];}catch(_0x58d5db){return this[_0x1d903f(0x1e0)][_0x1d903f(0x1e6)]('Failed to update pricing from server:',_0x58d5db),![];}finally{this['pricingUpdateInProgress']=![];}}['_shouldUpdatePricing'](){const _0x4d35b6=a0_0x28a540;if(!this[_0x4d35b6(0x158)])return!![];const _0x56522c=Date['now']()-new Date(this[_0x4d35b6(0x158)])[_0x4d35b6(0x190)]();return _0x56522c>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0xb0b4c5){const _0x2a4f64=a0_0x28a540;if(!_0xb0b4c5||typeof _0xb0b4c5!==_0x2a4f64(0x175))return this[_0x2a4f64(0x1e0)]['warn'](_0x2a4f64(0x1cb)),null;return this[_0x2a4f64(0x19d)][_0x2a4f64(0x18a)](_0xb0b4c5)||null;}[a0_0x28a540(0x1d2)](){const _0x545b96=a0_0x28a540;return this[_0x545b96(0x1d1)][_0x545b96(0x1ce)]();}async[a0_0x28a540(0x1c4)](_0x3334dc,_0x3af4a9,_0x468344,_0x23a46e){const _0x313dba=a0_0x28a540;this['logger'][_0x313dba(0x168)](_0x313dba(0x1b6)+_0x3334dc+'/'+_0x3af4a9,{'inputTokens':_0x468344,'outputTokens':_0x23a46e,'service':_0x3334dc,'model':_0x3af4a9}),this[_0x313dba(0x162)](_0x3334dc,_0x3af4a9,_0x468344,_0x23a46e),await this['updatePricingFromServer']();const _0x127b73=this[_0x313dba(0x1d9)](_0x3af4a9,_0x468344,_0x23a46e);!_0x127b73['success']&&this['logger'][_0x313dba(0x17b)]('Pricing\x20unavailable\x20for\x20model\x20'+_0x3af4a9+',\x20using\x20estimate');this['_updateUsageData'](_0x3334dc,_0x3af4a9,_0x468344,_0x23a46e,_0x127b73['totalCost']);const _0x59a6f4=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x238632={'service':_0x3334dc,'model':_0x3af4a9,'inputTokens':_0x468344,'outputTokens':_0x23a46e,'cost':_0x127b73,'budgetStatus':_0x59a6f4,'timestamp':new Date()[_0x313dba(0x14c)]()};return this['logger'][_0x313dba(0x1d0)](_0x313dba(0x166),_0x238632),_0x238632;}['_validateUsageInputs'](_0x5166ec,_0x5bab10,_0x28e6e2,_0x4d4112){const _0x25cae4=a0_0x28a540;if(!_0x5166ec||typeof _0x5166ec!==_0x25cae4(0x175))throw new Error(ERROR_MESSAGES[_0x25cae4(0x16e)]);if(!_0x5bab10||typeof _0x5bab10!==_0x25cae4(0x175))throw new Error('Model\x20name\x20must\x20be\x20a\x20non-empty\x20string');if(typeof _0x28e6e2!=='number'||_0x28e6e2<0x0)throw new Error(ERROR_MESSAGES[_0x25cae4(0x191)]);if(typeof _0x4d4112!==_0x25cae4(0x1b4)||_0x4d4112<0x0)throw new Error(ERROR_MESSAGES[_0x25cae4(0x191)]);}[a0_0x28a540(0x1d9)](_0x4940eb,_0x109e5e,_0x5433e3){const _0x10a170=a0_0x28a540,_0x3883f1=this['getModelPricing'](_0x4940eb);if(!_0x3883f1){const _0x359c07=this[_0x10a170(0x170)](_0x4940eb),_0x48a40a=_0x109e5e/0x3e8*_0x359c07[_0x10a170(0x195)],_0x1771ef=_0x5433e3/0x3e8*_0x359c07[_0x10a170(0x19a)];return{'success':![],'inputCost':_0x48a40a,'outputCost':_0x1771ef,'totalCost':_0x48a40a+_0x1771ef,'currency':_0x10a170(0x151),'unit':_0x10a170(0x18d),'estimated':!![],'reason':'Pricing\x20data\x20unavailable\x20for\x20model'};}const _0x2b558b=_0x109e5e/0x3e8*_0x3883f1[_0x10a170(0x195)],_0x319348=_0x5433e3/0x3e8*_0x3883f1[_0x10a170(0x19a)];return{'success':!![],'inputCost':_0x2b558b,'outputCost':_0x319348,'totalCost':_0x2b558b+_0x319348,'currency':_0x3883f1['currency'],'unit':_0x3883f1['unit'],'estimated':![]};}['_getEstimatedPricing'](_0x4fd276){const _0x40fb9e=a0_0x28a540,_0x76cf0c=_0x4fd276['toLowerCase']();if(_0x76cf0c[_0x40fb9e(0x16f)]('opus')||_0x76cf0c['includes'](_0x40fb9e(0x1d6)))return{'input':0.015,'output':0.075};else{if(_0x76cf0c['includes']('sonnet')||_0x76cf0c[_0x40fb9e(0x16f)]('gpt-3.5'))return{'input':0.003,'output':0.015};else{if(_0x76cf0c['includes'](_0x40fb9e(0x1a0))||_0x76cf0c['includes']('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}['_updateUsageData'](_0x1026c3,_0x130f3f,_0x5ac19c,_0x1f1961,_0x40749b){const _0x4a6158=a0_0x28a540;this[_0x4a6158(0x156)][_0x4a6158(0x1c5)]+=_0x5ac19c,this[_0x4a6158(0x156)]['totalOutputTokens']+=_0x1f1961,this['usage'][_0x4a6158(0x1e5)]+=_0x40749b,this['usage']['lastUpdated']=new Date()[_0x4a6158(0x14c)](),!this[_0x4a6158(0x156)]['serviceUsage'][_0x1026c3]&&(this[_0x4a6158(0x156)][_0x4a6158(0x1de)][_0x1026c3]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage']['serviceUsage'][_0x1026c3][_0x4a6158(0x149)]+=_0x5ac19c,this['usage']['serviceUsage'][_0x1026c3][_0x4a6158(0x1d3)]+=_0x1f1961,this['usage']['serviceUsage'][_0x1026c3][_0x4a6158(0x192)]+=_0x40749b,this[_0x4a6158(0x156)][_0x4a6158(0x1de)][_0x1026c3][_0x4a6158(0x16d)]+=0x1,!this['usage'][_0x4a6158(0x1e3)][_0x130f3f]&&(this['usage'][_0x4a6158(0x1e3)][_0x130f3f]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x4a6158(0x156)]['modelUsage'][_0x130f3f]['inputTokens']+=_0x5ac19c,this[_0x4a6158(0x156)][_0x4a6158(0x1e3)][_0x130f3f][_0x4a6158(0x1d3)]+=_0x1f1961,this[_0x4a6158(0x156)]['modelUsage'][_0x130f3f][_0x4a6158(0x192)]+=_0x40749b,this[_0x4a6158(0x156)]['modelUsage'][_0x130f3f]['requestCount']+=0x1;}['_checkBudgetStatus'](){const _0x218434=a0_0x28a540,_0x57472f={'withinBudget':!![],'budgetLimit':this['budgetLimit'],'totalSpent':this[_0x218434(0x156)]['totalCost'],'remainingBudget':null,'percentageUsed':null,'warningLevel':'normal'};if(this[_0x218434(0x19e)]!==null){_0x57472f['remainingBudget']=Math['max'](0x0,this[_0x218434(0x19e)]-this['usage']['totalCost']),_0x57472f['percentageUsed']=this[_0x218434(0x156)][_0x218434(0x1e5)]/this['budgetLimit']*0x64,_0x57472f['withinBudget']=this[_0x218434(0x156)]['totalCost']<=this[_0x218434(0x19e)];if(_0x57472f['percentageUsed']>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x57472f['warningLevel']=_0x218434(0x179);else _0x57472f[_0x218434(0x152)]>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x57472f[_0x218434(0x1dd)]=_0x218434(0x1e1));_0x57472f[_0x218434(0x1dd)]!==_0x218434(0x15f)&&this[_0x218434(0x1e0)]['warn'](_0x218434(0x16c)+_0x57472f['warningLevel']+':\x20'+_0x57472f[_0x218434(0x152)][_0x218434(0x1b1)](0x1)+'%\x20used',{'totalSpent':this[_0x218434(0x156)]['totalCost'],'budgetLimit':this[_0x218434(0x19e)],'remainingBudget':_0x57472f[_0x218434(0x182)]});if(!_0x57472f['withinBudget']&&this[_0x218434(0x15b)]){const _0x249bb9=new Error(ERROR_MESSAGES[_0x218434(0x17c)]+':\x20$'+this[_0x218434(0x156)][_0x218434(0x1e5)]['toFixed'](0x2)+'\x20exceeds\x20limit\x20of\x20$'+this[_0x218434(0x19e)][_0x218434(0x1b1)](0x2));_0x249bb9['code']='BUDGET_EXCEEDED',_0x249bb9[_0x218434(0x1c6)]=_0x57472f;throw _0x249bb9;}}return _0x57472f;}async['setBudgetLimit'](_0x25dc17){const _0x2d11be=a0_0x28a540,_0x17752c=this['_validateBudgetAmount'](_0x25dc17);this['budgetLimit']=_0x17752c,this[_0x2d11be(0x1da)][_0x2d11be(0x180)]=this['config'][_0x2d11be(0x180)]||{},this[_0x2d11be(0x1da)][_0x2d11be(0x180)]['limit']=_0x17752c,this[_0x2d11be(0x1e0)][_0x2d11be(0x168)]('Budget\x20limit\x20set\x20to\x20$'+_0x17752c[_0x2d11be(0x1b1)](0x2),{'previousLimit':this[_0x2d11be(0x19e)],'newLimit':_0x17752c}),await this['saveUsageData']();}[a0_0x28a540(0x1af)](_0x4c6d26){const _0x3b1f5d=a0_0x28a540;if(typeof _0x4c6d26!=='number'||_0x4c6d26<0x0||!isFinite(_0x4c6d26))throw new Error(ERROR_MESSAGES[_0x3b1f5d(0x1a2)]);return _0x4c6d26;}async['getBudgetUsage'](){const _0x5a5ee9=a0_0x28a540;await this['updatePricingFromServer']();const _0x4c2eee={'totalSpent':this['usage']['totalCost'],'budgetLimit':this['budgetLimit'],'inputTokens':this['usage']['totalInputTokens'],'outputTokens':this['usage'][_0x5a5ee9(0x13f)],'remainingBudget':this[_0x5a5ee9(0x19e)]!==null?Math['max'](0x0,this['budgetLimit']-this['usage']['totalCost']):null,'percentageUsed':this[_0x5a5ee9(0x19e)]!==null?this['usage'][_0x5a5ee9(0x1e5)]/this[_0x5a5ee9(0x19e)]*0x64:null,'sessionStart':this['usage'][_0x5a5ee9(0x197)],'lastUpdated':this[_0x5a5ee9(0x156)][_0x5a5ee9(0x1b7)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this[_0x5a5ee9(0x158)],'modelsWithPricing':this['pricingData'][_0x5a5ee9(0x16a)],'source':this[_0x5a5ee9(0x1d1)]?_0x5a5ee9(0x1b5):'fallback'}};for(const [_0x23ed13,_0x2ac157]of Object['entries'](this['usage']['serviceUsage'])){_0x4c2eee[_0x5a5ee9(0x18f)][_0x23ed13]={'cost':_0x2ac157['cost'],'inputTokens':_0x2ac157['inputTokens'],'outputTokens':_0x2ac157[_0x5a5ee9(0x1d3)],'requestCount':_0x2ac157['requestCount']};}for(const [_0x550a6c,_0x54b12d]of Object['entries'](this['usage'][_0x5a5ee9(0x1e3)])){_0x4c2eee[_0x5a5ee9(0x1dc)][_0x550a6c]={'cost':_0x54b12d[_0x5a5ee9(0x192)],'inputTokens':_0x54b12d[_0x5a5ee9(0x149)],'outputTokens':_0x54b12d['outputTokens'],'requestCount':_0x54b12d['requestCount']};}return _0x4c2eee;}async[a0_0x28a540(0x1aa)](){const _0x5b8d2a=a0_0x28a540,_0x3e831d=await this[_0x5b8d2a(0x1c7)]();let _0x5a47f4=_0x5b8d2a(0x13b);_0x5a47f4+='Total\x20cost:\x20$'+_0x3e831d[_0x5b8d2a(0x1bd)]['toFixed'](0x4)+'\x0a',_0x5a47f4+='Total\x20input\x20tokens:\x20'+_0x3e831d['inputTokens'][_0x5b8d2a(0x140)]()+'\x0a',_0x5a47f4+=_0x5b8d2a(0x13c)+_0x3e831d[_0x5b8d2a(0x1d3)][_0x5b8d2a(0x140)]()+'\x0a';_0x3e831d['budgetLimit']!==null&&(_0x5a47f4+=_0x5b8d2a(0x189)+_0x3e831d['budgetLimit']['toFixed'](0x2)+'\x0a',_0x5a47f4+='Remaining:\x20$'+_0x3e831d[_0x5b8d2a(0x182)]['toFixed'](0x4)+'\x0a',_0x5a47f4+=_0x5b8d2a(0x1b2)+_0x3e831d[_0x5b8d2a(0x152)][_0x5b8d2a(0x1b1)](0x1)+'%\x0a');_0x5a47f4+='\x0aPricing\x20source:\x20'+_0x3e831d['pricingInfo']['source']+'\x0a',_0x5a47f4+=_0x5b8d2a(0x17a)+_0x3e831d[_0x5b8d2a(0x1c8)][_0x5b8d2a(0x1ca)]+'\x0a';if(Object[_0x5b8d2a(0x167)](_0x3e831d[_0x5b8d2a(0x18f)])[_0x5b8d2a(0x18b)]>0x0){_0x5a47f4+=_0x5b8d2a(0x14d);for(const [_0x326930,_0x49c151]of Object['entries'](_0x3e831d['breakdownByService'])){_0x5a47f4+=_0x326930+_0x5b8d2a(0x198)+_0x49c151['cost'][_0x5b8d2a(0x1b1)](0x4)+'\x20('+_0x49c151['requestCount']+'\x20requests)\x0a';}}if(Object[_0x5b8d2a(0x167)](_0x3e831d[_0x5b8d2a(0x1dc)])[_0x5b8d2a(0x18b)]>0x0){_0x5a47f4+=_0x5b8d2a(0x19f);for(const [_0x165940,_0x342696]of Object[_0x5b8d2a(0x187)](_0x3e831d['breakdownByModel'])){_0x5a47f4+=_0x165940+_0x5b8d2a(0x198)+_0x342696['cost']['toFixed'](0x4)+'\x20('+_0x342696[_0x5b8d2a(0x16d)]+_0x5b8d2a(0x15c);}}return _0x5a47f4;}async[a0_0x28a540(0x154)](){const _0x1248cc=a0_0x28a540,_0x48baaf=0.1,_0x3c643b=this['usage']['lastSavedCost']||0x0;this[_0x1248cc(0x156)][_0x1248cc(0x1e5)]-_0x3c643b>=_0x48baaf&&(await this[_0x1248cc(0x14e)](),this['usage'][_0x1248cc(0x14a)]=this[_0x1248cc(0x156)][_0x1248cc(0x1e5)]);}async['_loadUsageData'](){const _0x423fa2=a0_0x28a540;try{await this[_0x423fa2(0x177)]();const _0x4b29f9=a0_0x649a16[_0x423fa2(0x1b3)](this[_0x423fa2(0x145)],USAGE_FILENAME);try{const _0x44b88b=await a0_0x3a1b8e[_0x423fa2(0x16b)](_0x4b29f9,_0x423fa2(0x1db)),_0x14d37e=JSON[_0x423fa2(0x13d)](_0x44b88b);this[_0x423fa2(0x156)]['totalInputTokens']=_0x14d37e[_0x423fa2(0x1c5)]||0x0,this[_0x423fa2(0x156)][_0x423fa2(0x13f)]=_0x14d37e[_0x423fa2(0x13f)]||0x0,this[_0x423fa2(0x156)][_0x423fa2(0x1e5)]=_0x14d37e[_0x423fa2(0x1e5)]||0x0,this['usage']['serviceUsage']=_0x14d37e[_0x423fa2(0x1de)]||{},this['usage']['modelUsage']=_0x14d37e[_0x423fa2(0x1e3)]||{},this[_0x423fa2(0x1e0)]['info']('Loaded\x20previous\x20usage\x20data',{'totalCost':this[_0x423fa2(0x156)]['totalCost'],'totalTokens':this['usage'][_0x423fa2(0x1c5)]+this[_0x423fa2(0x156)]['totalOutputTokens']});}catch(_0x3f455e){_0x3f455e['code']!=='ENOENT'&&this['logger']['warn']('Failed\x20to\x20load\x20usage\x20data:',_0x3f455e);}}catch(_0x5d5030){this[_0x423fa2(0x1e0)]['warn'](_0x423fa2(0x1cf),_0x5d5030);}}async['_ensureUsageDirectory'](){const _0x30ad73=a0_0x28a540;try{await a0_0x3a1b8e['mkdir'](this[_0x30ad73(0x145)],{'recursive':!![]});}catch(_0x3fe428){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x3fe428['message']);}}async['saveUsageData'](){const _0x3306cd=a0_0x28a540;try{await this[_0x3306cd(0x177)](),this['usage']['sessionEnd']=new Date()['toISOString']();const _0x1fff3f=a0_0x649a16[_0x3306cd(0x1b3)](this['usageDir'],USAGE_FILENAME);await a0_0x3a1b8e['writeFile'](_0x1fff3f,JSON[_0x3306cd(0x1a7)](this['usage'],null,0x2),'utf-8');const _0xa8fd94=a0_0x649a16['join'](this[_0x3306cd(0x145)],''+SESSION_PREFIX+this['usage']['sessionId']+'.json');await a0_0x3a1b8e['writeFile'](_0xa8fd94,JSON[_0x3306cd(0x1a7)](this['usage'],null,0x2),_0x3306cd(0x1db)),await this[_0x3306cd(0x17d)](),this['logger']['info'](_0x3306cd(0x174),{'totalCost':this[_0x3306cd(0x156)]['totalCost'],'sessionId':this[_0x3306cd(0x156)][_0x3306cd(0x161)]});}catch(_0x16205a){this['logger'][_0x3306cd(0x1e6)]('Failed\x20to\x20save\x20usage\x20data:',_0x16205a);throw new Error(ERROR_MESSAGES[_0x3306cd(0x15a)]+':\x20'+_0x16205a[_0x3306cd(0x13e)]);}}async['_cleanupOldSessionFiles'](){const _0x2a49f0=a0_0x28a540;try{const _0x5ed126=await a0_0x3a1b8e['readdir'](this[_0x2a49f0(0x145)]),_0x4d7026=_0x5ed126['filter'](_0x32314f=>_0x32314f[_0x2a49f0(0x176)](SESSION_PREFIX)&&_0x32314f[_0x2a49f0(0x1ad)]('.json'))['map'](_0x2e9bf4=>({'name':_0x2e9bf4,'path':a0_0x649a16['join'](this[_0x2a49f0(0x145)],_0x2e9bf4)}));if(_0x4d7026['length']<=MAX_SESSION_FILES)return;const _0x30b6f2=await Promise[_0x2a49f0(0x178)](_0x4d7026[_0x2a49f0(0x157)](async _0x2b92f3=>{const _0x131010=_0x2a49f0;try{const _0x2de646=await a0_0x3a1b8e[_0x131010(0x1a1)](_0x2b92f3[_0x131010(0x1bf)]);return{..._0x2b92f3,'mtime':_0x2de646['mtime']};}catch(_0x19d813){return null;}})),_0xed87f5=_0x30b6f2[_0x2a49f0(0x1c0)](_0x2b1713=>_0x2b1713!==null)[_0x2a49f0(0x1bc)]((_0x51b1fc,_0x345c74)=>_0x345c74[_0x2a49f0(0x181)]-_0x51b1fc[_0x2a49f0(0x181)]),_0x29cc8e=_0xed87f5[_0x2a49f0(0x1b0)](MAX_SESSION_FILES);for(const _0x3c4b68 of _0x29cc8e){try{await a0_0x3a1b8e[_0x2a49f0(0x17e)](_0x3c4b68['path']),this['logger'][_0x2a49f0(0x1d0)](_0x2a49f0(0x172)+_0x3c4b68[_0x2a49f0(0x169)]);}catch(_0x3928fe){this[_0x2a49f0(0x1e0)]['warn'](_0x2a49f0(0x1c3)+_0x3c4b68['name']+':',_0x3928fe);}}_0x29cc8e['length']>0x0&&this[_0x2a49f0(0x1e0)][_0x2a49f0(0x168)](_0x2a49f0(0x14b)+_0x29cc8e[_0x2a49f0(0x18b)]+_0x2a49f0(0x188));}catch(_0x34d119){this[_0x2a49f0(0x1e0)][_0x2a49f0(0x17b)]('Failed\x20to\x20cleanup\x20old\x20session\x20files:',_0x34d119);}}async['resetUsageData'](_0x1520b6=![]){const _0x46e44e=a0_0x28a540;this['logger'][_0x46e44e(0x168)](_0x46e44e(0x163),{'preserveTotal':_0x1520b6});if(!_0x1520b6)this[_0x46e44e(0x156)]=this['_initializeUsageData']();else{const _0x311086=this[_0x46e44e(0x156)]['totalCost'],_0x483bc8=this[_0x46e44e(0x156)]['totalInputTokens'],_0x32572e=this['usage']['totalOutputTokens'];this['usage']=this[_0x46e44e(0x150)](),this['usage']['totalCost']=_0x311086,this[_0x46e44e(0x156)][_0x46e44e(0x1c5)]=_0x483bc8,this[_0x46e44e(0x156)][_0x46e44e(0x13f)]=_0x32572e;}await this[_0x46e44e(0x14e)]();}async[a0_0x28a540(0x1a3)](_0x30d2ff=a0_0x28a540(0x14f)){const _0x52c859=a0_0x28a540,_0xb1a7a0=await this['getBudgetUsage']();if(_0x30d2ff===_0x52c859(0x1c9))return this[_0x52c859(0x1a8)](_0xb1a7a0);return JSON[_0x52c859(0x1a7)](_0xb1a7a0,null,0x2);}[a0_0x28a540(0x1a8)](_0x18fbd2){const _0x1a263f=a0_0x28a540,_0x431db2=[_0x1a263f(0x1e4)];for(const [_0x3fc96a,_0x4f5db5]of Object['entries'](_0x18fbd2[_0x1a263f(0x18f)])){_0x431db2['push'](_0x1a263f(0x1a4)+_0x3fc96a+','+_0x4f5db5['cost']+','+_0x4f5db5['inputTokens']+','+_0x4f5db5[_0x1a263f(0x1d3)]+','+_0x4f5db5[_0x1a263f(0x16d)]);}for(const [_0x464b6b,_0x3fbfe5]of Object['entries'](_0x18fbd2['breakdownByModel'])){_0x431db2[_0x1a263f(0x185)]('Model,'+_0x464b6b+','+_0x3fbfe5['cost']+','+_0x3fbfe5['inputTokens']+','+_0x3fbfe5[_0x1a263f(0x1d3)]+','+_0x3fbfe5['requestCount']);}return _0x431db2[_0x1a263f(0x1b3)]('\x0a');}[a0_0x28a540(0x19c)](_0x1218bb,_0x595343,_0x2578f1){const _0x327cd6=a0_0x28a540;this['_validateUsageInputs'](_0x327cd6(0x1c2),_0x1218bb,_0x595343,_0x2578f1);const _0x1aa4b8=this[_0x327cd6(0x1d9)](_0x1218bb,_0x595343,_0x2578f1),_0x7d7d75={'model':_0x1218bb,'estimatedInputTokens':_0x595343,'estimatedOutputTokens':_0x2578f1,'estimatedCost':_0x1aa4b8['totalCost'],..._0x1aa4b8,'budgetImpact':null};if(this[_0x327cd6(0x19e)]!==null){const _0x1db5db=this[_0x327cd6(0x156)]['totalCost']+_0x1aa4b8['totalCost'];_0x7d7d75['budgetImpact']={'currentSpent':this[_0x327cd6(0x156)]['totalCost'],'afterOperation':_0x1db5db,'remainingAfter':Math[_0x327cd6(0x164)](0x0,this[_0x327cd6(0x19e)]-_0x1db5db),'wouldExceedBudget':_0x1db5db>this[_0x327cd6(0x19e)],'percentageAfter':_0x1db5db/this['budgetLimit']*0x64};}return _0x7d7d75;}[a0_0x28a540(0x143)](_0x5a85e7,_0x21291a,_0x46ebb8){const _0x1f3edd=a0_0x28a540,_0x32ff7a=this[_0x1f3edd(0x19c)](_0x5a85e7,_0x21291a,_0x46ebb8);return{'canProceed':this[_0x1f3edd(0x19e)]===null||!_0x32ff7a['budgetImpact']?.['wouldExceedBudget'],'estimate':_0x32ff7a,'recommendation':this['_getBudgetRecommendation'](_0x32ff7a)};}[a0_0x28a540(0x1c1)](_0x311b16){const _0xce788b=a0_0x28a540;if(this[_0xce788b(0x19e)]===null)return _0xce788b(0x17f);if(!_0x311b16['budgetImpact'])return'Proceed\x20with\x20operation.';const {percentageAfter:_0x4d12dc,wouldExceedBudget:_0x5e93bb}=_0x311b16['budgetImpact'];if(_0x5e93bb)return _0xce788b(0x196);if(_0x4d12dc>BUDGET_CRITICAL_THRESHOLD*0x64)return _0xce788b(0x1cd);if(_0x4d12dc>BUDGET_WARNING_THRESHOLD*0x64)return _0xce788b(0x165);return _0xce788b(0x1d7);}['getPricingInfo'](){const _0x186f37=a0_0x28a540,_0x2c0792=Array['from'](this[_0x186f37(0x19d)]['entries']())[_0x186f37(0x157)](([_0x836ec6,_0x3fc51b])=>({'model':_0x836ec6,'inputPrice':_0x3fc51b['input'],'outputPrice':_0x3fc51b['output'],'unit':_0x3fc51b['unit'],'currency':_0x3fc51b['currency']}));return{'models':_0x2c0792,'lastUpdate':this['lastPricingUpdate'],'source':this['serverLLMService']?_0x186f37(0x1b5):'fallback','totalModels':this[_0x186f37(0x19d)]['size']};}async['healthCheck'](){const _0x49e771=a0_0x28a540,_0x525ab8={'status':_0x49e771(0x1e2),'issues':[],'metrics':{'totalCost':this[_0x49e771(0x156)]['totalCost'],'totalTokens':this['usage']['totalInputTokens']+this[_0x49e771(0x156)][_0x49e771(0x13f)],'modelsWithPricing':this[_0x49e771(0x19d)]['size'],'budgetLimit':this[_0x49e771(0x19e)]}};try{await this['_ensureUsageDirectory']();const _0x542a2e=a0_0x649a16['join'](this['usageDir'],'.health-check');await a0_0x3a1b8e[_0x49e771(0x1ba)](_0x542a2e,_0x49e771(0x1b8)),await a0_0x3a1b8e['unlink'](_0x542a2e);}catch(_0x2c9879){_0x525ab8[_0x49e771(0x155)]='degraded',_0x525ab8['issues']['push'](_0x49e771(0x160));}this[_0x49e771(0x19d)]['size']===0x0&&(_0x525ab8['status']=_0x49e771(0x183),_0x525ab8[_0x49e771(0x199)]['push']('No\x20pricing\x20data\x20available'));if(this['lastPricingUpdate']){const _0x4dc2aa=(Date['now']()-new Date(this[_0x49e771(0x158)])[_0x49e771(0x190)]())/(0x3e8*0x3c*0x3c);_0x4dc2aa>0x18&&_0x525ab8[_0x49e771(0x199)]['push'](_0x49e771(0x1a9));}if(this[_0x49e771(0x19e)]!==null){const _0x1ba721=this['_checkBudgetStatus']();_0x1ba721[_0x49e771(0x1dd)]!=='normal'&&_0x525ab8[_0x49e771(0x199)][_0x49e771(0x185)]('Budget\x20'+_0x1ba721['warningLevel']+':\x20'+_0x1ba721['percentageUsed']['toFixed'](0x1)+'%\x20used');}return _0x525ab8['issues']['length']>0x0&&_0x525ab8['status']===_0x49e771(0x1e2)&&(_0x525ab8['status']='warning'),_0x525ab8;}async['shutdown'](){const _0x5bad3b=a0_0x28a540;this['logger']['info']('Shutting\x20down\x20budget\x20service');try{await this[_0x5bad3b(0x14e)](),this[_0x5bad3b(0x19d)]['clear'](),this[_0x5bad3b(0x1e0)][_0x5bad3b(0x168)](_0x5bad3b(0x18c));}catch(_0x37fc91){this[_0x5bad3b(0x1e0)][_0x5bad3b(0x1e6)](_0x5bad3b(0x19b),_0x37fc91);throw _0x37fc91;}}}