function a0_0x1475(){const _0x55d5b1=['AgfYzeXPBwL0','x2nHBgn1Bgf0zunVC3q','ChjPy2LUz0rHDge','ru5pru5u','ihjLCxvLC3rZkqO','Dw5SAw5R','ChvZAa','D2fYBMLUzW','su5wquXjrf9btu9vtLq','Dg9gAxHLza','Aw5JBhvKzxm','C2vZC2LVBLn0yxj0','su5wquXjrf9trvjwsunf','yNvKz2v0','C3vJy2vZCW','tw9KzwXZihDPDgGGChjPy2LUzZOG','z2v0qNvKz2v0vxnHz2u','z3b0ltmUnq','ywXS','C2L6zq','BgfZDfvWzgf0zwq','C3rYAw5NAwz5','BxrPBwu','x2LUAxrPywXPEMvvC2fNzurHDge','C2v0','Dg90ywXjBNb1DfrVA2vUCW','mtboC3b6AxO','mZe0nZa5mgHIsMLVwa','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','CMvZzxrvC2fNzurHDge','qNvKz2v0igXPBwL0ihnLDcb0BYaK','lMPZB24','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','mJeWs0nnzwjX','Dg90ywXdB3n0','tw9KzwWGBMfTzsbTDxn0igjLigeGBM9UlwvTChr5ihn0CMLUzW','mJi3mtKYv1j1DMPN','D2fYBMLUz0XLDMvS','qNvKz2v0ia','x3zHBgLKyxrLqNvKz2v0qw1VDw50','vg90ywWGy29ZDdOGja','t3bLCMf0Aw9UihDVDwXKihvZzsbZAwDUAwzPy2fUDcbWB3j0Aw9Uig9Migj1zgDLDc4Gq29UC2LKzxiGy29ZDcbVChrPBwL6yxrPB24U','A2v5CW','mtuYnJqYotnbzfvvtNm','Dw5PDa','mJuWnJjTzM5Rvvy','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','C3rHCNrZv2L0Aa','y3jPDgLJywW','t3bLCMf0Aw9UigLZihDPDgHPBIbIDwrNzxqGz3vPzgvSAw5LCY4','Aw5WDxq','C291CMnL','rMLSzsbZExn0zw0GywnJzxnZigLZC3vLCW','C3rHDhvZ','C2vYDMLJzvvZywDL','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','uhjPy2LUzYbKyxrHihvUyxzHAwXHyMXLigzVCIbTB2rLBa','lcb1C2LUzYbLC3rPBwf0zq','mZqZndC4mg5xA3fiuW','rKLmrv9twvnuru1Frvjst1i','odfmAfvwuwG','igv4y2vLzhmGBgLTAxqGB2yGja','D291BgrfEgnLzwrcDwrNzxq','mZa1otyWoePeEe5ZDq','Aw5MBW','Aw5WDxruB2TLBNm','C2XPy2u','C2v0qNvKz2v0tgLTAxq','muSGDg9Rzw5Z','CMvXDwvZDenVDw50','BgvUz3rO','x2v4Cg9YDfrVq3n2','uhjPy2LUzYb1CgrHDguGywXYzwfKEsbPBIbWCM9NCMvZCW','AM9PBG','m1Hvs2XkuG','Dg90ywXpDxrWDxruB2TLBNm','ig9SzcbZzxnZAw9UigzPBgvZ','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','yNvKz2v0u3rHDhvZ','uMvJB3jKAw5NihvZywDLigzVCIa','y3vYCMvUy3K','zNjVBq','tM8GChjPy2LUzYbKyxrHigf2ywLSywjSzq','qLver0vux0vyq0vfreve','x3vWzgf0zvvZywDLrgf0yq','CMvTywLUAw5NqNvKz2v0','rMfPBgvKihrVigXVywqGDxnHz2uGzgf0ytO','lI8UBg94AweTyNvKz2v0','oIaK','x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','tw9KzwWS','BwTKAxi','cLbYAwnPBMCGC291CMnLoIa','tM8GC2vYDMvYieXmtsbZzxj2AwnLigf2ywLSywjSzsbMB3iGChjPy2LUzYb1CgrHDgvZ','BwfW','C2H1DgrVD24','x2XVywrcDwrNzxrmAw1PDa','zxjYB3i','BgfZDfbYAwnPBMDvCgrHDgu','y29UzMLN','yNvKz2v0sw1Wywn0','BM93','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','C2f2zvvZywDLrgf0yq','yNvKz2v0tgLTAxq','DxnHz2u','C2vYDMvYteXnu2vYDMLJzq','Dg9mB3DLCKnHC2u','CMfUzg9T','yNjLywTKB3DUqNLnB2rLBa','t3bLCMf0Aw9UihDVDwXKihvZzsbTB3n0ig9MihLVDxiGyNvKz2v0lIbnB25PDg9YihvZywDLignHCMvMDwXSEs4','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','CMvJB3jKvxnHz2u','z2v0vxnHz2vszxbVCNq','Bg9Nz2vY','CMvHzezPBgu','rMLSzsbZExn0zw0GB3bLCMf0Aw9UigzHAwXLza','CgvYy2vUDgfNzvvZzwq','x2DLDevZDgLTyxrLzfbYAwnPBMC','DxrMltG','BwvZC2fNzq','y2XLyxi','vg90ywWGAw5WDxqGDg9Rzw5ZoIa','DxnHz2veAxi','AxnZDwvZ','z2v0q29ZDevZDgLTyxrL','yNjLywTKB3DUqNLtzxj2AwnL','y29Kzq','uMvTB3zLzcbVBgqGC2vZC2LVBIbMAwXLoIa','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','su5wquXjrf9ut0TftLm','x2DLBMvYyxrLu2vZC2LVBKLK','D2fYBG','y29ZDa','vxnHz2uGCMvJB3jKzwqGC3vJy2vZC2z1BgX5','Bwf4','mtiXmJe0wLjgBfHV','cJ09psbcuKvbs0rpv04GqLKGtu9eruWGpt09cG','B3v0Chv0vg9Rzw5Z','uMvZzxr0Aw5NihvZywDLigrHDge','zw50CMLLCW','D2L0AgLUqNvKz2v0','Cgf0Aa','zgvIDwC','vvne','Bw9KzwXvC2fNzq','zxHWB3j0vxnHz2veyxrH','Dg9tDhjPBMC','cJ09psbcuKvbs0rpv04GqLKGu0vsvKLdrsa9pt0k','BM9YBwfS','B3v0Chv0','x2nOzwnRqNvKz2v0u3rHDhvZ','D3jPDgvgAwXL','z2v0uhjPy2LUz0rHDge','C3rYAw5N','Dg9ju09tDhjPBMC','BNvTyMvY','ChjPy2LUz0LUzM8','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi'];a0_0x1475=function(){return _0x55d5b1;};return a0_0x1475();}function a0_0xee9d(_0x5630df,_0x433567){const _0x1475b1=a0_0x1475();return a0_0xee9d=function(_0xee9d7f,_0x32db32){_0xee9d7f=_0xee9d7f-0x1dd;let _0x4a1916=_0x1475b1[_0xee9d7f];if(a0_0xee9d['fPmfnT']===undefined){var _0x48ad1c=function(_0x183a2d){const _0x40b50c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x51e957='',_0x3c0c6f='';for(let _0x57b9a5=0x0,_0x2dff70,_0x11d387,_0x2a47ec=0x0;_0x11d387=_0x183a2d['charAt'](_0x2a47ec++);~_0x11d387&&(_0x2dff70=_0x57b9a5%0x4?_0x2dff70*0x40+_0x11d387:_0x11d387,_0x57b9a5++%0x4)?_0x51e957+=String['fromCharCode'](0xff&_0x2dff70>>(-0x2*_0x57b9a5&0x6)):0x0){_0x11d387=_0x40b50c['indexOf'](_0x11d387);}for(let _0x4e81bc=0x0,_0x4acd3e=_0x51e957['length'];_0x4e81bc<_0x4acd3e;_0x4e81bc++){_0x3c0c6f+='%'+('00'+_0x51e957['charCodeAt'](_0x4e81bc)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x3c0c6f);};a0_0xee9d['ArfVJM']=_0x48ad1c,_0x5630df=arguments,a0_0xee9d['fPmfnT']=!![];}const _0x53e8ca=_0x1475b1[0x0],_0x7f6cfd=_0xee9d7f+_0x53e8ca,_0x64667d=_0x5630df[_0x7f6cfd];return!_0x64667d?(_0x4a1916=a0_0xee9d['ArfVJM'](_0x4a1916),_0x5630df[_0x7f6cfd]=_0x4a1916):_0x4a1916=_0x64667d,_0x4a1916;},a0_0xee9d(_0x5630df,_0x433567);}const a0_0x5bc1b5=a0_0xee9d;(function(_0x46d270,_0x4ddf8a){const _0x3a73e2=a0_0xee9d,_0x2ef82b=_0x46d270();while(!![]){try{const _0x311024=parseInt(_0x3a73e2(0x242))/0x1*(parseInt(_0x3a73e2(0x273))/0x2)+parseInt(_0x3a73e2(0x203))/0x3*(-parseInt(_0x3a73e2(0x1f8))/0x4)+-parseInt(_0x3a73e2(0x274))/0x5+parseInt(_0x3a73e2(0x1e5))/0x6*(-parseInt(_0x3a73e2(0x27a))/0x7)+parseInt(_0x3a73e2(0x27d))/0x8*(parseInt(_0x3a73e2(0x1f5))/0x9)+-parseInt(_0x3a73e2(0x1f3))/0xa+parseInt(_0x3a73e2(0x1e3))/0xb;if(_0x311024===_0x4ddf8a)break;else _0x2ef82b['push'](_0x2ef82b['shift']());}catch(_0x3eacb4){_0x2ef82b['push'](_0x2ef82b['shift']());}}}(a0_0x1475,0x5e4a8));import{promises as a0_0x183a2d}from'fs';import a0_0x40b50c from'path';const DEFAULT_USAGE_DIR=a0_0x5bc1b5(0x210),USAGE_FILENAME='usage.json',SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':'Budget\x20amount\x20must\x20be\x20a\x20positive\x20number','INVALID_TOKENS':'Token\x20counts\x20must\x20be\x20non-negative\x20numbers','INVALID_SERVICE':a0_0x5bc1b5(0x1e7),'BUDGET_EXCEEDED':'Budget\x20limit\x20exceeded','PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':a0_0x5bc1b5(0x22d)};export class BudgetService{constructor(_0x51e957,_0x3c0c6f,_0x57b9a5=null){const _0x7d6da3=a0_0x5bc1b5;this['config']=_0x51e957,this['logger']=_0x3c0c6f,this['serverLLMService']=_0x57b9a5,this['usage']=this['_initializeUsageData'](),this['budgetLimit']=this[_0x7d6da3(0x219)](),this['hardLimit']=_0x51e957['budget']?.[_0x7d6da3(0x259)]||![],this['pricingData']=new Map(),this[_0x7d6da3(0x21b)]=null,this['pricingUpdateInProgress']=![],this['usageDir']=_0x51e957[_0x7d6da3(0x266)]?.['usageDir']||DEFAULT_USAGE_DIR,this['logger']['info']('Budget\x20service\x20initialized',{'budgetLimit':this[_0x7d6da3(0x221)],'hardLimit':this['hardLimit'],'usageDir':this[_0x7d6da3(0x234)],'hasPricingService':!!this['serverLLMService']}),this['_loadUsageData']()['catch'](_0x2dff70=>{const _0x395543=_0x7d6da3;this['logger'][_0x395543(0x23e)]('Failed\x20to\x20load\x20previous\x20usage\x20data:',_0x2dff70);});}['_initializeUsageData'](){const _0x21505a=a0_0x5bc1b5;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()['toISOString'](),'sessionId':this[_0x21505a(0x23d)](),'lastUpdated':new Date()[_0x21505a(0x255)]()};}['_generateSessionId'](){const _0x2f0807=a0_0x5bc1b5,_0x11d387=Date[_0x2f0807(0x21e)]()[_0x2f0807(0x24d)](0x24),_0x2a47ec=Math[_0x2f0807(0x225)]()[_0x2f0807(0x24d)](0x24)['slice'](0x2);return _0x11d387+'_'+_0x2a47ec;}[a0_0x5bc1b5(0x219)](){const _0x55c9c4=a0_0x5bc1b5,_0x4e81bc=this[_0x55c9c4(0x21c)]['budget']?.['limit'];if(_0x4e81bc!==undefined&&_0x4e81bc!==null)return this['_validateBudgetAmount'](_0x4e81bc);return null;}async['updatePricingFromServer'](){const _0x170be4=a0_0x5bc1b5;if(!this['serverLLMService'])return this['logger'][_0x170be4(0x249)](_0x170be4(0x216)),![];if(this['pricingUpdateInProgress'])return this[_0x170be4(0x22b)][_0x170be4(0x249)](_0x170be4(0x201)),![];if(!this['_shouldUpdatePricing']())return!![];this[_0x170be4(0x206)]=!![];try{this['logger']['info']('Updating pricing data from server');const _0x4acd3e=await this[_0x170be4(0x223)][_0x170be4(0x253)]();if(_0x4acd3e[_0x170be4(0x26c)]===0x0)return this[_0x170be4(0x22b)]['warn']('No pricing data received from server'),![];this[_0x170be4(0x25b)][_0x170be4(0x232)]();for(const [_0x2ed584,_0x17ccbc]of _0x4acd3e['entries']()){this[_0x170be4(0x25b)][_0x170be4(0x271)](_0x2ed584,{'input':_0x17ccbc[_0x170be4(0x1eb)],'output':_0x17ccbc[_0x170be4(0x250)],'unit':_0x17ccbc['unit']||'1K\x20tokens','currency':_0x17ccbc[_0x170be4(0x209)]||_0x170be4(0x24a)});}return this[_0x170be4(0x21b)]=new Date()[_0x170be4(0x255)](),this[_0x170be4(0x22b)][_0x170be4(0x1f9)]('Updated\x20pricing\x20for\x20'+this['pricingData']['size']+'\x20models\x20from\x20server'),!![];}catch(_0x3e4549){return this[_0x170be4(0x22b)][_0x170be4(0x21a)]('Failed to update pricing from server:',_0x3e4549),![];}finally{this[_0x170be4(0x206)]=![];}}['_shouldUpdatePricing'](){const _0x59aeff=a0_0x5bc1b5;if(!this[_0x59aeff(0x21b)])return!![];const _0x3c5fa4=Date['now']()-new Date(this['lastPricingUpdate'])['getTime']();return _0x3c5fa4>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0x409aa8){const _0x1d6f05=a0_0x5bc1b5;if(!_0x409aa8||typeof _0x409aa8!=='string')return this[_0x1d6f05(0x22b)]['warn']('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this[_0x1d6f05(0x25b)]['get'](_0x409aa8)||null;}['getAllPricing'](){return this['serverLLMService']['getPricingData']();}async[a0_0x5bc1b5(0x229)](_0x38e9f1,_0x2b40b1,_0x763a4e,_0x455161){const _0xd954a5=a0_0x5bc1b5;this[_0xd954a5(0x22b)][_0xd954a5(0x1f9)](_0xd954a5(0x208)+_0x38e9f1+'/'+_0x2b40b1,{'inputTokens':_0x763a4e,'outputTokens':_0x455161,'service':_0x38e9f1,'model':_0x2b40b1}),this['_validateUsageInputs'](_0x38e9f1,_0x2b40b1,_0x763a4e,_0x455161),await this['updatePricingFromServer']();const _0x28fb55=this[_0xd954a5(0x25a)](_0x2b40b1,_0x763a4e,_0x455161);!_0x28fb55[_0xd954a5(0x267)]&&this[_0xd954a5(0x22b)]['warn']('Pricing\x20unavailable\x20for\x20model\x20'+_0x2b40b1+_0xd954a5(0x1f2));this[_0xd954a5(0x20d)](_0x38e9f1,_0x2b40b1,_0x763a4e,_0x455161,_0x28fb55[_0xd954a5(0x27b)]);const _0x190af8=this[_0xd954a5(0x251)]();await this[_0xd954a5(0x228)]();const _0x44156f={'service':_0x38e9f1,'model':_0x2b40b1,'inputTokens':_0x763a4e,'outputTokens':_0x455161,'cost':_0x28fb55,'budgetStatus':_0x190af8,'timestamp':new Date()['toISOString']()};return this[_0xd954a5(0x22b)]['debug'](_0xd954a5(0x240),_0x44156f),_0x44156f;}[a0_0x5bc1b5(0x279)](_0x20dca7,_0x18a888,_0x1232f5,_0xbb2845){const _0xd7d53c=a0_0x5bc1b5;if(!_0x20dca7||typeof _0x20dca7!==_0xd7d53c(0x254))throw new Error(ERROR_MESSAGES[_0xd7d53c(0x265)]);if(!_0x18a888||typeof _0x18a888!==_0xd7d53c(0x254))throw new Error(_0xd7d53c(0x27c));if(typeof _0x1232f5!==_0xd7d53c(0x256)||_0x1232f5<0x0)throw new Error(ERROR_MESSAGES[_0xd7d53c(0x23c)]);if(typeof _0xbb2845!=='number'||_0xbb2845<0x0)throw new Error(ERROR_MESSAGES[_0xd7d53c(0x23c)]);}[a0_0x5bc1b5(0x25a)](_0xd7d18b,_0x43c99b,_0x29e591){const _0x19f3e2=a0_0x5bc1b5,_0x442497=this['getModelPricing'](_0xd7d18b);if(!_0x442497){const _0x1c6059=this['_getEstimatedPricing'](_0xd7d18b),_0xba7cb8=_0x43c99b/0x3e8*_0x1c6059['input'],_0x1c3f8e=_0x29e591/0x3e8*_0x1c6059['output'];return{'success':![],'inputCost':_0xba7cb8,'outputCost':_0x1c3f8e,'totalCost':_0xba7cb8+_0x1c3f8e,'currency':'USD','unit':_0x19f3e2(0x1fd),'estimated':!![],'reason':_0x19f3e2(0x1f1)};}const _0x3fb927=_0x43c99b/0x3e8*_0x442497['input'],_0x4f97c8=_0x29e591/0x3e8*_0x442497['output'];return{'success':!![],'inputCost':_0x3fb927,'outputCost':_0x4f97c8,'totalCost':_0x3fb927+_0x4f97c8,'currency':_0x442497['currency'],'unit':_0x442497['unit'],'estimated':![]};}[a0_0x5bc1b5(0x22f)](_0x3ad3a2){const _0x539cc7=a0_0x5bc1b5,_0x260a80=_0x3ad3a2[_0x539cc7(0x224)]();if(_0x260a80[_0x539cc7(0x263)]('opus')||_0x260a80[_0x539cc7(0x263)]('gpt-4'))return{'input':0.015,'output':0.075};else{if(_0x260a80['includes']('sonnet')||_0x260a80['includes'](_0x539cc7(0x26a)))return{'input':0.003,'output':0.015};else{if(_0x260a80[_0x539cc7(0x263)]('haiku')||_0x260a80[_0x539cc7(0x263)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}[a0_0x5bc1b5(0x20d)](_0x3b677f,_0x481c58,_0x4f6f16,_0x4c5d8c,_0x3029ef){const _0x565646=a0_0x5bc1b5;this['usage'][_0x565646(0x272)]+=_0x4f6f16,this['usage']['totalOutputTokens']+=_0x4c5d8c,this['usage'][_0x565646(0x27b)]+=_0x3029ef,this['usage']['lastUpdated']=new Date()[_0x565646(0x255)](),!this[_0x565646(0x222)]['serviceUsage'][_0x3b677f]&&(this[_0x565646(0x222)]['serviceUsage'][_0x3b677f]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x565646(0x222)]['serviceUsage'][_0x3b677f]['inputTokens']+=_0x4f6f16,this['usage'][_0x565646(0x1ef)][_0x3b677f][_0x565646(0x244)]+=_0x4c5d8c,this[_0x565646(0x222)][_0x565646(0x1ef)][_0x3b677f][_0x565646(0x23f)]+=_0x3029ef,this[_0x565646(0x222)]['serviceUsage'][_0x3b677f][_0x565646(0x1fe)]+=0x1,!this['usage'][_0x565646(0x24b)][_0x481c58]&&(this[_0x565646(0x222)][_0x565646(0x24b)][_0x481c58]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage']['modelUsage'][_0x481c58][_0x565646(0x1fa)]+=_0x4f6f16,this[_0x565646(0x222)]['modelUsage'][_0x481c58][_0x565646(0x244)]+=_0x4c5d8c,this['usage'][_0x565646(0x24b)][_0x481c58]['cost']+=_0x3029ef,this['usage']['modelUsage'][_0x481c58][_0x565646(0x1fe)]+=0x1;}[a0_0x5bc1b5(0x251)](){const _0x101511=a0_0x5bc1b5,_0x7b67f8={'withinBudget':!![],'budgetLimit':this[_0x101511(0x221)],'totalSpent':this[_0x101511(0x222)][_0x101511(0x27b)],'remainingBudget':null,'percentageUsed':null,'warningLevel':'normal'};if(this[_0x101511(0x221)]!==null){_0x7b67f8['remainingBudget']=Math[_0x101511(0x241)](0x0,this[_0x101511(0x221)]-this[_0x101511(0x222)]['totalCost']),_0x7b67f8['percentageUsed']=this['usage']['totalCost']/this['budgetLimit']*0x64,_0x7b67f8[_0x101511(0x247)]=this['usage']['totalCost']<=this[_0x101511(0x221)];if(_0x7b67f8[_0x101511(0x22e)]>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x7b67f8[_0x101511(0x1dd)]=_0x101511(0x1e9);else _0x7b67f8['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x7b67f8[_0x101511(0x1dd)]='warning');_0x7b67f8['warningLevel']!==_0x101511(0x24f)&&this[_0x101511(0x22b)][_0x101511(0x23e)](_0x101511(0x1de)+_0x7b67f8[_0x101511(0x1dd)]+':\x20'+_0x7b67f8[_0x101511(0x22e)][_0x101511(0x262)](0x1)+'%\x20used',{'totalSpent':this['usage'][_0x101511(0x27b)],'budgetLimit':this[_0x101511(0x221)],'remainingBudget':_0x7b67f8['remainingBudget']});if(!_0x7b67f8['withinBudget']&&this[_0x101511(0x259)]){const _0x1c77cf=new Error(ERROR_MESSAGES[_0x101511(0x20c)]+_0x101511(0x211)+this[_0x101511(0x222)]['totalCost'][_0x101511(0x262)](0x2)+_0x101511(0x1f6)+this['budgetLimit']['toFixed'](0x2));_0x1c77cf[_0x101511(0x238)]='BUDGET_EXCEEDED',_0x1c77cf[_0x101511(0x207)]=_0x7b67f8;throw _0x1c77cf;}}return _0x7b67f8;}async[a0_0x5bc1b5(0x1fc)](_0x1918dd){const _0x23c675=a0_0x5bc1b5,_0x578d64=this['_validateBudgetAmount'](_0x1918dd);this[_0x23c675(0x221)]=_0x578d64,this[_0x23c675(0x21c)][_0x23c675(0x266)]=this[_0x23c675(0x21c)]['budget']||{},this[_0x23c675(0x21c)]['budget']['limit']=_0x578d64,this[_0x23c675(0x22b)][_0x23c675(0x1f9)](_0x23c675(0x277)+_0x578d64['toFixed'](0x2),{'previousLimit':this[_0x23c675(0x221)],'newLimit':_0x578d64}),await this['saveUsageData']();}[a0_0x5bc1b5(0x1df)](_0x2c5720){const _0x2a183a=a0_0x5bc1b5;if(typeof _0x2c5720!=='number'||_0x2c5720<0x0||!isFinite(_0x2c5720))throw new Error(ERROR_MESSAGES[_0x2a183a(0x261)]);return _0x2c5720;}async['getBudgetUsage'](){const _0x2a6e60=a0_0x5bc1b5;await this[_0x2a6e60(0x258)]();const _0x174bfa={'totalSpent':this['usage'][_0x2a6e60(0x27b)],'budgetLimit':this[_0x2a6e60(0x221)],'inputTokens':this[_0x2a6e60(0x222)]['totalInputTokens'],'outputTokens':this[_0x2a6e60(0x222)]['totalOutputTokens'],'remainingBudget':this['budgetLimit']!==null?Math['max'](0x0,this['budgetLimit']-this['usage'][_0x2a6e60(0x27b)]):null,'percentageUsed':this[_0x2a6e60(0x221)]!==null?this[_0x2a6e60(0x222)][_0x2a6e60(0x27b)]/this[_0x2a6e60(0x221)]*0x64:null,'sessionStart':this[_0x2a6e60(0x222)][_0x2a6e60(0x264)],'lastUpdated':this[_0x2a6e60(0x222)][_0x2a6e60(0x26d)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this['lastPricingUpdate'],'modelsWithPricing':this[_0x2a6e60(0x25b)]['size'],'source':this['serverLLMService']?'server':'fallback'}};for(const [_0x2e3eb2,_0x41adbb]of Object[_0x2a6e60(0x246)](this['usage'][_0x2a6e60(0x1ef)])){_0x174bfa[_0x2a6e60(0x237)][_0x2e3eb2]={'cost':_0x41adbb['cost'],'inputTokens':_0x41adbb['inputTokens'],'outputTokens':_0x41adbb[_0x2a6e60(0x244)],'requestCount':_0x41adbb[_0x2a6e60(0x1fe)]};}for(const [_0x3e9089,_0x36cad0]of Object[_0x2a6e60(0x246)](this[_0x2a6e60(0x222)][_0x2a6e60(0x24b)])){_0x174bfa[_0x2a6e60(0x226)][_0x3e9089]={'cost':_0x36cad0[_0x2a6e60(0x23f)],'inputTokens':_0x36cad0['inputTokens'],'outputTokens':_0x36cad0[_0x2a6e60(0x244)],'requestCount':_0x36cad0['requestCount']};}return _0x174bfa;}async[a0_0x5bc1b5(0x22a)](){const _0x40b1a0=a0_0x5bc1b5,_0x2754be=await this[_0x40b1a0(0x269)]();let _0x1311a2='===\x20USAGE\x20REPORT\x20===\x0a';_0x1311a2+=_0x40b1a0(0x1e0)+_0x2754be['totalSpent'][_0x40b1a0(0x262)](0x4)+'\x0a',_0x1311a2+=_0x40b1a0(0x233)+_0x2754be[_0x40b1a0(0x1fa)]['toLocaleString']()+'\x0a',_0x1311a2+='Total\x20output\x20tokens:\x20'+_0x2754be[_0x40b1a0(0x244)]['toLocaleString']()+'\x0a';_0x2754be['budgetLimit']!==null&&(_0x1311a2+='Budget\x20limit:\x20$'+_0x2754be['budgetLimit'][_0x40b1a0(0x262)](0x2)+'\x0a',_0x1311a2+='Remaining:\x20$'+_0x2754be[_0x40b1a0(0x20e)]['toFixed'](0x4)+'\x0a',_0x1311a2+='Usage:\x20'+_0x2754be[_0x40b1a0(0x22e)][_0x40b1a0(0x262)](0x1)+'%\x0a');_0x1311a2+=_0x40b1a0(0x215)+_0x2754be[_0x40b1a0(0x257)][_0x40b1a0(0x1ec)]+'\x0a',_0x1311a2+=_0x40b1a0(0x268)+_0x2754be['pricingInfo']['modelsWithPricing']+'\x0a';if(Object[_0x40b1a0(0x1e2)](_0x2754be[_0x40b1a0(0x237)])[_0x40b1a0(0x1ff)]>0x0){_0x1311a2+=_0x40b1a0(0x24e);for(const [_0x29e9af,_0x575e1f]of Object[_0x40b1a0(0x246)](_0x2754be['breakdownByService'])){_0x1311a2+=_0x29e9af+_0x40b1a0(0x211)+_0x575e1f['cost']['toFixed'](0x4)+'\x20('+_0x575e1f[_0x40b1a0(0x1fe)]+'\x20requests)\x0a';}}if(Object['keys'](_0x2754be[_0x40b1a0(0x226)])[_0x40b1a0(0x1ff)]>0x0){_0x1311a2+=_0x40b1a0(0x243);for(const [_0xbad294,_0x27f5a4]of Object['entries'](_0x2754be['breakdownByModel'])){_0x1311a2+=_0xbad294+':\x20$'+_0x27f5a4[_0x40b1a0(0x23f)]['toFixed'](0x4)+'\x20('+_0x27f5a4[_0x40b1a0(0x1fe)]+_0x40b1a0(0x25d);}}return _0x1311a2;}async[a0_0x5bc1b5(0x228)](){const _0x2ff5af=a0_0x5bc1b5,_0xb14cda=0.1,_0x167b2a=this[_0x2ff5af(0x222)]['lastSavedCost']||0x0;this[_0x2ff5af(0x222)]['totalCost']-_0x167b2a>=_0xb14cda&&(await this['saveUsageData'](),this['usage']['lastSavedCost']=this['usage']['totalCost']);}async['_loadUsageData'](){const _0xf5310d=a0_0x5bc1b5;try{await this['_ensureUsageDirectory']();const _0x22a000=a0_0x40b50c['join'](this[_0xf5310d(0x234)],USAGE_FILENAME);try{const _0x363194=await a0_0x183a2d[_0xf5310d(0x22c)](_0x22a000,_0xf5310d(0x230)),_0x5373bb=JSON['parse'](_0x363194);this[_0xf5310d(0x222)][_0xf5310d(0x272)]=_0x5373bb[_0xf5310d(0x272)]||0x0,this[_0xf5310d(0x222)][_0xf5310d(0x204)]=_0x5373bb['totalOutputTokens']||0x0,this['usage']['totalCost']=_0x5373bb['totalCost']||0x0,this[_0xf5310d(0x222)]['serviceUsage']=_0x5373bb[_0xf5310d(0x1ef)]||{},this['usage'][_0xf5310d(0x24b)]=_0x5373bb['modelUsage']||{},this['logger'][_0xf5310d(0x1f9)]('Loaded\x20previous\x20usage\x20data',{'totalCost':this['usage'][_0xf5310d(0x27b)],'totalTokens':this[_0xf5310d(0x222)]['totalInputTokens']+this['usage'][_0xf5310d(0x204)]});}catch(_0x26a811){_0x26a811[_0xf5310d(0x238)]!==_0xf5310d(0x25c)&&this['logger'][_0xf5310d(0x23e)](_0xf5310d(0x20f),_0x26a811);}}catch(_0x47f63f){this[_0xf5310d(0x22b)][_0xf5310d(0x23e)]('Error\x20initializing\x20usage\x20data\x20directory:',_0x47f63f);}}async['_ensureUsageDirectory'](){const _0x38f03f=a0_0x5bc1b5;try{await a0_0x183a2d[_0x38f03f(0x214)](this['usageDir'],{'recursive':!![]});}catch(_0x5afed7){throw new Error(ERROR_MESSAGES[_0x38f03f(0x1f4)]+':\x20'+_0x5afed7['message']);}}async[a0_0x5bc1b5(0x220)](){const _0x4790dc=a0_0x5bc1b5;try{await this['_ensureUsageDirectory'](),this['usage']['sessionEnd']=new Date()['toISOString']();const _0x4fbeae=a0_0x40b50c[_0x4790dc(0x202)](this[_0x4790dc(0x234)],USAGE_FILENAME);await a0_0x183a2d[_0x4790dc(0x252)](_0x4fbeae,JSON[_0x4790dc(0x26e)](this['usage'],null,0x2),'utf-8');const _0x45891a=a0_0x40b50c['join'](this[_0x4790dc(0x234)],''+SESSION_PREFIX+this[_0x4790dc(0x222)]['sessionId']+_0x4790dc(0x278));await a0_0x183a2d[_0x4790dc(0x252)](_0x45891a,JSON['stringify'](this[_0x4790dc(0x222)],null,0x2),_0x4790dc(0x230)),await this[_0x4790dc(0x212)](),this['logger'][_0x4790dc(0x1f9)]('Usage\x20data\x20saved\x20successfully',{'totalCost':this['usage']['totalCost'],'sessionId':this[_0x4790dc(0x222)]['sessionId']});}catch(_0x138ada){this[_0x4790dc(0x22b)][_0x4790dc(0x21a)]('Failed\x20to\x20save\x20usage\x20data:',_0x138ada);throw new Error(ERROR_MESSAGES[_0x4790dc(0x1f4)]+':\x20'+_0x138ada[_0x4790dc(0x231)]);}}async[a0_0x5bc1b5(0x212)](){const _0x47980d=a0_0x5bc1b5;try{const _0x3ad962=await a0_0x183a2d['readdir'](this['usageDir']),_0xe6d96e=_0x3ad962['filter'](_0x15cf14=>_0x15cf14[_0x47980d(0x1e8)](SESSION_PREFIX)&&_0x15cf14['endsWith']('.json'))['map'](_0x4c511d=>({'name':_0x4c511d,'path':a0_0x40b50c[_0x47980d(0x202)](this['usageDir'],_0x4c511d)}));if(_0xe6d96e[_0x47980d(0x1ff)]<=MAX_SESSION_FILES)return;const _0x112066=await Promise[_0x47980d(0x26b)](_0xe6d96e[_0x47980d(0x217)](async _0xc3cf26=>{const _0x2564d7=_0x47980d;try{const _0x695810=await a0_0x183a2d['stat'](_0xc3cf26[_0x2564d7(0x248)]);return{..._0xc3cf26,'mtime':_0x695810[_0x2564d7(0x26f)]};}catch(_0x320bdb){return null;}})),_0x277dc6=_0x112066['filter'](_0x2a1cad=>_0x2a1cad!==null)['sort']((_0x4d3a6d,_0x5a2cde)=>_0x5a2cde[_0x47980d(0x26f)]-_0x4d3a6d[_0x47980d(0x26f)]),_0xde250e=_0x277dc6[_0x47980d(0x1fb)](MAX_SESSION_FILES);for(const _0x1ee2e4 of _0xde250e){try{await a0_0x183a2d[_0x47980d(0x25e)](_0x1ee2e4['path']),this[_0x47980d(0x22b)]['debug'](_0x47980d(0x239)+_0x1ee2e4['name']);}catch(_0x47c8c6){this['logger'][_0x47980d(0x23e)](_0x47980d(0x23a)+_0x1ee2e4['name']+':',_0x47c8c6);}}_0xde250e['length']>0x0&&this[_0x47980d(0x22b)]['info']('Cleaned\x20up\x20'+_0xde250e[_0x47980d(0x1ff)]+_0x47980d(0x205));}catch(_0x5f31a4){this['logger']['warn'](_0x47980d(0x275),_0x5f31a4);}}async[a0_0x5bc1b5(0x276)](_0x5e3ca3=![]){const _0x3a5381=a0_0x5bc1b5;this['logger']['info'](_0x3a5381(0x245),{'preserveTotal':_0x5e3ca3});if(!_0x5e3ca3)this[_0x3a5381(0x222)]=this['_initializeUsageData']();else{const _0x217ce2=this['usage'][_0x3a5381(0x27b)],_0x5463f6=this[_0x3a5381(0x222)]['totalInputTokens'],_0xbddc65=this[_0x3a5381(0x222)][_0x3a5381(0x204)];this['usage']=this[_0x3a5381(0x270)](),this['usage'][_0x3a5381(0x27b)]=_0x217ce2,this['usage']['totalInputTokens']=_0x5463f6,this[_0x3a5381(0x222)][_0x3a5381(0x204)]=_0xbddc65;}await this['saveUsageData']();}async[a0_0x5bc1b5(0x24c)](_0x54a663='json'){const _0x4960ec=a0_0x5bc1b5,_0x5d0f32=await this[_0x4960ec(0x269)]();if(_0x54a663==='csv')return this[_0x4960ec(0x200)](_0x5d0f32);return JSON['stringify'](_0x5d0f32,null,0x2);}['_exportToCsv'](_0x224f54){const _0x7445dc=a0_0x5bc1b5,_0x511920=['Category,Service/Model,Cost,InputTokens,OutputTokens,RequestCount'];for(const [_0x3537fe,_0x1344b3]of Object['entries'](_0x224f54['breakdownByService'])){_0x511920['push']('Service,'+_0x3537fe+','+_0x1344b3[_0x7445dc(0x23f)]+','+_0x1344b3[_0x7445dc(0x1fa)]+','+_0x1344b3[_0x7445dc(0x244)]+','+_0x1344b3[_0x7445dc(0x1fe)]);}for(const [_0x3b0208,_0x544672]of Object[_0x7445dc(0x246)](_0x224f54['breakdownByModel'])){_0x511920[_0x7445dc(0x25f)](_0x7445dc(0x213)+_0x3b0208+','+_0x544672[_0x7445dc(0x23f)]+','+_0x544672['inputTokens']+','+_0x544672['outputTokens']+','+_0x544672['requestCount']);}return _0x511920[_0x7445dc(0x202)]('\x0a');}[a0_0x5bc1b5(0x236)](_0x258196,_0x254861,_0x528a7a){const _0x3ced45=a0_0x5bc1b5;this[_0x3ced45(0x279)]('estimate',_0x258196,_0x254861,_0x528a7a);const _0x336859=this['_calculateCost'](_0x258196,_0x254861,_0x528a7a),_0xeed215={'model':_0x258196,'estimatedInputTokens':_0x254861,'estimatedOutputTokens':_0x528a7a,'estimatedCost':_0x336859['totalCost'],..._0x336859,'budgetImpact':null};if(this['budgetLimit']!==null){const _0x272a79=this[_0x3ced45(0x222)]['totalCost']+_0x336859['totalCost'];_0xeed215['budgetImpact']={'currentSpent':this['usage']['totalCost'],'afterOperation':_0x272a79,'remainingAfter':Math['max'](0x0,this[_0x3ced45(0x221)]-_0x272a79),'wouldExceedBudget':_0x272a79>this['budgetLimit'],'percentageAfter':_0x272a79/this['budgetLimit']*0x64};}return _0xeed215;}['checkBudgetForOperation'](_0x2807d1,_0x74a6bf,_0x45733c){const _0x234281=a0_0x5bc1b5,_0x3eec15=this[_0x234281(0x236)](_0x2807d1,_0x74a6bf,_0x45733c);return{'canProceed':this['budgetLimit']===null||!_0x3eec15[_0x234281(0x21d)]?.[_0x234281(0x1f7)],'estimate':_0x3eec15,'recommendation':this['_getBudgetRecommendation'](_0x3eec15)};}['_getBudgetRecommendation'](_0x15c687){const _0x46791a=a0_0x5bc1b5;if(this['budgetLimit']===null)return _0x46791a(0x1e6);if(!_0x15c687[_0x46791a(0x21d)])return'Proceed\x20with\x20operation.';const {percentageAfter:_0x5787c1,wouldExceedBudget:_0x2c34ea}=_0x15c687['budgetImpact'];if(_0x2c34ea)return'Operation\x20would\x20exceed\x20budget\x20limit.\x20Consider\x20increasing\x20budget\x20or\x20using\x20a\x20less\x20expensive\x20model.';if(_0x5787c1>BUDGET_CRITICAL_THRESHOLD*0x64)return _0x46791a(0x227);if(_0x5787c1>BUDGET_WARNING_THRESHOLD*0x64)return _0x46791a(0x1e1);return _0x46791a(0x1ea);}['getPricingInfo'](){const _0xf92cfd=a0_0x5bc1b5,_0x551b28=Array[_0xf92cfd(0x20a)](this[_0xf92cfd(0x25b)]['entries']())['map'](([_0x1d1e02,_0x5217dd])=>({'model':_0x1d1e02,'inputPrice':_0x5217dd[_0xf92cfd(0x1eb)],'outputPrice':_0x5217dd['output'],'unit':_0x5217dd[_0xf92cfd(0x1e4)],'currency':_0x5217dd['currency']}));return{'models':_0x551b28,'lastUpdate':this['lastPricingUpdate'],'source':this['serverLLMService']?'server':'fallback','totalModels':this[_0xf92cfd(0x25b)]['size']};}async['healthCheck'](){const _0x12a7dd=a0_0x5bc1b5,_0x25bdb3={'status':'healthy','issues':[],'metrics':{'totalCost':this['usage']['totalCost'],'totalTokens':this[_0x12a7dd(0x222)][_0x12a7dd(0x272)]+this[_0x12a7dd(0x222)]['totalOutputTokens'],'modelsWithPricing':this[_0x12a7dd(0x25b)]['size'],'budgetLimit':this[_0x12a7dd(0x221)]}};try{await this['_ensureUsageDirectory']();const _0x32ace4=a0_0x40b50c[_0x12a7dd(0x202)](this[_0x12a7dd(0x234)],'.health-check');await a0_0x183a2d['writeFile'](_0x32ace4,'test'),await a0_0x183a2d[_0x12a7dd(0x25e)](_0x32ace4);}catch(_0x14959c){_0x25bdb3[_0x12a7dd(0x1ee)]='degraded',_0x25bdb3['issues']['push'](_0x12a7dd(0x1ed));}this[_0x12a7dd(0x25b)]['size']===0x0&&(_0x25bdb3['status']='degraded',_0x25bdb3['issues'][_0x12a7dd(0x25f)](_0x12a7dd(0x20b)));if(this['lastPricingUpdate']){const _0x19be2f=(Date['now']()-new Date(this[_0x12a7dd(0x21b)])['getTime']())/(0x3e8*0x3c*0x3c);_0x19be2f>0x18&&_0x25bdb3[_0x12a7dd(0x235)][_0x12a7dd(0x25f)](_0x12a7dd(0x21f));}if(this[_0x12a7dd(0x221)]!==null){const _0x165469=this['_checkBudgetStatus']();_0x165469[_0x12a7dd(0x1dd)]!=='normal'&&_0x25bdb3['issues']['push'](_0x12a7dd(0x1de)+_0x165469[_0x12a7dd(0x1dd)]+':\x20'+_0x165469[_0x12a7dd(0x22e)]['toFixed'](0x1)+'%\x20used');}return _0x25bdb3['issues']['length']>0x0&&_0x25bdb3[_0x12a7dd(0x1ee)]==='healthy'&&(_0x25bdb3[_0x12a7dd(0x1ee)]=_0x12a7dd(0x260)),_0x25bdb3;}async[a0_0x5bc1b5(0x218)](){const _0x252987=a0_0x5bc1b5;this['logger']['info']('Shutting\x20down\x20budget\x20service');try{await this[_0x252987(0x220)](),this['pricingData']['clear'](),this['logger'][_0x252987(0x1f9)](_0x252987(0x23b));}catch(_0x24ea30){this['logger']['error'](_0x252987(0x1f0),_0x24ea30);throw _0x24ea30;}}}