function a0_0x3de3(_0x49ca22,_0x1ae8a9){const _0x11633c=a0_0x1163();return a0_0x3de3=function(_0x3de363,_0x5ea301){_0x3de363=_0x3de363-0x67;let _0x5c6f7e=_0x11633c[_0x3de363];if(a0_0x3de3['EQyTSS']===undefined){var _0x2b75c3=function(_0x4e6021){const _0x31c6bd='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1281a9='',_0x4934e8='';for(let _0x52328f=0x0,_0x253019,_0x1e74ca,_0x1a761f=0x0;_0x1e74ca=_0x4e6021['charAt'](_0x1a761f++);~_0x1e74ca&&(_0x253019=_0x52328f%0x4?_0x253019*0x40+_0x1e74ca:_0x1e74ca,_0x52328f++%0x4)?_0x1281a9+=String['fromCharCode'](0xff&_0x253019>>(-0x2*_0x52328f&0x6)):0x0){_0x1e74ca=_0x31c6bd['indexOf'](_0x1e74ca);}for(let _0x360fd1=0x0,_0x3d76db=_0x1281a9['length'];_0x360fd1<_0x3d76db;_0x360fd1++){_0x4934e8+='%'+('00'+_0x1281a9['charCodeAt'](_0x360fd1)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x4934e8);};a0_0x3de3['iEvaOY']=_0x2b75c3,_0x49ca22=arguments,a0_0x3de3['EQyTSS']=!![];}const _0x19c87c=_0x11633c[0x0],_0xf5ca55=_0x3de363+_0x19c87c,_0x16b659=_0x49ca22[_0xf5ca55];return!_0x16b659?(_0x5c6f7e=a0_0x3de3['iEvaOY'](_0x5c6f7e),_0x49ca22[_0xf5ca55]=_0x5c6f7e):_0x5c6f7e=_0x16b659,_0x5c6f7e;},a0_0x3de3(_0x49ca22,_0x1ae8a9);}const a0_0x2f6e05=a0_0x3de3;(function(_0x12f7ff,_0x5669ef){const _0x2ebd8e=a0_0x3de3,_0x4dafd4=_0x12f7ff();while(!![]){try{const _0x5000eb=parseInt(_0x2ebd8e(0xa5))/0x1*(-parseInt(_0x2ebd8e(0x71))/0x2)+parseInt(_0x2ebd8e(0x85))/0x3+parseInt(_0x2ebd8e(0x8a))/0x4*(-parseInt(_0x2ebd8e(0xaf))/0x5)+-parseInt(_0x2ebd8e(0xd6))/0x6+-parseInt(_0x2ebd8e(0xf2))/0x7+parseInt(_0x2ebd8e(0x96))/0x8+parseInt(_0x2ebd8e(0x108))/0x9*(parseInt(_0x2ebd8e(0x103))/0xa);if(_0x5000eb===_0x5669ef)break;else _0x4dafd4['push'](_0x4dafd4['shift']());}catch(_0x18e5ee){_0x4dafd4['push'](_0x4dafd4['shift']());}}}(a0_0x1163,0xc3ef9));function a0_0x1163(){const _0x1b0b60=['rMfPBgvKihrVihnHDMuGDxnHz2uGzgf0ytO','C2f2zvvZywDLrgf0yq','BgfZDfvWzgf0zwq','z2v0qNvKz2v0vxnHz2u','yNjLywTKB3DUqNLnB2rLBa','x2DLDevZDgLTyxrLzfbYAwnPBMC','D2fYBG','Bw9KzwXZv2L0AfbYAwnPBMC','C3rHDhvZ','Aw5WDxruB2TLBNm','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','zMLSDgvY','mtm4mtq2n09yuxzrqG','CMvXDwvZDenVDw50','A2v5CW','yNvKz2v0u3rHDhvZ','C2L6zq','mJuXodq0B1rbzg5j','t3bLCMf0Aw9UigLZihDPDgHPBIbIDwrNzxqGz3vPzgvSAw5LCY4','y2XLyxi','tw9KzwXZihDPDgGGChjPy2LUzZOG','CMfUzg9T','su5wquXjrf9btu9vtLq','ChvZAa','D2fYBMLUzW','BwfW','z2v0uhjPy2LUz0rHDge','tM8GC2vYDMvYieXmtsbZzxj2AwnLigf2ywLSywjSzsbMB3iGChjPy2LUzYb1CgrHDgvZ','ANnVBG','ndC4mdmYmfnny2fmsW','C2vZC2LVBL8','D2L0AgLUqNvKz2v0','Dg9gAxHLza','AxnZDwvZ','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','x2nSzwfUDxbpBgrtzxnZAw9UrMLSzxm','D2fYBMLUz0XLDMvS','BgvUz3rO','C2vYDMvY','yNjLywTKB3DUqNLtzxj2AwnL','DxrMltG','su5wquXjrf9trvjwsunf','C3rHCNrZv2L0Aa','zxjYB3i','mte3n1PJz0Pkza','CMvTywLUAw5NqNvKz2v0','lMPZB24','uhjPy2LUzYb1BMf2ywLSywjSzsbMB3iGBw9KzwWG','y29UzMLN','BwTKAxi','AM9PBG','lMHLywX0Ac1JAgvJAW','z2v0vxnHz2vszxbVCNq','x3zHBgLKyxrLqNvKz2v0qw1VDw50','otvwsgTrA0K','DxnHz2u','x2LUAxrPywXPEMvvC2fNzurHDge','vg90ywWGAw5WDxqGDg9Rzw5ZoIa','CgfYC2u','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','vvne','uMvZzxr0Aw5NihvZywDLigrHDge','qNvKz2v0igXPBwL0ihnLDcb0BYaK','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','yNvKz2v0tgLTAxq','jsb1C2vK','x2XVywrcDwrNzxrmAw1PDa','Dw5SAw5R','BM9YBwfS','B3v0Chv0vg9Rzw5Z','uMvTywLUAw5NoIaK','u2H1DhrPBMCGzg93BIbIDwrNzxqGC2vYDMLJzq','rMLSzsbZExn0zw0GB3bLCMf0Aw9UigzHAwXLza','z3b0ltq','C2XPy2u','rMfPBgvKihrVigXVywqGDxnHz2uGzgf0ytO','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','D3jPDgvgAwXL','z2v0q29ZDevZDgLTyxrL','C2vZC2LVBLn0yxj0','BNvTyMvY','rMLSzsbZExn0zw0GywnJzxnZigLZC3vLCW','BxrPBwu','z2v0uhjPy2LUz0LUzM8','ig9SzcbZzxnZAw9UigzPBgvZ','lI8UBg94AweTyNvKz2v0','z2v0','Aw5MBW','Aw5WDxq','C2vYDMLJzvvZywDL','Bw9KzwXvC2fNzq','z2v0vgLTzq','ntqYodm4nMrtBvzOzq','pt09ifvtquDfifjfue9svca9pt0k','Dg90ywXdB3n0','qNvKz2v0ia','C2H1DgrVD24','C3vJy2vZCW','Dg9tDhjPBMC','BM93','x2vUC3vYzvvZywDLrgLYzwn0B3j5','DxnHz2veAxi','DgvZDa','zxHWB3j0vxnHz2veyxrH','vg9Rzw4Gy291BNrZig11C3qGyMuGBM9Ulw5Lz2f0AxzLig51BwjLCNm','zw50CMLLCW','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','CMvHzgrPCG','y29ZDa','C2v0','BgLTAxq','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','C3rYAw5NAwz5','BgfZDfbYAwnPBMDvCgrHDgu','Dg90ywXjBNb1DfrVA2vUCW','zgvIDwC','BgfZDfnHDMvKq29ZDa','Dw5PDa','zNjVBq','x3nOB3vSzfvWzgf0zvbYAwnPBMC','nti2nJGXnfPywNDVDG','uhjPy2LUzYbKyxrHihvUyxzHAwXHyMXLigzVCIbTB2rLBa','Dg9ju09tDhjPBMC','Dg9mB3DLCKnHC2u','C2vYDMvYteXnu2vYDMLJzq','u2vYDMLJzsW','t3bLCMf0Aw9UihDVDwXKihvZzsbZAwDUAwzPy2fUDcbWB3j0Aw9Uig9Migj1zgDLDc4Gq29UC2LKzxiGy29ZDcbVChrPBwL6yxrPB24U','tw9KzwWGBMfTzsbTDxn0igjLigeGBM9UlwvTChr5ihn0CMLUzW','z3b0ltmUnq','ig1VzgvSCYbMCM9TihnLCNzLCG','qLver0vux0vyq0vfreve','Dg9mB2nHBgvtDhjPBMC','BMfTzq','x3vWzgf0zvvZywDLrgf0yq','AgvHBhrOEq','vxnHz2u6ia','rxjYB3iGAw5PDgLHBgL6Aw5NihvZywDLigrHDgeGzgLYzwn0B3j5oG','mZmWmJKZotbdwMHIrKW','AgfYzeXPBwL0','Bg9Nz2vY','C3rYAw5N','qNvKz2v0igXPBwL0igv4y2vLzgvK','oxzPsLjIsG','uMvJB3jKAw5NihvZywDLigzVCIa','rMfPBgvKihrVigXVywqGChjLDMLVDxmGDxnHz2uGzgf0ytO','yNvKz2v0','vg90ywWGB3v0Chv0ihrVA2vUCZOG','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','cJ09psbcuKvbs0rpv04GqLKGu0vsvKLdrsa9pt0k','zgvNCMfKzwq','oIaK','Bwf4','DxnHz2uUANnVBG','y3vYCMvUy3K','yNvKz2v0sw1Wywn0','CgvYy2vUDgfNzvvZzwq','mte5ogrOAfDPva','Aw5JBhvKzxm','C291CMnL','ChjPy2LUz0rHDge','x2v4Cg9YDfrVq3n2','uhjVy2vLzcb3AxrOig9WzxjHDgLVBI4','q2f0zwDVCNKSu2vYDMLJzs9nB2rLBcXdB3n0leLUChv0vg9Rzw5Zle91Dhb1DfrVA2vUCYXszxf1zxn0q291BNq','Dg90ywXpDxrWDxruB2TLBNm'];a0_0x1163=function(){return _0x1b0b60;};return a0_0x1163();}import{promises as a0_0x4e6021}from'fs';import a0_0x31c6bd from'path';const DEFAULT_USAGE_DIR=a0_0x2f6e05(0xcf),USAGE_FILENAME=a0_0x2f6e05(0x6d),SESSION_PREFIX=a0_0x2f6e05(0x97),PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':'Budget\x20amount\x20must\x20be\x20a\x20positive\x20number','INVALID_TOKENS':a0_0x2f6e05(0xe2),'INVALID_SERVICE':a0_0x2f6e05(0xb9),'BUDGET_EXCEEDED':a0_0x2f6e05(0x107),'PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':a0_0x2f6e05(0xc2)};export class BudgetService{constructor(_0x1281a9,_0x4934e8,_0x52328f=null){const _0x574a69=a0_0x2f6e05;this['config']=_0x1281a9,this[_0x574a69(0x105)]=_0x4934e8,this['serverLLMService']=_0x52328f,this['usage']=this[_0x574a69(0xb1)](),this['budgetLimit']=this[_0x574a69(0xbc)](),this['hardLimit']=_0x1281a9['budget']?.['hardLimit']||![],this['pricingData']=new Map(),this[_0x574a69(0xeb)]=null,this[_0x574a69(0xc6)]=![],this['usageDir']=_0x1281a9['budget']?.[_0x574a69(0xdf)]||DEFAULT_USAGE_DIR,this['logger'][_0x574a69(0xd1)]('Budget\x20service\x20initialized',{'budgetLimit':this['budgetLimit'],'hardLimit':this[_0x574a69(0x104)],'usageDir':this['usageDir'],'hasPricingService':!!this[_0x574a69(0xf6)]}),this['_loadUsageData']()['catch'](_0x253019=>{const _0x511a81=_0x574a69;this['logger'][_0x511a81(0x7f)](_0x511a81(0x10a),_0x253019);});}['_initializeUsageData'](){return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()['toISOString'](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()['toISOString']()};}['_generateSessionId'](){const _0x57a5a7=a0_0x2f6e05,_0x1e74ca=Date[_0x57a5a7(0xdd)]()[_0x57a5a7(0xdc)](0x24),_0x1a761f=Math[_0x57a5a7(0x8e)]()['toString'](0x24)[_0x57a5a7(0xc4)](0x2);return _0x1e74ca+'_'+_0x1a761f;}['_loadBudgetLimit'](){const _0x30ef8d=a0_0x2f6e05,_0x360fd1=this['config']['budget']?.['limit'];if(_0x360fd1!==undefined&&_0x360fd1!==null)return this[_0x30ef8d(0xae)](_0x360fd1);return null;}async['updatePricingFromServer'](){const _0x1fb855=a0_0x2f6e05;if(!this['serverLLMService'])return this['logger'][_0x1fb855(0xed)](_0x1fb855(0x94)),![];if(this['pricingUpdateInProgress'])return this[_0x1fb855(0x105)][_0x1fb855(0xed)]('Pricing\x20update\x20already\x20in\x20progress'),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this[_0x1fb855(0x105)][_0x1fb855(0xd1)]('Updating pricing data from server');const _0x3d76db=await this[_0x1fb855(0xf6)]['getPricingData']();if(_0x3d76db['size']===0x0)return this[_0x1fb855(0x105)][_0x1fb855(0x7f)]('No pricing data received from server'),![];this[_0x1fb855(0x74)][_0x1fb855(0x8c)]();for(const [_0x3cb918,_0x4ebd69]of _0x3d76db['entries']()){this[_0x1fb855(0x74)][_0x1fb855(0xe7)](_0x3cb918,{'input':_0x4ebd69['input'],'output':_0x4ebd69['output'],'unit':_0x4ebd69[_0x1fb855(0xef)]||'1K\x20tokens','currency':_0x4ebd69[_0x1fb855(0x6e)]||_0x1fb855(0xb6)});}return this['lastPricingUpdate']=new Date()[_0x1fb855(0xf4)](),this[_0x1fb855(0x105)]['info']('Updated\x20pricing\x20for\x20'+this['pricingData']['size']+_0x1fb855(0xfb)),!![];}catch(_0x3785ed){return this[_0x1fb855(0x105)][_0x1fb855(0xa4)]('Failed to update pricing from server:',_0x3785ed),![];}finally{this[_0x1fb855(0xc6)]=![];}}[a0_0x2f6e05(0xf1)](){const _0x27ac54=a0_0x2f6e05;if(!this['lastPricingUpdate'])return!![];const _0x283dba=Date[_0x27ac54(0xdd)]()-new Date(this['lastPricingUpdate'])[_0x27ac54(0xd5)]();return _0x283dba>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0xb6986a){const _0x4bd980=a0_0x2f6e05;if(!_0xb6986a||typeof _0xb6986a!==_0x4bd980(0x106))return this['logger'][_0x4bd980(0x7f)]('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this['pricingData'][_0x4bd980(0xd0)](_0xb6986a)||null;}['getAllPricing'](){const _0x4a8f9c=a0_0x2f6e05;return this[_0x4a8f9c(0xf6)][_0x4a8f9c(0x93)]();}async['recordUsage'](_0x1836ab,_0x3e2fae,_0x493358,_0x91660a){const _0x2dff2a=a0_0x2f6e05;this['logger'][_0x2dff2a(0xd1)](_0x2dff2a(0x109)+_0x1836ab+'/'+_0x3e2fae,{'inputTokens':_0x493358,'outputTokens':_0x91660a,'service':_0x1836ab,'model':_0x3e2fae}),this['_validateUsageInputs'](_0x1836ab,_0x3e2fae,_0x493358,_0x91660a),await this[_0x2dff2a(0xb4)]();const _0x438f59=this['_calculateCost'](_0x3e2fae,_0x493358,_0x91660a);!_0x438f59[_0x2dff2a(0xdb)]&&this['logger'][_0x2dff2a(0x7f)](_0x2dff2a(0xa8)+_0x3e2fae+',\x20using\x20estimate');this[_0x2dff2a(0xff)](_0x1836ab,_0x3e2fae,_0x493358,_0x91660a,_0x438f59['totalCost']);const _0x4e989d=this['_checkBudgetStatus']();await this['_saveUsageDataIfNeeded']();const _0x4e95c5={'service':_0x1836ab,'model':_0x3e2fae,'inputTokens':_0x493358,'outputTokens':_0x91660a,'cost':_0x438f59,'budgetStatus':_0x4e989d,'timestamp':new Date()['toISOString']()};return this['logger']['debug']('Usage\x20recorded\x20successfully',_0x4e95c5),_0x4e95c5;}[a0_0x2f6e05(0x83)](_0x13e531,_0x5226f0,_0x7dad20,_0x2b2196){const _0x23bedd=a0_0x2f6e05;if(!_0x13e531||typeof _0x13e531!=='string')throw new Error(ERROR_MESSAGES[_0x23bedd(0xa2)]);if(!_0x5226f0||typeof _0x5226f0!=='string')throw new Error(_0x23bedd(0xf9));if(typeof _0x7dad20!=='number'||_0x7dad20<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);if(typeof _0x2b2196!==_0x23bedd(0xca)||_0x2b2196<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);}['_calculateCost'](_0xfa5d66,_0x204796,_0x594057){const _0x223132=a0_0x2f6e05,_0x68aa7e=this['getModelPricing'](_0xfa5d66);if(!_0x68aa7e){const _0x96a5c5=this[_0x223132(0x7e)](_0xfa5d66),_0x4e5fdd=_0x204796/0x3e8*_0x96a5c5[_0x223132(0xd2)],_0x5e1d2b=_0x594057/0x3e8*_0x96a5c5['output'];return{'success':![],'inputCost':_0x4e5fdd,'outputCost':_0x5e1d2b,'totalCost':_0x4e5fdd+_0x5e1d2b,'currency':'USD','unit':'1K\x20tokens','estimated':!![],'reason':_0x223132(0xf3)};}const _0x916a87=_0x204796/0x3e8*_0x68aa7e['input'],_0x49c012=_0x594057/0x3e8*_0x68aa7e['output'];return{'success':!![],'inputCost':_0x916a87,'outputCost':_0x49c012,'totalCost':_0x916a87+_0x49c012,'currency':_0x68aa7e[_0x223132(0x6e)],'unit':_0x68aa7e[_0x223132(0xef)],'estimated':![]};}['_getEstimatedPricing'](_0x60cfc1){const _0x5d8778=a0_0x2f6e05,_0x30dfa5=_0x60cfc1[_0x5d8778(0xf5)]();if(_0x30dfa5['includes']('opus')||_0x30dfa5[_0x5d8778(0x72)](_0x5d8778(0xc3)))return{'input':0.015,'output':0.075};else{if(_0x30dfa5['includes']('sonnet')||_0x30dfa5['includes'](_0x5d8778(0xfa)))return{'input':0.003,'output':0.015};else{if(_0x30dfa5['includes']('haiku')||_0x30dfa5[_0x5d8778(0x72)]('phi'))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}['_updateUsageData'](_0x42ca5c,_0x13178a,_0xf998,_0x918e13,_0x4074e9){const _0x5583fa=a0_0x2f6e05;this['usage']['totalInputTokens']+=_0xf998,this['usage'][_0x5583fa(0x78)]+=_0x918e13,this['usage']['totalCost']+=_0x4074e9,this['usage']['lastUpdated']=new Date()[_0x5583fa(0xf4)](),!this[_0x5583fa(0xb0)][_0x5583fa(0xd3)][_0x42ca5c]&&(this[_0x5583fa(0xb0)][_0x5583fa(0xd3)][_0x42ca5c]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x5583fa(0xb0)]['serviceUsage'][_0x42ca5c]['inputTokens']+=_0xf998,this['usage'][_0x5583fa(0xd3)][_0x42ca5c][_0x5583fa(0xbf)]+=_0x918e13,this['usage']['serviceUsage'][_0x42ca5c][_0x5583fa(0xe6)]+=_0x4074e9,this[_0x5583fa(0xb0)]['serviceUsage'][_0x42ca5c]['requestCount']+=0x1,!this['usage'][_0x5583fa(0xd4)][_0x13178a]&&(this[_0x5583fa(0xb0)][_0x5583fa(0xd4)][_0x13178a]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage'][_0x5583fa(0xd4)][_0x13178a]['inputTokens']+=_0xf998,this['usage'][_0x5583fa(0xd4)][_0x13178a]['outputTokens']+=_0x918e13,this[_0x5583fa(0xb0)]['modelUsage'][_0x13178a][_0x5583fa(0xe6)]+=_0x4074e9,this[_0x5583fa(0xb0)][_0x5583fa(0xd4)][_0x13178a]['requestCount']+=0x1;}['_checkBudgetStatus'](){const _0xc69bc3=a0_0x2f6e05,_0x47a61f={'withinBudget':!![],'budgetLimit':this['budgetLimit'],'totalSpent':this[_0xc69bc3(0xb0)]['totalCost'],'remainingBudget':null,'percentageUsed':null,'warningLevel':'normal'};if(this[_0xc69bc3(0xba)]!==null){_0x47a61f[_0xc69bc3(0xa6)]=Math[_0xc69bc3(0x6c)](0x0,this[_0xc69bc3(0xba)]-this['usage'][_0xc69bc3(0xd8)]),_0x47a61f['percentageUsed']=this['usage'][_0xc69bc3(0xd8)]/this[_0xc69bc3(0xba)]*0x64,_0x47a61f['withinBudget']=this[_0xc69bc3(0xb0)][_0xc69bc3(0xd8)]<=this[_0xc69bc3(0xba)];if(_0x47a61f['percentageUsed']>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x47a61f[_0xc69bc3(0x9d)]='critical';else _0x47a61f['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x47a61f[_0xc69bc3(0x9d)]=_0xc69bc3(0x91));_0x47a61f[_0xc69bc3(0x9d)]!==_0xc69bc3(0xbe)&&this['logger']['warn'](_0xc69bc3(0xd9)+_0x47a61f['warningLevel']+':\x20'+_0x47a61f[_0xc69bc3(0x70)]['toFixed'](0x1)+_0xc69bc3(0xbb),{'totalSpent':this[_0xc69bc3(0xb0)][_0xc69bc3(0xd8)],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x47a61f[_0xc69bc3(0xa6)]});if(!_0x47a61f[_0xc69bc3(0x98)]&&this[_0xc69bc3(0x104)]){const _0x59b79c=new Error(ERROR_MESSAGES[_0xc69bc3(0xfc)]+_0xc69bc3(0x6b)+this['usage']['totalCost']['toFixed'](0x2)+'\x20exceeds\x20limit\x20of\x20$'+this['budgetLimit'][_0xc69bc3(0x99)](0x2));_0x59b79c['code']='BUDGET_EXCEEDED',_0x59b79c[_0xc69bc3(0x88)]=_0x47a61f;throw _0x59b79c;}}return _0x47a61f;}async['setBudgetLimit'](_0x44fbd8){const _0xaa6e2a=a0_0x2f6e05,_0xc2d685=this['_validateBudgetAmount'](_0x44fbd8);this[_0xaa6e2a(0xba)]=_0xc2d685,this[_0xaa6e2a(0xa9)][_0xaa6e2a(0x10b)]=this[_0xaa6e2a(0xa9)]['budget']||{},this['config'][_0xaa6e2a(0x10b)][_0xaa6e2a(0xe8)]=_0xc2d685,this[_0xaa6e2a(0x105)]['info'](_0xaa6e2a(0xb8)+_0xc2d685['toFixed'](0x2),{'previousLimit':this[_0xaa6e2a(0xba)],'newLimit':_0xc2d685}),await this['saveUsageData']();}[a0_0x2f6e05(0xae)](_0x1db998){const _0x51a1b2=a0_0x2f6e05;if(typeof _0x1db998!=='number'||_0x1db998<0x0||!isFinite(_0x1db998))throw new Error(ERROR_MESSAGES[_0x51a1b2(0x8f)]);return _0x1db998;}async[a0_0x2f6e05(0x7c)](){const _0x647f03=a0_0x2f6e05;await this['updatePricingFromServer']();const _0x1916a0={'totalSpent':this['usage']['totalCost'],'budgetLimit':this['budgetLimit'],'inputTokens':this[_0x647f03(0xb0)][_0x647f03(0xec)],'outputTokens':this['usage'][_0x647f03(0x78)],'remainingBudget':this[_0x647f03(0xba)]!==null?Math['max'](0x0,this[_0x647f03(0xba)]-this['usage'][_0x647f03(0xd8)]):null,'percentageUsed':this['budgetLimit']!==null?this[_0x647f03(0xb0)]['totalCost']/this['budgetLimit']*0x64:null,'sessionStart':this[_0x647f03(0xb0)][_0x647f03(0xc9)],'lastUpdated':this[_0x647f03(0xb0)][_0x647f03(0x7b)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this[_0x647f03(0xeb)],'modelsWithPricing':this['pricingData']['size'],'source':this['serverLLMService']?_0x647f03(0x9f):'fallback'}};for(const [_0xaf1f96,_0x2383ba]of Object[_0x647f03(0xe3)](this['usage']['serviceUsage'])){_0x1916a0['breakdownByService'][_0xaf1f96]={'cost':_0x2383ba[_0x647f03(0xe6)],'inputTokens':_0x2383ba[_0x647f03(0x82)],'outputTokens':_0x2383ba[_0x647f03(0xbf)],'requestCount':_0x2383ba['requestCount']};}for(const [_0x3fd7fb,_0xf90630]of Object[_0x647f03(0xe3)](this[_0x647f03(0xb0)]['modelUsage'])){_0x1916a0['breakdownByModel'][_0x3fd7fb]={'cost':_0xf90630['cost'],'inputTokens':_0xf90630[_0x647f03(0x82)],'outputTokens':_0xf90630[_0x647f03(0xbf)],'requestCount':_0xf90630[_0x647f03(0x86)]};}return _0x1916a0;}async[a0_0x2f6e05(0xad)](){const _0x2bf5f3=a0_0x2f6e05,_0x2b034c=await this[_0x2bf5f3(0x7c)]();let _0x28b647=_0x2bf5f3(0xd7);_0x28b647+='Total\x20cost:\x20$'+_0x2b034c['totalSpent'][_0x2bf5f3(0x99)](0x4)+'\x0a',_0x28b647+=_0x2bf5f3(0xb2)+_0x2b034c[_0x2bf5f3(0x82)][_0x2bf5f3(0xfd)]()+'\x0a',_0x28b647+=_0x2bf5f3(0x67)+_0x2b034c['outputTokens'][_0x2bf5f3(0xfd)]()+'\x0a';_0x2b034c['budgetLimit']!==null&&(_0x28b647+='Budget\x20limit:\x20$'+_0x2b034c['budgetLimit'][_0x2bf5f3(0x99)](0x2)+'\x0a',_0x28b647+=_0x2bf5f3(0xc0)+_0x2b034c['remainingBudget'][_0x2bf5f3(0x99)](0x4)+'\x0a',_0x28b647+=_0x2bf5f3(0x101)+_0x2b034c[_0x2bf5f3(0x70)][_0x2bf5f3(0x99)](0x1)+'%\x0a');_0x28b647+='\x0aPricing\x20source:\x20'+_0x2b034c['pricingInfo'][_0x2bf5f3(0x73)]+'\x0a',_0x28b647+=_0x2bf5f3(0x8d)+_0x2b034c['pricingInfo'][_0x2bf5f3(0x80)]+'\x0a';if(Object['keys'](_0x2b034c['breakdownByService'])['length']>0x0){_0x28b647+=_0x2bf5f3(0x69);for(const [_0x1e3299,_0x187709]of Object[_0x2bf5f3(0xe3)](_0x2b034c['breakdownByService'])){_0x28b647+=_0x1e3299+':\x20$'+_0x187709[_0x2bf5f3(0xe6)][_0x2bf5f3(0x99)](0x4)+'\x20('+_0x187709[_0x2bf5f3(0x86)]+'\x20requests)\x0a';}}if(Object[_0x2bf5f3(0x87)](_0x2b034c[_0x2bf5f3(0x7d)])[_0x2bf5f3(0x9e)]>0x0){_0x28b647+='\x0a===\x20BREAKDOWN\x20BY\x20MODEL\x20===\x0a';for(const [_0x3408b0,_0x399283]of Object['entries'](_0x2b034c['breakdownByModel'])){_0x28b647+=_0x3408b0+_0x2bf5f3(0x6b)+_0x399283['cost'][_0x2bf5f3(0x99)](0x4)+'\x20('+_0x399283[_0x2bf5f3(0x86)]+'\x20requests)\x0a';}}return _0x28b647;}async[a0_0x2f6e05(0xe9)](){const _0x370fab=a0_0x2f6e05,_0x1063e2=0.1,_0x47207e=this['usage']['lastSavedCost']||0x0;this['usage']['totalCost']-_0x47207e>=_0x1063e2&&(await this[_0x370fab(0x7a)](),this['usage'][_0x370fab(0xee)]=this['usage'][_0x370fab(0xd8)]);}async['_loadUsageData'](){const _0x3aa930=a0_0x2f6e05;try{await this[_0x3aa930(0xde)]();const _0x105055=a0_0x31c6bd['join'](this['usageDir'],USAGE_FILENAME);try{const _0x533ff1=await a0_0x4e6021['readFile'](_0x105055,'utf-8'),_0x41f11b=JSON[_0x3aa930(0xb3)](_0x533ff1);this[_0x3aa930(0xb0)][_0x3aa930(0xec)]=_0x41f11b['totalInputTokens']||0x0,this[_0x3aa930(0xb0)][_0x3aa930(0x78)]=_0x41f11b['totalOutputTokens']||0x0,this['usage']['totalCost']=_0x41f11b[_0x3aa930(0xd8)]||0x0,this[_0x3aa930(0xb0)]['serviceUsage']=_0x41f11b[_0x3aa930(0xd3)]||{},this['usage'][_0x3aa930(0xd4)]=_0x41f11b[_0x3aa930(0xd4)]||{},this[_0x3aa930(0x105)]['info']('Loaded\x20previous\x20usage\x20data',{'totalCost':this[_0x3aa930(0xb0)]['totalCost'],'totalTokens':this['usage']['totalInputTokens']+this['usage']['totalOutputTokens']});}catch(_0x3e83d8){_0x3e83d8['code']!=='ENOENT'&&this['logger'][_0x3aa930(0x7f)](_0x3aa930(0xc5),_0x3e83d8);}}catch(_0xb02420){this['logger'][_0x3aa930(0x7f)](_0x3aa930(0x102),_0xb02420);}}async[a0_0x2f6e05(0xde)](){const _0x240269=a0_0x2f6e05;try{await a0_0x4e6021[_0x240269(0xaa)](this[_0x240269(0xdf)],{'recursive':!![]});}catch(_0x2f83ff){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x2f83ff['message']);}}async['saveUsageData'](){const _0x1ab011=a0_0x2f6e05;try{await this[_0x1ab011(0xde)](),this[_0x1ab011(0xb0)]['sessionEnd']=new Date()['toISOString']();const _0x4f30d8=a0_0x31c6bd[_0x1ab011(0xab)](this[_0x1ab011(0xdf)],USAGE_FILENAME);await a0_0x4e6021[_0x1ab011(0xc7)](_0x4f30d8,JSON['stringify'](this['usage'],null,0x2),'utf-8');const _0x131f36=a0_0x31c6bd['join'](this['usageDir'],''+SESSION_PREFIX+this[_0x1ab011(0xb0)]['sessionId']+_0x1ab011(0xa7));await a0_0x4e6021['writeFile'](_0x131f36,JSON[_0x1ab011(0xea)](this[_0x1ab011(0xb0)],null,0x2),_0x1ab011(0xa1)),await this[_0x1ab011(0x9c)](),this[_0x1ab011(0x105)]['info'](_0x1ab011(0xb5),{'totalCost':this[_0x1ab011(0xb0)]['totalCost'],'sessionId':this[_0x1ab011(0xb0)]['sessionId']});}catch(_0xf3c0a7){this[_0x1ab011(0x105)][_0x1ab011(0xa4)](_0x1ab011(0x79),_0xf3c0a7);throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0xf3c0a7['message']);}}async[a0_0x2f6e05(0x9c)](){const _0x197a3e=a0_0x2f6e05;try{const _0x3fa136=await a0_0x4e6021[_0x197a3e(0xe5)](this['usageDir']),_0x2734cf=_0x3fa136[_0x197a3e(0x84)](_0x1c60ca=>_0x1c60ca[_0x197a3e(0xa3)](SESSION_PREFIX)&&_0x1c60ca['endsWith'](_0x197a3e(0xa7)))['map'](_0x12a276=>({'name':_0x12a276,'path':a0_0x31c6bd['join'](this[_0x197a3e(0xdf)],_0x12a276)}));if(_0x2734cf['length']<=MAX_SESSION_FILES)return;const _0x511ab8=await Promise['all'](_0x2734cf[_0x197a3e(0x92)](async _0x42a640=>{const _0x38702f=_0x197a3e;try{const _0x477e98=await a0_0x4e6021['stat'](_0x42a640['path']);return{..._0x42a640,'mtime':_0x477e98[_0x38702f(0xcc)]};}catch(_0x3c9f7f){return null;}})),_0x1a3ca8=_0x511ab8['filter'](_0x2856e3=>_0x2856e3!==null)['sort']((_0x3732ce,_0x4028d4)=>_0x4028d4[_0x197a3e(0xcc)]-_0x3732ce['mtime']),_0x278293=_0x1a3ca8[_0x197a3e(0xc4)](MAX_SESSION_FILES);for(const _0x540faf of _0x278293){try{await a0_0x4e6021[_0x197a3e(0xbd)](_0x540faf['path']),this[_0x197a3e(0x105)][_0x197a3e(0xed)]('Removed\x20old\x20session\x20file:\x20'+_0x540faf['name']);}catch(_0x486312){this[_0x197a3e(0x105)][_0x197a3e(0x7f)](_0x197a3e(0x9b)+_0x540faf[_0x197a3e(0xfe)]+':',_0x486312);}}_0x278293[_0x197a3e(0x9e)]>0x0&&this[_0x197a3e(0x105)]['info']('Cleaned\x20up\x20'+_0x278293['length']+_0x197a3e(0xce));}catch(_0x22311f){this[_0x197a3e(0x105)]['warn']('Failed\x20to\x20cleanup\x20old\x20session\x20files:',_0x22311f);}}async['resetUsageData'](_0x552402=![]){const _0xca2465=a0_0x2f6e05;this['logger']['info'](_0xca2465(0xb7),{'preserveTotal':_0x552402});if(!_0x552402)this['usage']=this[_0xca2465(0xb1)]();else{const _0x5630c8=this['usage']['totalCost'],_0x491ad0=this['usage'][_0xca2465(0xec)],_0x2f9ce0=this['usage'][_0xca2465(0x78)];this['usage']=this[_0xca2465(0xb1)](),this['usage']['totalCost']=_0x5630c8,this['usage'][_0xca2465(0xec)]=_0x491ad0,this[_0xca2465(0xb0)][_0xca2465(0x78)]=_0x2f9ce0;}await this[_0xca2465(0x7a)]();}async[a0_0x2f6e05(0xe1)](_0x1d28a=a0_0x2f6e05(0x95)){const _0x379525=a0_0x2f6e05,_0x2b5d68=await this['getBudgetUsage']();if(_0x1d28a==='csv')return this[_0x379525(0x75)](_0x2b5d68);return JSON['stringify'](_0x2b5d68,null,0x2);}['_exportToCsv'](_0x5bfdc1){const _0x2752fa=a0_0x2f6e05,_0x20429d=[_0x2752fa(0x77)];for(const [_0x3e187b,_0x4483d2]of Object['entries'](_0x5bfdc1[_0x2752fa(0xa0)])){_0x20429d['push'](_0x2752fa(0xf7)+_0x3e187b+','+_0x4483d2['cost']+','+_0x4483d2['inputTokens']+','+_0x4483d2['outputTokens']+','+_0x4483d2[_0x2752fa(0x86)]);}for(const [_0x100e5e,_0x168c8f]of Object['entries'](_0x5bfdc1[_0x2752fa(0x7d)])){_0x20429d['push']('Model,'+_0x100e5e+','+_0x168c8f['cost']+','+_0x168c8f['inputTokens']+','+_0x168c8f[_0x2752fa(0xbf)]+','+_0x168c8f['requestCount']);}return _0x20429d['join']('\x0a');}[a0_0x2f6e05(0xc8)](_0x19dc6a,_0x473ba2,_0x1b8ae5){const _0x53d046=a0_0x2f6e05;this['_validateUsageInputs']('estimate',_0x19dc6a,_0x473ba2,_0x1b8ae5);const _0x4599cd=this['_calculateCost'](_0x19dc6a,_0x473ba2,_0x1b8ae5),_0x22b6a5={'model':_0x19dc6a,'estimatedInputTokens':_0x473ba2,'estimatedOutputTokens':_0x1b8ae5,'estimatedCost':_0x4599cd['totalCost'],..._0x4599cd,'budgetImpact':null};if(this[_0x53d046(0xba)]!==null){const _0x34761d=this['usage']['totalCost']+_0x4599cd['totalCost'];_0x22b6a5['budgetImpact']={'currentSpent':this[_0x53d046(0xb0)][_0x53d046(0xd8)],'afterOperation':_0x34761d,'remainingAfter':Math['max'](0x0,this[_0x53d046(0xba)]-_0x34761d),'wouldExceedBudget':_0x34761d>this['budgetLimit'],'percentageAfter':_0x34761d/this['budgetLimit']*0x64};}return _0x22b6a5;}['checkBudgetForOperation'](_0x47770d,_0x1b21f2,_0x124950){const _0x5d81b6=a0_0x2f6e05,_0x2cc324=this[_0x5d81b6(0xc8)](_0x47770d,_0x1b21f2,_0x124950);return{'canProceed':this['budgetLimit']===null||!_0x2cc324['budgetImpact']?.['wouldExceedBudget'],'estimate':_0x2cc324,'recommendation':this['_getBudgetRecommendation'](_0x2cc324)};}['_getBudgetRecommendation'](_0x2ce0f4){const _0x537178=a0_0x2f6e05;if(this['budgetLimit']===null)return'No\x20budget\x20limit\x20set.\x20Consider\x20setting\x20a\x20budget\x20for\x20cost\x20control.';if(!_0x2ce0f4['budgetImpact'])return _0x537178(0x76);const {percentageAfter:_0x15590c,wouldExceedBudget:_0x57dc2a}=_0x2ce0f4[_0x537178(0x6f)];if(_0x57dc2a)return'Operation\x20would\x20exceed\x20budget\x20limit.\x20Consider\x20increasing\x20budget\x20or\x20using\x20a\x20less\x20expensive\x20model.';if(_0x15590c>BUDGET_CRITICAL_THRESHOLD*0x64)return'Operation\x20would\x20use\x20most\x20of\x20your\x20budget.\x20Monitor\x20usage\x20carefully.';if(_0x15590c>BUDGET_WARNING_THRESHOLD*0x64)return _0x537178(0xf8);return _0x537178(0x8b);}[a0_0x2f6e05(0xcd)](){const _0x5c0715=a0_0x2f6e05,_0x51af58=Array[_0x5c0715(0xf0)](this[_0x5c0715(0x74)]['entries']())[_0x5c0715(0x92)](([_0x2c12a4,_0x2f47b1])=>({'model':_0x2c12a4,'inputPrice':_0x2f47b1['input'],'outputPrice':_0x2f47b1['output'],'unit':_0x2f47b1[_0x5c0715(0xef)],'currency':_0x2f47b1[_0x5c0715(0x6e)]}));return{'models':_0x51af58,'lastUpdate':this['lastPricingUpdate'],'source':this[_0x5c0715(0xf6)]?'server':'fallback','totalModels':this[_0x5c0715(0x74)][_0x5c0715(0x89)]};}async['healthCheck'](){const _0x515e57=a0_0x2f6e05,_0x490702={'status':_0x515e57(0x100),'issues':[],'metrics':{'totalCost':this['usage'][_0x515e57(0xd8)],'totalTokens':this[_0x515e57(0xb0)]['totalInputTokens']+this['usage']['totalOutputTokens'],'modelsWithPricing':this['pricingData'][_0x515e57(0x89)],'budgetLimit':this[_0x515e57(0xba)]}};try{await this[_0x515e57(0xde)]();const _0x3a00a7=a0_0x31c6bd['join'](this['usageDir'],_0x515e57(0xac));await a0_0x4e6021['writeFile'](_0x3a00a7,_0x515e57(0xe0)),await a0_0x4e6021[_0x515e57(0xbd)](_0x3a00a7);}catch(_0x4dd6eb){_0x490702[_0x515e57(0x81)]=_0x515e57(0x6a),_0x490702[_0x515e57(0x9a)][_0x515e57(0x90)](_0x515e57(0xcb));}this['pricingData']['size']===0x0&&(_0x490702[_0x515e57(0x81)]='degraded',_0x490702['issues']['push']('No\x20pricing\x20data\x20available'));if(this['lastPricingUpdate']){const _0x35ad97=(Date[_0x515e57(0xdd)]()-new Date(this[_0x515e57(0xeb)])[_0x515e57(0xd5)]())/(0x3e8*0x3c*0x3c);_0x35ad97>0x18&&_0x490702[_0x515e57(0x9a)][_0x515e57(0x90)](_0x515e57(0xe4));}if(this['budgetLimit']!==null){const _0x909968=this['_checkBudgetStatus']();_0x909968['warningLevel']!==_0x515e57(0xbe)&&_0x490702[_0x515e57(0x9a)][_0x515e57(0x90)](_0x515e57(0xd9)+_0x909968[_0x515e57(0x9d)]+':\x20'+_0x909968['percentageUsed'][_0x515e57(0x99)](0x1)+'%\x20used');}return _0x490702['issues'][_0x515e57(0x9e)]>0x0&&_0x490702['status']===_0x515e57(0x100)&&(_0x490702['status']=_0x515e57(0x91)),_0x490702;}async[a0_0x2f6e05(0xda)](){const _0x4095e1=a0_0x2f6e05;this['logger'][_0x4095e1(0xd1)](_0x4095e1(0xc1));try{await this[_0x4095e1(0x7a)](),this['pricingData']['clear'](),this['logger'][_0x4095e1(0xd1)]('Budget\x20service\x20shut\x20down\x20successfully');}catch(_0x2cbf65){this[_0x4095e1(0x105)][_0x4095e1(0xa4)](_0x4095e1(0x68),_0x2cbf65);throw _0x2cbf65;}}}