const a0_0x559715=a0_0x1172;function a0_0x1172(_0xdf2900,_0x522675){const _0x2cba17=a0_0x2cba();return a0_0x1172=function(_0x117292,_0x3e5733){_0x117292=_0x117292-0x12e;let _0x457760=_0x2cba17[_0x117292];if(a0_0x1172['YpuPWA']===undefined){var _0x4b2a03=function(_0xe073ae){const _0x49c32a='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x13a2ac='',_0x57eee9='';for(let _0x279253=0x0,_0x2bb719,_0x5b9001,_0x2f89a5=0x0;_0x5b9001=_0xe073ae['charAt'](_0x2f89a5++);~_0x5b9001&&(_0x2bb719=_0x279253%0x4?_0x2bb719*0x40+_0x5b9001:_0x5b9001,_0x279253++%0x4)?_0x13a2ac+=String['fromCharCode'](0xff&_0x2bb719>>(-0x2*_0x279253&0x6)):0x0){_0x5b9001=_0x49c32a['indexOf'](_0x5b9001);}for(let _0x46cb98=0x0,_0x3371c3=_0x13a2ac['length'];_0x46cb98<_0x3371c3;_0x46cb98++){_0x57eee9+='%'+('00'+_0x13a2ac['charCodeAt'](_0x46cb98)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x57eee9);};a0_0x1172['HzQOcU']=_0x4b2a03,_0xdf2900=arguments,a0_0x1172['YpuPWA']=!![];}const _0x56976d=_0x2cba17[0x0],_0x45b57c=_0x117292+_0x56976d,_0x2fcfb6=_0xdf2900[_0x45b57c];return!_0x2fcfb6?(_0x457760=a0_0x1172['HzQOcU'](_0x457760),_0xdf2900[_0x45b57c]=_0x457760):_0x457760=_0x2fcfb6,_0x457760;},a0_0x1172(_0xdf2900,_0x522675);}(function(_0x50a39,_0x52eef1){const _0xb640a4=a0_0x1172,_0x297cb0=_0x50a39();while(!![]){try{const _0xc83285=parseInt(_0xb640a4(0x197))/0x1*(-parseInt(_0xb640a4(0x16b))/0x2)+parseInt(_0xb640a4(0x136))/0x3+-parseInt(_0xb640a4(0x138))/0x4+-parseInt(_0xb640a4(0x199))/0x5+parseInt(_0xb640a4(0x14e))/0x6*(parseInt(_0xb640a4(0x135))/0x7)+-parseInt(_0xb640a4(0x180))/0x8*(-parseInt(_0xb640a4(0x169))/0x9)+-parseInt(_0xb640a4(0x198))/0xa*(parseInt(_0xb640a4(0x157))/0xb);if(_0xc83285===_0x52eef1)break;else _0x297cb0['push'](_0x297cb0['shift']());}catch(_0x18e7c2){_0x297cb0['push'](_0x297cb0['shift']());}}}(a0_0x2cba,0xb1384));import{promises as a0_0xe073ae}from'fs';import a0_0x49c32a from'path';const DEFAULT_USAGE_DIR='./.loxia-budget',USAGE_FILENAME='usage.json',SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':'Budget\x20amount\x20must\x20be\x20a\x20positive\x20number','INVALID_TOKENS':'Token\x20counts\x20must\x20be\x20non-negative\x20numbers','INVALID_SERVICE':a0_0x559715(0x15f),'BUDGET_EXCEEDED':a0_0x559715(0x191),'PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':'File\x20system\x20operation\x20failed'};export class BudgetService{constructor(_0x13a2ac,_0x57eee9,_0x279253=null){const _0x5c3d5f=a0_0x559715;this[_0x5c3d5f(0x1ba)]=_0x13a2ac,this[_0x5c3d5f(0x195)]=_0x57eee9,this['serverLLMService']=_0x279253,this['usage']=this[_0x5c3d5f(0x182)](),this[_0x5c3d5f(0x14f)]=this[_0x5c3d5f(0x185)](),this['hardLimit']=_0x13a2ac[_0x5c3d5f(0x14b)]?.[_0x5c3d5f(0x152)]||![],this['pricingData']=new Map(),this[_0x5c3d5f(0x18f)]=null,this[_0x5c3d5f(0x184)]=![],this[_0x5c3d5f(0x1ad)]=_0x13a2ac[_0x5c3d5f(0x14b)]?.[_0x5c3d5f(0x1ad)]||DEFAULT_USAGE_DIR,this[_0x5c3d5f(0x195)][_0x5c3d5f(0x1a7)]('Budget\x20service\x20initialized',{'budgetLimit':this[_0x5c3d5f(0x14f)],'hardLimit':this['hardLimit'],'usageDir':this['usageDir'],'hasPricingService':!!this[_0x5c3d5f(0x1aa)]}),this['_loadUsageData']()[_0x5c3d5f(0x16f)](_0x2bb719=>{const _0x2b6f00=_0x5c3d5f;this[_0x2b6f00(0x195)]['warn']('Failed\x20to\x20load\x20previous\x20usage\x20data:',_0x2bb719);});}['_initializeUsageData'](){const _0x3d2caa=a0_0x559715;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()[_0x3d2caa(0x1b4)](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()['toISOString']()};}[a0_0x559715(0x168)](){const _0x2b93ac=a0_0x559715,_0x5b9001=Date['now']()['toString'](0x24),_0x2f89a5=Math[_0x2b93ac(0x13f)]()[_0x2b93ac(0x15c)](0x24)[_0x2b93ac(0x16c)](0x2);return _0x5b9001+'_'+_0x2f89a5;}[a0_0x559715(0x185)](){const _0xb2fb39=a0_0x559715,_0x46cb98=this[_0xb2fb39(0x1ba)]['budget']?.[_0xb2fb39(0x17c)];if(_0x46cb98!==undefined&&_0x46cb98!==null)return this['_validateBudgetAmount'](_0x46cb98);return null;}async['updatePricingFromServer'](){const _0xf00837=a0_0x559715;if(!this['serverLLMService'])return this[_0xf00837(0x195)][_0xf00837(0x192)]('No\x20server\x20LLM\x20service\x20available\x20for\x20pricing\x20updates'),![];if(this['pricingUpdateInProgress'])return this[_0xf00837(0x195)]['debug']('Pricing\x20update\x20already\x20in\x20progress'),![];if(!this['_shouldUpdatePricing']())return!![];this['pricingUpdateInProgress']=!![];try{this['logger']['info']('Updating pricing data from server');const _0x3371c3=await this[_0xf00837(0x1aa)]['getPricingData']();if(_0x3371c3[_0xf00837(0x172)]===0x0)return this['logger'][_0xf00837(0x170)]('No pricing data received from server'),![];this['pricingData']['clear']();for(const [_0x26ec31,_0x5f53ef]of _0x3371c3[_0xf00837(0x1cb)]()){this[_0xf00837(0x139)]['set'](_0x26ec31,{'input':_0x5f53ef[_0xf00837(0x1bc)],'output':_0x5f53ef['output'],'unit':_0x5f53ef['unit']||'1K\x20tokens','currency':_0x5f53ef[_0xf00837(0x196)]||'USD'});}return this[_0xf00837(0x18f)]=new Date()['toISOString'](),this['logger'][_0xf00837(0x1a7)]('Updated\x20pricing\x20for\x20'+this['pricingData']['size']+'\x20models\x20from\x20server'),!![];}catch(_0x35b30d){return this[_0xf00837(0x195)][_0xf00837(0x17e)]('Failed to update pricing from server:',_0x35b30d),![];}finally{this['pricingUpdateInProgress']=![];}}[a0_0x559715(0x1bd)](){const _0x15201b=a0_0x559715;if(!this[_0x15201b(0x18f)])return!![];const _0x7c4f07=Date[_0x15201b(0x156)]()-new Date(this[_0x15201b(0x18f)])['getTime']();return _0x7c4f07>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0x414176){const _0x51000f=a0_0x559715;if(!_0x414176||typeof _0x414176!=='string')return this['logger']['warn']('Invalid\x20model\x20name\x20provided\x20for\x20pricing\x20lookup'),null;return this['pricingData'][_0x51000f(0x14d)](_0x414176)||null;}[a0_0x559715(0x153)](){return this['serverLLMService']['getPricingData']();}async['recordUsage'](_0xb0ccbe,_0xc52378,_0x1f0b8c,_0x272fcd){const _0x3df5ca=a0_0x559715;this[_0x3df5ca(0x195)][_0x3df5ca(0x1a7)](_0x3df5ca(0x1bb)+_0xb0ccbe+'/'+_0xc52378,{'inputTokens':_0x1f0b8c,'outputTokens':_0x272fcd,'service':_0xb0ccbe,'model':_0xc52378}),this['_validateUsageInputs'](_0xb0ccbe,_0xc52378,_0x1f0b8c,_0x272fcd),await this[_0x3df5ca(0x1bf)]();const _0x4154d7=this[_0x3df5ca(0x1b5)](_0xc52378,_0x1f0b8c,_0x272fcd);!_0x4154d7[_0x3df5ca(0x158)]&&this[_0x3df5ca(0x195)]['warn']('Pricing\x20unavailable\x20for\x20model\x20'+_0xc52378+',\x20using\x20estimate');this['_updateUsageData'](_0xb0ccbe,_0xc52378,_0x1f0b8c,_0x272fcd,_0x4154d7[_0x3df5ca(0x141)]);const _0x43ad4b=this[_0x3df5ca(0x171)]();await this[_0x3df5ca(0x1be)]();const _0x3e66f1={'service':_0xb0ccbe,'model':_0xc52378,'inputTokens':_0x1f0b8c,'outputTokens':_0x272fcd,'cost':_0x4154d7,'budgetStatus':_0x43ad4b,'timestamp':new Date()[_0x3df5ca(0x1b4)]()};return this[_0x3df5ca(0x195)]['debug']('Usage\x20recorded\x20successfully',_0x3e66f1),_0x3e66f1;}[a0_0x559715(0x17d)](_0x346f85,_0xb6daa5,_0xd1161,_0x41787b){const _0x27d56b=a0_0x559715;if(!_0x346f85||typeof _0x346f85!==_0x27d56b(0x1b7))throw new Error(ERROR_MESSAGES['INVALID_SERVICE']);if(!_0xb6daa5||typeof _0xb6daa5!==_0x27d56b(0x1b7))throw new Error('Model\x20name\x20must\x20be\x20a\x20non-empty\x20string');if(typeof _0xd1161!==_0x27d56b(0x134)||_0xd1161<0x0)throw new Error(ERROR_MESSAGES[_0x27d56b(0x144)]);if(typeof _0x41787b!=='number'||_0x41787b<0x0)throw new Error(ERROR_MESSAGES[_0x27d56b(0x144)]);}['_calculateCost'](_0x270454,_0x350685,_0x44c366){const _0x5ad2be=a0_0x559715,_0x265a3f=this['getModelPricing'](_0x270454);if(!_0x265a3f){const _0x4e0608=this['_getEstimatedPricing'](_0x270454),_0x4cc0a1=_0x350685/0x3e8*_0x4e0608[_0x5ad2be(0x1bc)],_0x10a0a7=_0x44c366/0x3e8*_0x4e0608[_0x5ad2be(0x1b6)];return{'success':![],'inputCost':_0x4cc0a1,'outputCost':_0x10a0a7,'totalCost':_0x4cc0a1+_0x10a0a7,'currency':_0x5ad2be(0x1b3),'unit':'1K\x20tokens','estimated':!![],'reason':_0x5ad2be(0x160)};}const _0x5bbd59=_0x350685/0x3e8*_0x265a3f[_0x5ad2be(0x1bc)],_0x26903b=_0x44c366/0x3e8*_0x265a3f[_0x5ad2be(0x1b6)];return{'success':!![],'inputCost':_0x5bbd59,'outputCost':_0x26903b,'totalCost':_0x5bbd59+_0x26903b,'currency':_0x265a3f['currency'],'unit':_0x265a3f[_0x5ad2be(0x1c1)],'estimated':![]};}[a0_0x559715(0x16e)](_0x181084){const _0x163040=a0_0x559715,_0x59f123=_0x181084['toLowerCase']();if(_0x59f123['includes'](_0x163040(0x150))||_0x59f123[_0x163040(0x1ac)]('gpt-4'))return{'input':0.015,'output':0.075};else{if(_0x59f123[_0x163040(0x1ac)]('sonnet')||_0x59f123['includes'](_0x163040(0x1a6)))return{'input':0.003,'output':0.015};else{if(_0x59f123['includes']('haiku')||_0x59f123['includes'](_0x163040(0x1c9)))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}[a0_0x559715(0x161)](_0xc956c,_0x4c8ba9,_0x21132a,_0x1c9e7e,_0x2ddeb4){const _0x27177b=a0_0x559715;this['usage']['totalInputTokens']+=_0x21132a,this[_0x27177b(0x165)][_0x27177b(0x1a2)]+=_0x1c9e7e,this['usage'][_0x27177b(0x141)]+=_0x2ddeb4,this['usage'][_0x27177b(0x1b8)]=new Date()['toISOString'](),!this['usage'][_0x27177b(0x164)][_0xc956c]&&(this['usage'][_0x27177b(0x164)][_0xc956c]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0x27177b(0x165)][_0x27177b(0x164)][_0xc956c][_0x27177b(0x18b)]+=_0x21132a,this['usage'][_0x27177b(0x164)][_0xc956c][_0x27177b(0x193)]+=_0x1c9e7e,this['usage']['serviceUsage'][_0xc956c][_0x27177b(0x194)]+=_0x2ddeb4,this['usage']['serviceUsage'][_0xc956c][_0x27177b(0x18d)]+=0x1,!this['usage'][_0x27177b(0x15d)][_0x4c8ba9]&&(this[_0x27177b(0x165)][_0x27177b(0x15d)][_0x4c8ba9]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this['usage'][_0x27177b(0x15d)][_0x4c8ba9][_0x27177b(0x18b)]+=_0x21132a,this['usage'][_0x27177b(0x15d)][_0x4c8ba9]['outputTokens']+=_0x1c9e7e,this['usage']['modelUsage'][_0x4c8ba9]['cost']+=_0x2ddeb4,this[_0x27177b(0x165)]['modelUsage'][_0x4c8ba9][_0x27177b(0x18d)]+=0x1;}[a0_0x559715(0x171)](){const _0x4c68c5=a0_0x559715,_0x206e36={'withinBudget':!![],'budgetLimit':this['budgetLimit'],'totalSpent':this[_0x4c68c5(0x165)][_0x4c68c5(0x141)],'remainingBudget':null,'percentageUsed':null,'warningLevel':'normal'};if(this['budgetLimit']!==null){_0x206e36[_0x4c68c5(0x147)]=Math['max'](0x0,this[_0x4c68c5(0x14f)]-this['usage'][_0x4c68c5(0x141)]),_0x206e36['percentageUsed']=this[_0x4c68c5(0x165)][_0x4c68c5(0x141)]/this['budgetLimit']*0x64,_0x206e36['withinBudget']=this['usage'][_0x4c68c5(0x141)]<=this[_0x4c68c5(0x14f)];if(_0x206e36[_0x4c68c5(0x188)]>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x206e36['warningLevel']=_0x4c68c5(0x1c3);else _0x206e36[_0x4c68c5(0x188)]>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x206e36['warningLevel']=_0x4c68c5(0x1cc));_0x206e36['warningLevel']!==_0x4c68c5(0x1b0)&&this[_0x4c68c5(0x195)]['warn'](_0x4c68c5(0x142)+_0x206e36['warningLevel']+':\x20'+_0x206e36[_0x4c68c5(0x188)][_0x4c68c5(0x176)](0x1)+'%\x20used',{'totalSpent':this['usage']['totalCost'],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x206e36['remainingBudget']});if(!_0x206e36[_0x4c68c5(0x18a)]&&this[_0x4c68c5(0x152)]){const _0x4b8a58=new Error(ERROR_MESSAGES['BUDGET_EXCEEDED']+':\x20$'+this['usage'][_0x4c68c5(0x141)][_0x4c68c5(0x176)](0x2)+'\x20exceeds\x20limit\x20of\x20$'+this['budgetLimit'][_0x4c68c5(0x176)](0x2));_0x4b8a58['code']=_0x4c68c5(0x133),_0x4b8a58[_0x4c68c5(0x1a1)]=_0x206e36;throw _0x4b8a58;}}return _0x206e36;}async[a0_0x559715(0x151)](_0x38418e){const _0x41aec1=a0_0x559715,_0x2d8ef2=this['_validateBudgetAmount'](_0x38418e);this['budgetLimit']=_0x2d8ef2,this[_0x41aec1(0x1ba)][_0x41aec1(0x14b)]=this['config'][_0x41aec1(0x14b)]||{},this[_0x41aec1(0x1ba)][_0x41aec1(0x14b)]['limit']=_0x2d8ef2,this[_0x41aec1(0x195)]['info']('Budget\x20limit\x20set\x20to\x20$'+_0x2d8ef2[_0x41aec1(0x176)](0x2),{'previousLimit':this['budgetLimit'],'newLimit':_0x2d8ef2}),await this[_0x41aec1(0x166)]();}[a0_0x559715(0x1ae)](_0x56a1e9){const _0x3ece9d=a0_0x559715;if(typeof _0x56a1e9!==_0x3ece9d(0x134)||_0x56a1e9<0x0||!isFinite(_0x56a1e9))throw new Error(ERROR_MESSAGES[_0x3ece9d(0x13e)]);return _0x56a1e9;}async['getBudgetUsage'](){const _0x1531fc=a0_0x559715;await this['updatePricingFromServer']();const _0xc3c2cb={'totalSpent':this[_0x1531fc(0x165)][_0x1531fc(0x141)],'budgetLimit':this['budgetLimit'],'inputTokens':this['usage'][_0x1531fc(0x146)],'outputTokens':this[_0x1531fc(0x165)][_0x1531fc(0x1a2)],'remainingBudget':this[_0x1531fc(0x14f)]!==null?Math[_0x1531fc(0x15b)](0x0,this[_0x1531fc(0x14f)]-this[_0x1531fc(0x165)]['totalCost']):null,'percentageUsed':this[_0x1531fc(0x14f)]!==null?this['usage'][_0x1531fc(0x141)]/this[_0x1531fc(0x14f)]*0x64:null,'sessionStart':this[_0x1531fc(0x165)][_0x1531fc(0x1c7)],'lastUpdated':this['usage'][_0x1531fc(0x1b8)],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this[_0x1531fc(0x18f)],'modelsWithPricing':this['pricingData'][_0x1531fc(0x172)],'source':this[_0x1531fc(0x1aa)]?'server':'fallback'}};for(const [_0x265566,_0x464151]of Object[_0x1531fc(0x1cb)](this[_0x1531fc(0x165)][_0x1531fc(0x164)])){_0xc3c2cb[_0x1531fc(0x1c0)][_0x265566]={'cost':_0x464151[_0x1531fc(0x194)],'inputTokens':_0x464151['inputTokens'],'outputTokens':_0x464151['outputTokens'],'requestCount':_0x464151['requestCount']};}for(const [_0x2f1de9,_0x512f75]of Object['entries'](this[_0x1531fc(0x165)][_0x1531fc(0x15d)])){_0xc3c2cb['breakdownByModel'][_0x2f1de9]={'cost':_0x512f75[_0x1531fc(0x194)],'inputTokens':_0x512f75['inputTokens'],'outputTokens':_0x512f75['outputTokens'],'requestCount':_0x512f75[_0x1531fc(0x18d)]};}return _0xc3c2cb;}async[a0_0x559715(0x16d)](){const _0x30e3aa=a0_0x559715,_0xffcdbf=await this[_0x30e3aa(0x15e)]();let _0x580177=_0x30e3aa(0x155);_0x580177+=_0x30e3aa(0x159)+_0xffcdbf[_0x30e3aa(0x17f)][_0x30e3aa(0x176)](0x4)+'\x0a',_0x580177+=_0x30e3aa(0x18e)+_0xffcdbf[_0x30e3aa(0x18b)][_0x30e3aa(0x177)]()+'\x0a',_0x580177+='Total\x20output\x20tokens:\x20'+_0xffcdbf[_0x30e3aa(0x193)][_0x30e3aa(0x177)]()+'\x0a';_0xffcdbf[_0x30e3aa(0x14f)]!==null&&(_0x580177+='Budget\x20limit:\x20$'+_0xffcdbf[_0x30e3aa(0x14f)]['toFixed'](0x2)+'\x0a',_0x580177+=_0x30e3aa(0x167)+_0xffcdbf['remainingBudget'][_0x30e3aa(0x176)](0x4)+'\x0a',_0x580177+='Usage:\x20'+_0xffcdbf[_0x30e3aa(0x188)]['toFixed'](0x1)+'%\x0a');_0x580177+='\x0aPricing\x20source:\x20'+_0xffcdbf[_0x30e3aa(0x189)][_0x30e3aa(0x1b1)]+'\x0a',_0x580177+=_0x30e3aa(0x1a3)+_0xffcdbf[_0x30e3aa(0x189)][_0x30e3aa(0x18c)]+'\x0a';if(Object[_0x30e3aa(0x132)](_0xffcdbf[_0x30e3aa(0x1c0)])['length']>0x0){_0x580177+='\x0a===\x20BREAKDOWN\x20BY\x20SERVICE\x20===\x0a';for(const [_0x1f2b2a,_0x301c95]of Object[_0x30e3aa(0x1cb)](_0xffcdbf[_0x30e3aa(0x1c0)])){_0x580177+=_0x1f2b2a+':\x20$'+_0x301c95[_0x30e3aa(0x194)]['toFixed'](0x4)+'\x20('+_0x301c95['requestCount']+_0x30e3aa(0x14a);}}if(Object[_0x30e3aa(0x132)](_0xffcdbf['breakdownByModel'])['length']>0x0){_0x580177+=_0x30e3aa(0x187);for(const [_0x65f7f6,_0x5962a5]of Object[_0x30e3aa(0x1cb)](_0xffcdbf['breakdownByModel'])){_0x580177+=_0x65f7f6+':\x20$'+_0x5962a5[_0x30e3aa(0x194)][_0x30e3aa(0x176)](0x4)+'\x20('+_0x5962a5[_0x30e3aa(0x18d)]+'\x20requests)\x0a';}}return _0x580177;}async['_saveUsageDataIfNeeded'](){const _0x56997d=a0_0x559715,_0x10d6a1=0.1,_0x4e2a64=this['usage'][_0x56997d(0x1cd)]||0x0;this['usage'][_0x56997d(0x141)]-_0x4e2a64>=_0x10d6a1&&(await this['saveUsageData'](),this[_0x56997d(0x165)][_0x56997d(0x1cd)]=this['usage']['totalCost']);}async[a0_0x559715(0x181)](){const _0x306457=a0_0x559715;try{await this[_0x306457(0x145)]();const _0x282ffa=a0_0x49c32a['join'](this[_0x306457(0x1ad)],USAGE_FILENAME);try{const _0x6620ca=await a0_0xe073ae[_0x306457(0x137)](_0x282ffa,'utf-8'),_0x34fbec=JSON[_0x306457(0x17a)](_0x6620ca);this[_0x306457(0x165)]['totalInputTokens']=_0x34fbec[_0x306457(0x146)]||0x0,this[_0x306457(0x165)][_0x306457(0x1a2)]=_0x34fbec['totalOutputTokens']||0x0,this[_0x306457(0x165)]['totalCost']=_0x34fbec[_0x306457(0x141)]||0x0,this[_0x306457(0x165)][_0x306457(0x164)]=_0x34fbec[_0x306457(0x164)]||{},this['usage'][_0x306457(0x15d)]=_0x34fbec['modelUsage']||{},this[_0x306457(0x195)][_0x306457(0x1a7)](_0x306457(0x148),{'totalCost':this['usage']['totalCost'],'totalTokens':this[_0x306457(0x165)]['totalInputTokens']+this[_0x306457(0x165)]['totalOutputTokens']});}catch(_0x462a1d){_0x462a1d['code']!==_0x306457(0x179)&&this[_0x306457(0x195)]['warn']('Failed\x20to\x20load\x20usage\x20data:',_0x462a1d);}}catch(_0x558434){this['logger'][_0x306457(0x170)](_0x306457(0x19f),_0x558434);}}async['_ensureUsageDirectory'](){const _0x3b39c3=a0_0x559715;try{await a0_0xe073ae['mkdir'](this[_0x3b39c3(0x1ad)],{'recursive':!![]});}catch(_0x9d08a3){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x9d08a3['message']);}}async['saveUsageData'](){const _0x19c095=a0_0x559715;try{await this[_0x19c095(0x145)](),this['usage'][_0x19c095(0x175)]=new Date()['toISOString']();const _0x2c3a92=a0_0x49c32a['join'](this[_0x19c095(0x1ad)],USAGE_FILENAME);await a0_0xe073ae['writeFile'](_0x2c3a92,JSON['stringify'](this[_0x19c095(0x165)],null,0x2),_0x19c095(0x174));const _0x55c8ab=a0_0x49c32a['join'](this[_0x19c095(0x1ad)],''+SESSION_PREFIX+this[_0x19c095(0x165)][_0x19c095(0x1a0)]+'.json');await a0_0xe073ae[_0x19c095(0x1c2)](_0x55c8ab,JSON['stringify'](this[_0x19c095(0x165)],null,0x2),_0x19c095(0x174)),await this['_cleanupOldSessionFiles'](),this[_0x19c095(0x195)][_0x19c095(0x1a7)](_0x19c095(0x19c),{'totalCost':this[_0x19c095(0x165)][_0x19c095(0x141)],'sessionId':this[_0x19c095(0x165)][_0x19c095(0x1a0)]});}catch(_0x153224){this[_0x19c095(0x195)]['error'](_0x19c095(0x1b2),_0x153224);throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x153224['message']);}}async['_cleanupOldSessionFiles'](){const _0x250b1b=a0_0x559715;try{const _0xe327c9=await a0_0xe073ae[_0x250b1b(0x154)](this['usageDir']),_0x22f481=_0xe327c9['filter'](_0x512101=>_0x512101[_0x250b1b(0x163)](SESSION_PREFIX)&&_0x512101['endsWith']('.json'))[_0x250b1b(0x149)](_0x10cc1f=>({'name':_0x10cc1f,'path':a0_0x49c32a['join'](this['usageDir'],_0x10cc1f)}));if(_0x22f481[_0x250b1b(0x15a)]<=MAX_SESSION_FILES)return;const _0x59e395=await Promise[_0x250b1b(0x1ca)](_0x22f481[_0x250b1b(0x149)](async _0x1fbee2=>{const _0x5a9171=_0x250b1b;try{const _0x2c6d50=await a0_0xe073ae['stat'](_0x1fbee2[_0x5a9171(0x1b9)]);return{..._0x1fbee2,'mtime':_0x2c6d50[_0x5a9171(0x1af)]};}catch(_0x1f7a53){return null;}})),_0x31efa2=_0x59e395[_0x250b1b(0x19a)](_0x5255c6=>_0x5255c6!==null)[_0x250b1b(0x1ce)]((_0x4be85b,_0x419d68)=>_0x419d68[_0x250b1b(0x1af)]-_0x4be85b['mtime']),_0x42f35a=_0x31efa2[_0x250b1b(0x16c)](MAX_SESSION_FILES);for(const _0x25168a of _0x42f35a){try{await a0_0xe073ae['unlink'](_0x25168a['path']),this[_0x250b1b(0x195)][_0x250b1b(0x192)]('Removed\x20old\x20session\x20file:\x20'+_0x25168a[_0x250b1b(0x13c)]);}catch(_0x49f2c7){this['logger']['warn']('Failed\x20to\x20remove\x20session\x20file\x20'+_0x25168a[_0x250b1b(0x13c)]+':',_0x49f2c7);}}_0x42f35a[_0x250b1b(0x15a)]>0x0&&this[_0x250b1b(0x195)]['info'](_0x250b1b(0x13d)+_0x42f35a[_0x250b1b(0x15a)]+'\x20old\x20session\x20files');}catch(_0x323980){this[_0x250b1b(0x195)]['warn'](_0x250b1b(0x1c8),_0x323980);}}async['resetUsageData'](_0x5f5c15=![]){const _0x35dfc1=a0_0x559715;this['logger']['info']('Resetting\x20usage\x20data',{'preserveTotal':_0x5f5c15});if(!_0x5f5c15)this[_0x35dfc1(0x165)]=this['_initializeUsageData']();else{const _0x4af9cd=this[_0x35dfc1(0x165)][_0x35dfc1(0x141)],_0x53f57e=this['usage'][_0x35dfc1(0x146)],_0x301448=this['usage']['totalOutputTokens'];this[_0x35dfc1(0x165)]=this['_initializeUsageData'](),this['usage'][_0x35dfc1(0x141)]=_0x4af9cd,this[_0x35dfc1(0x165)][_0x35dfc1(0x146)]=_0x53f57e,this[_0x35dfc1(0x165)][_0x35dfc1(0x1a2)]=_0x301448;}await this['saveUsageData']();}async[a0_0x559715(0x1cf)](_0x3189f7=a0_0x559715(0x13a)){const _0x2b2a77=a0_0x559715,_0x4f14ee=await this[_0x2b2a77(0x15e)]();if(_0x3189f7==='csv')return this[_0x2b2a77(0x131)](_0x4f14ee);return JSON[_0x2b2a77(0x17b)](_0x4f14ee,null,0x2);}['_exportToCsv'](_0x3aa511){const _0x1155ed=a0_0x559715,_0x136637=['Category,Service/Model,Cost,InputTokens,OutputTokens,RequestCount'];for(const [_0x31930e,_0x4b835c]of Object['entries'](_0x3aa511[_0x1155ed(0x1c0)])){_0x136637['push'](_0x1155ed(0x190)+_0x31930e+','+_0x4b835c['cost']+','+_0x4b835c['inputTokens']+','+_0x4b835c[_0x1155ed(0x193)]+','+_0x4b835c[_0x1155ed(0x18d)]);}for(const [_0x2207f2,_0x1045a4]of Object[_0x1155ed(0x1cb)](_0x3aa511['breakdownByModel'])){_0x136637[_0x1155ed(0x186)]('Model,'+_0x2207f2+','+_0x1045a4[_0x1155ed(0x194)]+','+_0x1045a4[_0x1155ed(0x18b)]+','+_0x1045a4[_0x1155ed(0x193)]+','+_0x1045a4['requestCount']);}return _0x136637[_0x1155ed(0x12e)]('\x0a');}[a0_0x559715(0x1c6)](_0x14762f,_0x11eab8,_0x552987){const _0x543a3c=a0_0x559715;this[_0x543a3c(0x17d)]('estimate',_0x14762f,_0x11eab8,_0x552987);const _0x4cc439=this[_0x543a3c(0x1b5)](_0x14762f,_0x11eab8,_0x552987),_0x39892c={'model':_0x14762f,'estimatedInputTokens':_0x11eab8,'estimatedOutputTokens':_0x552987,'estimatedCost':_0x4cc439[_0x543a3c(0x141)],..._0x4cc439,'budgetImpact':null};if(this[_0x543a3c(0x14f)]!==null){const _0x1ce8bc=this['usage'][_0x543a3c(0x141)]+_0x4cc439[_0x543a3c(0x141)];_0x39892c['budgetImpact']={'currentSpent':this['usage']['totalCost'],'afterOperation':_0x1ce8bc,'remainingAfter':Math[_0x543a3c(0x15b)](0x0,this[_0x543a3c(0x14f)]-_0x1ce8bc),'wouldExceedBudget':_0x1ce8bc>this['budgetLimit'],'percentageAfter':_0x1ce8bc/this['budgetLimit']*0x64};}return _0x39892c;}[a0_0x559715(0x162)](_0x453898,_0x4e49e6,_0x5494dc){const _0x410ea2=a0_0x559715,_0xe27745=this['getCostEstimate'](_0x453898,_0x4e49e6,_0x5494dc);return{'canProceed':this[_0x410ea2(0x14f)]===null||!_0xe27745[_0x410ea2(0x1a5)]?.['wouldExceedBudget'],'estimate':_0xe27745,'recommendation':this[_0x410ea2(0x1c5)](_0xe27745)};}[a0_0x559715(0x1c5)](_0x5f5572){const _0xe17e5f=a0_0x559715;if(this['budgetLimit']===null)return _0xe17e5f(0x19b);if(!_0x5f5572[_0xe17e5f(0x1a5)])return'Proceed\x20with\x20operation.';const {percentageAfter:_0x2cfc3d,wouldExceedBudget:_0x46bc0c}=_0x5f5572['budgetImpact'];if(_0x46bc0c)return'Operation\x20would\x20exceed\x20budget\x20limit.\x20Consider\x20increasing\x20budget\x20or\x20using\x20a\x20less\x20expensive\x20model.';if(_0x2cfc3d>BUDGET_CRITICAL_THRESHOLD*0x64)return'Operation\x20would\x20use\x20most\x20of\x20your\x20budget.\x20Monitor\x20usage\x20carefully.';if(_0x2cfc3d>BUDGET_WARNING_THRESHOLD*0x64)return'Operation\x20would\x20use\x20significant\x20portion\x20of\x20budget.\x20Consider\x20cost\x20optimization.';return _0xe17e5f(0x13b);}[a0_0x559715(0x183)](){const _0x54854d=a0_0x559715,_0x4776d9=Array[_0x54854d(0x143)](this[_0x54854d(0x139)]['entries']())['map'](([_0x1ea71b,_0x312bd6])=>({'model':_0x1ea71b,'inputPrice':_0x312bd6[_0x54854d(0x1bc)],'outputPrice':_0x312bd6[_0x54854d(0x1b6)],'unit':_0x312bd6['unit'],'currency':_0x312bd6[_0x54854d(0x196)]}));return{'models':_0x4776d9,'lastUpdate':this['lastPricingUpdate'],'source':this['serverLLMService']?_0x54854d(0x19d):'fallback','totalModels':this['pricingData'][_0x54854d(0x172)]};}async[a0_0x559715(0x1ab)](){const _0x2903c2=a0_0x559715,_0x4cefae={'status':_0x2903c2(0x14c),'issues':[],'metrics':{'totalCost':this['usage'][_0x2903c2(0x141)],'totalTokens':this['usage'][_0x2903c2(0x146)]+this['usage']['totalOutputTokens'],'modelsWithPricing':this['pricingData']['size'],'budgetLimit':this['budgetLimit']}};try{await this[_0x2903c2(0x145)]();const _0x4584a8=a0_0x49c32a['join'](this['usageDir'],'.health-check');await a0_0xe073ae[_0x2903c2(0x1c2)](_0x4584a8,_0x2903c2(0x12f)),await a0_0xe073ae[_0x2903c2(0x1c4)](_0x4584a8);}catch(_0x586897){_0x4cefae['status']='degraded',_0x4cefae['issues']['push']('File\x20system\x20access\x20issues');}this['pricingData']['size']===0x0&&(_0x4cefae['status']=_0x2903c2(0x1a8),_0x4cefae['issues'][_0x2903c2(0x186)](_0x2903c2(0x1a9)));if(this[_0x2903c2(0x18f)]){const _0xd2e374=(Date[_0x2903c2(0x156)]()-new Date(this['lastPricingUpdate'])[_0x2903c2(0x178)]())/(0x3e8*0x3c*0x3c);_0xd2e374>0x18&&_0x4cefae['issues']['push'](_0x2903c2(0x140));}if(this['budgetLimit']!==null){const _0x4d85ba=this['_checkBudgetStatus']();_0x4d85ba[_0x2903c2(0x19e)]!=='normal'&&_0x4cefae['issues'][_0x2903c2(0x186)](_0x2903c2(0x142)+_0x4d85ba['warningLevel']+':\x20'+_0x4d85ba[_0x2903c2(0x188)][_0x2903c2(0x176)](0x1)+'%\x20used');}return _0x4cefae['issues']['length']>0x0&&_0x4cefae[_0x2903c2(0x1a4)]==='healthy'&&(_0x4cefae['status']='warning'),_0x4cefae;}async['shutdown'](){const _0x344fb6=a0_0x559715;this['logger']['info'](_0x344fb6(0x16a));try{await this[_0x344fb6(0x166)](),this['pricingData']['clear'](),this[_0x344fb6(0x195)][_0x344fb6(0x1a7)](_0x344fb6(0x130));}catch(_0x400ea9){this[_0x344fb6(0x195)][_0x344fb6(0x17e)](_0x344fb6(0x173),_0x400ea9);throw _0x400ea9;}}}function a0_0x2cba(){const _0x539be6=['AM9PBG','DgvZDa','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','x2v4Cg9YDfrVq3n2','A2v5CW','qLver0vux0vyq0vfreve','BNvTyMvY','mJK2nJK3mxbdv0HXCG','mtaYmtuYn2jdEuH0sG','CMvHzezPBgu','mJKWodKYnfburxj1DW','ChjPy2LUz0rHDge','ANnVBG','t3bLCMf0Aw9UigLZihDPDgHPBIbIDwrNzxqGz3vPzgvSAw5LCY4','BMfTzq','q2XLyw5Lzcb1Cca','su5wquXjrf9btu9vtLq','CMfUzg9T','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','Dg90ywXdB3n0','qNvKz2v0ia','zNjVBq','su5wquXjrf9ut0TftLm','x2vUC3vYzvvZywDLrgLYzwn0B3j5','Dg90ywXjBNb1DfrVA2vUCW','CMvTywLUAw5NqNvKz2v0','tg9HzgvKihbYzxzPB3vZihvZywDLigrHDge','BwfW','ihjLCxvLC3rZkqO','yNvKz2v0','AgvHBhrOEq','z2v0','mtjpDfLrqMe','yNvKz2v0tgLTAxq','B3b1CW','C2v0qNvKz2v0tgLTAxq','AgfYzeXPBwL0','z2v0qwXSuhjPy2LUzW','CMvHzgrPCG','pt09ifvtquDfifjfue9svca9pt0k','BM93','mtuXodmZuNnZs1HJ','C3vJy2vZCW','vg90ywWGy29ZDdOGja','BgvUz3rO','Bwf4','Dg9tDhjPBMC','Bw9KzwXvC2fNzq','z2v0qNvKz2v0vxnHz2u','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','uhjPy2LUzYbKyxrHihvUyxzHAwXHyMXLigzVCIbTB2rLBa','x3vWzgf0zvvZywDLrgf0yq','y2HLy2TcDwrNzxrgB3jpCgvYyxrPB24','C3rHCNrZv2L0Aa','C2vYDMLJzvvZywDL','DxnHz2u','C2f2zvvZywDLrgf0yq','uMvTywLUAw5NoIaK','x2DLBMvYyxrLu2vZC2LVBKLK','mtGYndnkDfjfANy','u2H1DhrPBMCGzg93BIbIDwrNzxqGC2vYDMLJzq','mZjTruzVsK4','C2XPy2u','z2v0vxnHz2vszxbVCNq','x2DLDevZDgLTyxrLzfbYAwnPBMC','y2f0y2G','D2fYBG','x2nOzwnRqNvKz2v0u3rHDhvZ','C2L6zq','rxjYB3iGzhvYAw5Nigj1zgDLDcbZzxj2AwnLihnODxrKB3DUoG','DxrMltG','C2vZC2LVBKvUza','Dg9gAxHLza','Dg9mB2nHBgvtDhjPBMC','z2v0vgLTzq','ru5pru5u','CgfYC2u','C3rYAw5NAwz5','BgLTAxq','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','zxjYB3i','Dg90ywXtCgvUDa','ndy1nKj0AMrOtW','x2XVywrvC2fNzurHDge','x2LUAxrPywXPEMvvC2fNzurHDge','z2v0uhjPy2LUz0LUzM8','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','x2XVywrcDwrNzxrmAw1PDa','ChvZAa','cJ09psbcuKvbs0rpv04GqLKGtu9eruWGpt09cG','CgvYy2vUDgfNzvvZzwq','ChjPy2LUz0LUzM8','D2L0AgLUqNvKz2v0','Aw5WDxruB2TLBNm','Bw9KzwXZv2L0AfbYAwnPBMC','CMvXDwvZDenVDw50','vg90ywWGAw5WDxqGDg9Rzw5ZoIa','BgfZDfbYAwnPBMDvCgrHDgu','u2vYDMLJzsW','qNvKz2v0igXPBwL0igv4y2vLzgvK','zgvIDwC','B3v0Chv0vg9Rzw5Z','y29ZDa','Bg9Nz2vY','y3vYCMvUy3K','mJKZmM90Ce12ra','mZbtsxPrt3u','ndeZmJqYnxrsC2LMvW','zMLSDgvY','tM8GyNvKz2v0igXPBwL0ihnLDc4Gq29UC2LKzxiGC2v0DgLUzYbHigj1zgDLDcbMB3iGy29ZDcbJB250CM9SlG','vxnHz2uGzgf0ysbZyxzLzcbZDwnJzxnZzNvSBhK','C2vYDMvY','D2fYBMLUz0XLDMvS','rxjYB3iGAw5PDgLHBgL6Aw5NihvZywDLigrHDgeGzgLYzwn0B3j5oG','C2vZC2LVBKLK','yNvKz2v0u3rHDhvZ','Dg90ywXpDxrWDxruB2TLBNm','tw9KzwXZihDPDgGGChjPy2LUzZOG','C3rHDhvZ','yNvKz2v0sw1Wywn0','z3b0ltmUnq','Aw5MBW','zgvNCMfKzwq','tM8GChjPy2LUzYbKyxrHigf2ywLSywjSzq','C2vYDMvYteXnu2vYDMLJzq','AgvHBhrOq2HLy2S','Aw5JBhvKzxm','DxnHz2veAxi','x3zHBgLKyxrLqNvKz2v0qw1VDw50','BxrPBwu','BM9YBwfS','C291CMnL','rMfPBgvKihrVihnHDMuGDxnHz2uGzgf0ytO','vvne','Dg9ju09tDhjPBMC','x2nHBgn1Bgf0zunVC3q','B3v0Chv0','C3rYAw5N','BgfZDfvWzgf0zwq','Cgf0Aa','y29UzMLN','uMvJB3jKAw5NihvZywDLigzVCIa','Aw5WDxq','x3nOB3vSzfvWzgf0zvbYAwnPBMC','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','yNjLywTKB3DUqNLtzxj2AwnL','Dw5PDa','D3jPDgvgAwXL','y3jPDgLJywW','Dw5SAw5R','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','z2v0q29ZDevZDgLTyxrL','C2vZC2LVBLn0yxj0','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','CgHP','ywXS','zw50CMLLCW','D2fYBMLUzW','BgfZDfnHDMvKq29ZDa','C29YDa','zxHWB3j0vxnHz2veyxrH'];a0_0x2cba=function(){return _0x539be6;};return a0_0x2cba();}