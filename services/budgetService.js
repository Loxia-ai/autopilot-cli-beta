function a0_0x709a(_0x4f8512,_0x4fa227){const _0x334905=a0_0x3349();return a0_0x709a=function(_0x709a5e,_0x55ed10){_0x709a5e=_0x709a5e-0xb1;let _0xe3c856=_0x334905[_0x709a5e];if(a0_0x709a['iYcAZT']===undefined){var _0x3149a3=function(_0x380c98){const _0x15de03='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x2a02bb='',_0x5ac35c='';for(let _0x4e1472=0x0,_0x557ace,_0x35e671,_0x484f08=0x0;_0x35e671=_0x380c98['charAt'](_0x484f08++);~_0x35e671&&(_0x557ace=_0x4e1472%0x4?_0x557ace*0x40+_0x35e671:_0x35e671,_0x4e1472++%0x4)?_0x2a02bb+=String['fromCharCode'](0xff&_0x557ace>>(-0x2*_0x4e1472&0x6)):0x0){_0x35e671=_0x15de03['indexOf'](_0x35e671);}for(let _0x4450c0=0x0,_0x234946=_0x2a02bb['length'];_0x4450c0<_0x234946;_0x4450c0++){_0x5ac35c+='%'+('00'+_0x2a02bb['charCodeAt'](_0x4450c0)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x5ac35c);};a0_0x709a['PXMlkm']=_0x3149a3,_0x4f8512=arguments,a0_0x709a['iYcAZT']=!![];}const _0x468989=_0x334905[0x0],_0x556fb3=_0x709a5e+_0x468989,_0x301572=_0x4f8512[_0x556fb3];return!_0x301572?(_0xe3c856=a0_0x709a['PXMlkm'](_0xe3c856),_0x4f8512[_0x556fb3]=_0xe3c856):_0xe3c856=_0x301572,_0xe3c856;},a0_0x709a(_0x4f8512,_0x4fa227);}function a0_0x3349(){const _0x4fd453=['ndrpDNHJswW','q2f0zwDVCNKSu2vYDMLJzs9nB2rLBcXdB3n0leLUChv0vg9Rzw5Zle91Dhb1DfrVA2vUCYXszxf1zxn0q291BNq','C2v0qNvKz2v0tgLTAxq','uhjPy2LUzYb1CgrHDguGywXYzwfKEsbPBIbWCM9NCMvZCW','BM9YBwfS','t3bLCMf0Aw9UihDVDwXKigv4y2vLzcbIDwrNzxqGBgLTAxqUienVBNnPzgvYigLUy3jLyxnPBMCGyNvKz2v0ig9YihvZAw5NigeGBgvZCYbLEhbLBNnPDMuGBw9KzwWU','mJKWsgL3CgnU','tM8GC2vYDMvYieXmtsbZzxj2AwnLigf2ywLSywjSzsbMB3iGChjPy2LUzYb1CgrHDgvZ','nJaXntq5owrjvuHfvG','z2v0q29ZDevZDgLTyxrL','Bw9KzwXZv2L0AfbYAwnPBMC','Aw5JBhvKzxm','yNvKz2v0tgLTAxq','DxnHz2u','DxnHz2veAxi','AxnZDwvZ','zNjVBq','rMfPBgvKihrVigXVywqGDxnHz2uGzgf0ytO','jsb1C2vK','C2vYDMvY','zw5KC1DPDgG','x2vUC3vYzvvZywDLrgLYzwn0B3j5','A2v5CW','C2vYDMLJzvvZywDL','y2HLy2TcDwrNzxrgB3jpCgvYyxrPB24','C2vYDMvYteXnu2vYDMLJzq','qNvKz2v0igfTB3vUDcbTDxn0igjLigeGCg9ZAxrPDMuGBNvTyMvY','x2nHBgn1Bgf0zunVC3q','pt09ifvtquDfifjfue9svca9pt0k','ANnVBG','zgvIDwC','y29UzMLN','rxjYB3iGAw5PDgLHBgL6Aw5NihvZywDLigrHDgeGzgLYzwn0B3j5oG','BgfZDfbYAwnPBMDvCgrHDgu','Dw5SAw5R','u2vYDMLJzsW','mty4uKznrMvc','BwvZC2fNzq','mJC0odqWr3L4C1jX','z2v0tw9KzwXqCMLJAw5N','rMLSzsbZExn0zw0GB3bLCMf0Aw9UigzHAwXLza','tM8GChjPy2LUzYbKyxrHigf2ywLSywjSzq','mtaWodGXt2vVqMXw','Bw9KzwXvC2fNzq','odi1oty2C2rKtuD4','rMfPBgvKihrVigXVywqGChjLDMLVDxmGDxnHz2uGzgf0ytO','B3v0Chv0vg9Rzw5Z','Dg9gAxHLza','x3zHBgLKyxrLvxnHz2vjBNb1Dhm','y3vYCMvUy3K','zw50CMLLCW','yNjLywTKB3DUqNLtzxj2AwnL','zgvNCMfKzwq','igv4y2vLzhmGBgLTAxqGB2yGja','y3n2','uhjPy2LUzYbKyxrHigLZihn0ywXLicG+mJqGAg91CNmGB2XKkq','qLver0vux0vyq0vfreve','x2nOzwnRqNvKz2v0u3rHDhvZ','zxjYB3i','AgfPA3u','Cgf0Aa','CgvYy2vUDgfNzvvZzwq','zMfSBgjHy2S','oIaK','C3rHDa','CMvTywLUAw5NqNvKz2v0','otaWntHcDvb1ywO','x2LUAxrPywXPEMvvC2fNzurHDge','B3b1CW','Bg9Nz2vY','qNvKz2v0ihnLCNzPy2uGAw5PDgLHBgL6zwq','vg90ywWGB3v0Chv0ihrVA2vUCZOG','Dg90ywXtCgvUDa','BgvUz3rO','yNvKz2v0u3rHDhvZ','C2f2zvvZywDLrgf0yq','nMPQr2LUDG','x3nHDMvvC2fNzurHDgfjzK5LzwrLza','CMvXDwvZDenVDw50','DxbKyxrLuhjPy2LUz0zYB21tzxj2zxi','yNjLywTKB3DUqNLnB2rLBa','uhjPy2LUzYbKyxrHihvUyxzHAwXHyMXLigzVCIbTB2rLBa','tw9KzwWGBMfTzsbTDxn0igjLigeGBM9UlwvTChr5ihn0CMLUzW','yNvKz2v0','BNvTyMvY','u2vYDMLJzsbUyw1Lig11C3qGyMuGysbUB24Tzw1WDhKGC3rYAw5N','D2fYBMLUz0XLDMvS','BMfTzq','x3vWzgf0zvvZywDLrgf0yq','Dg9ju09tDhjPBMC','uMvTywLUAw5NoIaK','q2XLyw5Lzcb1Cca','C2L6zq','B3v0Chv0','x3zHBgLKyxrLqNvKz2v0qw1VDw50','Dg9mB2nHBgvtDhjPBMC','muSGDg9Rzw5Z','qNvKz2v0ihnLCNzPy2uGC2H1DcbKB3DUihn1y2nLC3nMDwXSEq','tw9KzwWS','z2v0uhjPy2LUz0LUzM8','tw9KzwXZihDPDgGGChjPy2LUzZOG','x2DLDej1zgDLDfjLy29TBwvUzgf0Aw9U','BgfZDfnHDMvKq29ZDa','BgLTAxq','yNvKz2v0sw1Wywn0','uMvZzxr0Aw5NihvZywDLigrHDge','rMfPBgvKihrVihjLBw92zsbZzxnZAw9UigzPBguG','C2vZC2LVBKLK','C3rYAw5NAwz5','D3jPDgvgAwXL','CMvJB3jKvxnHz2u','DgvZDa','mtG0mti5qMH2zeX6','y29ZDa','Dg90ywXjBNb1DfrVA2vUCW','zMLSDgvY','CMfUzg9T','ChvZAa','Dg90ywXdB3n0','BM93','C2XPy2u','y2f0y2G','x2XVywrcDwrNzxrmAw1PDa','ChjPy2LUz1vWzgf0zuLUuhjVz3jLC3m','C3vJy2vZCW','su5wquXjrf9ut0TftLm','Dg9mB3DLCKnHC2u','CgHP','qNvKz2v0igXPBwL0igv4y2vLzgvK','Aw5MBW','BwfW','rMfPBgvKihrVignSzwfUDxaGB2XKihnLC3nPB24GzMLSzxm6','cJ09psbcuKvbs0rpv04GqLKGu0vsvKLdrsa9pt0k','ChjPy2LUz0rHDge','Dw5PDa','Aw5WDxruB2TLBNm','sw52ywXPzcbTB2rLBcbUyw1LihbYB3zPzgvKigzVCIbWCMLJAw5NigXVB2T1Ca','C3rYAw5N','Dg90ywXpDxrWDxruB2TLBNm','ntu5nJm5ohHcyKzjsq','u2H1DhrPBMCGzg93BIbIDwrNzxqGC2vYDMLJzq','z2v0uhjPy2LUz0rHDge','D2fYBG','AM9PBG','Aw5WDxq','cLbYAwnPBMCGC291CMnLoIa','ihjLCxvLC3rZkqO','zxHWB3j0vxnHz2veyxrH','AgvHBhrOEq','z3b0ltq'];a0_0x3349=function(){return _0x4fd453;};return a0_0x3349();}const a0_0x465bea=a0_0x709a;(function(_0xd09ff5,_0x33980e){const _0x132332=a0_0x709a,_0x39b9e8=_0xd09ff5();while(!![]){try{const _0x250a24=parseInt(_0x132332(0x103))/0x1+parseInt(_0x132332(0xed))/0x2*(-parseInt(_0x132332(0x10d))/0x3)+-parseInt(_0x132332(0xc1))/0x4*(-parseInt(_0x132332(0xe7))/0x5)+parseInt(_0x132332(0xb6))/0x6+-parseInt(_0x132332(0xc9))/0x7+parseInt(_0x132332(0xe5))/0x8*(parseInt(_0x132332(0xeb))/0x9)+parseInt(_0x132332(0xc7))/0xa*(parseInt(_0x132332(0x131))/0xb);if(_0x250a24===_0x33980e)break;else _0x39b9e8['push'](_0x39b9e8['shift']());}catch(_0x489113){_0x39b9e8['push'](_0x39b9e8['shift']());}}}(a0_0x3349,0xa1d98));import{promises as a0_0x380c98}from'fs';import a0_0x15de03 from'path';const DEFAULT_USAGE_DIR='./.loxia-budget',USAGE_FILENAME='usage.json',SESSION_PREFIX='session_',PRICING_CACHE_DURATION_MS=0x493e0,PRICING_REFRESH_THRESHOLD_MS=0xea60,MAX_SESSION_FILES=0x64,BUDGET_WARNING_THRESHOLD=0.8,BUDGET_CRITICAL_THRESHOLD=0.95,ERROR_MESSAGES={'INVALID_AMOUNT':a0_0x465bea(0xdb),'INVALID_TOKENS':'Token\x20counts\x20must\x20be\x20non-negative\x20numbers','INVALID_SERVICE':a0_0x465bea(0x116),'BUDGET_EXCEEDED':a0_0x465bea(0x141),'PRICING_UNAVAILABLE':'Pricing\x20information\x20unavailable','FILE_SYSTEM_ERROR':a0_0x465bea(0xe9)};export class BudgetService{constructor(_0x2a02bb,_0x5ac35c,_0x4e1472=null){const _0x3e3109=a0_0x465bea;this['config']=_0x2a02bb,this[_0x3e3109(0x106)]=_0x5ac35c,this[_0x3e3109(0xda)]=_0x4e1472,this['usage']=this[_0x3e3109(0x104)](),this['budgetLimit']=this[_0x3e3109(0x13b)](),this['hardLimit']=_0x2a02bb[_0x3e3109(0x114)]?.['hardLimit']||![],this[_0x3e3109(0x146)]=new Map(),this[_0x3e3109(0xe2)]=null,this['pricingUpdateInProgress']=![],this['usageDir']=_0x2a02bb[_0x3e3109(0x114)]?.[_0x3e3109(0xcf)]||DEFAULT_USAGE_DIR,this['logger']['info'](_0x3e3109(0x107),{'budgetLimit':this['budgetLimit'],'hardLimit':this['hardLimit'],'usageDir':this[_0x3e3109(0xcf)],'hasPricingService':!!this['serverLLMService']}),this['_loadUsageData']()[_0x3e3109(0x13a)](_0x557ace=>{const _0x275e20=_0x3e3109;this[_0x275e20(0x106)][_0x275e20(0xb9)](_0x275e20(0xee),_0x557ace);});}['_initializeUsageData'](){const _0x8fa13f=a0_0x465bea;return{'totalInputTokens':0x0,'totalOutputTokens':0x0,'totalCost':0x0,'serviceUsage':{},'modelUsage':{},'sessionStart':new Date()['toISOString'](),'sessionId':this['_generateSessionId'](),'lastUpdated':new Date()[_0x8fa13f(0x11a)]()};}['_generateSessionId'](){const _0x41f425=a0_0x465bea,_0x35e671=Date[_0x41f425(0x138)]()['toString'](0x24),_0x484f08=Math[_0x41f425(0x135)]()['toString'](0x24)[_0x41f425(0x139)](0x2);return _0x35e671+'_'+_0x484f08;}['_loadBudgetLimit'](){const _0x2bae6c=a0_0x465bea,_0x4450c0=this[_0x2bae6c(0xe0)][_0x2bae6c(0x114)]?.['limit'];if(_0x4450c0!==undefined&&_0x4450c0!==null)return this[_0x2bae6c(0x11f)](_0x4450c0);return null;}async[a0_0x465bea(0x110)](){const _0x1ef1bc=a0_0x465bea;if(!this['serverLLMService'])return this[_0x1ef1bc(0x106)][_0x1ef1bc(0xdf)](_0x1ef1bc(0xc8)),![];if(this[_0x1ef1bc(0x13c)])return this[_0x1ef1bc(0x106)]['debug'](_0x1ef1bc(0xc4)),![];if(!this['_shouldUpdatePricing']())return!![];this[_0x1ef1bc(0x13c)]=!![];try{this['logger'][_0x1ef1bc(0x142)]('Updating pricing data from server');const _0x234946=await this['serverLLMService']['getPricingData']();if(_0x234946[_0x1ef1bc(0x11d)]===0x0)return this[_0x1ef1bc(0x106)][_0x1ef1bc(0xb9)]('No pricing data received from server'),![];this[_0x1ef1bc(0x146)]['clear']();for(const [_0x468850,_0x179228]of _0x234946[_0x1ef1bc(0xf3)]()){this['pricingData']['set'](_0x468850,{'input':_0x179228['input'],'output':_0x179228[_0x1ef1bc(0x11e)],'unit':_0x179228['unit']||'1K\x20tokens','currency':_0x179228[_0x1ef1bc(0xf2)]||'USD'});}return this['lastPricingUpdate']=new Date()['toISOString'](),this[_0x1ef1bc(0x106)]['info']('Updated\x20pricing\x20for\x20'+this['pricingData'][_0x1ef1bc(0x11d)]+'\x20models\x20from\x20server'),!![];}catch(_0x2f9762){return this[_0x1ef1bc(0x106)]['error']('Failed to update pricing from server:',_0x2f9762),![];}finally{this[_0x1ef1bc(0x13c)]=![];}}['_shouldUpdatePricing'](){const _0x738779=a0_0x465bea;if(!this['lastPricingUpdate'])return!![];const _0x4509a1=Date[_0x738779(0x138)]()-new Date(this[_0x738779(0xe2)])['getTime']();return _0x4509a1>PRICING_REFRESH_THRESHOLD_MS;}['getModelPricing'](_0x17498f){const _0xc8ffe3=a0_0x465bea;if(!_0x17498f||typeof _0x17498f!==_0xc8ffe3(0xb4))return this['logger'][_0xc8ffe3(0xb9)](_0xc8ffe3(0xb3)),null;return this['pricingData']['get'](_0x17498f)||null;}['getAllPricing'](){const _0x1f16e1=a0_0x465bea;return this[_0x1f16e1(0xda)][_0x1f16e1(0xb8)]();}async[a0_0x465bea(0x12f)](_0x7c413d,_0x649dbf,_0x1106ec,_0x38ec84){const _0x5b74c1=a0_0x465bea;this[_0x5b74c1(0x106)][_0x5b74c1(0x142)]('Recording\x20usage\x20for\x20'+_0x7c413d+'/'+_0x649dbf,{'inputTokens':_0x1106ec,'outputTokens':_0x38ec84,'service':_0x7c413d,'model':_0x649dbf}),this['_validateUsageInputs'](_0x7c413d,_0x649dbf,_0x1106ec,_0x38ec84),await this['updatePricingFromServer']();const _0x130e6b=this[_0x5b74c1(0xdc)](_0x649dbf,_0x1106ec,_0x38ec84);!_0x130e6b[_0x5b74c1(0x13d)]&&this[_0x5b74c1(0x106)]['warn']('Pricing\x20unavailable\x20for\x20model\x20'+_0x649dbf+',\x20using\x20estimate');this['_updateUsageData'](_0x7c413d,_0x649dbf,_0x1106ec,_0x38ec84,_0x130e6b['totalCost']);const _0xeffbb9=this[_0x5b74c1(0xfa)]();await this[_0x5b74c1(0x10e)]();const _0x2876ee={'service':_0x7c413d,'model':_0x649dbf,'inputTokens':_0x1106ec,'outputTokens':_0x38ec84,'cost':_0x130e6b,'budgetStatus':_0xeffbb9,'timestamp':new Date()['toISOString']()};return this[_0x5b74c1(0x106)]['debug']('Usage\x20recorded\x20successfully',_0x2876ee),_0x2876ee;}[a0_0x465bea(0xf1)](_0x345906,_0x33d0fd,_0x954cbd,_0x5c858f){const _0x3d006b=a0_0x465bea;if(!_0x345906||typeof _0x345906!=='string')throw new Error(ERROR_MESSAGES['INVALID_SERVICE']);if(!_0x33d0fd||typeof _0x33d0fd!=='string')throw new Error(_0x3d006b(0x113));if(typeof _0x954cbd!==_0x3d006b(0x115)||_0x954cbd<0x0)throw new Error(ERROR_MESSAGES['INVALID_TOKENS']);if(typeof _0x5c858f!=='number'||_0x5c858f<0x0)throw new Error(ERROR_MESSAGES[_0x3d006b(0x13e)]);}['_calculateCost'](_0x4665a5,_0x9f2d4e,_0x18c7b1){const _0x476e03=a0_0x465bea,_0x17e815=this[_0x476e03(0xe8)](_0x4665a5);if(!_0x17e815){const _0x2d0253=this['_getEstimatedPricing'](_0x4665a5),_0x4a563a=_0x9f2d4e/0x3e8*_0x2d0253['input'],_0x2e8527=_0x18c7b1/0x3e8*_0x2d0253['output'];return{'success':![],'inputCost':_0x4a563a,'outputCost':_0x2e8527,'totalCost':_0x4a563a+_0x2e8527,'currency':'USD','unit':_0x476e03(0x121),'estimated':!![],'reason':_0x476e03(0x112)};}const _0x539038=_0x9f2d4e/0x3e8*_0x17e815['input'],_0x3711ba=_0x18c7b1/0x3e8*_0x17e815['output'];return{'success':!![],'inputCost':_0x539038,'outputCost':_0x3711ba,'totalCost':_0x539038+_0x3711ba,'currency':_0x17e815[_0x476e03(0xf2)],'unit':_0x17e815[_0x476e03(0xb1)],'estimated':![]};}['_getEstimatedPricing'](_0x2ca8be){const _0x3924d0=a0_0x465bea,_0x516484=_0x2ca8be[_0x3924d0(0x13f)]();if(_0x516484['includes'](_0x3924d0(0x105))||_0x516484['includes'](_0x3924d0(0xc0)))return{'input':0.015,'output':0.075};else{if(_0x516484[_0x3924d0(0xcc)]('sonnet')||_0x516484['includes']('gpt-3.5'))return{'input':0.003,'output':0.015};else{if(_0x516484['includes'](_0x3924d0(0xfc))||_0x516484['includes'](_0x3924d0(0x140)))return{'input':0.001,'output':0.004};}}return{'input':0.005,'output':0.02};}[a0_0x465bea(0x119)](_0x3cdbba,_0x27e619,_0x6b0c09,_0x77f344,_0x39cfd9){const _0xf021e6=a0_0x465bea;this['usage'][_0xf021e6(0x133)]+=_0x6b0c09,this['usage']['totalOutputTokens']+=_0x77f344,this[_0xf021e6(0xce)]['totalCost']+=_0x39cfd9,this[_0xf021e6(0xce)]['lastUpdated']=new Date()['toISOString'](),!this[_0xf021e6(0xce)][_0xf021e6(0xd8)][_0x3cdbba]&&(this[_0xf021e6(0xce)][_0xf021e6(0xd8)][_0x3cdbba]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0xf021e6(0xce)]['serviceUsage'][_0x3cdbba]['inputTokens']+=_0x6b0c09,this[_0xf021e6(0xce)][_0xf021e6(0xd8)][_0x3cdbba]['outputTokens']+=_0x77f344,this['usage']['serviceUsage'][_0x3cdbba][_0xf021e6(0x132)]+=_0x39cfd9,this['usage'][_0xf021e6(0xd8)][_0x3cdbba][_0xf021e6(0x10f)]+=0x1,!this['usage'][_0xf021e6(0xec)][_0x27e619]&&(this['usage']['modelUsage'][_0x27e619]={'inputTokens':0x0,'outputTokens':0x0,'cost':0x0,'requestCount':0x0}),this[_0xf021e6(0xce)][_0xf021e6(0xec)][_0x27e619]['inputTokens']+=_0x6b0c09,this[_0xf021e6(0xce)]['modelUsage'][_0x27e619][_0xf021e6(0xef)]+=_0x77f344,this[_0xf021e6(0xce)][_0xf021e6(0xec)][_0x27e619][_0xf021e6(0x132)]+=_0x39cfd9,this['usage']['modelUsage'][_0x27e619][_0xf021e6(0x10f)]+=0x1;}[a0_0x465bea(0xfa)](){const _0x1f140b=a0_0x465bea,_0x2b60ae={'withinBudget':!![],'budgetLimit':this[_0x1f140b(0xcd)],'totalSpent':this['usage'][_0x1f140b(0x137)],'remainingBudget':null,'percentageUsed':null,'warningLevel':_0x1f140b(0xc5)};if(this[_0x1f140b(0xcd)]!==null){_0x2b60ae[_0x1f140b(0x102)]=Math['max'](0x0,this[_0x1f140b(0xcd)]-this['usage']['totalCost']),_0x2b60ae['percentageUsed']=this[_0x1f140b(0xce)][_0x1f140b(0x137)]/this[_0x1f140b(0xcd)]*0x64,_0x2b60ae['withinBudget']=this[_0x1f140b(0xce)][_0x1f140b(0x137)]<=this[_0x1f140b(0xcd)];if(_0x2b60ae[_0x1f140b(0xfe)]>=BUDGET_CRITICAL_THRESHOLD*0x64)_0x2b60ae[_0x1f140b(0x117)]='critical';else _0x2b60ae['percentageUsed']>=BUDGET_WARNING_THRESHOLD*0x64&&(_0x2b60ae['warningLevel']='warning');_0x2b60ae['warningLevel']!==_0x1f140b(0xc5)&&this['logger']['warn']('Budget\x20'+_0x2b60ae['warningLevel']+':\x20'+_0x2b60ae[_0x1f140b(0xfe)][_0x1f140b(0xf0)](0x1)+_0x1f140b(0xd3),{'totalSpent':this[_0x1f140b(0xce)]['totalCost'],'budgetLimit':this['budgetLimit'],'remainingBudget':_0x2b60ae['remainingBudget']});if(!_0x2b60ae['withinBudget']&&this['hardLimit']){const _0x3abea9=new Error(ERROR_MESSAGES[_0x1f140b(0xf9)]+_0x1f140b(0x100)+this['usage']['totalCost'][_0x1f140b(0xf0)](0x2)+_0x1f140b(0xf6)+this['budgetLimit'][_0x1f140b(0xf0)](0x2));_0x3abea9['code']=_0x1f140b(0xf9),_0x3abea9[_0x1f140b(0x10b)]=_0x2b60ae;throw _0x3abea9;}}return _0x2b60ae;}async[a0_0x465bea(0xc3)](_0x434ffd){const _0x5d1c9e=a0_0x465bea,_0x1f53c9=this[_0x5d1c9e(0x11f)](_0x434ffd);this[_0x5d1c9e(0xcd)]=_0x1f53c9,this['config']['budget']=this['config'][_0x5d1c9e(0x114)]||{},this[_0x5d1c9e(0xe0)][_0x5d1c9e(0x114)][_0x5d1c9e(0x128)]=_0x1f53c9,this[_0x5d1c9e(0x106)]['info']('Budget\x20limit\x20set\x20to\x20$'+_0x1f53c9[_0x5d1c9e(0xf0)](0x2),{'previousLimit':this['budgetLimit'],'newLimit':_0x1f53c9}),await this[_0x5d1c9e(0x10c)]();}[a0_0x465bea(0x11f)](_0x52ed1c){const _0x382a4a=a0_0x465bea;if(typeof _0x52ed1c!==_0x382a4a(0x115)||_0x52ed1c<0x0||!isFinite(_0x52ed1c))throw new Error(ERROR_MESSAGES['INVALID_AMOUNT']);return _0x52ed1c;}async['getBudgetUsage'](){const _0x293a41=a0_0x465bea;await this['updatePricingFromServer']();const _0x177dd6={'totalSpent':this['usage']['totalCost'],'budgetLimit':this[_0x293a41(0xcd)],'inputTokens':this['usage'][_0x293a41(0x133)],'outputTokens':this['usage']['totalOutputTokens'],'remainingBudget':this[_0x293a41(0xcd)]!==null?Math['max'](0x0,this[_0x293a41(0xcd)]-this['usage'][_0x293a41(0x137)]):null,'percentageUsed':this['budgetLimit']!==null?this['usage'][_0x293a41(0x137)]/this[_0x293a41(0xcd)]*0x64:null,'sessionStart':this[_0x293a41(0xce)]['sessionStart'],'lastUpdated':this[_0x293a41(0xce)]['lastUpdated'],'breakdownByService':{},'breakdownByModel':{},'pricingInfo':{'lastUpdate':this['lastPricingUpdate'],'modelsWithPricing':this['pricingData'][_0x293a41(0x11d)],'source':this['serverLLMService']?'server':_0x293a41(0xff)}};for(const [_0x71db9a,_0x52c9cd]of Object[_0x293a41(0xf3)](this[_0x293a41(0xce)]['serviceUsage'])){_0x177dd6[_0x293a41(0xf4)][_0x71db9a]={'cost':_0x52c9cd['cost'],'inputTokens':_0x52c9cd['inputTokens'],'outputTokens':_0x52c9cd[_0x293a41(0xef)],'requestCount':_0x52c9cd['requestCount']};}for(const [_0x1a0147,_0x1f577c]of Object[_0x293a41(0xf3)](this[_0x293a41(0xce)]['modelUsage'])){_0x177dd6[_0x293a41(0x111)][_0x1a0147]={'cost':_0x1f577c[_0x293a41(0x132)],'inputTokens':_0x1f577c['inputTokens'],'outputTokens':_0x1f577c['outputTokens'],'requestCount':_0x1f577c['requestCount']};}return _0x177dd6;}async['getUsageReport'](){const _0x1e5b8d=a0_0x465bea,_0x15e470=await this['getBudgetUsage']();let _0x21ee10=_0x1e5b8d(0xdd);_0x21ee10+='Total\x20cost:\x20$'+_0x15e470[_0x1e5b8d(0x109)]['toFixed'](0x4)+'\x0a',_0x21ee10+='Total\x20input\x20tokens:\x20'+_0x15e470[_0x1e5b8d(0xb2)]['toLocaleString']()+'\x0a',_0x21ee10+=_0x1e5b8d(0x108)+_0x15e470[_0x1e5b8d(0xef)][_0x1e5b8d(0x120)]()+'\x0a';_0x15e470['budgetLimit']!==null&&(_0x21ee10+='Budget\x20limit:\x20$'+_0x15e470['budgetLimit'][_0x1e5b8d(0xf0)](0x2)+'\x0a',_0x21ee10+=_0x1e5b8d(0x11b)+_0x15e470['remainingBudget'][_0x1e5b8d(0xf0)](0x4)+'\x0a',_0x21ee10+='Usage:\x20'+_0x15e470[_0x1e5b8d(0xfe)]['toFixed'](0x1)+'%\x0a');_0x21ee10+=_0x1e5b8d(0xbc)+_0x15e470['pricingInfo']['source']+'\x0a',_0x21ee10+=_0x1e5b8d(0x125)+_0x15e470['pricingInfo'][_0x1e5b8d(0xcb)]+'\x0a';if(Object[_0x1e5b8d(0xd7)](_0x15e470['breakdownByService'])[_0x1e5b8d(0x10a)]>0x0){_0x21ee10+=_0x1e5b8d(0x145);for(const [_0x3b99b4,_0x2e144b]of Object[_0x1e5b8d(0xf3)](_0x15e470[_0x1e5b8d(0xf4)])){_0x21ee10+=_0x3b99b4+_0x1e5b8d(0x100)+_0x2e144b['cost'][_0x1e5b8d(0xf0)](0x4)+'\x20('+_0x2e144b[_0x1e5b8d(0x10f)]+_0x1e5b8d(0xbd);}}if(Object[_0x1e5b8d(0xd7)](_0x15e470['breakdownByModel'])[_0x1e5b8d(0x10a)]>0x0){_0x21ee10+='\x0a===\x20BREAKDOWN\x20BY\x20MODEL\x20===\x0a';for(const [_0x2f49f4,_0xe1267f]of Object[_0x1e5b8d(0xf3)](_0x15e470['breakdownByModel'])){_0x21ee10+=_0x2f49f4+_0x1e5b8d(0x100)+_0xe1267f['cost'][_0x1e5b8d(0xf0)](0x4)+'\x20('+_0xe1267f['requestCount']+_0x1e5b8d(0xbd);}}return _0x21ee10;}async['_saveUsageDataIfNeeded'](){const _0xfaa375=a0_0x465bea,_0x4dff59=0.1,_0x216089=this[_0xfaa375(0xce)][_0xfaa375(0x127)]||0x0;this['usage']['totalCost']-_0x216089>=_0x4dff59&&(await this['saveUsageData'](),this['usage'][_0xfaa375(0x127)]=this['usage']['totalCost']);}async['_loadUsageData'](){const _0x1d0d49=a0_0x465bea;try{await this['_ensureUsageDirectory']();const _0x4d097a=a0_0x15de03['join'](this['usageDir'],USAGE_FILENAME);try{const _0x20684e=await a0_0x380c98['readFile'](_0x4d097a,'utf-8'),_0x2bc482=JSON['parse'](_0x20684e);this['usage']['totalInputTokens']=_0x2bc482[_0x1d0d49(0x133)]||0x0,this[_0x1d0d49(0xce)]['totalOutputTokens']=_0x2bc482['totalOutputTokens']||0x0,this[_0x1d0d49(0xce)][_0x1d0d49(0x137)]=_0x2bc482[_0x1d0d49(0x137)]||0x0,this[_0x1d0d49(0xce)]['serviceUsage']=_0x2bc482[_0x1d0d49(0xd8)]||{},this['usage'][_0x1d0d49(0xec)]=_0x2bc482[_0x1d0d49(0xec)]||{},this[_0x1d0d49(0x106)][_0x1d0d49(0x142)]('Loaded\x20previous\x20usage\x20data',{'totalCost':this[_0x1d0d49(0xce)]['totalCost'],'totalTokens':this[_0x1d0d49(0xce)][_0x1d0d49(0x133)]+this[_0x1d0d49(0xce)][_0x1d0d49(0xb5)]});}catch(_0xf320d){_0xf320d['code']!=='ENOENT'&&this[_0x1d0d49(0x106)]['warn'](_0x1d0d49(0xd2),_0xf320d);}}catch(_0x1b6377){this['logger'][_0x1d0d49(0xb9)](_0x1d0d49(0xe1),_0x1b6377);}}async['_ensureUsageDirectory'](){const _0x558f4b=a0_0x465bea;try{await a0_0x380c98['mkdir'](this[_0x558f4b(0xcf)],{'recursive':!![]});}catch(_0x5615be){throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x5615be[_0x558f4b(0xe6)]);}}async['saveUsageData'](){const _0x245599=a0_0x465bea;try{await this['_ensureUsageDirectory'](),this[_0x245599(0xce)]['sessionEnd']=new Date()[_0x245599(0x11a)]();const _0x4beb19=a0_0x15de03['join'](this['usageDir'],USAGE_FILENAME);await a0_0x380c98[_0x245599(0x12e)](_0x4beb19,JSON[_0x245599(0x12d)](this[_0x245599(0xce)],null,0x2),'utf-8');const _0x54e8ba=a0_0x15de03[_0x245599(0xba)](this[_0x245599(0xcf)],''+SESSION_PREFIX+this[_0x245599(0xce)][_0x245599(0x12c)]+'.json');await a0_0x380c98[_0x245599(0x12e)](_0x54e8ba,JSON['stringify'](this['usage'],null,0x2),'utf-8'),await this['_cleanupOldSessionFiles'](),this['logger'][_0x245599(0x142)]('Usage\x20data\x20saved\x20successfully',{'totalCost':this['usage']['totalCost'],'sessionId':this['usage'][_0x245599(0x12c)]});}catch(_0x1335fe){this[_0x245599(0x106)]['error']('Failed\x20to\x20save\x20usage\x20data:',_0x1335fe);throw new Error(ERROR_MESSAGES['FILE_SYSTEM_ERROR']+':\x20'+_0x1335fe[_0x245599(0xe6)]);}}async['_cleanupOldSessionFiles'](){const _0x46a098=a0_0x465bea;try{const _0x27e541=await a0_0x380c98['readdir'](this[_0x46a098(0xcf)]),_0x4a208d=_0x27e541['filter'](_0x43b2a4=>_0x43b2a4['startsWith'](SESSION_PREFIX)&&_0x43b2a4[_0x46a098(0xd5)]('.json'))[_0x46a098(0x143)](_0x4cc30a=>({'name':_0x4cc30a,'path':a0_0x15de03['join'](this['usageDir'],_0x4cc30a)}));if(_0x4a208d[_0x46a098(0x10a)]<=MAX_SESSION_FILES)return;const _0x2ac407=await Promise['all'](_0x4a208d['map'](async _0x149eac=>{const _0x5787b9=_0x46a098;try{const _0x24fe26=await a0_0x380c98[_0x5787b9(0x101)](_0x149eac['path']);return{..._0x149eac,'mtime':_0x24fe26['mtime']};}catch(_0x6392c5){return null;}})),_0x39af86=_0x2ac407[_0x46a098(0x134)](_0x301fa5=>_0x301fa5!==null)['sort']((_0x1fe4fe,_0x300467)=>_0x300467['mtime']-_0x1fe4fe['mtime']),_0x3b55a8=_0x39af86['slice'](MAX_SESSION_FILES);for(const _0x3a7b78 of _0x3b55a8){try{await a0_0x380c98[_0x46a098(0xe3)](_0x3a7b78[_0x46a098(0xfd)]),this['logger']['debug']('Removed\x20old\x20session\x20file:\x20'+_0x3a7b78[_0x46a098(0x118)]);}catch(_0x594383){this['logger']['warn'](_0x46a098(0x12b)+_0x3a7b78['name']+':',_0x594383);}}_0x3b55a8['length']>0x0&&this[_0x46a098(0x106)]['info'](_0x46a098(0x11c)+_0x3b55a8[_0x46a098(0x10a)]+'\x20old\x20session\x20files');}catch(_0x25965a){this['logger'][_0x46a098(0xb9)](_0x46a098(0x144),_0x25965a);}}async['resetUsageData'](_0x2dd7b6=![]){const _0x41fade=a0_0x465bea;this['logger']['info'](_0x41fade(0x12a),{'preserveTotal':_0x2dd7b6});if(!_0x2dd7b6)this['usage']=this[_0x41fade(0x104)]();else{const _0x5a2680=this['usage'][_0x41fade(0x137)],_0xa87963=this[_0x41fade(0xce)][_0x41fade(0x133)],_0x381e45=this[_0x41fade(0xce)]['totalOutputTokens'];this[_0x41fade(0xce)]=this[_0x41fade(0x104)](),this['usage'][_0x41fade(0x137)]=_0x5a2680,this[_0x41fade(0xce)]['totalInputTokens']=_0xa87963,this[_0x41fade(0xce)][_0x41fade(0xb5)]=_0x381e45;}await this[_0x41fade(0x10c)]();}async[a0_0x465bea(0xbe)](_0x5ce6b2=a0_0x465bea(0xde)){const _0x5d3122=a0_0x465bea,_0x4bfb45=await this['getBudgetUsage']();if(_0x5ce6b2===_0x5d3122(0xf7))return this['_exportToCsv'](_0x4bfb45);return JSON['stringify'](_0x4bfb45,null,0x2);}['_exportToCsv'](_0x48b671){const _0x45c606=a0_0x465bea,_0x4dfbc3=[_0x45c606(0xc2)];for(const [_0x3af96c,_0x44bffe]of Object[_0x45c606(0xf3)](_0x48b671[_0x45c606(0xf4)])){_0x4dfbc3['push'](_0x45c606(0xe4)+_0x3af96c+','+_0x44bffe['cost']+','+_0x44bffe[_0x45c606(0xb2)]+','+_0x44bffe['outputTokens']+','+_0x44bffe[_0x45c606(0x10f)]);}for(const [_0x25204d,_0x26fcf7]of Object[_0x45c606(0xf3)](_0x48b671['breakdownByModel'])){_0x4dfbc3[_0x45c606(0x136)](_0x45c606(0x123)+_0x25204d+','+_0x26fcf7[_0x45c606(0x132)]+','+_0x26fcf7['inputTokens']+','+_0x26fcf7[_0x45c606(0xef)]+','+_0x26fcf7[_0x45c606(0x10f)]);}return _0x4dfbc3['join']('\x0a');}[a0_0x465bea(0xca)](_0x18fde6,_0x30f761,_0x5ccfcb){const _0x34341a=a0_0x465bea;this[_0x34341a(0xf1)]('estimate',_0x18fde6,_0x30f761,_0x5ccfcb);const _0x4214a0=this[_0x34341a(0xdc)](_0x18fde6,_0x30f761,_0x5ccfcb),_0x5f5419={'model':_0x18fde6,'estimatedInputTokens':_0x30f761,'estimatedOutputTokens':_0x5ccfcb,'estimatedCost':_0x4214a0['totalCost'],..._0x4214a0,'budgetImpact':null};if(this['budgetLimit']!==null){const _0x310a87=this[_0x34341a(0xce)]['totalCost']+_0x4214a0['totalCost'];_0x5f5419['budgetImpact']={'currentSpent':this['usage']['totalCost'],'afterOperation':_0x310a87,'remainingAfter':Math['max'](0x0,this[_0x34341a(0xcd)]-_0x310a87),'wouldExceedBudget':_0x310a87>this[_0x34341a(0xcd)],'percentageAfter':_0x310a87/this['budgetLimit']*0x64};}return _0x5f5419;}[a0_0x465bea(0xd9)](_0x2b09ca,_0x341db9,_0x22920e){const _0x45c4e7=a0_0x465bea,_0x44518b=this['getCostEstimate'](_0x2b09ca,_0x341db9,_0x22920e);return{'canProceed':this[_0x45c4e7(0xcd)]===null||!_0x44518b['budgetImpact']?.['wouldExceedBudget'],'estimate':_0x44518b,'recommendation':this[_0x45c4e7(0x126)](_0x44518b)};}[a0_0x465bea(0x126)](_0x5a1d2f){const _0x1ff8f5=a0_0x465bea;if(this[_0x1ff8f5(0xcd)]===null)return'No\x20budget\x20limit\x20set.\x20Consider\x20setting\x20a\x20budget\x20for\x20cost\x20control.';if(!_0x5a1d2f['budgetImpact'])return'Proceed\x20with\x20operation.';const {percentageAfter:_0x1b6c58,wouldExceedBudget:_0x55e78f}=_0x5a1d2f[_0x1ff8f5(0x129)];if(_0x55e78f)return _0x1ff8f5(0xc6);if(_0x1b6c58>BUDGET_CRITICAL_THRESHOLD*0x64)return'Operation\x20would\x20use\x20most\x20of\x20your\x20budget.\x20Monitor\x20usage\x20carefully.';if(_0x1b6c58>BUDGET_WARNING_THRESHOLD*0x64)return'Operation\x20would\x20use\x20significant\x20portion\x20of\x20budget.\x20Consider\x20cost\x20optimization.';return'Operation\x20is\x20within\x20budget\x20guidelines.';}[a0_0x465bea(0x124)](){const _0x218c20=a0_0x465bea,_0x59cc0f=Array[_0x218c20(0xd1)](this[_0x218c20(0x146)][_0x218c20(0xf3)]())['map'](([_0x23f754,_0x149b80])=>({'model':_0x23f754,'inputPrice':_0x149b80[_0x218c20(0xbb)],'outputPrice':_0x149b80[_0x218c20(0x11e)],'unit':_0x149b80[_0x218c20(0xb1)],'currency':_0x149b80[_0x218c20(0xf2)]}));return{'models':_0x59cc0f,'lastUpdate':this['lastPricingUpdate'],'source':this['serverLLMService']?_0x218c20(0xd4):'fallback','totalModels':this[_0x218c20(0x146)][_0x218c20(0x11d)]};}async['healthCheck'](){const _0xa5d0ac=a0_0x465bea,_0x1d4c7c={'status':_0xa5d0ac(0xbf),'issues':[],'metrics':{'totalCost':this[_0xa5d0ac(0xce)][_0xa5d0ac(0x137)],'totalTokens':this['usage']['totalInputTokens']+this[_0xa5d0ac(0xce)]['totalOutputTokens'],'modelsWithPricing':this[_0xa5d0ac(0x146)][_0xa5d0ac(0x11d)],'budgetLimit':this[_0xa5d0ac(0xcd)]}};try{await this[_0xa5d0ac(0xd6)]();const _0x168fec=a0_0x15de03['join'](this['usageDir'],'.health-check');await a0_0x380c98['writeFile'](_0x168fec,_0xa5d0ac(0x130)),await a0_0x380c98['unlink'](_0x168fec);}catch(_0x539fc1){_0x1d4c7c['status']=_0xa5d0ac(0xf5),_0x1d4c7c['issues']['push']('File\x20system\x20access\x20issues');}this[_0xa5d0ac(0x146)]['size']===0x0&&(_0x1d4c7c['status']=_0xa5d0ac(0xf5),_0x1d4c7c['issues']['push'](_0xa5d0ac(0xea)));if(this[_0xa5d0ac(0xe2)]){const _0x190c3f=(Date['now']()-new Date(this['lastPricingUpdate'])['getTime']())/(0x3e8*0x3c*0x3c);_0x190c3f>0x18&&_0x1d4c7c[_0xa5d0ac(0xd0)][_0xa5d0ac(0x136)](_0xa5d0ac(0xf8));}if(this[_0xa5d0ac(0xcd)]!==null){const _0x4a221d=this[_0xa5d0ac(0xfa)]();_0x4a221d['warningLevel']!==_0xa5d0ac(0xc5)&&_0x1d4c7c['issues'][_0xa5d0ac(0x136)]('Budget\x20'+_0x4a221d['warningLevel']+':\x20'+_0x4a221d[_0xa5d0ac(0xfe)][_0xa5d0ac(0xf0)](0x1)+_0xa5d0ac(0xd3));}return _0x1d4c7c[_0xa5d0ac(0xd0)]['length']>0x0&&_0x1d4c7c['status']===_0xa5d0ac(0xbf)&&(_0x1d4c7c['status']='warning'),_0x1d4c7c;}async['shutdown'](){const _0x3b6637=a0_0x465bea;this[_0x3b6637(0x106)][_0x3b6637(0x142)](_0x3b6637(0xb7));try{await this['saveUsageData'](),this[_0x3b6637(0x146)]['clear'](),this['logger']['info'](_0x3b6637(0x122));}catch(_0x51cd54){this[_0x3b6637(0x106)][_0x3b6637(0xfb)]('Error\x20during\x20budget\x20service\x20shutdown:',_0x51cd54);throw _0x51cd54;}}}